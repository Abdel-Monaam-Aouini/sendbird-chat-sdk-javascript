import{_ as e,j as t,Y as n,c as a,d as r,M as s,Z as c,I as i,$ as o,a0 as l,g as u,q as h,a1 as d,a2 as f,U as p,a3 as v,W as E,A as _,e as g,h as A,k as b}from"./__bundle-03e78b6f.js";var m,C,L,I;!function(e){e.SUCCESS="success",e.PENDING="pending",e.ERROR="error"}(m||(m={})),function(e){e.DEFAULT="default",e.ALL="all",e.MENTION_ONLY="mention_only",e.OFF="off"}(C||(C={})),function(e){e.FCM="gcm",e.APNS="apns",e.UNKNOWN="unknown"}(L||(L={})),function(e){e.ALTERNATIVE="alternative",e.DEFAULT="default"}(I||(I={}));var y,T,N,S=100,w="GroupChannel",M="url",U=100,O="Message",D="messageId";!function(e){e.LATEST_LAST_MESSAGE="latest_last_message",e.CHRONOLOGICAL="chronological",e.CHANNEL_NAME_ALPHABETICAL="channel_name_alphabetical",e.METADATA_VALUE_ALPHABETICAL="metadata_value_alphabetical"}(y||(y={})),function(e){e.CHRONOLOGICAL="chronological",e.CHANNEL_NAME_ALPHABETICAL="channel_name_alphabetical",e.METADATA_VALUE_ALPHABETICAL="metadata_value_alphabetical"}(T||(T={})),function(e){e.CREATED_AT="created_at",e.SCHEDULED_AT="scheduled_at"}(N||(N={}));var k,P=function(e){switch(e){case y.LATEST_LAST_MESSAGE:return["-lastMessageUpdatedAt","-createdAt","syncIndex"];case y.CHRONOLOGICAL:return["-createdAt","syncIndex"];case y.CHANNEL_NAME_ALPHABETICAL:return["name"]}},H={},R=function(i){function p(e,t){var n=t.sdkState,a=t.cacheContext,r=t.unsentMessageCache,s=i.call(this,e)||this;return s._sdkState=n,s._cacheContext=a,s._unsentMessageCache=r,H[e]=s,s}return e(p,i),p.of=function(e){return H[e]},Object.defineProperty(p.prototype,"collection",{get:function(){var e=this._cacheContext.nestdb;return e?e.collection("Message"):null},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"localCacheEnabled",{get:function(){return this._cacheContext.localCacheEnabled&&!!this.collection},enumerable:!1,configurable:!0}),p.prototype._serialize=function(e){return t(t({},e.serialize()),{messageId:"".concat(e.messageId)})},p.prototype._deserialize=function(e){return e=t(t({},e),{messageId:parseInt(e.messageId)}),n.of(this._iid).buildMessageFromSerializedData(e)},p.prototype.get=function(e){return a(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return this.localCacheEnabled?[4,this.collection.getByKey("".concat(e))]:[3,2];case 1:if(t=n.sent())return[2,this._deserialize(t)];n.label=2;case 2:return[2,null]}}))}))},p.prototype.fetch=function(e){var t=e.channelUrl,n=e.token,i=e.limit,h=void 0===i?100:i,d=e.filter,p=void 0===d?new c:d,v=e.order,E=void 0===v?s.CHANNEL_LATEST:v,_=e.backward,g=void 0!==_&&_,A=e.parentMessageId,b=void 0===A?null:A;return a(this,void 0,void 0,(function(){var e,c,i,d=this;return r(this,(function(v){switch(v.label){case 0:return this.localCacheEnabled?(e=u(E),c={where:{channelUrl:t,"/where":function(e){if(n)switch(E){case s.CHANNEL_LATEST:if(!g&&e.createdAt>n||g&&e.createdAt<n)return!1;break;case s.NEWEST_CHILD_MESSAGE:if(!b||0===e.parentMessageId||e.parentMessageId!==b)return!1}return p.match(d._deserialize(e))}},index:e,backward:g},[4,this.collection.query(c)]):[3,3];case 1:return[4,v.sent().fetch({limit:h})];case 2:return i=v.sent(),[2,Promise.all(i.map((function(e){return a(d,void 0,void 0,(function(){var t,n,a;return r(this,(function(r){switch(r.label){case 0:return t=this._deserialize(e),(n=e.messageParams)?t instanceof l?(t.messageParams=n,[3,4]):[3,1]:[3,4];case 1:return t instanceof o?n.fileKey&&"string"==typeof n.fileKey&&f(n.fileType)?(a=n,[4,this.collection.getBlob(n.fileKey)]):[3,3]:[3,4];case 2:a.file=r.sent(),r.label=3;case 3:t.messageParams=n,r.label=4;case 4:return[2,t]}}))}))})))];case 3:return[2,[]]}}))}))},p.prototype.getAllChildMessages=function(e,t){return void 0===t&&(t=new c),a(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.fetch({channelUrl:e.channelUrl,token:Date.now(),limit:null,backward:!1,filter:t,order:s.NEWEST_CHILD_MESSAGE,parentMessageId:e.messageId})];case 1:return[2,n.sent()]}}))}))},p.prototype.upsert=function(e){return a(this,void 0,void 0,(function(){var t,n=this;return r(this,(function(a){switch(a.label){case 0:return this.localCacheEnabled?[4,this.saveBlobs(e)]:[3,5];case 1:return a.sent(),t=e.map((function(e){return n._serialize(e)})),[4,this.collection.upsertMany(t)];case 2:return a.sent(),[4,this.upsertChildMessages(e)];case 3:return a.sent(),[4,this._unsentMessageCache.upsertChildMessages(e)];case 4:a.sent(),a.label=5;case 5:return[2]}}))}))},p.prototype.upsertChildMessages=function(e){return a(this,void 0,void 0,(function(){var t=this;return r(this,(function(n){switch(n.label){case 0:return this.localCacheEnabled?[4,Promise.all(e.map((function(e){return a(t,void 0,void 0,(function(){var t,n;return r(this,(function(a){switch(a.label){case 0:return t=[],(null===(n=e.threadInfo)||void 0===n?void 0:n.replyCount)>0?[4,this.getAllChildMessages(e)]:[3,2];case 1:t=a.sent(),a.label=2;case 2:return t.length>0?(t.forEach((function(t){return t.applyParentMessage(e)})),[4,this.upsert(t)]):[3,4];case 3:a.sent(),a.label=4;case 4:return[2]}}))}))})))]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))},p.prototype.remove=function(e){return a(this,void 0,void 0,(function(){var t,n,a,s,c,i;return r(this,(function(r){switch(r.label){case 0:if(!this.localCacheEnabled)return[3,8];r.label=1;case 1:r.trys.push([1,6,7,8]),t=h(e),n=t.next(),r.label=2;case 2:return n.done?[3,5]:(a=n.value,[4,this.collection.remove("".concat(a))]);case 3:r.sent(),r.label=4;case 4:return n=t.next(),[3,2];case 5:return[3,8];case 6:return s=r.sent(),c={error:s},[3,8];case 7:try{n&&!n.done&&(i=t.return)&&i.call(t)}finally{if(c)throw c.error}return[7];case 8:return[2]}}))}))},p.prototype.removeMessagesOfChannel=function(e){return a(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return this.localCacheEnabled?[4,this.collection.removeIf({where:{channelUrl:e},index:u(s.CHANNEL_LATEST)})]:[3,6];case 1:return n.sent(),[4,(t=this._cacheContext.store).remove("sendbird:".concat(this._sdkState.userId,"@groupchannel/").concat(e,"/message/sync"))];case 2:return n.sent(),[4,t.remove("sendbird:".concat(this._sdkState.userId,"@groupchannel/").concat(e,"/message/sync.meta"))];case 3:return n.sent(),[4,t.remove("sendbird:".concat(this._sdkState.userId,"@groupchannel/").concat(e,"/message/changelogs"))];case 4:return n.sent(),[4,t.remove("sendbird:".concat(this._sdkState.userId,"@groupchannel/").concat(e,"/message/changelogs.meta"))];case 5:n.sent(),n.label=6;case 6:return[2]}}))}))},p.prototype.removeUnderOffset=function(e,t){return a(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return this.localCacheEnabled?[4,this.collection.removeIf({where:{channelUrl:e,createdAt:{"<":t}},index:u(s.CHANNEL_LATEST)})]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))},p.prototype.clear=function(){return a(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return this.localCacheEnabled?[4,this.collection.clear()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},p.prototype.countBetween=function(e,t,n){return a(this,void 0,void 0,(function(){var a,c=this;return r(this,(function(r){switch(r.label){case 0:return this.localCacheEnabled?(a=u(s.CHANNEL_LATEST),[4,this.collection.query({where:{channelUrl:e,"/where":function(e){var a=c._deserialize(e);return n.includes(a.createdAt)&&t.match(a)}},index:a}).count()]):[3,2];case 1:return[2,r.sent()];case 2:return[2,0]}}))}))},p.prototype.saveBlobs=function(e){return a(this,void 0,void 0,(function(){var t=this;return r(this,(function(n){switch(n.label){case 0:return[4,Promise.all(e.map((function(e){return a(t,void 0,void 0,(function(){var t,n;return r(this,(function(a){switch(a.label){case 0:return e instanceof o&&e.messageParams&&((t=e.messageParams).file&&d(t.file))?[4,this.collection.saveBlob(t.file,e.reqId)]:[3,2];case 1:n=a.sent(),t.fileKey=n,a.label=2;case 2:return[2]}}))}))})))];case 1:return n.sent(),[2]}}))}))},p}(i);!function(e){e[e.USER_BLOCK=20001]="USER_BLOCK",e[e.USER_UNBLOCK=2e4]="USER_UNBLOCK",e[e.FRIEND_DISCOVERED=20900]="FRIEND_DISCOVERED"}(k||(k={}));var B=function(){function e(e){this.category=e.cat,this.data=e.data}return e.getDataAsUserBlockEvent=function(e,t){var n=t.data,a=n.blocker,r=n.blockee;return{blocker:new p(e,a),blockee:new p(e,r)}},e.getDataAsFriendDiscoveredEvent=function(e,t){var n=t.data.friend_discoveries;return{friendDiscoveries:Array.isArray(n)?n.map((function(t){return new p(e,t)})):[]}},e}(),x=function(t){function n(e,n){var a=n.userId,r=t.call(this)||this;return r._iid=e,r.userId=a,r}return e(n,t),n}(v),G=function(t){function n(e,n,a){var r=t.call(this,e,"USEV",a)||this;return r.event=new B(a),r}return e(n,t),n}(E),K=function(t){function n(e){var n=e.userId,a=t.call(this)||this;return a.method=_.GET,a.path="".concat(g,"/").concat(encodeURIComponent(n),"/push_preference"),a}return e(n,t),n}(A),z=function(t){function n(e,n){var a=t.call(this,e,n)||this;return a.pushTriggerOption=n.push_trigger_option,a}return e(n,t),n}(b),F=function(t){function n(e){var n=e.userId,a=e.pushTriggerOption,r=t.call(this)||this;return r.method=_.PUT,r.path="".concat(g,"/").concat(encodeURIComponent(n),"/push_preference"),r.params={push_trigger_option:a},r}return e(n,t),n}(A),V=function(t){function n(e,n){var a=t.call(this,e,n)||this;return a.pushTriggerOption=n.push_trigger_option,a}return e(n,t),n}(b);export{x as D,y as G,R as M,w as N,L as P,V as S,G as U,M as a,O as b,D as c,k as d,B as e,m as f,P as g,z as h,K as i,C as j,F as k,I as l,S as m,U as n,T as o,N as p};
