import{_ as e,aV as t,b as s,c as n,ac as r,aB as a,y as i,z as o,r as u,ak as c,az as d,T as h,U as l,W as _}from"./__bundle-1da35e70.js";import{q as A}from"./__bundle-0099b2f2.js";var g,f,E;!function(e){e.LATEST_LAST_MESSAGE="latest_last_message",e.CHRONOLOGICAL="chronological",e.CHANNEL_NAME_ALPHABETICAL="channel_name_alphabetical",e.METADATA_VALUE_ALPHABETICAL="metadata_value_alphabetical"}(g||(g={})),function(e){e.CHRONOLOGICAL="chronological",e.CHANNEL_NAME_ALPHABETICAL="channel_name_alphabetical",e.METADATA_VALUE_ALPHABETICAL="metadata_value_alphabetical"}(f||(f={})),function(e){e.CREATED_AT="created_at",e.SCHEDULED_AT="scheduled_at"}(E||(E={}));var p,C=function(e){switch(e){case g.LATEST_LAST_MESSAGE:return["-lastMessageUpdatedAt","-createdAt","syncIndex"];case g.CHRONOLOGICAL:return["-createdAt","syncIndex"];case g.CHANNEL_NAME_ALPHABETICAL:return["name"];default:return["-lastMessageUpdatedAt","-createdAt","syncIndex"]}},L=function(t){function s(e){var s=e.message,n=t.call(this)||this;return n.message=s,n}return e(s,t),s}(t),R={},I=function(){function e(e,t){var s=t.localCacheEnabled,n=t.dispatcher,r=t.sdkState,a=t.logger,u=this;this._iid=e,R[e]=this,this._localCacheEnabled=s,this._isProcessingAutoResend=!1,this._autoResendQueue=[],this._dispatcher=n,this._logger=a,this._sdkState=r,this._localCacheEnabled&&n.on((function(e){if(e instanceof i)switch(e.stateType){case o.CONNECTED:u._isProcessingAutoResend||u.processAutoResendRegisteredPendingMessages().then((function(){return u._processNextAutoResend()}));break;case o.INTERNAL_DISCONNECTED:case o.EXTERNAL_DISCONNECTED:u._isProcessingAutoResend=!1}}))}return e.of=function(e){return R[e]},e.prototype.processNonAutoResendRegisteredPendingMessages=function(){return s(this,void 0,void 0,(function(){var e,t,s,a,i,o;return n(this,(function(n){switch(n.label){case 0:return[4,this._fetchAllCachedPendingMessages()];case 1:e=n.sent();try{for(t=u(e),s=t.next();!s.done;s=t.next())0===(a=s.value).errorCode&&(this._logger.debug("cached pending message is not auto-resend registered. changing its sending status to failed: ",a.reqId),a.sendingStatus=r.FAILED,a.errorCode=c.ACK_TIMEOUT,this._dispatcher.dispatch(new d({messages:[a],source:h.LOCAL_MESSAGE_FAILED})))}catch(e){i={error:e}}finally{try{s&&!s.done&&(o=t.return)&&o.call(t)}finally{if(i)throw i.error}}return[2]}}))}))},e.prototype.processAutoResendRegisteredPendingMessages=function(){return s(this,void 0,void 0,(function(){var e,t,s,i,o,c,l,_;return n(this,(function(n){switch(n.label){case 0:return[4,this._fetchAllCachedPendingMessages()];case 1:e=n.sent();try{for(t=u(e),s=t.next();!s.done;s=t.next())(i=s.value).errorCode&&a(i.errorCode)&&(o=(new Date).getTime(),c=i.createdAt+2592e5,o<=c?this._autoResendQueue.map((function(e){return e.reqId})).indexOf(i.reqId)<0&&this._autoResendQueue.push(i):(this._logger.debug("auto-resend registered pending messaged expired. expiration date: ",new Date(c).toLocaleString()),i.sendingStatus=r.FAILED,this._dispatcher.dispatch(new d({messages:[i],source:h.LOCAL_MESSAGE_FAILED}))))}catch(e){l={error:e}}finally{try{s&&!s.done&&(_=t.return)&&_.call(t)}finally{if(l)throw l.error}}return[2]}}))}))},e.prototype.completeCurrentAndProcessNextAutoResend=function(e){if(this._localCacheEnabled&&(e.sendingStatus===r.SUCCEEDED||e.sendingStatus===r.FAILED&&!a(e.errorCode))){var t=this.indexOf(e);t>=0&&this._autoResendQueue.splice(t,1),0===t&&this._processNextAutoResend()}},e.prototype._fetchAllCachedPendingMessages=function(){return s(this,void 0,void 0,(function(){var e,t;return n(this,(function(s){switch(s.label){case 0:return(e=A.of(this._iid))?[4,e.fetch({sendingStatus:r.PENDING,backward:!0})]:[3,2];case 1:return t=s.sent(),[3,3];case 2:t=[],s.label=3;case 3:return[2,t]}}))}))},e.prototype.indexOf=function(e){return this._autoResendQueue.length>0?this._autoResendQueue.map((function(e){return e.reqId})).indexOf(e.reqId):-1},e.prototype._isNotInQueue=function(e){return-1===this._autoResendQueue.map((function(e){return e.reqId})).indexOf(e.reqId)},e.prototype._processNextAutoResend=function(){return s(this,void 0,void 0,(function(){var e;return n(this,(function(t){if(this._localCacheEnabled&&"foreground"===this._sdkState.appState)try{this._autoResendQueue.length>0?(this._isProcessingAutoResend||(this._logger.debug("auto-resend queue started."),this._isProcessingAutoResend=!0),e=this._autoResendQueue[0],this._dispatcher.dispatch(new L({message:e})),this._logger.debug("processing auto-resend for message request id: ",e.reqId)):(this._logger.debug("auto-resend queue finished."),this._isProcessingAutoResend=!1)}catch(e){this._logger.warn("process auto-resend error: ",e),this._isProcessingAutoResend=!1}return[2]}))}))},e}();!function(e){e[e.USER_BLOCK=20001]="USER_BLOCK",e[e.USER_UNBLOCK=2e4]="USER_UNBLOCK",e[e.FRIEND_DISCOVERED=20900]="FRIEND_DISCOVERED"}(p||(p={}));var S=function(){function e(e){this.category=e.cat,this.data=e.data}return e.getDataAsUserBlockEvent=function(e,t){var s=t.data,n=s.blocker,r=s.blockee;return{blocker:new l(e,n),blockee:new l(e,r)}},e.getDataAsFriendDiscoveredEvent=function(e,t){var s=t.data.friend_discoveries;return{friendDiscoveries:Array.isArray(s)?s.map((function(t){return new l(e,t)})):[]}},e}(),N=function(t){function s(e,s){var n=s.userId,r=t.call(this)||this;return r._iid=e,r.userId=n,r}return e(s,t),s}(t),v=function(t){function s(){return t.call(this)||this}return e(s,t),s}(t),D=function(t){function s(e,s,n){var r=t.call(this,e,"USEV",n)||this;return r.event=new S(n),r}return e(s,t),s}(_);export{I as A,N as D,g as G,f as P,v as R,E as S,D as U,p as a,S as b,L as c,C as g};
