"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t,s,n,i,a,r,o,d,l=require("./lib/__bundle-2c62c22a.js"),h=require("./lib/__bundle-a0aca442.js"),u=require("./lib/__bundle-110b4c07.js"),c=require("./lib/__bundle-f919b499.js"),_=require("./lib/__bundle-2509e4be.js"),p=require("./lib/__bundle-5beb62ec.js");exports.MemberState=void 0,(e=exports.MemberState||(exports.MemberState={})).NONE="none",e.JOINED="joined",e.INVITED="invited",e.LEFT="left";class m extends h.RestrictedUser{constructor(e,t){super(e,t),this.state=null,this.role=null,this.isMuted=!1,this.isBlockedByMe=!1,this.isBlockingMe=!1,this.state=l.isEnumOf(exports.MemberState,t.state)?t.state:null,this.role=l.isEnumOf(l.Role,t.role)?t.role:null,"boolean"==typeof t.is_muted&&(this.isMuted=t.is_muted),"boolean"==typeof t.is_blocked_by_me&&(this.isBlockedByMe=t.is_blocked_by_me),"boolean"==typeof t.is_blocking_me&&(this.isBlockingMe=t.is_blocking_me)}static payloadify(e){return l.deundefined(l.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{state:e.state,role:e.role,is_muted:e.isMuted,is_blocked_by_me:e.isBlockedByMe,is_blocking_me:e.isBlockingMe})))}}class g extends l.InstancedObject{constructor(e,t){var s,n;super(e),this.channelUrl=null!==(s=t.channel_url)&&void 0!==s?s:"",this.channelType=null!==(n=t.channel_type)&&void 0!==n?n:l.ChannelType.GROUP,this.reader=new l.User(this._iid,t.user),this.readAt=t.ts}}exports.PublicChannelFilter=void 0,(t=exports.PublicChannelFilter||(exports.PublicChannelFilter={})).ALL="all",t.PUBLIC="public",t.PRIVATE="private",exports.MyMemberStateFilter=void 0,(s=exports.MyMemberStateFilter||(exports.MyMemberStateFilter={})).ALL="all",s.JOINED="joined_only",s.INVITED="invited_only",s.INVITED_BY_FRIEND="invited_by_friend",s.INVITED_BY_NON_FRIEND="invited_by_non_friend",exports.SuperChannelFilter=void 0,(n=exports.SuperChannelFilter||(exports.SuperChannelFilter={})).ALL="all",n.SUPER="super",n.NON_SUPER="nonsuper",n.BROADCAST_ONLY="broadcast_only",n.EXCLUSIVE_ONLY="exclusive_only",exports.UnreadChannelFilter=void 0,(i=exports.UnreadChannelFilter||(exports.UnreadChannelFilter={})).ALL="all",i.UNREAD_MESSAGE="unread_message",exports.HiddenChannelFilter=void 0,(a=exports.HiddenChannelFilter||(exports.HiddenChannelFilter={})).ALL="all",a.UNHIDDEN="unhidden_only",a.HIDDEN="hidden_only",a.HIDDEN_ALLOW_AUTO_UNHIDE="hidden_allow_auto_unhide",a.HIDDEN_PREVENT_AUTO_UNHIDE="hidden_prevent_auto_unhide",exports.OperatorFilter=void 0,(r=exports.OperatorFilter||(exports.OperatorFilter={})).ALL="all",r.OPERATOR="operator",r.NONOPERATOR="nonoperator",exports.QueryType=void 0,(o=exports.QueryType||(exports.QueryType={})).AND="AND",o.OR="OR",exports.GroupChannelSearchField=void 0,(d=exports.GroupChannelSearchField||(exports.GroupChannelSearchField={})).MEMBER_NICKNAME="member_nickname",d.CHANNEL_NAME="channel_name";class C{constructor(){this._searchFilter=null,this._userIdsFilter=null,this.includeEmpty=!1,this.nicknameContainsFilter=null,this.nicknameStartsWithFilter=null,this.nicknameExactMatchFilter=null,this.channelNameContainsFilter="",this.myMemberStateFilter=exports.MyMemberStateFilter.ALL,this.customTypesFilter=null,this.channelUrlsFilter=null,this.superChannelFilter=exports.SuperChannelFilter.ALL,this.publicChannelFilter=exports.PublicChannelFilter.ALL,this.customTypeStartsWithFilter=null,this.unreadChannelFilter=exports.UnreadChannelFilter.ALL,this.hiddenChannelFilter=exports.HiddenChannelFilter.UNHIDDEN,this.includeFrozen=!0}_isFriend(e){return!(!e||!e.friendDiscoveryKey&&!e.friendName)}get searchFilter(){return this._searchFilter}setSearchFilter(e,t){Array.isArray(e)&&0!==e.length&&"string"==typeof t&&t&&(this._searchFilter={query:t,fields:e})}get userIdsFilter(){return this._userIdsFilter}setUserIdsFilter(e,t,s=exports.QueryType.AND){this._userIdsFilter={userIds:e,includeMode:t,queryType:s}}clone(){var e;const t=new C;this.searchFilter&&t.setSearchFilter(this.searchFilter.fields,null!==(e=this.searchFilter.query)&&void 0!==e?e:void 0),this.userIdsFilter&&t.setUserIdsFilter(this.userIdsFilter.userIds,this.userIdsFilter.includeMode,this.userIdsFilter.queryType);const s=JSON.parse(JSON.stringify(this));return Object.keys(s).forEach((e=>{t[e]=s[e]})),t}match(e,t){if(this._searchFilter){const{query:t,fields:s}=this._searchFilter;if(t&&s&&s.length>0&&!s.some((s=>{switch(s){case exports.GroupChannelSearchField.CHANNEL_NAME:return e.name.toLowerCase().includes(t.toLowerCase());case exports.GroupChannelSearchField.MEMBER_NICKNAME:return e.members.some((e=>e.nickname.toLowerCase().includes(t.toLowerCase())));default:return!0}})))return!1}if(this._userIdsFilter){const{userIds:s,includeMode:n,queryType:i}=this._userIdsFilter,a=e.members.map((e=>e.userId));if(n){if(s.length>0)switch(i){case exports.QueryType.AND:if(s.some((e=>!a.includes(e))))return!1;break;case exports.QueryType.OR:if(s.every((e=>!a.includes(e))))return!1}}else{if(s.includes(t)||s.push(t),e.members.length>s.length)return!1;if(!l.hasSameMembers(s,a))return!1}}if(!this.includeEmpty&&!e.lastMessage)return!1;if(!this.includeFrozen&&e.isFrozen)return!1;if(this.customTypesFilter&&this.customTypesFilter.length>0&&!this.customTypesFilter.includes(e.customType))return!1;if(this.customTypeStartsWithFilter&&!new RegExp(`^${this.customTypeStartsWithFilter}`).test(e.customType))return!1;if(this.channelNameContainsFilter&&!e.name.toLowerCase().includes(this.channelNameContainsFilter.toLowerCase()))return!1;if(this.nicknameContainsFilter){const s=this.nicknameContainsFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase().includes(s))))return!1}if(this.nicknameStartsWithFilter){const s=this.nicknameStartsWithFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase().startsWith(s))))return!1}if(this.nicknameExactMatchFilter){const s=this.nicknameExactMatchFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase()!=s)))return!1}if(this.channelUrlsFilter&&this.channelUrlsFilter.length>0&&!this.channelUrlsFilter.includes(e.url))return!1;if(this.myMemberStateFilter)switch(this.myMemberStateFilter){case exports.MyMemberStateFilter.JOINED:if("joined"!==e.myMemberState)return!1;break;case exports.MyMemberStateFilter.INVITED:if("invited"!==e.myMemberState)return!1;break;case exports.MyMemberStateFilter.INVITED_BY_FRIEND:if("invited"!==e.myMemberState||!this._isFriend(e.inviter))return!1;break;case exports.MyMemberStateFilter.INVITED_BY_NON_FRIEND:if("invited"!==e.myMemberState||this._isFriend(e.inviter))return!1}if(this.hiddenChannelFilter)switch(this.hiddenChannelFilter){case exports.HiddenChannelFilter.UNHIDDEN:if(e.isHidden||"unhidden"!==e.hiddenState)return!1;break;case exports.HiddenChannelFilter.HIDDEN:if(!e.isHidden)return!1;break;case exports.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:if(!e.isHidden||"hidden_allow_auto_unhide"!==e.hiddenState)return!1;break;case exports.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:if(!e.isHidden||"hidden_prevent_auto_unhide"!==e.hiddenState)return!1}if(this.unreadChannelFilter&&this.unreadChannelFilter===exports.UnreadChannelFilter.UNREAD_MESSAGE)if(0===e.unreadMessageCount)return!1;if(this.publicChannelFilter)switch(this.publicChannelFilter){case exports.PublicChannelFilter.PUBLIC:if(!e.isPublic)return!1;break;case exports.PublicChannelFilter.PRIVATE:if(e.isPublic)return!1}if(this.superChannelFilter)switch(this.superChannelFilter){case exports.SuperChannelFilter.SUPER:if(!e.isSuper)return!1;break;case exports.SuperChannelFilter.NON_SUPER:if(e.isSuper)return!1}return!0}}class v extends l.InstancedObject{constructor(e,{sdkState:t,cacheContext:s}){super(e),this._channels=new Map,this._sdkState=t,this._cacheContext=s}get collection(){const{nestdb:e}=this._cacheContext;return l.unless(!!e).throw(l.SendbirdError.databaseError),e.collection(h.NESTDB_GROUPCHANNEL_COLLECTION_NAME)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e,t=0){return Object.assign(Object.assign({},e.serialize()),{lastMessageUpdatedAt:e.lastMessage?e.lastMessage.createdAt:0,syncIndex:t})}_deserialize(e){return Ae.of(this._iid).buildGroupChannelFromSerializedData(e)}get channels(){return[...this._channels.values()]}isCachedInMemory(e){return this._channels.has(e)}filterOffsetChanged(e){return e.filter((e=>{if(this._channels.has(e.url)){return this._channels.get(e.url).messageOffsetTimestamp<e.messageOffsetTimestamp}}))}get(e){return l.__awaiter(this,void 0,void 0,(function*(){if(this._channels.has(e))return this._channels.get(e);if(this.localCacheEnabled){const t=yield this.collection.getByKey(e);if(t){const s=this._deserialize(t);return this._channels.set(e,s),s}}}))}fetch({token:e,limit:t=h.DEFAULT_GROUPCHANNEL_LIMIT,backward:s=!1,filter:n=new C,order:i=u.GroupChannelListOrder.LATEST_LAST_MESSAGE,borderlineChannelUrl:a}){return l.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const r={where:t=>{if(e)switch(i){case u.GroupChannelListOrder.CHANNEL_NAME_ALPHABETICAL:if(!s&&t.name.localeCompare(e)<0||s&&t.name.localeCompare(e)>0)return!1;if(a&&a===t.url)return!1;break;case u.GroupChannelListOrder.CHRONOLOGICAL:if(!s&&t.createdAt>e||s&&t.createdAt<e)return!1;if(a&&a===t.url)return!1;break;case u.GroupChannelListOrder.LATEST_LAST_MESSAGE:if(!s&&t.lastMessageUpdatedAt>e||s&&t.lastMessageUpdatedAt<e)return!1;if(a&&a===t.url)return!1}return n.match(this._deserialize(t),this._sdkState.userId)},index:u.getGroupChannelIndexBy(i),backward:s},o=yield this.collection.query(r),d=(yield o.fetch({limit:t})).map((e=>this._deserialize(e)));return d.forEach((e=>{this._channels.has(e.url)||this._channels.set(e.url,e)})),d}return[]}))}upsert(e,t){return l.__awaiter(this,void 0,void 0,(function*(){const s=[];if(e.forEach((e=>{if(this._channels.has(e.url)){const n=this._channels.get(e.url);n._pinnedMessagesUpdatedAt<e._pinnedMessagesUpdatedAt&&(n._pinnedMessagesUpdatedAt=e._pinnedMessagesUpdatedAt),e.cachedMetaData&&t&&(n._upsertCachedMetaData(e.cachedMetaData,t),Object.assign(e,{_cachedMetaData:void 0})),n._update(e),s.push(n)}else this._channels.set(e.url,e),s.push(e)})),this.localCacheEnabled){const e=[];for(const t in s)e.push(this._serialize(s[t],parseInt(t)));yield this.collection.upsertMany(e)}return s}))}remove(e){return l.__awaiter(this,void 0,void 0,(function*(){for(const t of e)this._channels.delete(t),this.localCacheEnabled&&(yield this.collection.remove(t))}))}clear(){return l.__awaiter(this,void 0,void 0,(function*(){this.clearMemoryCache(),this.localCacheEnabled&&(yield this.collection.clear())}))}clearMemoryCache(){this._channels.clear()}_setBlockStateOfAllChannels(e,t,s){return l.__awaiter(this,void 0,void 0,(function*(){const n=[];if(e===this._sdkState.userId){for(const e of this._channels.values())for(const i of e.members)if(i.userId===t){i.isBlockedByMe=s,n.push(e);break}}else if(t===this._sdkState.userId)for(const t of this._channels.values())for(const i of t.members)if(i.userId===e){i.isBlockingMe=s,n.push(t);break}n.length>0&&(yield this.upsert(n))}))}block(e,t){return l.__awaiter(this,void 0,void 0,(function*(){yield this._setBlockStateOfAllChannels(e,t,!0)}))}unblock(e,t){return l.__awaiter(this,void 0,void 0,(function*(){yield this._setBlockStateOfAllChannels(e,t,!1)}))}markAsRead(e,t=[...this._channels.keys()]){return l.__awaiter(this,void 0,void 0,(function*(){const s=[];for(const n of t){const t=yield this.get(n);(null==t?void 0:t._updateUnreadMemberState(this._sdkState.userId,e))&&(t._updateUnreadCount(0,0),s.push(t))}s.length>0&&(yield this.upsert(s))}))}}const E={invitedUserIds:void 0,channelUrl:void 0,coverUrl:void 0,coverImage:void 0,isDistinct:void 0,isSuper:void 0,isBroadcast:void 0,isExclusive:void 0,isPublic:void 0,isDiscoverable:void 0,isStrict:void 0,isEphemeral:void 0,accessCode:void 0,name:void 0,data:void 0,customType:void 0,operatorUserIds:void 0,messageSurvivalSeconds:void 0},f=e=>l.isArrayOf("string",e.invitedUserIds,!0)&&l.isTypeOf("string",e.channelUrl,!0)&&l.isTypeOf("string",e.coverUrl,!0)&&(l.isFile(e.coverImage)||l.isTypeOf("string",e.coverImage,!0))&&l.isTypeOf("boolean",e.isDistinct,!0)&&l.isTypeOf("boolean",e.isSuper,!0)&&l.isTypeOf("boolean",e.isBroadcast,!0)&&l.isTypeOf("boolean",e.isExclusive,!0)&&l.isTypeOf("boolean",e.isPublic,!0)&&l.isTypeOf("boolean",e.isStrict,!0)&&l.isTypeOf("boolean",e.isDiscoverable,!0)&&l.isTypeOf("boolean",e.isEphemeral,!0)&&l.isTypeOf("string",e.accessCode,!0)&&l.isTypeOf("string",e.name,!0)&&l.isTypeOf("string",e.data,!0)&&l.isTypeOf("string",e.customType,!0)&&l.isArrayOf("string",e.operatorUserIds,!0)&&l.isTypeOf("number",e.messageSurvivalSeconds,!0),M={customTypes:void 0,includeEmpty:!1,includeFrozen:!0},y=e=>l.isArrayOf("string",e.customTypes,!0)&&l.isTypeOf("boolean",e.includeEmpty)&&l.isTypeOf("boolean",e.includeFrozen),S={myMemberStateFilter:exports.MyMemberStateFilter.ALL},b=e=>l.isEnumOf(exports.MyMemberStateFilter,e.myMemberStateFilter);var A;exports.UnreadItemKey=void 0,(A=exports.UnreadItemKey||(exports.UnreadItemKey={})).GROUP_CHANNEL_UNREAD_MENTION_COUNT="group_channel_unread_mention_count",A.NONSUPER_UNREAD_MENTION_COUNT="non_super_group_channel_unread_mention_count",A.SUPER_UNREAD_MENTION_COUNT="super_group_channel_unread_mention_count",A.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT="group_channel_unread_message_count",A.NONSUPER_UNREAD_MESSAGE_COUNT="non_super_group_channel_unread_message_count",A.SUPER_UNREAD_MESSAGE_COUNT="super_group_channel_unread_message_count",A.GROUP_CHANNEL_INVITATION_COUNT="group_channel_invitation_count",A.NONSUPER_INVITATION_COUNT="non_super_group_channel_invitation_count",A.SUPER_INVITATION_COUNT="super_group_channel_invitation_count";const U={keys:[]},T={channelCustomTypesFilter:void 0,superChannelFilter:exports.SuperChannelFilter.ALL},N={channelUrl:void 0,scheduledStatus:void 0,messageTypeFilter:l.MessageTypeFilter.ALL};class I{constructor({groupChannelCache:e,messageCache:t,unsentMessageCache:s,dispatcher:n}){this._observers=new Map,n.on((n=>l.__awaiter(this,void 0,void 0,(function*(){if(n instanceof u.GroupChannelUpdateEventCommand){const{channels:s,source:i,isWebSocketEventComing:a,data:r}=n,o=s.filter((e=>e instanceof Ot)),d=e.filterOffsetChanged(o);for(const e of d)yield t.removeUnderOffset(e.url,e.messageOffsetTimestamp);const l=yield e.upsert(o,n.ts);a||this._broadcastUpdateEvent(l,i,r)}else if(n instanceof u.GroupChannelRemoveEventCommand){const{channelUrls:i,source:a,isWebSocketEventComing:r}=n;yield e.remove(i),yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of i)yield t.removeMessagesOfChannel(e),yield s.removeMessagesOfChannel(e)})))),r||this._broadcastRemoveEvent(i,a)}else n instanceof u.DatabaseOpenCommand&&(yield e.fetch({token:Number.MAX_SAFE_INTEGER,limit:Number.MAX_SAFE_INTEGER}))}))))}_broadcastUpdateEvent(e,t,s){for(const n of this._observers.values())n.onUpdate&&n.onUpdate(e,t,s)}_broadcastRemoveEvent(e,t){for(const s of this._observers.values())s.onRemove&&s.onRemove(e,t)}subscribe(e,t){this._observers.set(e,t)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}class O{constructor({cacheContext:e,messageCache:t,unsentMessageCache:s,dispatcher:n,logger:i}){this._observers=new Map,this._cacheContext=e,this._logger=i,n.on((e=>l.__awaiter(this,void 0,void 0,(function*(){if(e instanceof l.MessageUpdateEventCommand){const{messages:n,source:i,isWebSocketEventComing:a}=e,r=n.filter((e=>e.messageId>0)),o=n.filter((e=>0===e.messageId));r.length>0&&(yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){yield t.upsert(r),yield s.remove(r.map((e=>e instanceof _.SendableMessage?e.reqId:null)).filter((e=>null!==e)))})))),a||this._broadcastUpdateEvent(r,i)),o.length>0&&(yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){yield s.upsert(o)})))),a||this._broadcastUpdateEvent(o,i))}else if(e instanceof l.MessageRemoveEventCommand){const{messageIds:s,source:n,isWebSocketEventComing:i}=e;yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){yield t.remove(s)})))),i||this._broadcastRemoveEvent(s,n)}else if(e instanceof l.UnsentMessageRemoveEventCommand){const{reqId:t,source:n}=e;yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){yield s.remove([t])})))),this._broadcastRemoveUnsentEvent(t,n)}else if(e instanceof l.PollChangeLogEventCommand){const{polls:s,source:n}=e;if(this._cacheContext.localCacheEnabled){const e=s.map((e=>e.messageId)),n=(yield Promise.all(e.map((e=>t.get(e))))).filter((e=>e));n.length>0&&s.forEach((e=>{const t=n.find((t=>t.messageId===e.messageId));t&&t.applyPoll(e)})),yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){return yield t.upsert(n)}))))}this._broadcastPollChangeLogEvent(s,n)}else if(e instanceof l.PollUpdateInternalEventCommand){const{event:s,source:n}=e,i=yield t.get(s.messageId);i&&i.isUserMessage()&&i.poll&&i.poll.applyPollUpdateEvent(s)&&(yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){return yield t.upsert([i])}))))),this._broadcastPollUpdateEvent(s,n)}else if(e instanceof l.PollVoteInternalEventCommand){const{event:s,source:n}=e,i=yield t.get(s.messageId);i&&i.isUserMessage()&&i.poll&&i.poll.applyPollVoteEvent(s)&&(yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){return yield t.upsert([i])}))))),this._broadcastPollVoteEvent(s,n)}}))))}_broadcastUpdateEvent(e,t){for(const s of this._observers.values())s.onUpdate&&s.onUpdate(e,t)}_broadcastPollChangeLogEvent(e,t){for(const s of this._observers.values())s.onPollChangeLogUpdate&&s.onPollChangeLogUpdate(e,t)}_broadcastPollUpdateEvent(e,t){for(const s of this._observers.values())s.onPollUpdate&&s.onPollUpdate(e,t)}_broadcastPollVoteEvent(e,t){for(const s of this._observers.values())s.onPollVote&&s.onPollVote(e,t)}_broadcastRemoveEvent(e,t){for(const s of this._observers.values())s.onRemove&&s.onRemove(e,t)}_broadcastRemoveUnsentEvent(e,t){for(const s of this._observers.values())s.onRemoveUnsent&&s.onRemoveUnsent(e,t)}subscribe(e,t){this._observers.set(e,t)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}class P extends l.APIRequestCommand{constructor({userId:e,ts:t,token:s,filter:n}){super();const{customTypes:i,includeEmpty:a,includeFrozen:r}=Object.assign(Object.assign({},M),n);this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/my_group_channels/changelogs`,this.params=l.deundefined(l.undefineNullProps({show_delivery_receipt:!0,show_member:!0,show_read_receipt:!0,change_ts:t||null,token:s,custom_types:i,show_empty:a,show_frozen:r}))}}class w extends l.APIResponseCommand{constructor(e,t){super(e,t),this.updatedChannels=t.updated.map((s=>new Ot(e,Object.assign(s,{ts:t.ts})))),this.deletedChannelUrls=t.deleted,this.hasMore=t.has_more,this.token=t.next,this.ts=t.ts}}class x extends l.APIRequestCommand{constructor({channelUrl:e,isInternalCall:t}){super(),this.method=l.APIRequestMethod.GET,this.path=`${t?l.API_PATH_GROUP_CHANNELS_INTERNAL:l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}`,this.params={show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0}}}class R extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Ot(e,t)}}const L={includeEmpty:!1,includeFrozen:!0,includeMetaData:!0,channelUrlsFilter:void 0,customTypesFilter:void 0,customTypeStartsWithFilter:void 0,nicknameContainsFilter:void 0,nicknameStartsWithFilter:void 0,nicknameExactMatchFilter:void 0,channelNameContainsFilter:void 0,myMemberStateFilter:exports.MyMemberStateFilter.ALL,unreadChannelFilter:exports.UnreadChannelFilter.ALL,superChannelFilter:exports.SuperChannelFilter.ALL,publicChannelFilter:exports.PublicChannelFilter.ALL,hiddenChannelFilter:exports.HiddenChannelFilter.ALL,userIdsFilter:{userIds:[],includeMode:!0,queryType:exports.QueryType.AND},searchFilter:{query:void 0,fields:[]},metadataKey:void 0,metadataValues:void 0,metadataOrderKeyFilter:void 0,metadataValueStartsWith:void 0,order:u.GroupChannelListOrder.LATEST_LAST_MESSAGE};class F extends l.APIRequestCommand{constructor(e){const{userId:t,token:s,limit:n,order:i,includeEmpty:a,myMemberStateFilter:r,superChannelFilter:o,publicChannelFilter:d,unreadChannelFilter:h,nicknameContainsFilter:u,nicknameStartsWithFilter:c,nicknameExactMatchFilter:_,channelNameContainsFilter:p,channelUrlsFilter:m,customTypesFilter:g,customTypeStartsWithFilter:C,hiddenChannelFilter:v,metadataOrderKeyFilter:E,metadataKey:f,metadataValues:M,metadataValueStartsWith:y,includeFrozen:S,includeMetaData:b,searchFilter:A,userIdsFilter:U}=e;super(),this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(t)}/my_group_channels`,this.params=l.deundefined({token:s,limit:n,order:null!=i?i:L.order,show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0,show_empty:null!=a?a:L.includeEmpty,member_state_filter:null!=r?r:L.myMemberStateFilter,super_mode:null!=o?o:L.superChannelFilter,public_mode:null!=d?d:L.publicChannelFilter,unread_filter:null!=h?h:L.unreadChannelFilter,members_nickname_contains:u,members_nickname_startswith:c,members_nickname:_,name_contains:p,channel_urls:m,custom_types:g,custom_type_startswith:C,hidden_mode:v,metadata_order_key:E,metadata_key:f,metadata_values:M,metadata_value_startswith:y,show_frozen:S,show_metadata:b}),A&&A.query&&A.fields&&(this.params.search_query=A.query,this.params.search_fields=A.fields),U&&U.userIds&&U.userIds.length>0&&(U.includeMode?(this.params.members_include_in=U.userIds,this.params.query_type=U.queryType.toUpperCase()):this.params.members_exactly_in=U.userIds)}}class k extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channels=[];const{next:s,channels:n,ts:i}=t;this.token=s,n&&n.length>0&&(this.channels=n.map((t=>(t.ts=i,new Ot(e,t))))),this.ts=null!=i?i:0}}class D extends l.APIRequestCommand{constructor({userId:e,filter:t}){super();const{myMemberStateFilter:s}=t;this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/group_channel_count`,this.params={state:null!=s?s:exports.MyMemberStateFilter.ALL}}}class G extends l.APIResponseCommand{constructor(e,t){super(e,t),this.groupChannelCount=t.group_channel_count}}class H extends l.APIRequestCommand{constructor({userId:e,filter:t}){super();const{keys:s}=t;this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/unread_item_count`,this.params=l.deundefined({item_keys:s})}}class V extends l.APIResponseCommand{constructor(e,t){super(e,t),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT]&&(this.groupChannelUnreadMentionCount=t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT]&&(this.groupChannelUnreadMessageCount=t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT]&&(this.groupChannelInvitationCount=t[exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT]&&(this.superGroupChannelUnreadMentionCount=t[exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT]&&(this.superGroupChannelUnreadMessageCount=t[exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_INVITATION_COUNT]&&(this.superGroupChannelInvitationCount=t[exports.UnreadItemKey.SUPER_INVITATION_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT]&&(this.nonSuperGroupChannelUnreadMentionCount=t[exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT]&&(this.nonSuperGroupChannelUnreadMessageCount=t[exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_INVITATION_COUNT]&&(this.nonSuperGroupChannelInvitationCount=t[exports.UnreadItemKey.NONSUPER_INVITATION_COUNT])}}class q extends l.APIRequestCommand{constructor({userId:e}){super(),this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/unread_channel_count`}}class j extends l.APIResponseCommand{constructor(e,t){super(e,t),this.unreadCount=t.unread_count}}class B extends l.APIRequestCommand{constructor({userId:e,filter:t}){super();const{channelCustomTypesFilter:s,superChannelFilter:n}=t;this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/unread_message_count`,this.params={super_mode:null!=n?n:exports.SuperChannelFilter.ALL,custom_types:s}}}class W extends l.APIResponseCommand{constructor(e,t){super(e,t),this.unreadCount=t.unread_count}}class $ extends l.APIRequestCommand{constructor({channelUrl:e,scheduledStatus:t,messageTypeFilter:s}){super(),this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_SCHEDULED_MESSAGES}/count`,this.params={channel_url:e,status:Q(t)},s&&(this.params.message_type=s)}}class z extends l.APIResponseCommand{constructor(e,t){super(e,t),this.count=t.count}}const Q=e=>{if(!e)return[];const t=[];return e.forEach((e=>{switch(e){case _.ScheduledStatus.PENDING:t.push(_.InternalScheduledStatus.PENDING);break;case _.ScheduledStatus.SENT:t.push(_.InternalScheduledStatus.IN_QUEUE),t.push(_.InternalScheduledStatus.SENT);break;case _.ScheduledStatus.CANCELED:t.push(_.InternalScheduledStatus.CANCELED);break;case _.ScheduledStatus.FAILED:t.push(_.InternalScheduledStatus.FAILED)}})),t};class K extends l.APIRequestCommand{constructor(e){const{userId:t,channelUrl:s,coverUrl:n,coverImage:i,isDistinct:a,isSuper:r,isBroadcast:o,isPublic:d,isExclusive:h,isDiscoverable:u,isStrict:c,isEphemeral:_,accessCode:p,name:m,data:g,customType:C,messageSurvivalSeconds:v,invitedUserIds:E,operatorUserIds:f}=e;super(),this.method=l.APIRequestMethod.POST,this.path=l.API_PATH_GROUP_CHANNELS,this.params=l.deundefined({user_ids:[t,...null!=E?E:[]].filter(((e,t,s)=>t===s.indexOf(e))),channel_url:s,cover_url:n,cover_file:i,is_distinct:a,is_super:r,is_broadcast:o,is_exclusive:h,is_public:d,is_discoverable:u,strict:c,is_ephemeral:_,access_code:p,name:m,data:g,custom_type:C,operator_ids:f,message_survival_seconds:v})}}class Y extends l.APIResponseCommand{constructor(e,t){var s;super(e,t),this.channel=new Ot(e,t),this.isCreated=null===(s=t.is_created)||void 0===s||s}}class J extends l.APIRequestCommand{constructor({userId:e,channelUrls:t}){super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/mark_as_read_all`,this.params={channel_urls:t}}}class X extends l.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,accessCode:n}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/join`,this.params={user_id:s,access_code:n}}}class Z extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Ot(e,t)}}class ee extends c.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n=0,joined_member_count:i=0,users:a=null}=s.data;this.memberCount=n,this.joinedMemberCount=i,this.members=Array.isArray(a)?a.map((t=>new m(e,t))):[new m(e,s.data)]}}class te extends l.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,shouldRemoveOperatorStatus:n}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/leave`,this.params={user_id:s,should_remove_operator_status:n}}}class se extends c.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n=0,joined_member_count:i=0}=s.data;this.memberCount=n,this.joinedMemberCount=i,this.member=new m(this._iid,s.data)}}class ne extends l.APIRequestCommand{constructor(e){const{channelUrl:t,userIds:s}=e;super(),this.method=l.APIRequestMethod.POST,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/invite`,this.params={user_ids:s}}}class ie extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Ot(e,t)}}class ae extends c.ChannelEventCommand{constructor(e,t,s){super(e,t,s),this.inviter=null;const{member_count:n=0,joined_member_count:i=0,inviter:a,invitees:r=[]}=s.data;this.memberCount=n,this.joinedMemberCount=i,a&&Object.keys(a).length>0&&(this.inviter=new l.User(e,a)),this.invitees=r.map((t=>new m(e,t)))}}class re extends l.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/decline`,this.params={user_id:s}}}class oe extends c.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n,joined_member_count:i,inviter:a,invitee:r}=s.data;this.memberCount=null!=n?n:0,this.joinedMemberCount=null!=i?i:0,this.inviter=new l.User(e,a),this.invitee=new m(e,r)}}class de extends l.WebSocketRequestCommand{constructor({channelUrl:e}){super({code:"READ",ackRequired:!0,payload:{channel_url:e}})}}class le extends l.WebSocketEventCommand{constructor(e,t,s){super(e,"READ",s),this.readStatus=new g(e,s)}}class he extends l.APIRequestCommand{constructor({channelUrl:e,userId:t}){super(),super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}/messages/mark_as_delivered`,this.params=l.deundefined({userId:t})}}class ue extends l.WebSocketEventCommand{constructor(e,t,s){super(e,"DLVR",s),this.channelUrl=s.channel_url,this.deliveredStateUpdate=s.updated}}const ce={hidePreviousMessages:!1,allowAutoUnhide:!0};class _e extends l.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,hidePreviousMessages:n,allowAutoUnhide:i}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/hide`,this.params={user_id:s,hide_previous_messages:null!=n?n:ce.hidePreviousMessages,allow_auto_unhide:null!=i?i:ce.allowAutoUnhide}}}class pe extends l.APIResponseCommand{constructor(e,t){super(e,t);const{ts_message_offset:s}=t;this.messageOffsetTimestamp=s}}class me extends l.WebSocketEventCommand{constructor(e,t,s){var n,i,a;super(e,"SYEV",s),this.allowAutoUnhide=null,this.hidePreviousMessages=null,this.messageOffsetTimestamp=null,s.data&&(this.allowAutoUnhide=null!==(n=s.data.allow_auto_unhide)&&void 0!==n?n:null,this.hidePreviousMessages=null!==(i=s.data.hide_previous_messages)&&void 0!==i?i:null),this.messageOffsetTimestamp=null!==(a=s.ts_message_offset)&&void 0!==a?a:null}}class ge extends l.WebSocketRequestCommand{constructor({channelUrl:e,time:t}){super({code:"TPST",ackRequired:!1,payload:{channel_url:e,time:t}})}}class Ce extends l.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new l.User(e,s.data)}}class ve extends l.WebSocketRequestCommand{constructor({channelUrl:e,time:t}){super({code:"TPEN",ackRequired:!1,payload:{channel_url:e,time:t}})}}class Ee extends l.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new l.User(e,s.data)}}class fe extends l.WebSocketRequestCommand{constructor({channelUrl:e,messageId:t}){super({code:"MACK",ackRequired:!1,payload:{channel_url:e,msg_id:t}})}}class Me extends l.BaseListQuery{constructor(e,t){var s,n,i,a,r,o,d,l,h,c,_,p,m,g,C,v,E,f,M,y,S,b;super(e,t),this.includeEmpty=!1,this.includeFrozen=!0,this.includeMetaData=!0,this.channelUrlsFilter=null,this.customTypesFilter=null,this.customTypeStartsWithFilter=null,this.nicknameContainsFilter=null,this.nicknameStartsWithFilter=null,this.nicknameExactMatchFilter=null,this.channelNameContainsFilter="",this.myMemberStateFilter=exports.MyMemberStateFilter.ALL,this.unreadChannelFilter=exports.UnreadChannelFilter.ALL,this.superChannelFilter=exports.SuperChannelFilter.ALL,this.publicChannelFilter=exports.PublicChannelFilter.ALL,this.hiddenChannelFilter=exports.HiddenChannelFilter.UNHIDDEN,this.searchFilter={fields:[],query:null},this.userIdsFilter={userIds:[],includeMode:!0,queryType:exports.QueryType.AND},this.metadataKey=null,this.metadataValues=null,this.metadataOrderKeyFilter=null,this.metadataValueStartsWith=null,this.order=u.GroupChannelListOrder.LATEST_LAST_MESSAGE,this.includeEmpty=null!==(s=t.includeEmpty)&&void 0!==s&&s,this.includeFrozen=null===(n=t.includeFrozen)||void 0===n||n,this.includeMetaData=null===(i=t.includeMetaData)||void 0===i||i,this.channelUrlsFilter=null!==(a=t.channelUrlsFilter)&&void 0!==a?a:null,this.customTypesFilter=null!==(r=t.customTypesFilter)&&void 0!==r?r:null,this.customTypeStartsWithFilter=null!==(o=t.customTypeStartsWithFilter)&&void 0!==o?o:"",this.nicknameContainsFilter=null!==(d=t.nicknameContainsFilter)&&void 0!==d?d:null,this.nicknameStartsWithFilter=null!==(l=t.nicknameStartsWithFilter)&&void 0!==l?l:null,this.nicknameExactMatchFilter=null!==(h=t.nicknameExactMatchFilter)&&void 0!==h?h:null,this.channelNameContainsFilter=null!==(c=t.channelNameContainsFilter)&&void 0!==c?c:"",this.myMemberStateFilter=null!==(_=t.myMemberStateFilter)&&void 0!==_?_:exports.MyMemberStateFilter.ALL,this.unreadChannelFilter=null!==(p=t.unreadChannelFilter)&&void 0!==p?p:exports.UnreadChannelFilter.ALL,this.superChannelFilter=null!==(m=t.superChannelFilter)&&void 0!==m?m:exports.SuperChannelFilter.ALL,this.publicChannelFilter=null!==(g=t.publicChannelFilter)&&void 0!==g?g:exports.PublicChannelFilter.ALL,this.hiddenChannelFilter=null!==(C=t.hiddenChannelFilter)&&void 0!==C?C:exports.HiddenChannelFilter.UNHIDDEN,this.searchFilter=null!==(v=t.searchFilter)&&void 0!==v?v:{fields:[],query:null},this.userIdsFilter=null!==(E=t.userIdsFilter)&&void 0!==E?E:{userIds:[],includeMode:!0,queryType:exports.QueryType.AND},this.metadataKey=null!==(f=t.metadataKey)&&void 0!==f?f:null,this.metadataValues=null!==(M=t.metadataValues)&&void 0!==M?M:null,this.metadataOrderKeyFilter=null!==(y=t.metadataOrderKeyFilter)&&void 0!==y?y:null,this.metadataValueStartsWith=null!==(S=t.metadataValueStartsWith)&&void 0!==S?S:null,this.order=null!==(b=t.order)&&void 0!==b?b:u.GroupChannelListOrder.LATEST_LAST_MESSAGE}_validate(){return super._validate()&&l.isTypeOf("boolean",this.includeEmpty)&&l.isTypeOf("boolean",this.includeFrozen)&&l.isTypeOf("boolean",this.includeMetaData)&&l.isTypeOf("string",this.channelNameContainsFilter)&&l.isArrayOf("string",this.channelUrlsFilter,!0)&&l.isArrayOf("string",this.customTypesFilter,!0)&&l.isTypeOf("string",this.customTypeStartsWithFilter)&&l.isTypeOf("string",this.nicknameContainsFilter,!0)&&l.isTypeOf("string",this.nicknameStartsWithFilter,!0)&&l.isTypeOf("string",this.nicknameExactMatchFilter,!0)&&l.isEnumOf(exports.MyMemberStateFilter,this.myMemberStateFilter)&&l.isEnumOf(exports.SuperChannelFilter,this.superChannelFilter)&&l.isEnumOf(exports.PublicChannelFilter,this.publicChannelFilter)&&l.isEnumOf(exports.UnreadChannelFilter,this.unreadChannelFilter)&&l.isEnumOf(exports.HiddenChannelFilter,this.hiddenChannelFilter)&&l.isArrayOf(exports.GroupChannelSearchField,this.searchFilter.fields)&&l.isTypeOf("string",this.searchFilter.query,!0)&&l.isArrayOf("string",this.userIdsFilter.userIds)&&l.isTypeOf("boolean",this.userIdsFilter.includeMode)&&l.isEnumOf(exports.QueryType,this.userIdsFilter.queryType)&&l.isEnumOf(u.GroupChannelListOrder,this.order)&&l.isTypeOf("string",this.metadataOrderKeyFilter,!0)&&l.isTypeOf("string",this.metadataKey,!0)&&l.isArrayOf("string",this.metadataValues,!0)&&l.isTypeOf("string",this.metadataValueStartsWith,!0)}serialize(){return l.serialize(this)}next(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw l.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const e=Ae.of(this._iid),{channels:t,token:s}=yield e.getMyGroupChannels(this._token,l.undefineNullProps(Object.assign({},this)),this.limit);return this._token=s,this._hasNext=!!s,this._isLoading=!1,t}return[]}throw l.SendbirdError.invalidParameters}))}}class ye{constructor({top:e=Number.MAX_SAFE_INTEGER,bottom:t=0}){this.top=e,this.bottom=t}includes(...e){return e.every((e=>this.top<=e&&e<=this.bottom))}overlap(e){return this.includes(e.top)||this.includes(e.bottom)}intersect(...e){return e.some((e=>this.top<=e&&e<=this.bottom))}extends(...e){this.top=Math.min(this.top,...e),this.bottom=Math.max(this.bottom,...e)}}class Se extends l.WebSocketEventCommand{constructor(e,t,s){var n;super(e,"SYEV",s),this.pinnedMessageIds=[],this.latestPinnedMessage=null,this.ts=0,s.data&&(this.pinnedMessageIds=null!==(n=s.data.pinned_message_ids)&&void 0!==n?n:[],this.latestPinnedMessage=s.data.latest_pinned_message?_.parseMessagePayload(e,Object.assign({},s.data.latest_pinned_message)):null),this.ts=s.ts}}const be={};class Ae{constructor(e,{sdkState:t,cacheContext:s,dispatcher:n,sessionManager:i,requestQueue:a,logger:r,disableMack:o=!1}){return this._leftChannels=new Map,this._disableMack=!1,this._markAsReadAllLastSentAt=0,be[e]||(this._iid=e,this._sdkState=t,this._sessionManager=i,this._requestQueue=a,this._dispatcher=n,this._logger=r,this._disableMack=o,this._groupChannelHandlers=new Map,this._groupChannelCache=new v(this._iid,{sdkState:t,cacheContext:s}),this._unsentMessageCache=new u.UnsentMessageCache(this._iid,{sdkState:t,cacheContext:s}),this._messageCache=new u.MessageCache(this._iid,{sdkState:t,cacheContext:s,unsentMessageCache:this._unsentMessageCache}),this._groupChannelBroadcast=new I({groupChannelCache:this._groupChannelCache,messageCache:this._messageCache,unsentMessageCache:this._unsentMessageCache,dispatcher:n}),this._messageBroadcast=new O({cacheContext:s,messageCache:this._messageCache,unsentMessageCache:this._unsentMessageCache,dispatcher:n,logger:r}),setInterval((()=>{for(const e of this._groupChannelCache.channels)e.invalidateTypingStatus()&&(this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[e],source:u.GroupChannelEventSource.EVENT_CHANNEL_TYPING_STATUS_UPDATE})),this._groupChannelHandlers.forEach((t=>{t.onTypingStatusUpdated&&t.onTypingStatusUpdated(e)})))}),1e3),this._dispatcher.on((e=>{e instanceof l.WebSocketEventCommand?this._handleEvent(e):e instanceof u.AutoResendRequestCommand?(()=>{l.__awaiter(this,void 0,void 0,(function*(){const{message:t}=e,s=yield this.getChannel(t.channelUrl,!0);t instanceof _.UserMessage?s._autoResendUserMessage(t):t instanceof _.FileMessage&&s._autoResendFileMessage(t)}))})():e instanceof u.ReduceDBSizeEventCommand&&this.reduceDBSize()})),be[e]=this),be[e]}static of(e){return be[e]}static clear(e){be[e]&&delete be[e]}get handlers(){return[...this._groupChannelHandlers.values()]}buildGroupChannelFromSerializedData(e){const t=l.deserialize(e);return new Ot(this._iid,Ot.payloadify(t))}buildGroupChannelListQueryFromSerializedData(e){const t=l.deserialize(e);return new Me(this._iid,t)}buildMemberFromSerializedData(e){const t=l.deserialize(e);return new m(this._iid,m.payloadify(t))}getChannelFromCache(e){var t;return l.__awaiter(this,void 0,void 0,(function*(){return null!==(t=yield this._groupChannelCache.get(e))&&void 0!==t?t:null}))}getChannelsFromCache(e,t,s,n,i){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannelCache.fetch({token:e,filter:t,order:s,limit:n,borderlineChannelUrl:i})}))}upsertChannelsToCache(e){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannelCache.upsert(e)}))}removeChannelsFromCache(e){return l.__awaiter(this,void 0,void 0,(function*(){yield this._groupChannelCache.remove(e)}))}clearChannelsFromCache(){return l.__awaiter(this,void 0,void 0,(function*(){yield this._groupChannelCache.clear()}))}reduceDBSize(){return l.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=l.Vault.of(this._iid),{localCacheConfig:t,nestdb:s}=e;if(!e.localCacheEnabled||!s||s.state!=u.NestDBState.OPENED)return;const n=1024*t.maxSize*1024;let i=yield s.estimateUsage();if(i<n)return;const a=[],r=this._groupChannelCache.channels,o={};for(let e=0;e<r.length;e++){const t=yield this.getMessagesFromCache(r[e].url,0,"prev",new u.MessageFilter);o[r[e].url]=JSON.stringify(t).length;const s=new l.CachedChannelInfo({channel:r[e],cachedMessageCount:t.length});a.push(s)}const d=a.sort(t.clearOrderComparator);for(let e=0;e<d.length;e++){yield this._messageCache.removeMessagesOfChannel(d[e].channel.url);const t=yield this._messageCache._getGroupChannelPreferenceSize(d[e].channel.url);if(i-=o[d[e].channel.url]+t,i<n)break}}))}_handleEvent(e){var t;return l.__awaiter(this,void 0,void 0,(function*(){try{switch(e.code){case"MESG":case"FILE":case"ADMM":case"BRDM":{let s=null;if("MESG"===e.code?s=e.as(h.UserMessageEventCommand):"FILE"===e.code?s=e.as(_.FileMessageEventCommand):"ADMM"!==e.code&&"BRDM"!=e.code||(s=e.as(c.AdminMessageEventCommand)),s){const{message:e,isMentioned:n,forceUpdateLastMessage:i}=s;if(e.channelType===l.ChannelType.GROUP){this._disableMack||l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){const t=new fe(e);this._requestQueue.send(t)}))));const s=this._groupChannelCache.isCachedInMemory(e.channelUrl),a=e instanceof _.SendableMessage&&e.sender.userId===this._sdkState.userId,r=yield this.getChannel(e.channelUrl,!0);if(r.hiddenState===exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE&&(r.hiddenState=exports.HiddenState.UNHIDDEN),e instanceof _.SendableMessage){const{useMemberInfoInMessage:s}=l.Vault.of(this._iid);for(const t of r.members)if(t.userId===e.sender.userId){s||(e.sender.nickname=t.nickname,e.sender.plainProfileUrl=t.plainProfileUrl,e.sender.metaData=t.metaData,e.sender.isBlockedByMe=t.isBlockedByMe);break}if(!s&&n&&(null===(t=e.mentionedUsers)||void 0===t||t.forEach((e=>{for(const t of r.members)if(e.userId===t.userId){e.nickname=t.nickname,e.plainProfileUrl=t.plainProfileUrl,e.metaData=t.metaData;break}}))),a){const{currentUser:t}=this._sessionManager;t&&(t.nickname=e.sender.nickname,t.plainProfileUrl=e.sender.plainProfileUrl,t.metaData=e.sender.metaData)}}e.silent&&!a||(r.isEphemeral||s)&&((!r.lastMessage||r.lastMessage.createdAt<e.createdAt)&&(r.lastMessage=e),a||r._updateUnreadCount(r.unreadMessageCount+1,r.unreadMentionCount+(n?1:0))),i&&(!r.lastMessage||r.lastMessage.createdAt<e.createdAt)&&(r.lastMessage=e),this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[r],source:u.GroupChannelEventSource.EVENT_MESSAGE_RECEIVED})),e.silent&&!a||l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(r)})))),this._dispatcher.dispatch(new l.MessageUpdateEventCommand({messages:[e],source:l.MessageEventSource.EVENT_MESSAGE_RECEIVED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageReceived&&t.onMessageReceived(r,e),n&&t.onMentionReceived&&t.onMentionReceived(r,e)}))))}}break}case"MEDI":case"FEDI":case"AEDI":{let t=null;if("MEDI"===e.code?t=e.as(h.UpdateUserMessageEventCommand):"FEDI"===e.code?t=e.as(h.UpdateFileMessageEventCommand):"AEDI"===e.code&&(t=e.as(c.UpdateAdminMessageEventCommand)),t){const{message:e,mentionCountChange:s}=t;if(e.channelType===l.ChannelType.GROUP){const t=this._groupChannelCache.isCachedInMemory(e.channelUrl),n=yield this.getChannel(e.channelUrl,!0),i=e instanceof _.SendableMessage&&e.sender.userId===this._sdkState.userId;let a=!1;if(i){const t=e.sender,{currentUser:s}=this._sessionManager;s&&(s.nickname=t.nickname,s.plainProfileUrl=t.plainProfileUrl,s.metaData=t.metaData)}else n.isReadMessage(e)||0!==s&&!e.silent&&t&&(n._updateUnreadCount(n.unreadMessageCount,n.unreadMentionCount+s),a=!0);!n.lastMessage||n.lastMessage.createdAt<e.createdAt?(n.lastMessage=e,a=!0):n.lastMessage.isIdentical(e)&&(t?n.lastMessage.updatedAt<e.updatedAt&&(n.lastMessage=e,a=!0):a=!0);let r=!1;n.lastPinnedMessage&&n.lastPinnedMessage.messageId===e.messageId&&(n.lastPinnedMessage=e,a=!0,r=!0),a&&(this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[n],source:r?u.GroupChannelEventSource.EVENT_PINNED_MESSAGE_UPDATED:u.GroupChannelEventSource.EVENT_MESSAGE_UPDATED})),e.silent&&!i||l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(n)})))),r&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(n)}))))),this._dispatcher.dispatch(new l.MessageUpdateEventCommand({messages:[e],source:l.MessageEventSource.EVENT_MESSAGE_UPDATED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageUpdated&&t.onMessageUpdated(n,e),0!==s&&t.onMentionReceived&&t.onMentionReceived(n,e)}))))}}break}case"DELM":{const{channelUrl:t,channelType:s,messageId:n}=e.as(h.DeleteMessageEventCommand);if(s===l.ChannelType.GROUP){const e=yield this.getChannel(t,!0);this._dispatcher.dispatch(new l.MessageRemoveEventCommand({messageIds:[n],source:l.MessageEventSource.EVENT_MESSAGE_DELETED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageDeleted&&t.onMessageDeleted(e,n)}))))}break}case"READ":{const{readStatus:t}=e.as(le);if(t.channelType===l.ChannelType.GROUP){const e=this._groupChannelCache.isCachedInMemory(t.channelUrl),s=yield this.getChannel(t.channelUrl,!0);e&&s._updateUnreadMemberState(t.reader.userId,t.readAt),t.reader.userId===this._sdkState.userId?e?(s.unreadMessageCount>0||s.unreadMentionCount>0)&&(s._updateUnreadCount(0,0),this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_READ})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)}))))):0!==s.unreadMessageCount&&0!==s.unreadMentionCount||(this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_READ})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)}))))):(this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_READ})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onUnreadMemberStatusUpdated&&e.onUnreadMemberStatusUpdated(s)})))))}break}case"DLVR":{const{channelUrl:t,deliveredStateUpdate:s={}}=e.as(ue),n=this._groupChannelCache.isCachedInMemory(t),i=yield this.getChannel(t,!0);if(n)for(const e in s)i._updateUndeliveredMemberState(e,s[e]);Object.keys(s).some((e=>e!==this._sdkState.userId))&&(this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[i],source:u.GroupChannelEventSource.EVENT_CHANNEL_DELIVERED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onUndeliveredMemberStatusUpdated&&e.onUndeliveredMemberStatusUpdated(i)})))));break}case"MRCT":{const{channelUrl:t,channelType:s,event:n}=e.as(c.ReactionEventCommand);if(s===l.ChannelType.GROUP){const e=yield this.getChannel(t,!0),s=yield this.getMessageFromCache(n.messageId);s&&(s.applyReactionEvent(n),this._dispatcher.dispatch(new l.MessageUpdateEventCommand({messages:[s],source:l.MessageEventSource.EVENT_MESSAGE_REACTION_UPDATED}))),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onReactionUpdated&&t.onReactionUpdated(e,n)}))))}break}case"MTHD":{const{event:t}=e.as(c.ThreadInfoUpdateEventCommand);if(t.channelType===l.ChannelType.GROUP){const e=yield this.getChannel(t.channelUrl,!0),s=yield this.getMessageFromCache(t.targetMessageId);s&&(s.applyThreadInfoUpdateEvent(t),this._dispatcher.dispatch(new l.MessageUpdateEventCommand({messages:[s],source:l.MessageEventSource.EVENT_MESSAGE_THREADINFO_UPDATED}))),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onThreadInfoUpdated&&s.onThreadInfoUpdated(e,t)}))))}break}case"MCNT":{const{groupChannelMemberCounts:t}=e.as(c.MemberCountUpdateEventCommand),s=[];for(const e of t){const{channelUrl:t,memberCount:n,joinedMemberCount:i,updatedAt:a}=e,r=yield this.getChannelFromCache(t);r&&r._setLatestMemberCount(n,i,a)&&s.push(r)}s.length>0&&(this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:s,source:u.GroupChannelEventSource.EVENT_CHANNEL_MEMBER_COUNT_UPDATED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged(s)})))));break}case"PEDI":{const{event:t,status:s,channelUrl:n,channelType:i}=e.as(c.PollUpdateEventCommand);if(n&&i===l.ChannelType.GROUP){const e=yield this.getChannel(n,!0);this._dispatcher.dispatch(new l.PollUpdateInternalEventCommand({event:t,source:l.MessageEventSource.EVENT_POLL_UPDATED})),s===l.POLL_REMOVED_STATUS?l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollDeleted&&s.onPollDeleted(e,t.pollId)})))):l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollUpdated&&s.onPollUpdated(e,t)}))))}break}case"VOTE":{const{event:t,channelUrl:s,channelType:n}=e.as(h.PollVoteEventCommand);if(s&&n===l.ChannelType.GROUP){const e=yield this.getChannel(s,!0);this._dispatcher.dispatch(new l.PollVoteInternalEventCommand({event:t,source:l.MessageEventSource.EVENT_POLL_VOTED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollVoted&&s.onPollVoted(e,t)}))))}break}case"SYEV":{const{event:t}=e.as(c.ChannelEventCommand);if(t.isGroupChannelEvent)switch(t.category){case c.ChannelEventCategory.CHANNEL_JOIN:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,members:a}=e.as(ee);let r=!1;a.forEach((e=>{s.isExclusive||s.isSuper||s.isBroadcast?r=r||s._setLatestMemberCount(n,i,t.ts):(e.state=exports.MemberState.JOINED,s.addMember(e,t.ts),this._updateJoinedMemberCount(s)),e.userId===this._sdkState.userId&&(s.myMemberState=exports.MemberState.JOINED)})),this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_JOINED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{for(const t of a)e.onUserJoined&&e.onUserJoined(s,t);s.isBroadcast&&r&&e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged([s])}))}))));break}case c.ChannelEventCategory.CHANNEL_LEAVE:{const s=this._leftChannels.get(t.channelUrl),n=s?s.channel:yield this.getChannel(t.channelUrl,!0),{memberCount:i,joinedMemberCount:a,member:r}=e.as(se);let o=!1;const{appInfo:d}=l.Vault.of(this._iid);if(n.isExclusive||n.isSuper||n.isBroadcast)o=n._setLatestMemberCount(i,a,t.ts);else{if(null==d?void 0:d.enabledChannelMemberShipHistory){const e=n.members.find((t=>t.userId===e.userId));e&&(e.state=exports.MemberState.LEFT),n.memberCount=i}else n.removeMember(r);this._updateJoinedMemberCount(n)}r.userId===this._sdkState.userId?(n.myMemberState=exports.MemberState.NONE,n.invitedAt=0,n.joinedAt=0,n._updateUnreadCount(0,0),n.isPublic?this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[n],source:u.GroupChannelEventSource.EVENT_CHANNEL_LEFT})):(this._markAsLeave(n),this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:[n.url],source:u.GroupChannelEventSource.EVENT_CHANNEL_LEFT})))):this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[n],source:u.GroupChannelEventSource.EVENT_CHANNEL_LEFT})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserLeft&&e.onUserLeft(n,r),n.isBroadcast&&o&&e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged([n])}))}))));break}case c.ChannelEventCategory.CHANNEL_OPERATOR_UPDATE:{const s=yield this.getChannel(t.channelUrl,!0),{operators:n}=e.as(c.OperatorUpdateEventCommand),i=n.map((e=>e.userId));for(const e of s.members)e.role=i.includes(e.userId)?l.Role.OPERATOR:l.Role.NONE;s.myRole=i.includes(this._sdkState.userId)?l.Role.OPERATOR:l.Role.NONE,this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_OPERATOR_UPDATED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onOperatorUpdated&&e.onOperatorUpdated(s,n)}))}))));break}case c.ChannelEventCategory.CHANNEL_INVITE:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,inviter:a,invitees:r}=e.as(ae);r.forEach((e=>e.state=exports.MemberState.INVITED));for(const e of r)s.isExclusive||s.isSuper||s.isBroadcast?s._setLatestMemberCount(n,i,t.ts):s.addMember(e,t.ts),this._sdkState.userId===e.userId&&(s.hiddenState=exports.HiddenState.UNHIDDEN,s.myMemberState!==exports.MemberState.JOINED&&(s.myMemberState=exports.MemberState.INVITED),s.invitedAt=t.ts);this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_INVITED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserReceivedInvitation&&e.onUserReceivedInvitation(s,a,r)}))}))));break}case c.ChannelEventCategory.CHANNEL_DECLINE_INVITE:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,inviter:a,invitee:r}=e.as(oe);s.isExclusive||s.isSuper||s.isBroadcast?s._setLatestMemberCount(n,i,t.ts):s.removeMember(r),this._sdkState.userId===r.userId?(s.invitedAt=0,s.myMemberState=exports.MemberState.NONE,s.isPublic?this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_DECLINED_INVITE})):this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:[s.url],source:u.GroupChannelEventSource.EVENT_CHANNEL_DECLINED_INVITE}))):this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_DECLINED_INVITE})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserDeclinedInvitation&&e.onUserDeclinedInvitation(s,a,r)}))}))));break}case c.ChannelEventCategory.TYPING_START:case c.ChannelEventCategory.TYPING_END:{const s=yield this.getChannel(t.channelUrl,!0),n=t.category===c.ChannelEventCategory.TYPING_START,{user:i}=e.as(n?Ce:Ee);s._updateTypingStatus(i,n?t.ts:0),this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_TYPING_STATUS_UPDATE})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onTypingStatusUpdated&&e.onTypingStatusUpdated(s)}))}))));break}case c.ChannelEventCategory.USER_CHANNEL_MUTE:case c.ChannelEventCategory.USER_CHANNEL_UNMUTE:{const s=yield this.getChannel(t.channelUrl,!0),n=t.category===c.ChannelEventCategory.USER_CHANNEL_MUTE,{user:i}=e.as(n?h.MuteUserEventCommand:h.UnmuteUserEventCommand);i.userId===this._sdkState.userId&&(s.myMutedState=n?exports.MutedState.MUTED:exports.MutedState.UNMUTED,s._myMutedRemainingTime=i.restrictionInfo.remainingDuration);for(const e of s.members)if(e.userId===i.userId){e.isMuted=n;break}this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:n?u.GroupChannelEventSource.EVENT_CHANNEL_MUTED:u.GroupChannelEventSource.EVENT_CHANNEL_UNMUTED,data:i.userId})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n?e.onUserMuted&&e.onUserMuted(s,i):e.onUserUnmuted&&e.onUserUnmuted(s,i)}))}))));break}case c.ChannelEventCategory.USER_CHANNEL_BAN:{const s=this._leftChannels.get(t.channelUrl),n=s?s.channel:yield this.getChannel(t.channelUrl,!0);this._markAsLeave(n);const{user:i}=e.as(h.BanUserEventCommand);i.userId===this._sdkState.userId&&this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:[n.url],source:u.GroupChannelEventSource.EVENT_CHANNEL_BANNED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserBanned&&e.onUserBanned(n,i)}))}))));break}case c.ChannelEventCategory.USER_CHANNEL_UNBAN:{const s=yield this.getChannel(t.channelUrl,!0),{user:n}=e.as(h.UnbanUserEventCommand);l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserUnbanned&&e.onUserUnbanned(s,n)}))}))));break}case c.ChannelEventCategory.CHANNEL_FREEZE:case c.ChannelEventCategory.CHANNEL_UNFREEZE:{const s=yield this.getChannel(t.channelUrl,!0),{freeze:n}=e.as(h.FreezeEventCommand);s.isFrozen=n,this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:n?u.GroupChannelEventSource.EVENT_CHANNEL_FROZEN:u.GroupChannelEventSource.EVENT_CHANNEL_UNFROZEN})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n?e.onChannelFrozen&&e.onChannelFrozen(s):e.onChannelUnfrozen&&e.onChannelUnfrozen(s)}))}))));break}case c.ChannelEventCategory.CHANNEL_HIDE:{const s=yield this.getChannel(t.channelUrl,!0),{allowAutoUnhide:n,hidePreviousMessages:i,messageOffsetTimestamp:a}=e.as(me);null!==n&&(s.hiddenState=n?exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE:exports.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE),null!==i&&i&&s._updateUnreadCount(0,0),null!==a&&(s.messageOffsetTimestamp=a),this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_CHANNEL_HIDDEN})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onChannelHidden&&e.onChannelHidden(s)}))}))));break}case c.ChannelEventCategory.CHANNEL_UNHIDE:{const e=yield this.getChannel(t.channelUrl,!0);e.hiddenState=exports.HiddenState.UNHIDDEN,this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[e],source:u.GroupChannelEventSource.EVENT_CHANNEL_UNHIDDEN})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelChanged&&t.onChannelChanged(e)}))}))));break}case c.ChannelEventCategory.CHANNEL_DELETED:{const e=yield this.getChannel(t.channelUrl,!0);this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:[t.channelUrl],source:u.GroupChannelEventSource.EVENT_CHANNEL_DELETED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelDeleted&&t.onChannelDeleted(e.url,e.channelType)}))}))));break}case c.ChannelEventCategory.CHANNEL_PROP_CHANGED:{const e=yield this.getChannelWithoutCache(t.channelUrl,!0);this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[e],source:u.GroupChannelEventSource.EVENT_CHANNEL_UPDATED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelChanged&&t.onChannelChanged(e)}))}))));break}case c.ChannelEventCategory.CHANNEL_META_DATA_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{created:n,updated:i,deleted:a}=e.as(h.UpdateMetaDataEventCommand);n&&s._upsertCachedMetaData(n,t.ts),i&&s._upsertCachedMetaData(i,t.ts),a&&s._removeFromCachedMetaData(a,t.ts),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n&&e.onMetaDataCreated&&e.onMetaDataCreated(s,n),i&&e.onMetaDataUpdated&&e.onMetaDataUpdated(s,i),a&&e.onMetaDataDeleted&&e.onMetaDataDeleted(s,a)}))}))));break}case c.ChannelEventCategory.CHANNEL_META_COUNTERS_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{created:n,updated:i,deleted:a}=e.as(h.UpdateMetaCounterEventCommand);l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n&&e.onMetaCounterCreated&&e.onMetaCounterCreated(s,n),i&&e.onMetaCounterUpdated&&e.onMetaCounterUpdated(s,i),a&&e.onMetaCounterDeleted&&e.onMetaCounterDeleted(s,a)}))}))));break}case c.ChannelEventCategory.PINNED_MESSAGE_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{pinnedMessageIds:n,latestPinnedMessage:i,ts:a}=e.as(Se);a>s._pinnedMessagesUpdatedAt&&(s.pinnedMessageIds=n,s.lastPinnedMessage=i,s._pinnedMessagesUpdatedAt=a,this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:[s],source:u.GroupChannelEventSource.EVENT_PINNED_MESSAGE_UPDATED})),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)})))),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(s)}))})))));break}}break}case"USEV":{const{event:t}=e.as(u.UserEventCommand);switch(t.category){case u.UserEventCategory.USER_BLOCK:{const{blocker:e,blockee:s}=u.UserEvent.getDataAsUserBlockEvent(this._iid,t);this._groupChannelCache.block(e.userId,s.userId);break}case u.UserEventCategory.USER_UNBLOCK:{const{blocker:e,blockee:s}=u.UserEvent.getDataAsUserBlockEvent(this._iid,t);this._groupChannelCache.unblock(e.userId,s.userId);break}}break}}}catch(e){if(l.isThrowingOutside(e))throw e}}))}_markAsLeave(e){var t;const s=null!==(t=this._leftChannels.get(e.url))&&void 0!==t?t:{channel:e,ref:0};s.ref++,this._leftChannels.set(e.url,s),setTimeout((()=>{s.ref--,0===s.ref&&this._leftChannels.delete(e.url)}),1e4)}addHandler(e,t){this._groupChannelHandlers.set(e,t)}removeHandler(e){this._groupChannelHandlers.delete(e)}clearHandler(){this._groupChannelHandlers.clear()}subscribeGroupChannelEvent(e,t){this._groupChannelBroadcast.subscribe(e,t)}unsubscribeGroupChannelEvent(e){this._groupChannelBroadcast.unsubscribe(e)}subscribeMessageEvent(e,t){this._messageBroadcast.subscribe(e,t)}unsubscribeMessageEvent(e){this._messageBroadcast.unsubscribe(e)}_updateJoinedMemberCount(e){e.joinedMemberCount=e.members.filter((e=>e.state===exports.MemberState.JOINED)).length}getChannel(e,t=!1){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("string",e)).throw(l.SendbirdError.invalidParameters);try{const t=yield this.getChannelFromCache(e);if(t)return t}catch(e){}return yield this.getChannelWithoutCache(e,t)}))}getChannelWithoutCache(e,t=!1){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("string",e)).throw(l.SendbirdError.invalidParameters);const s=new x({channelUrl:e,isInternalCall:t}),n=yield this._requestQueue.send(s),{channel:i}=n.as(R);let{unreadMessageCount:a,unreadMentionCount:r}=i;switch(i.myCountPreference){case exports.CountPreference.UNREAD_MESSAGE_COUNT_ONLY:r=0;break;case exports.CountPreference.UNREAD_MENTION_COUNT_ONLY:a=0;break;case exports.CountPreference.OFF:a=0,r=0}return i._updateUnreadCount(a,r),(yield this.upsertChannelsToCache([i]))[0]}))}refreshChannel(e,t=!0,s=u.GroupChannelEventSource.REFRESH_CHANNEL){return l.__awaiter(this,void 0,void 0,(function*(){try{const n=new x({channelUrl:e,isInternalCall:t}),i=yield this._requestQueue.send(n),{channel:a}=i.as(R);if(a.myMemberState===exports.MemberState.NONE)this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:[a.url],source:s}));else{const e=yield this.upsertChannelsToCache([a]);this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:e,source:s}))}}catch(t){t.code!==l.SendbirdErrorCode.NON_AUTHORIZED&&t.code!==l.SendbirdErrorCode.NOT_FOUND_IN_DATABASE||this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:[e],source:s}))}}))}getMyGroupChannels(e,t,s,n=u.GroupChannelEventSource.REQUEST_CHANNEL){return l.__awaiter(this,void 0,void 0,(function*(){const i=new F(Object.assign(Object.assign({},t),{userId:this._sdkState.userId,token:e,limit:s})),a=yield this._requestQueue.send(i),{channels:r,token:o}=a.as(k);return this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:r,source:n})),{channels:r,token:o}}))}getMessageFromCache(e){var t;return l.__awaiter(this,void 0,void 0,(function*(){return null!==(t=yield this._messageCache.get(e))&&void 0!==t?t:null}))}_getExactlyMatchingMessagesForTokenFromCache(e,t,s){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.fetch({channelUrl:e,token:t,filter:s,exactMatch:!0})}))}getMessagesFromCache(e,t,s,n,i=h.DEFAULT_MESSAGE_LIMIT,a=!0){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.fetch({channelUrl:e,token:t,limit:i,filter:n,backward:"next"===s,inclusive:a})}))}getPollMessagesFromCache(e,t,s,n=h.DEFAULT_MESSAGE_LIMIT){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.fetch({channelUrl:e,token:t,limit:n,filter:s,backward:!1,isPollOnly:!0})}))}getUnsentMessagesFromCache(e,t){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._unsentMessageCache.fetch({channelUrl:e,filter:t})}))}removeFailedMessageFromCache(e){return l.__awaiter(this,void 0,void 0,(function*(){yield this._unsentMessageCache.remove([e])}))}getCachedMessageCountBetween(e,t,s,n){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.countBetween(e,t,new ye({top:s,bottom:n}))}))}getMyGroupChannelChangeLogs(e,t,s=u.GroupChannelEventSource.REQUEST_CHANNEL_CHANGELOGS){return l.__awaiter(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},M),t);l.unless((l.isTypeOf("string",e)||l.isTypeOf("number",e))&&y(n)).throw(l.SendbirdError.invalidParameters);const i=new P(l.undefineNullProps({userId:this._sdkState.userId,ts:"number"==typeof e?e:null,token:"string"==typeof e?e:null,filter:n})),a=(yield this._requestQueue.send(i)).as(w),{updatedChannels:r,deletedChannelUrls:o,hasMore:d,ts:h}=a;return r.length>0&&this._dispatcher.dispatch(new u.GroupChannelUpdateEventCommand({channels:r,source:s,ts:h})),o.length>0&&this._dispatcher.dispatch(new u.GroupChannelRemoveEventCommand({channelUrls:o,source:s})),{updatedChannels:r,deletedChannelUrls:o,hasMore:d,token:a.token}}))}getGroupChannelCount(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},S),e);l.unless(b(t)).throw(l.SendbirdError.invalidParameters);const s=new D({userId:this._sdkState.userId,filter:t}),n=yield this._requestQueue.send(s),{groupChannelCount:i}=n.as(G);return i}))}getUnreadItemCount(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},U),e);l.unless((e=>l.isArrayOf(exports.UnreadItemKey,e.keys))(t)).throw(l.SendbirdError.invalidParameters);const{sdkState:s,requestQueue:n}=l.Vault.of(this._iid),i=new H({userId:s.userId,filter:t}),a=yield n.send(i),{groupChannelUnreadMentionCount:r,groupChannelUnreadMessageCount:o,groupChannelInvitationCount:d,superGroupChannelUnreadMentionCount:h,superGroupChannelUnreadMessageCount:u,superGroupChannelInvitationCount:c,nonSuperGroupChannelUnreadMentionCount:_,nonSuperGroupChannelUnreadMessageCount:p,nonSuperGroupChannelInvitationCount:m}=a.as(V);return l.deundefined({groupChannelUnreadMentionCount:r,groupChannelUnreadMessageCount:o,groupChannelInvitationCount:d,superGroupChannelUnreadMentionCount:h,superGroupChannelUnreadMessageCount:u,superGroupChannelInvitationCount:c,nonSuperGroupChannelUnreadMentionCount:_,nonSuperGroupChannelUnreadMessageCount:p,nonSuperGroupChannelInvitationCount:m})}))}getTotalUnreadChannelCount(){return l.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=l.Vault.of(this._iid),s=new q({userId:e.userId}),n=yield t.send(s),{unreadCount:i}=n.as(j);return i}))}getTotalUnreadMessageCount(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},T),e);l.unless((e=>l.isArrayOf("string",e.channelCustomTypesFilter,!0)&&l.isEnumOf(exports.SuperChannelFilter,e.superChannelFilter))(t)).throw(l.SendbirdError.invalidParameters);const{sdkState:s,requestQueue:n}=l.Vault.of(this._iid),i=new B({userId:s.userId,filter:t}),a=yield n.send(i),{unreadCount:r}=a.as(W);return r}))}getTotalScheduledMessageCount(e={}){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},N),e);l.unless((e=>l.isTypeOf("string",e.channelUrl,!0)&&l.isArrayOf(_.ScheduledStatus,e.scheduledStatus,!0)&&l.isEnumOf(l.MessageTypeFilter,e.messageTypeFilter))(t)).throw(l.SendbirdError.invalidParameters);const{requestQueue:s}=l.Vault.of(this._iid),n=new $(t),i=yield s.send(n),{count:a}=i.as(z);return a}))}getSubscribedTotalUnreadMessageCount(){const{subscribedUnreadMessageCount:e}=l.Vault.of(this._iid);return e.all>=0?e.all:0}getSubscribedCustomTypeTotalUnreadMessageCount(){let e=0;const{subscribedUnreadMessageCount:t}=l.Vault.of(this._iid);for(const s in t.customTypes)e+=t.customTypes[s];return e}getSubscribedCustomTypeUnreadMessageCount(e){var t;const{subscribedUnreadMessageCount:s}=l.Vault.of(this._iid);return null!==(t=s.customTypes[e])&&void 0!==t?t:0}createChannel(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},E),e);l.unless(f(t)).throw(l.SendbirdError.invalidParameters),t.isPublic||(t.accessCode=void 0);const s=new K(Object.assign({userId:this._sdkState.userId},t)),n=yield this._requestQueue.send(s),{channel:i}=n.as(Y);return yield this.upsertChannelsToCache([i]),i}))}markAsReadAll(){return l.__awaiter(this,void 0,void 0,(function*(){const e=Date.now();l.unless(e-this._markAsReadAllLastSentAt>=1e3).throw(l.SendbirdError.markAsReadAllRateLimitExceeded),this._markAsReadAllLastSentAt=e;const t=new J({userId:this._sdkState.userId});yield this._requestQueue.send(t);const s=this._groupChannelCache.channels;for(const t of s)t._updateUnreadMemberState(this._sdkState.userId,e),t._updateUnreadCount(0,0);s.length>0&&(yield this.upsertChannelsToCache(s))}))}markAsReadWithChannelUrls(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Date.now();l.unless(l.isArrayOf("string",e)&&t-this._markAsReadAllLastSentAt>=1e3).throw(l.SendbirdError.markAsReadAllRateLimitExceeded),this._markAsReadAllLastSentAt=t;const s=new J({userId:this._sdkState.userId,channelUrls:e});yield this._requestQueue.send(s);const n=this._groupChannelCache.channels,i=[];for(const s of n)e.includes(s.url)&&(s._updateUnreadMemberState(this._sdkState.userId,t),s._updateUnreadCount(0,0),i.push(s));i.length>0&&(yield this.upsertChannelsToCache(i))}))}markAsDelivered(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=yield this.getChannel(e);yield t.markAsDelivered()}))}}var Ue;!function(e){e[e.IDLE=0]="IDLE",e[e.RUNNING=1]="RUNNING",e[e.END=2]="END"}(Ue||(Ue={}));class Te extends l.EventDispatcher{constructor(e,t,s=2,n=10){super(),this._state=Ue.IDLE,this._retryCount=0,this._retryLimit=3,this.priority=0,this._worker=t}get isIdle(){return this._state===Ue.IDLE}get isRunning(){return this._state===Ue.RUNNING}get isDone(){return this._state===Ue.END}get retryCount(){return this._retryCount}get retryLimit(){return this._retryLimit}_run(e){return l.__awaiter(this,void 0,void 0,(function*(){if(this.isRunning)try{const t=yield this._worker(e);this._retryCount=0,this.dispatch("progress",t),t.hasNext?this._run(t.nextToken):this.end()}catch(t){this.dispatch("error",t),this._retryCount<this._retryLimit?(this._retryCount++,this._run(e)):this.stop()}}))}start(e){this.isIdle&&(this._state=Ue.RUNNING,this._run(e))}stop(){this._state=Ue.IDLE,this.dispatch("stop")}end(){this._state=Ue.END,this.dispatch("end")}}class Ne{constructor(e){this.source=e}}class Ie{constructor(e){this.source=e}}const Oe={};class Pe{constructor({_iid:e,channel:t,limit:s=100}){this.ref=0,this._iid=e,this._channel=t,this._limit=s,this._prevSyncLoopCount=0,this._nextSyncLoopCount=0;const{sdkState:n,dispatcher:i,logger:a}=l.Vault.of(this._iid);var r,o;this._metadataKey=(r=n.userId,o=t.url,`sendbird:${r}@groupchannel/${o}/message/sync.meta`);const d=((e,t)=>`sendbird:${e}@groupchannel/${t}/message/sync`)(n.userId,t.url);this._prevSync=new Te(d,(e=>l.__awaiter(this,void 0,void 0,(function*(){var t,s,n,i,r;const o={hasNext:!0,nextToken:0};if(this._prevSyncLoopCount++,yield this.loadMetadata(e),a.debug("message background prev sync from",null===(t=this._metadata)||void 0===t?void 0:t.range.top),null===(s=this._metadata)||void 0===s?void 0:s.previousComplete)o.hasNext=!1;else try{const t=_.MessageManager.of(this._iid),s=yield t.getMessagesByTimestamp(this._channel.url,this._channel.channelType,(null===(i=null===(n=this._metadata)||void 0===n?void 0:n.range)||void 0===i?void 0:i.top)?this._metadata.range.top:e,{prevResultSize:this._limit,nextResultSize:0,replyType:l.ReplyType.ALL,includeReactions:!0,includeMetaArray:!0,includeParentMessageInfo:!0,includeThreadInfo:!0},l.MessageEventSource.SYNC_MESSAGE_BACKGROUND);if(s.length>0){const e=s.map((e=>e.createdAt));(null===(r=this._metadata)||void 0===r?void 0:r.range.intersect(...e))?this.extendRange(s):this._metadata={range:new ye({top:Math.min(...e),bottom:Math.max(...e)}),previousComplete:!1}}o.hasNext=s.length>=this._limit&&this._prevSyncLoopCount<1,this._metadata&&(o.nextToken=this._metadata.range.top,this._metadata.previousComplete=s.length<this._limit),a.debug("message background prev sync progress",o),yield this.saveMetadata()}catch(e){throw a.debug("message background prev sync error",e),e instanceof l.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return o})))),this._nextSync=new Te(d,(e=>l.__awaiter(this,void 0,void 0,(function*(){var t,s,n,i;const r={hasNext:!0,nextToken:0};this._nextSyncLoopCount++,yield this.loadMetadata(e),a.debug("message background next sync from",null===(t=this._metadata)||void 0===t?void 0:t.range.bottom);try{const t=_.MessageManager.of(this._iid),o=yield t.getMessagesByTimestamp(this._channel.url,this._channel.channelType,(null===(n=null===(s=this._metadata)||void 0===s?void 0:s.range)||void 0===n?void 0:n.bottom)?this._metadata.range.bottom:e,{prevResultSize:0,nextResultSize:this._limit,replyType:l.ReplyType.ALL,includeReactions:!0,includeMetaArray:!0,includeParentMessageInfo:!0,includeThreadInfo:!0},l.MessageEventSource.SYNC_MESSAGE_BACKGROUND);if(o.length>0){const e=o.map((e=>e.createdAt));(null===(i=this._metadata)||void 0===i?void 0:i.range.intersect(...e))?this.extendRange(o):this._metadata={range:new ye({top:Math.min(...e),bottom:Math.max(...e)}),previousComplete:!1}}r.hasNext=o.length>=this._limit&&this._nextSyncLoopCount<1,this._metadata&&(r.nextToken=this._metadata.range.bottom),a.debug("message background next sync progress",r),yield this.saveMetadata()}catch(e){throw a.debug("message background next sync error",e),e}return r})))),this._connectionEventContext=i.on((e=>{if(e instanceof l.ConnectionStateChangeCommand)if(e.stateType===l.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t){return Oe[e]||(Oe[e]={}),Oe[e][t.url]||(Oe[e][t.url]=new Pe({_iid:e,channel:t})),Oe[e][t.url].ref++,Oe[e][t.url]}static clear(e,t){Oe[e]&&Oe[e][t]&&(Oe[e][t].close(),delete Oe[e])}get range(){var e,t;return null!==(t=null===(e=this._metadata)||void 0===e?void 0:e.range)&&void 0!==t?t:new ye({})}get previousComplete(){var e;return!!(null===(e=this._metadata)||void 0===e?void 0:e.previousComplete)}isWrappingMessages(e){var t;return null===(t=this.range)||void 0===t?void 0:t.includes(...e.map((e=>e.createdAt)))}extendRange(e){this._metadata&&this._metadata.range.extends(...e.map((e=>e.createdAt)))}loadMetadata(e){return l.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:t}=l.Vault.of(this._iid),s=yield t.preference.get(this._metadataKey);s?s.range.bottom<e?this._metadata={range:new ye({}),previousComplete:!1}:this._metadata={range:new ye(s.range),previousComplete:s.previousComplete}:this._metadata={range:new ye({}),previousComplete:!1}}return this._metadata}))}saveMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=l.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=l.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(e=Date.now()){var t,s,n,i;const{logger:a,connectionManager:r}=l.Vault.of(this._iid);r.isConnected&&(a.debug("message background sync resume()"),this._prevSyncLoopCount=this._nextSyncLoopCount=0,this._metadata&&this._metadata.previousComplete||this._prevSync.start(null!==(s=null===(t=this._metadata)||void 0===t?void 0:t.range.top)&&void 0!==s?s:e),this._nextSync.start(null!==(i=null===(n=this._metadata)||void 0===n?void 0:n.range.bottom)&&void 0!==i?i:e))}pause(){const{logger:e}=l.Vault.of(this._iid);e.debug("message background sync stop()"),this._prevSync.stop(),this._nextSync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete Oe[this._iid][this._channel.url])}}const we={};class xe{constructor({_iid:e,channel:t}){this.ref=0,this._iid=e,this._channel=t;const{logger:s,sdkState:n,dispatcher:i}=l.Vault.of(this._iid);var a,r;this._metadataKey=(a=n.userId,r=t.url,`sendbird:${a}@groupchannel/${r}/message/changelogs.meta`);const o=((e,t)=>`sendbird:${e}@groupchannel/${t}/message/changelogs`)(n.userId,this._channel.url);this._sync=new Te(o,(()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const t={hasNext:!0,nextToken:0};yield this.loadMetadata(),s.debug("message changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token);try{const e=_.MessageManager.of(this._iid),{updatedMessages:n,deletedMessageIds:i,hasMore:a,token:r}=yield e.getMessageChangelogs(this._channel.url,this._channel.channelType,this._metadata.token,{replyType:l.ReplyType.ALL,includeReactions:!0,includeThreadInfo:!0,includeMetaArray:!0,includeParentMessageInfo:!0},l.MessageEventSource.SYNC_MESSAGE_CHANGELOGS);t.hasNext=a,t.nextToken=r,(n.length>0||i.length>0)&&this._metadata&&(this._metadata.token=r),s.debug("message changelog sync progress",t),yield this.saveMetadata()}catch(e){throw s.debug("message changelog sync error",e),e instanceof l.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return t})))),this._connectionEventContext=i.on((e=>{if(e instanceof l.ConnectionStateChangeCommand)if(e.stateType===l.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t){return we[e]||(we[e]={}),we[e][t.url]||(we[e][t.url]=new xe({_iid:e,channel:t})),we[e][t.url].ref++,we[e][t.url]}static clear(e,t){we[e]&&we[e][t]&&(we[e][t].close(),delete we[e])}loadMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e,firstConnectedAt:t}=l.Vault.of(this._iid),s=yield e.preference.get(this._metadataKey);this._metadata={token:s?s.token:t}}return this._metadata}))}saveMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=l.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=l.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{logger:e,connectionManager:t}=l.Vault.of(this._iid);t.isConnected&&(e.debug("message changelog sync resume()"),this._sync.start(0))}pause(){const{logger:e,connectionManager:t}=l.Vault.of(this._iid);e.debug("message changelog sync pause()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete we[this._iid][this._channel.url])}}const Re={};class Le{constructor({_iid:e,channel:t,hasPollMessage:s}){this.ref=0,this._iid=e,this._channel=t;const{logger:n,sdkState:i,dispatcher:a}=l.Vault.of(this._iid);var r,o;this._metadataKey=(r=i.userId,o=t.url,`sendbird:${r}@groupchannel/${o}/poll/changelogs.meta`);const d=((e,t)=>`sendbird:${e}@groupchannel/${t}/poll/changelogs`)(i.userId,this._channel.url);this._sync=new Te(d,(()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const t={hasNext:!0,nextToken:0};if(yield this.loadMetadata(),n.debug("poll changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token),!(this._metadata&&this._metadata.token||(yield s()))){return{hasNext:!1,nextToken:0}}if(!this._metadata){const{firstConnectedAt:e}=l.Vault.of(this._iid);this._metadata={token:e}}try{const e=p.PollManager.of(this._iid),{hasMore:s,token:i}=yield e.getPollChangeLogs(this._channel.url,this._channel.channelType,this._metadata.token);t.hasNext=s,t.nextToken=i,this._metadata.token=i,n.debug("poll changelog sync progress",t),yield this.saveMetadata()}catch(e){throw n.debug("poll changelog sync error",e),e instanceof l.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return t})))),this._connectionEventContext=a.on((e=>{if(e instanceof l.ConnectionStateChangeCommand)if(e.stateType===l.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t,s){return Re[e]||(Re[e]={}),Re[e][t.url]||(Re[e][t.url]=new Le({_iid:e,channel:t,hasPollMessage:s})),Re[e][t.url].ref++,Re[e][t.url]}loadMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e}=l.Vault.of(this._iid),t=yield e.preference.get(this._metadataKey);this._metadata=t?{token:t.token}:void 0}}))}saveMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=l.Vault.of(this._iid);yield e.preference.set(this._metadataKey,this._metadata)}}))}clearMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=l.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{logger:e}=l.Vault.of(this._iid);e.debug("poll changelog sync resume()"),this._sync.start(0)}pause(){const{logger:e}=l.Vault.of(this._iid);e.debug("poll changelog sync pause()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete Re[this._iid][this._channel.url])}}class Fe extends l.APIRequestCommand{constructor(e){var t,s,n,i,a,r;super(),this.method=l.APIRequestMethod.GET,this.path=`${l.getChannelApiPathByType(e.channelType)}/${e.channelUrl}/messages_gap`,this.params=l.deundefined({prev_start_ts:e.prevStart,prev_end_ts:e.prevEnd,prev_cache_count:e.prevCount,next_start_ts:e.nextStart,next_end_ts:e.nextEnd,next_cache_count:e.nextCount,huge_gap_threshold:null!==(t=e.threshold)&&void 0!==t?t:null,reverse:!0,custom_types:null!==(s=e.customTypes)&&void 0!==s?s:["*"],message_type:null!==(n=e.messageType)&&void 0!==n?n:null,include_reactions:null===(i=e.includeReactions)||void 0===i||i,with_sorted_meta_array:null===(a=e.includeMetaArray)||void 0===a||a,show_subchannel_messages_only:null!==(r=e.showSubchannelMessagesOnly)&&void 0!==r&&r,include_poll_details:!0,checking_continuous_messages:e.checkingContinuousMessages})}}class ke extends l.APIResponseCommand{constructor(e,t){var s,n,i,a,r,o;super(e,t),this.isHugeGap=t.is_huge_gap,this.prevMessages=(null!==(s=t.prev_messages)&&void 0!==s?s:[]).map((t=>_.parseMessagePayload(e,t))),this.prevHasMore=null!==(n=t.prev_hasmore)&&void 0!==n&&n,this.isContinuousPrevMessages=null!==(i=t.is_continuous_prev_messages)&&void 0!==i&&i,this.nextMessages=(null!==(a=t.next_messages)&&void 0!==a?a:[]).map((t=>_.parseMessagePayload(e,t))),this.nextHasmore=null!==(r=t.next_hasmore)&&void 0!==r&&r,this.isContinuousNextMessages=null!==(o=t.is_continuous_next_messages)&&void 0!==o&&o}}const De=(e,t)=>e.findIndex((e=>e.isIdentical(t))),Ge=(e,t,s)=>{if(e.length>0){const n=De(e,t);let i=0,a=e.length-1,r=Math.floor((i+a)/2);for(;i<a;){const o=He(e[r],t,s);if(o>0)a=r,r=Math.floor((i+a)/2);else{if(!(o<0))return{place:r,oldPosition:n};i=r+1,r=Math.floor((i+a)/2)}}return{place:He(e[r],t,s)>=0?r:r+1,oldPosition:n}}return{place:e.length,oldPosition:-1}},He=(e,t,s)=>{switch(s){case u.GroupChannelListOrder.LATEST_LAST_MESSAGE:return e.lastMessage&&t.lastMessage?t.lastMessage.createdAt-e.lastMessage.createdAt:e.lastMessage?-1:t.lastMessage?1:t.createdAt-e.createdAt;case u.GroupChannelListOrder.CHRONOLOGICAL:return t.createdAt-e.createdAt;case u.GroupChannelListOrder.CHANNEL_NAME_ALPHABETICAL:{const s=e.name.localeCompare(t.name);return 0===s?e.createdAt-t.createdAt:s}default:return 0}},Ve=(e,t)=>t instanceof _.SendableMessage?e.findIndex((e=>e instanceof _.SendableMessage&&t.isIdentical(e))):e.findIndex((e=>e.isIdentical(t))),qe=(e,t)=>e.findIndex((e=>e.messageId===t)),je=(e,t)=>{if(e.length>0){let s=0,n=e.length-1,i=Math.floor((s+n)/2);for(;s<n;){const a=e[i].createdAt-t.createdAt;if(a>0)n=i,i=Math.floor((s+n)/2);else{if(!(a<0))return i;s=i+1,i=Math.floor((s+n)/2)}}return e[i].createdAt>t.createdAt?i:i+1}return e.length},Be=6e5;exports.MessageCollectionInitPolicy=void 0,(exports.MessageCollectionInitPolicy||(exports.MessageCollectionInitPolicy={})).CACHE_AND_REPLACE_BY_API="cache_and_replace_by_api";class We{_invokeResponse(e,t,s){l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){switch(e){case"local":this._onCacheResult(t,s);break;case"remote":this._onApiResult(t,s)}}))))}onCacheResult(e){return this._onCacheResult=e,this}onApiResult(e){return this._onApiResult=e,this}}class $e{constructor(e,{channel:t,filter:s,startingPoint:n,limit:i}){this._messages=[],this._unsentMessages=[],this._iid=e,this._key=`mc-${l.uuid()}`,this._isDisposed=!1,this.filter=null!=s?s:new u.MessageFilter,this._channel=t,this._syncRange=new ye({}),this._hasPrevious=!0,this._hasNext=!0,this._startingPoint="number"==typeof n?n:Date.now()+Be,this._limit=i||h.DEFAULT_MESSAGE_LIMIT;const a=Ae.of(this._iid);a.subscribeGroupChannelEvent(this._key,{onUpdate:(e,t,s)=>{const n=De(e,this._channel);if(n>=0){switch(this._channel=e[n],t){case u.GroupChannelEventSource.EVENT_CHANNEL_UPDATED:{let e=!1;for(const t in this._messages){if(this._messages[t].createdAt>=this._channel.messageOffsetTimestamp){e=!0;const s=parseInt(t);if(s>0){const e=this._messages.splice(0,s);this._removeMessagesFromView(e.map((e=>e.messageId)),l.MessageEventSource.EVENT_MESSAGE_OFFSET_UPDATED)}break}}!e&&this._messages.length>0&&this._removeMessagesFromView(this._messages.map((e=>e.messageId)),l.MessageEventSource.EVENT_MESSAGE_OFFSET_UPDATED);break}case u.GroupChannelEventSource.EVENT_CHANNEL_UNMUTED:{const{sdkState:e}=l.Vault.of(this._iid),t=s;e.userId===t&&this._clearCheckMyMutedTimer();break}case u.GroupChannelEventSource.EVENT_CHANNEL_MUTED:{const{sdkState:e}=l.Vault.of(this._iid),t=s;e.userId===t&&-1!==this.channel._myMutedRemainingTime&&this._startCheckMyMutedTimer(this.channel._myMutedRemainingTime);break}case u.GroupChannelEventSource.EVENT_CHANNEL_LEFT:this.channel.isPublic&&this._clearCheckMyMutedTimer()}l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const s=new Ne(t);u.shouldGiveEvent(t)&&(null===(e=this._handler)||void 0===e?void 0:e.onChannelUpdated)&&this._handler.onChannelUpdated(s,this.channel)}))))}},onRemove:(e,t)=>{e.indexOf(this.channel.url)>=0&&(this._clearCheckMyMutedTimer(),l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const s=new Ne(t);(null===(e=this._handler)||void 0===e?void 0:e.onChannelDeleted)&&this._handler.onChannelDeleted(s,this.channel.url)})))))}}),a.subscribeMessageEvent(this._key,{onUpdate:(e,t)=>{const s=[],n=[];for(const t of e)t.channelUrl===this._channel.url&&(this.filter.match(t)?s.push(t):n.push(t.messageId));if(l.shouldGiveEvent(t)){if(s.length>0)switch(t){case l.MessageEventSource.LOCAL_MESSAGE_CANCELED:case l.MessageEventSource.LOCAL_MESSAGE_RESEND_STARTED:case l.MessageEventSource.EVENT_MESSAGE_SENT_FAILED:case l.MessageEventSource.EVENT_MESSAGE_SENT_SUCCESS:case l.MessageEventSource.EVENT_MESSAGE_UPDATED:case l.MessageEventSource.EVENT_MESSAGE_THREADINFO_UPDATED:case l.MessageEventSource.EVENT_MESSAGE_REACTION_UPDATED:case l.MessageEventSource.SYNC_MESSAGE_CHANGELOGS:this._updateMessagesToView(s,t);break;case l.MessageEventSource.EVENT_MESSAGE_SENT_PENDING:this._addMessagesToView(s,t);break;case l.MessageEventSource.EVENT_MESSAGE_RECEIVED:this.hasNext||this._addMessagesToView(s,t);break;case l.MessageEventSource.SYNC_MESSAGE_FILL:this._addMessagesToView(s,t)}n.length>0&&this._removeMessagesFromView(n,t)}},onRemove:(e,t)=>{this._removeMessagesFromView(e,t)},onRemoveUnsent:(e,t)=>{this._removeUnsentMessageFromView(e,t)},onPollChangeLogUpdate:(e,t)=>{this._updatePollsToView(e,t)},onPollUpdate:(e,t)=>{this._applyPollUpdateEventToView(e,t)},onPollVote:(e,t)=>{this._applyPollVoteEventToView(e,t)}});const{cacheContext:r,dispatcher:o,logger:d}=l.Vault.of(this._iid);this._channel._updateMessageCollectionLastAccessedAt(),o.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this._channel],source:u.GroupChannelEventSource.CHANNEL_LASTACCESSEDAT_UPDATED})),!this._channel.isSuper&&r.localCacheEnabled&&(this._backgroundSync=Pe.of(this._iid,this._channel),this._backgroundSync.resume(this._startingPoint)),this._changelogSync=xe.of(this._iid,this._channel),this._changelogSync.resume(),this._pollChangelogSync=Le.of(this._iid,this._channel,this._hasPollMessage.bind(this)),this._pollChangelogSync.resume(),this._prevFill=new Te(this._key,(e=>l.__awaiter(this,void 0,void 0,(function*(){var t;const{messages:s,isContinuousMessages:n}=yield this._getRemoteMessages(e,{prevLimit:this._limit,source:l.MessageEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:r.localCacheEnabled});if(s.length>0){const e=Math.min(...s.map((e=>e.createdAt)));return this._syncRange.extends(e),n&&(null===(t=this._backgroundSync)||void 0===t||t.range.extends(e)),{hasNext:s.length>=this._limit&&this.viewTop<e,nextToken:this._syncRange.top}}return{hasNext:!1,nextToken:0}})))),this._nextFill=new Te(this._key,(e=>l.__awaiter(this,void 0,void 0,(function*(){var t;const{messages:s,isContinuousMessages:n}=yield this._getRemoteMessages(e,{nextLimit:this._limit,source:l.MessageEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:r.localCacheEnabled});if(s.length>0){const e=Math.max(...s.map((e=>e.createdAt)));return this._syncRange.extends(e),n&&(null===(t=this._backgroundSync)||void 0===t||t.range.extends(e)),{hasNext:!(s.length>=this._limit&&this._hasNext)||this.viewBottom>e,nextToken:this._syncRange.bottom}}return{hasNext:!1,nextToken:0}})))),this._connectionEventContext=o.on((e=>{if(e instanceof l.ConnectionStateChangeCommand)switch(e.stateType){case l.ConnectionStateType.CONNECTED:this._refreshChannel(u.GroupChannelEventSource.SYNC_CHANNEL_CHANGELOGS),l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){const e=yield this.channel.getMyMutedInfo();e.isMuted&&-1!==e.remainingDuration&&this._startCheckMyMutedTimer(e.remainingDuration)})))),d.debug("check huge gap"),this._checkHugeGap();break;case l.ConnectionStateType.LOGOUT:this.dispose();break;default:this._clearCheckMyMutedTimer(),this._prevFill.stop(),this._nextFill.stop()}}));const{statLogCollector:c}=l.Vault.of(this._iid);c.put(new l.DailyRecordStatLog({type:l.StatType.FEATURE_LOCALCACHE,data:{use_local_cache:r.localCacheEnabled,collection_interface:{message:!0}}}))}get channel(){return this._channel}get succeededMessages(){return[...this._messages]}get failedMessages(){return this._unsentMessages.filter((e=>e.sendingStatus===l.SendingStatus.FAILED))}get pendingMessages(){return this._unsentMessages.filter((e=>e.sendingStatus===l.SendingStatus.PENDING))}get hasPrevious(){return this._hasPrevious}get hasNext(){return this._hasNext}get viewTop(){return Math.min(...this._messages.map((e=>e.createdAt)),Number.MAX_SAFE_INTEGER)}get viewBottom(){return Math.max(...this._messages.map((e=>e.createdAt)),0)}setMessageCollectionHandler(e){this._handler=e}_filterUnderOffsetMessage(e){return e}_addMessagesToView(e,t){const s=this._filterUnderOffsetMessage(e),n=[],i=[];for(const e of s)if(t===l.MessageEventSource.SYNC_MESSAGE_FILL){if(e.messageId>0){if(Ve(this._messages,e)<0){Ve(this._unsentMessages,e)<0&&n.push(e);const t=je(this._messages,e);this._messages.splice(t,0,e)}}else if(e instanceof _.SendableMessage){Ve(this._unsentMessages,e)<0&&Ve(this._messages,e)<0&&(this._unsentMessages.push(e),n.push(e))}}else if(e.messageId>0){const t=Ve(this._messages,e);if(t<0){const t=Ve(this._unsentMessages,e);t<0?n.push(e):(this._unsentMessages.splice(t,1),i.push(e));const s=je(this._messages,e);this._messages.splice(s,0,e)}else i.push(e),this._messages[t]=e;if(e.updatedAt>0){const t=this._updateChildMessagesInView(e);i.push(...t)}}else if(e instanceof _.SendableMessage){const t=Ve(this._unsentMessages,e);t<0?Ve(this._messages,e)<0&&(this._unsentMessages.push(e),n.push(e)):(i.push(e),this._unsentMessages[t]=e)}l.shouldGiveEvent(t)&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e,s;const a=new Ie(t);n.length>0&&(null===(e=this._handler)||void 0===e?void 0:e.onMessagesAdded)&&this._handler.onMessagesAdded(a,this.channel,n),i.length>0&&(null===(s=this._handler)||void 0===s?void 0:s.onMessagesUpdated)&&this._handler.onMessagesUpdated(a,this.channel,i)}))))}_updateChildMessagesInView(e){const t=[];return this._messages.forEach((s=>{s.parentMessageId===e.messageId&&s.applyParentMessage(e)&&t.push(s)})),t}_updatePollsToView(e,t){const s=[];for(const t of e){const e=qe(this._messages,t.messageId);if(e>=0){const n=this._messages[e];n&&n.applyPoll(t),s.push(n)}}return s.length>0&&l.shouldGiveEvent(t)&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const n=new Ie(t);s.length>0&&(null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)&&this._handler.onMessagesUpdated(n,this.channel,s)})))),s}_applyPollUpdateEventToView(e,t){const s=qe(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&n.isUserMessage()&&n.poll&&n.poll.applyPollUpdateEvent(e)&&l.shouldGiveEvent(t)&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const s=new Ie(t);(null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)&&this._handler.onMessagesUpdated(s,this.channel,[n])}))))}}_applyPollVoteEventToView(e,t){const s=qe(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&n.isUserMessage()&&n.poll&&n.poll.applyPollVoteEvent(e)&&l.shouldGiveEvent(t)&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const s=new Ie(t);(null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)&&this._handler.onMessagesUpdated(s,this.channel,[n])}))))}}_updateMessagesToView(e,t){const s=[],n=[],i=[];for(const t of e)if(t.messageId>0){const e=Ve(this._messages,t);if(e>=0)n.push(t),this._messages[e]=t;else{const e=Ve(this._unsentMessages,t);if(e>=0){const s=this._unsentMessages.splice(e,1);if(this.hasNext&&s.length>0)i.push(s[0]);else{n.push(t);const e=je(this._messages,t);this._messages.splice(e,0,t)}}else{const e=this._messages.map((e=>e.createdAt));(t.createdAt<Math.min(...e)&&!this._hasPrevious||t.createdAt>Math.max(...e)&&!this._hasNext)&&s.push(t)}}}else if(t instanceof _.SendableMessage){const e=Ve(this._unsentMessages,t);e>=0&&(n.push(t),this._unsentMessages[e]=t)}return l.shouldGiveEvent(t)&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e,a;const r=new Ie(t);n.length>0&&(null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)?this._handler.onMessagesUpdated(r,this.channel,n):i.length>0&&(null===(a=this._handler)||void 0===a?void 0:a.onMessagesDeleted)?this._handler.onMessagesDeleted(r,this.channel,[],i):s.length>0&&this._addMessagesToView(s,t)})))),n}_removeMessagesFromView(e,t){const s=[],n=[];for(const t of e){const e=this._messages.findIndex((e=>e.messageId===t));if(e>=0){const t=this._messages[e];s.push(t.messageId),n.push(t),this._messages.splice(e,1)}}return l.shouldGiveEvent(t)&&n.length>0&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;if(null===(e=this._handler)||void 0===e?void 0:e.onMessagesDeleted){const e=new Ie(t);this._handler.onMessagesDeleted(e,this.channel,s,n)}})))),s}_removeUnsentMessageFromView(e,t){const s=this._unsentMessages.findIndex((t=>t.reqId===e));s>=0&&this._unsentMessages.splice(s,1)}_getLocalMessages(e,{prevLimit:t=0,nextLimit:s=0,inclusive:n=!0}){return l.__awaiter(this,void 0,void 0,(function*(){const i=Ae.of(this._iid);let a=[];n&&(a=yield i._getExactlyMatchingMessagesForTokenFromCache(this._channel.url,e,this.filter));const r=t>0?yield i.getMessagesFromCache(this._channel.url,e,"prev",this.filter,t,!1):[],o=s>0?yield i.getMessagesFromCache(this._channel.url,e,"next",this.filter,s,!1):[];return[...a,...r,...o].sort(((e,t)=>t.createdAt-e.createdAt))}))}_getRemoteMessages(e,{prevLimit:t=0,nextLimit:s=0,source:n=l.MessageEventSource.REQUEST_MESSAGE,reverse:i=!1,checkingContinuousMessages:a=!1}){return l.__awaiter(this,void 0,void 0,(function*(){const r=_.MessageManager.of(this._iid);return t>0||s>0?yield r._getMessagesByTimestampForCollection(this._channel.url,this._channel.channelType,e,l.undefineNullProps(Object.assign(Object.assign({},this.filter),{isInclusive:!0,reverse:i,prevResultSize:t,nextResultSize:s,includeMetaArray:!0,includeReactions:!0,includeThreadInfo:!0,includeParentMessageInfo:!0})),n,a):{messages:[],isContinuousMessages:!1}}))}_checkHugeGap(){var e;return l.__awaiter(this,void 0,void 0,(function*(){if(this._messages.length>0){const e=this._syncRange.top,t=this.viewTop,s=this._syncRange.bottom,n=this.hasNext?this.viewBottom:Number.MAX_SAFE_INTEGER,i=Ae.of(this._iid),a=yield i.getCachedMessageCountBetween(this._channel.url,this.filter,t,e),r=yield i.getCachedMessageCountBetween(this._channel.url,this.filter,s,n);yield l.asyncRetry((()=>l.__awaiter(this,void 0,void 0,(function*(){var i;const{dispatcher:o,requestQueue:d,cacheContext:h}=l.Vault.of(this._iid),u=new Fe(Object.assign({channelUrl:this._channel.url,channelType:this._channel.channelType,prevStart:t,prevEnd:e,prevCount:a,nextStart:s,nextEnd:n,nextCount:r,checkingContinuousMessages:h.localCacheEnabled},this.filter)),c=yield d.send(u),{isHugeGap:_,prevMessages:p=[],prevHasMore:m,isContinuousPrevMessages:g,nextMessages:C=[],nextHasmore:v,isContinuousNextMessages:E}=c.as(ke);if(_)l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;(null===(e=this._handler)||void 0===e?void 0:e.onHugeGapDetected)&&this._handler.onHugeGapDetected()}))));else{const e=this.viewTop,t=this.viewBottom,s=Math.min(Number.MAX_SAFE_INTEGER,e,...p.map((e=>e.createdAt))),n=Math.max(0,t,...C.map((e=>e.createdAt)));o.dispatch(new l.MessageUpdateEventCommand({messages:p,source:l.MessageEventSource.SYNC_MESSAGE_FILL})),o.dispatch(new l.MessageUpdateEventCommand({messages:C,source:l.MessageEventSource.SYNC_MESSAGE_FILL})),this._syncRange.extends(s,n),(g||E)&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(s,n)),m&&this._prevFill.start(s),v&&this._nextFill.start(n)}}))),1)}else{const{cacheContext:t}=l.Vault.of(this._iid),s=Math.floor(this._limit/2),n=Date.now();try{const{messages:i,isContinuousMessages:a}=yield this._getRemoteMessages(n,{prevLimit:s,nextLimit:s,source:l.MessageEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:t.localCacheEnabled});if(i.length>0){const t=i.map((e=>e.createdAt));let r=0,o=0;for(let e=0;e<t.length;e++){const s=t[e];s<=n?r++:s>=n&&o++}this._hasPrevious=r>=s,this._hasNext=o>=s,this._syncRange.extends(...t),a&&(null===(e=this._backgroundSync)||void 0===e||e.range.extends(this._syncRange.top,this._syncRange.bottom)),this._addMessagesToView(i,l.MessageEventSource.SYNC_MESSAGE_FILL)}else this._hasPrevious=!1,this._hasNext=!1}catch(e){e instanceof l.SendbirdError&&e.code===l.SendbirdErrorCode.NOT_FOUND_IN_DATABASE&&(this._hasPrevious=!1,this._hasNext=!1)}}}))}_loadUnsentMessages(){return l.__awaiter(this,void 0,void 0,(function*(){const e=Ae.of(this._iid);this._unsentMessages=yield e.getUnsentMessagesFromCache(this._channel.url,this.filter)}))}_hasPollMessage(){return l.__awaiter(this,void 0,void 0,(function*(){const e=Ae.of(this._iid);return(yield e.getPollMessagesFromCache(this._channel.url,Date.now()+Be,this.filter,1)).length>0}))}_refreshChannel(e){Ae.of(this._iid).refreshChannel(this.channel.url,!0,e)}_startCheckMyMutedTimer(e){this._clearCheckMyMutedTimer(),this._checkMyMutedStateTimer=setTimeout((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;this._checkMyMutedStateTimer=void 0;let t=!0;try{t=!(yield this._channel.getMyMutedInfo()).isMuted}catch(e){t=!0}finally{if(t&&(this.channel.myMutedState=exports.MutedState.UNMUTED,null===(e=this._handler)||void 0===e?void 0:e.onChannelUpdated)){const e=new Ne(u.GroupChannelEventSource.EVENT_CHANNEL_UNMUTED);this._handler.onChannelUpdated(e,this.channel)}}}))),e+1e3)}_clearCheckMyMutedTimer(){this._checkMyMutedStateTimer&&(clearTimeout(this._checkMyMutedStateTimer),this._checkMyMutedStateTimer=void 0)}initialize(e){const t=new We;this._messages=[],this._unsentMessages=[],this._syncRange=new ye({}),this._hasNext=!0,this._hasPrevious=!0,this._refreshChannel(u.GroupChannelEventSource.REFRESH_CHANNEL),l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){const e=yield this.channel.getMyMutedInfo();e.isMuted&&-1!==e.remainingDuration&&this._startCheckMyMutedTimer(e.remainingDuration)}))));const s=Math.floor(this._limit/2);if(e===exports.MessageCollectionInitPolicy.CACHE_AND_REPLACE_BY_API)this._getLocalMessages(this._startingPoint,{prevLimit:s,nextLimit:s}).then((e=>l.__awaiter(this,void 0,void 0,(function*(){const s=this._filterUnderOffsetMessage(e);this._addMessagesToView(s,l.MessageEventSource.REQUEST_MESSAGE),yield this._loadUnsentMessages(),t._invokeResponse("local",null,s)})))).catch((e=>{if(l.isThrowingOutside(e))throw e;t._invokeResponse("local",e,null)})).finally((()=>{const{cacheContext:e}=l.Vault.of(this._iid);this._getRemoteMessages(this._startingPoint,{prevLimit:s,nextLimit:s,reverse:!0,checkingContinuousMessages:e.localCacheEnabled}).then((({messages:e,isContinuousMessages:n})=>{var i;this._messages=[];const a=this._filterUnderOffsetMessage(e);if(a.length>0){const e=a.map((e=>e.createdAt));let t=0,r=0;for(let s=0;s<e.length;s++){const n=e[s];n<this._startingPoint?t++:n>this._startingPoint&&r++}this._hasPrevious=t>=s,this._hasNext=r>=s,this._syncRange.extends(...a.map((e=>e.createdAt))),n&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(this._syncRange.top,this._syncRange.bottom)),this._addMessagesToView(a,l.MessageEventSource.REQUEST_MESSAGE)}else this._hasPrevious=!1,this._hasNext=!1;t._invokeResponse("remote",null,a)})).catch((e=>{if(l.isThrowingOutside(e))throw e;t._invokeResponse("remote",e,null)}))}));const{cacheContext:n,statLogCollector:i}=l.Vault.of(this._iid);return i.put(new l.DailyRecordStatLog({type:l.StatType.FEATURE_LOCALCACHE,data:{use_local_cache:n.localCacheEnabled,collection_interface:{message_init_policy:e}}})),t}loadPrevious(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new l.SendbirdError({code:l.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});if(!this._hasPrevious)return[];const e=Math.floor(this._limit/2),t=this.viewTop;let s=[];return yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){s=this._filterUnderOffsetMessage(yield this._getLocalMessages(t,{prevLimit:e,inclusive:!1}))})))),s.length<e||!this._backgroundSync||!this._backgroundSync.isWrappingMessages(s)?(yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){var n,i;const{cacheContext:a}=l.Vault.of(this._iid),r=yield this._getRemoteMessages(t,{prevLimit:e,reverse:!0,checkingContinuousMessages:a.localCacheEnabled});s=this._filterUnderOffsetMessage(r.messages),s=s.filter((e=>Ve(this._messages,e)<0)),this._hasPrevious=s.length>=e,s.length>0&&(this._syncRange.extends(...s.map((e=>e.createdAt))),(null===(n=this._backgroundSync)||void 0===n?void 0:n.range.overlap(this._syncRange))&&r.isContinuousMessages&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(this._syncRange.top)))})))),this._addMessagesToView(s,l.MessageEventSource.REQUEST_MESSAGE)):(this._hasPrevious=s.length>=e,s.length>0&&this._addMessagesToView(s,l.MessageEventSource.REQUEST_MESSAGE)),s}))}loadNext(){var e;return l.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new l.SendbirdError({code:l.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});if(!this._hasNext)return[];const t=Math.floor(this._limit/2),s=this.viewBottom;let n=[];return yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){n=this._filterUnderOffsetMessage(yield this._getLocalMessages(s,{nextLimit:t,inclusive:!1}))})))),n.length<t||!(null===(e=this._backgroundSync)||void 0===e?void 0:e.isWrappingMessages(n))?(yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){var e,i;const{cacheContext:a}=l.Vault.of(this._iid),r=yield this._getRemoteMessages(s,{nextLimit:t,reverse:!0,checkingContinuousMessages:a.localCacheEnabled});n=this._filterUnderOffsetMessage(r.messages),n=n.filter((e=>Ve(this._messages,e)<0)),this._hasNext=n.length>=t,n.length>0&&(this._syncRange.extends(...n.map((e=>e.createdAt))),(null===(e=this._backgroundSync)||void 0===e?void 0:e.range.overlap(this._syncRange))&&r.isContinuousMessages&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(this._syncRange.bottom)))})))),this._addMessagesToView(n,l.MessageEventSource.REQUEST_MESSAGE)):(this._hasNext=n.length>=t,n.length>0&&this._addMessagesToView(n,l.MessageEventSource.REQUEST_MESSAGE)),n}))}removeFailedMessage(e){return l.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new l.SendbirdError({code:l.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});const t=Ae.of(this._iid);yield t.removeFailedMessageFromCache(e);const s=this._unsentMessages.findIndex((t=>t.reqId===e));s>-1&&this._unsentMessages.splice(s,1)}))}dispose(){var e,t,s;if(this._isDisposed)return;this._isDisposed=!0;const{cacheContext:n,dispatcher:i}=l.Vault.of(this._iid);this._messages=[],this._clearCheckMyMutedTimer(),this._channel._updateMessageCollectionLastAccessedAt(),i.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this._channel],source:u.GroupChannelEventSource.CHANNEL_LASTACCESSEDAT_UPDATED})),n.localCacheEnabled&&(this._prevFill.stop(),this._nextFill.stop()),null===(e=this._backgroundSync)||void 0===e||e.close(),null===(t=this._changelogSync)||void 0===t||t.close(),null===(s=this._pollChangelogSync)||void 0===s||s.close();const a=Ae.of(this._iid);a.unsubscribeGroupChannelEvent(this._key),a.unsubscribeMessageEvent(this._key),this._connectionEventContext&&this._connectionEventContext.close()}}const ze={coverUrl:void 0,coverImage:void 0,isDistinct:void 0,isPublic:void 0,isDiscoverable:void 0,accessCode:void 0,name:void 0,data:void 0,customType:void 0,operatorUserIds:void 0,messageSurvivalSeconds:void 0};class Qe extends l.APIRequestCommand{constructor(e){const{channelUrl:t,token:s,limit:n,order:i,mutedMemberFilter:a,memberStateFilter:r,nicknameStartsWithFilter:o,operatorFilter:d}=e;super(),this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/members`,this.params={token:s,limit:n,order:i,muted_member_filter:a,member_state_filter:r,nickname_startswith:o,operator_filter:d,show_member_is_muted:!0,show_read_receipt:!0,show_delivery_receipt:!0}}}class Ke extends l.APIResponseCommand{constructor(e,t){super(e,t),this.members=[];const{next:s,members:n}=t;this.token=s,n&&n.length>0&&(this.members=n.map((t=>new m(e,t))))}}var Ye,Je,Xe;exports.MutedMemberFilter=void 0,(Ye=exports.MutedMemberFilter||(exports.MutedMemberFilter={})).ALL="all",Ye.MUTED="muted",Ye.UNMUTED="unmuted",exports.MemberListOrder=void 0,(Je=exports.MemberListOrder||(exports.MemberListOrder={})).MEMBER_NICKNAME_ALPHABETICAL="member_nickname_alphabetical",Je.OPERATOR_THEN_MEMBER_ALPHABETICAL="operator_then_member_alphabetical",exports.MemberStateFilter=void 0,(Xe=exports.MemberStateFilter||(exports.MemberStateFilter={})).ALL="all",Xe.JOINED="joined_only",Xe.INVITED="invited_only",Xe.INVITED_BY_FRIEND="invited_by_friend",Xe.INVITED_BY_NON_FRIEND="invited_by_non_friend";class Ze extends l.ChannelDataListQuery{constructor(e,t,s){var n,i,a,r;super(e,t,l.ChannelType.GROUP,s),this.mutedMemberFilter=exports.MutedMemberFilter.ALL,this.memberStateFilter=exports.MemberStateFilter.ALL,this.nicknameStartsWithFilter=null,this.operatorFilter=exports.OperatorFilter.ALL,this.order=exports.MemberListOrder.MEMBER_NICKNAME_ALPHABETICAL,this.mutedMemberFilter=null!==(n=s.mutedMemberFilter)&&void 0!==n?n:exports.MutedMemberFilter.ALL,this.memberStateFilter=null!==(i=s.memberStateFilter)&&void 0!==i?i:exports.MemberStateFilter.ALL,this.nicknameStartsWithFilter=null!==(a=s.nicknameStartsWithFilter)&&void 0!==a?a:null,this.order=null!==(r=s.order)&&void 0!==r?r:exports.MemberListOrder.MEMBER_NICKNAME_ALPHABETICAL}_validate(){return super._validate()&&l.isEnumOf(exports.MutedMemberFilter,this.mutedMemberFilter)&&l.isEnumOf(exports.MemberStateFilter,this.memberStateFilter)&&(l.isTypeOf("string",this.nicknameStartsWithFilter)||null===this.nicknameStartsWithFilter)&&l.isEnumOf(exports.OperatorFilter,this.operatorFilter)&&l.isEnumOf(exports.MemberListOrder,this.order)}next(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw l.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=l.Vault.of(this._iid),t=new Qe(l.undefineNullProps(Object.assign(Object.assign({},this),{token:this._token}))),s=yield e.send(t),{members:n,token:i}=s.as(Ke);return this._token=i,this._hasNext=!!i,this._isLoading=!1,n}return[]}throw l.SendbirdError.invalidParameters}))}}class et extends l.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,accessCode:n}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/accept`,this.params={user_id:s,access_code:n}}}class tt extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Ot(e,t),this.channel.myMemberState=exports.MemberState.JOINED}}class st extends l.APIRequestCommand{constructor(e){const{channelUrl:t,isDistinct:s,isPublic:n,isDiscoverable:i,coverUrl:a,coverImage:r,accessCode:o,name:d,data:h,customType:u,operatorUserIds:c,messageSurvivalSeconds:_}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}`,this.params=l.deundefined({is_distinct:s,is_public:n,is_discoverable:i,name:d,data:h,custom_type:u,cover_url:a,cover_file:r,access_code:o,operator_ids:c,message_survival_seconds:_})}}class nt extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Ot(e,t)}}class it extends l.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=l.APIRequestMethod.DELETE,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}`}}class at extends l.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=l.APIRequestMethod.DELETE,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/hide`}}class rt extends l.APIRequestCommand{constructor({userId:e,channelUrl:t,countPreference:s}){super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/count_preference/${encodeURIComponent(t)}`,this.params={count_preference:s}}}class ot extends l.APIResponseCommand{constructor(e,t){super(e,t),this.countPreference=t.count_preference}}class dt extends l.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/reset_user_history`}}class lt extends l.APIResponseCommand{constructor(e,t){super(e,t);const{ts_message_offset:s}=t;this.messageOffsetTimestamp=s}}const ht=Object.assign(Object.assign({},h.BaseMessageUpdateParamsDefault),{scheduledAt:void 0,file:void 0,fileUrl:void 0,fileName:void 0,mimeType:void 0,fileSize:void 0,thumbnailSizes:void 0,requireAuth:!1}),ut=Object.assign(Object.assign({},h.UserMessageUpdateParamsDefault),{scheduledAt:void 0});class ct extends l.APIRequestCommand{constructor(e){var t;super();let s=[];e.mentionType===l.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:i,scheduledMessageId:a}=e;this.method=l.APIRequestMethod.PUT,this.path=`${l.getChannelApiPathByType(n)}/${encodeURIComponent(i)}/scheduled_messages/${encodeURIComponent(a)}`,this.params=l.deundefined(l.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:l.ServerSideMessageType.FILE,url:e.fileUrl,file_name:e.fileName,file_size:e.fileSize,file_type:e.mimeType,thumbnails:e.thumbnailSizes?e.thumbnailSizes.map((e=>_.Thumbnail.payloadify(e))):[],custom_type:e.customType,data:e.data,require_auth:e.requireAuth,mention_type:e.mentionType,mentioned_user_ids:s,sorted_metaarray:null===(t=e.metaArrays)||void 0===t?void 0:t.map((e=>_.MessageMetaArray.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?_.AppleCriticalAlertOptions.payloadify(e.appleCriticalAlertOptions):null,push_option:e.pushNotificationDeliveryOption}))}}class _t extends l.APIResponseCommand{constructor(e,t){super(e,t),this.message=new _.FileMessage(e,t)}}class pt extends l.APIRequestCommand{constructor(e){var t;super();let s=[];e.mentionType===l.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:i,scheduledMessageId:a}=e;this.method=l.APIRequestMethod.PUT,this.path=`${l.getChannelApiPathByType(n)}/${encodeURIComponent(i)}/scheduled_messages/${encodeURIComponent(a)}`,this.params=l.deundefined(l.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:l.ServerSideMessageType.USER,message:e.message,custom_type:e.customType,data:e.data,mention_type:e.mentionType,mentioned_user_ids:s,sorted_metaarray:null===(t=e.metaArrays)||void 0===t?void 0:t.map((e=>_.MessageMetaArray.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?_.AppleCriticalAlertOptions.payloadify(e.appleCriticalAlertOptions):null,target_langs:e.translationTargetLanguages,push_option:e.pushNotificationDeliveryOption}))}}class mt extends l.APIRequestCommand{constructor(e){super();const{channelType:t,channelUrl:s,scheduledMessageId:n}=e;this.method=l.APIRequestMethod.DELETE,this.path=`${l.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/scheduled_messages/${encodeURIComponent(n)}`}}class gt extends l.APIRequestCommand{constructor(e){super();const{channelType:t,channelUrl:s,scheduledMessageId:n}=e;this.method=l.APIRequestMethod.POST,this.path=`${l.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/scheduled_messages/${encodeURIComponent(n)}/send_now`}}class Ct extends l.APIRequestCommand{constructor({userId:e,channelUrl:t,pushTriggerOption:s}){super(),this.method=l.APIRequestMethod.PUT,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/push_preference/${encodeURIComponent(t)}`,this.params={push_trigger_option:s}}}class vt extends l.APIResponseCommand{constructor(e,t){super(e,t),this.pushTriggerOption=t.push_trigger_option,this.enabled=t.enable}}class Et extends l.APIRequestCommand{constructor({userId:e,channelUrl:t}){super(),this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_USERS}/${encodeURIComponent(e)}/push_preference/${encodeURIComponent(t)}`}}class ft extends l.APIResponseCommand{constructor(e,t){super(e,t),this.pushTriggerOption=t.push_trigger_option,this.enabled=t.enable}}class Mt extends l.APIRequestCommand{constructor({channelType:e,channelUrl:t,messageId:s}){super(),this.method=l.APIRequestMethod.POST,this.path=`${l.getChannelApiPathByType(e)}/${encodeURIComponent(t)}/messages/${s}/pin`}}class yt extends l.APIRequestCommand{constructor({channelType:e,channelUrl:t,messageId:s}){super(),this.method=l.APIRequestMethod.DELETE,this.path=`${l.getChannelApiPathByType(e)}/${encodeURIComponent(t)}/messages/${s}/pin`}}class St extends l.InstancedObject{constructor(e,t){super(e),this.message=_.parseMessagePayload(e,t.message)}}class bt extends l.APIRequestCommand{constructor(e){const{channelType:t,channelUrl:s,limit:n,token:i,includeReactions:a,includeMetaArray:r,includeParentMessageInfo:o,includeThreadInfo:d,includePollDetails:h}=e;super(),this.method=l.APIRequestMethod.GET,this.path=`${l.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/pinned_messages`,this.params=l.deundefined({limit:n,token:i,include_reactions:a,with_sorted_meta_array:r,include_thread_info:d,include_parent_message_info:o,include_poll_details:h})}}class At extends l.APIResponseCommand{constructor(e,t){super(e,t);const{pinned_messages:s,has_more:n,next:i}=t;this.pinnedMessages=s.map((t=>new St(e,t))),this.hasMore=n,this.token=i}}class Ut extends l.ChannelDataListQuery{constructor(e,t,s,n){super(e,t,s,n),this.includeMetaArray=n.includeMetaArray,this.includeReactions=n.includeReactions,this.includeParentMessageInfo=n.includeParentMessageInfo,this.includeThreadInfo=n.includeThreadInfo,this.includePollDetails=n.includePollDetails}_validate(){return super._validate()&&l.isTypeOf("boolean",this.includeMetaArray,!0)&&l.isTypeOf("boolean",this.includeReactions,!0)&&l.isTypeOf("boolean",this.includeParentMessageInfo,!0)&&l.isTypeOf("boolean",this.includeThreadInfo,!0)&&l.isTypeOf("boolean",this.includePollDetails,!0)}next(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw l.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=l.Vault.of(this._iid),t=new bt(Object.assign(Object.assign({},this),{token:this._token})),s=yield e.send(t),{pinnedMessages:n,hasMore:i,token:a}=s.as(At);return this._token=a,this._hasNext=!!i,this._isLoading=!1,n}return[]}throw l.SendbirdError.invalidParameters}))}}var Tt,Nt,It;exports.CountPreference=void 0,(Tt=exports.CountPreference||(exports.CountPreference={})).ALL="all",Tt.UNREAD_MESSAGE_COUNT_ONLY="unread_message_count_only",Tt.UNREAD_MENTION_COUNT_ONLY="unread_mention_count_only",Tt.OFF="off",exports.MutedState=void 0,(Nt=exports.MutedState||(exports.MutedState={})).MUTED="muted",Nt.UNMUTED="unmuted",exports.HiddenState=void 0,(It=exports.HiddenState||(exports.HiddenState={})).UNHIDDEN="unhidden",It.HIDDEN_ALLOW_AUTO_UNHIDE="hidden_allow_auto_unhide",It.HIDDEN_PREVENT_AUTO_UNHIDE="hidden_prevent_auto_unhide";class Ot extends h.BaseChannel{constructor(e,t){var s,n,i,a,r,o,d,h,u,c,p,g,C,v,E,f,M,y;super(e,t),this._unreadMemberStateMap=new Map,this._undeliveredMemberStateMap=new Map,this._typingStatus=new Map,this._lastMemberCountUpdated=0,this._typingStarted=0,this._typingEnded=0,this.isDistinct=!1,this.isSuper=!1,this.isBroadcast=!1,this.isExclusive=!1,this.isPublic=!1,this.isDiscoverable=!0,this.isAccessCodeRequired=!1,this.isPushEnabled=!1,this.unreadMessageCount=0,this.unreadMentionCount=0,this.members=[],this.memberCount=0,this.joinedMemberCount=0,this.hiddenState=exports.HiddenState.UNHIDDEN,this.lastMessage=null,this.messageOffsetTimestamp=0,this.messageSurvivalSeconds=-1,this.myMemberState=exports.MemberState.NONE,this.myRole=l.Role.NONE,this.myMutedState=exports.MutedState.UNMUTED,this.myLastRead=0,this.myCountPreference=exports.CountPreference.ALL,this.myPushTriggerOption=l.PushTriggerOption.DEFAULT,this.inviter=null,this.invitedAt=0,this.joinedAt=0,this.pinnedMessageIds=[],this.lastPinnedMessage=null,this._pinnedMessagesUpdatedAt=0,this._myMutedRemainingTime=-1,this.channelType=l.ChannelType.GROUP,this.isDistinct=null!==(s=t.is_distinct)&&void 0!==s&&s,this.isSuper=null!==(n=t.is_super)&&void 0!==n&&n,this.isBroadcast=null!==(i=t.is_broadcast)&&void 0!==i&&i,this.isExclusive=null!==(a=t.is_exclusive)&&void 0!==a&&a,this.isPublic=null!==(r=t.is_public)&&void 0!==r&&r,this.isDiscoverable=null!==(o=t.is_discoverable)&&void 0!==o?o:this.isPublic,this.isAccessCodeRequired=null!==(d=t.is_access_code_required)&&void 0!==d&&d,this.isPushEnabled=null!==(h=t.is_push_enabled)&&void 0!==h&&h,Array.isArray(t.members)&&this.members.push(...t.members.map((e=>new m(this._iid,e)))),this.memberCount=null!==(u=t.member_count)&&void 0!==u?u:0,this.joinedMemberCount=null!==(c=t.joined_member_count)&&void 0!==c?c:0,this.hiddenState=l.isEnumOf(exports.HiddenState,t.hidden_state)?t.hidden_state:exports.HiddenState.UNHIDDEN,this.messageOffsetTimestamp=null!==(p=t.ts_message_offset)&&void 0!==p?p:0,this.messageSurvivalSeconds=null!==(g=t.message_survival_seconds)&&void 0!==g?g:-1,this.lastMessage=t.last_message?_.parseMessagePayload(this._iid,Object.assign({channel_type:this.channelType},t.last_message)):null,t.read_receipt&&Object.keys(t.read_receipt).forEach((e=>{l.isTypeOf("number",t.read_receipt[e])&&this._updateUnreadMemberState(e,t.read_receipt[e])})),t.delivery_receipt&&Object.keys(t.delivery_receipt).forEach((e=>{l.isTypeOf("number",t.delivery_receipt[e])&&this._updateUndeliveredMemberState(e,t.delivery_receipt[e])})),this.myMemberState=l.isEnumOf(exports.MemberState,t.member_state)?t.member_state:exports.MemberState.NONE,this.myRole=l.isEnumOf(l.Role,t.my_role)?t.my_role:l.Role.NONE,l.isEnumOf(exports.MutedState,t.is_muted)?this.myMutedState=t.is_muted:l.isTypeOf("boolean",t.is_muted)?this.myMutedState=t.is_muted?exports.MutedState.MUTED:exports.MutedState.UNMUTED:this.myMutedState=exports.MutedState.UNMUTED,this.myCountPreference=l.isEnumOf(exports.CountPreference,t.count_preference)?t.count_preference:exports.CountPreference.ALL,this.myPushTriggerOption=l.isEnumOf(l.PushTriggerOption,t.push_trigger_option)?t.push_trigger_option:l.PushTriggerOption.ALL,this.myLastRead=null!==(C=t.user_last_read)&&void 0!==C?C:0,this.inviter=t.inviter?new l.User(this._iid,t.inviter):null,this.invitedAt=null!==(v=t.invited_at)&&void 0!==v?v:0,this.joinedAt=null!==(E=t.joined_ts)&&void 0!==E?E:0,this._updateUnreadCount(null!==(f=t.unread_message_count)&&void 0!==f?f:0,null!==(M=t.unread_mention_count)&&void 0!==M?M:0),this.pinnedMessageIds=null!==(y=t.pinned_message_ids)&&void 0!==y?y:[],this.lastPinnedMessage=t.latest_pinned_message?_.parseMessagePayload(this._iid,Object.assign({channel_type:this.channelType},t.latest_pinned_message)):null}get isHidden(){return this.hiddenState!==exports.HiddenState.UNHIDDEN}get isTyping(){return this._typingStatus.size>0}get cachedUnreadMemberState(){const e={};for(const[t,s]of this._unreadMemberStateMap)e[t]=s;return e}get cachedUndeliveredMemberState(){const e={};for(const[t,s]of this._undeliveredMemberStateMap)e[t]=s;return e}static payloadify(e){return l.deundefined(l.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{is_access_code_required:e.isAccessCodeRequired,is_distinct:e.isDistinct,is_super:e.isSuper,is_broadcast:e.isBroadcast,is_exclusive:e.isExclusive,is_public:e.isPublic,is_discoverable:e.isDiscoverable,is_muted:e.myMutedState,is_push_enabled:e.isPushEnabled,unread_message_count:e.unreadMessageCount,unread_mention_count:e.unreadMentionCount,push_trigger_option:e.myPushTriggerOption,count_preference:e.myCountPreference,hidden_state:e.hiddenState,member_count:e.memberCount,joined_member_count:e.joinedMemberCount,member_state:e.myMemberState,my_role:e.myRole,user_last_read:e.myLastRead,ts_message_offset:e.messageOffsetTimestamp,message_survival_seconds:e.messageSurvivalSeconds,read_receipt:e.cachedUnreadMemberState,delivery_receipt:e.cachedUndeliveredMemberState,members:e.members.map((e=>m.payloadify(e))),last_message:e.lastMessage?_.payloadifyMessage(e.lastMessage):null,inviter:e.inviter?l.User.payloadify(e.inviter):null,invited_at:e.invitedAt,joined_ts:e.joinedAt,pinned_message_ids:e.pinnedMessageIds,latest_pinned_message:e.lastPinnedMessage?_.payloadifyMessage(e.lastPinnedMessage):null})))}_shouldUpdateLastMessageWith(e){return!(e instanceof _.SendableMessage&&e.parentMessageId>0&&!e.replyToChannel)&&(!this.lastMessage||this.lastMessage.createdAt<e.createdAt||this.lastMessage.createdAt===e.createdAt&&this.lastMessage.messageId===e.messageId&&this.lastMessage.updatedAt<e.updatedAt)}_updateUnreadCount(e,t){if("number"==typeof e&&e>=0)if(this.myCountPreference===exports.CountPreference.ALL||this.myCountPreference===exports.CountPreference.UNREAD_MESSAGE_COUNT_ONLY)if(this.isExclusive||this.isSuper||this.isBroadcast){const{maxSuperGroupChannelUnreadCount:t}=l.Vault.of(this._iid);this.unreadMessageCount=t&&e>=t?t:e}else this.unreadMessageCount=e;else this.unreadMessageCount=0;else this.unreadMessageCount=0;"number"==typeof t&&t>=0&&(this.myCountPreference===exports.CountPreference.ALL||this.myCountPreference===exports.CountPreference.UNREAD_MENTION_COUNT_ONLY)?this.unreadMentionCount=t:this.unreadMentionCount=0}_updateUnreadMemberState(e,t){const s=this._unreadMemberStateMap.get(e);if(!s||s<t){this._unreadMemberStateMap.set(e,t);const{sdkState:s}=l.Vault.of(this._iid);return s.userId===e&&(this.myLastRead=t),!0}return!1}_updateUndeliveredMemberState(e,t){const s=this._undeliveredMemberStateMap.get(e);return(!s||s<t)&&(this._undeliveredMemberStateMap.set(e,t),!0)}_updateTypingStatus(e,t=(new Date).getTime()){t>0?this._typingStatus.set(e.userId,{user:e,ts:t}):this._typingStatus.delete(e.userId)}_clearTypingStatus(){this._typingStatus.clear(),this._typingStarted=0,this._typingEnded=0}_setLatestMemberCount(e,t,s){let n=!1;return s>=this._lastMemberCountUpdated&&(this._lastMemberCountUpdated=s,n=e!==this.memberCount||t!==this.joinedMemberCount,this.memberCount=e,this.joinedMemberCount=t),n}isReadMessage(e){const{sdkState:t}=l.Vault.of(this._iid),s=this._unreadMemberStateMap.get(t.userId);return!!s&&s>=e.createdAt}serialize(){return l.serialize(this,(e=>{e.cachedUnreadMemberState=this.cachedUnreadMemberState,e.cachedUndeliveredMemberState=this.cachedUndeliveredMemberState}))}createMessageCollection(e={}){return new $e(this._iid,Object.assign({channel:this},e))}createMemberListQuery(e={}){return new Ze(this._iid,this.url,e)}createPinnedMessageListQuery(e={}){return new Ut(this._iid,this.url,this.channelType,e)}addMember(e,t=0){if(!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const s=this.members.findIndex((t=>t.userId===e.userId));if(s>-1){const t=this.members[s];t.state===exports.MemberState.JOINED&&(e.state=t.state),this.members.splice(s,1),this.memberCount--}this.members.push(e),this.memberCount++,this._updateUnreadMemberState(e.userId,t),this._updateUndeliveredMemberState(e.userId,t)}}removeMember(e){if(!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const t=e instanceof m?e.userId:e,s=this.members.findIndex((e=>e.userId===t));if(s>-1)return this.members.splice(s,1),this.memberCount--,!0}return!1}getUnreadMemberCount(e){if(e instanceof _.SendableMessage&&!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const{sdkState:t}=l.Vault.of(this._iid),s=e.createdAt;let n=0;for(const i of this.members)if(t.userId!==i.userId&&i.state===exports.MemberState.JOINED&&e.sender.userId!==i.userId){(this.cachedUnreadMemberState[i.userId]||0)<s&&n++}return n}return 0}getUndeliveredMemberCount(e){if(e instanceof _.SendableMessage&&!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const{sdkState:t}=l.Vault.of(this._iid),s=e.createdAt;let n=0;for(const i of this.members)if(t.userId!==i.userId&&i.state===exports.MemberState.JOINED&&e.sender.userId!==i.userId){(this.cachedUndeliveredMemberState[i.userId]||0)<s&&n++}return n}return 0}getReadMembers(e,t=!1){const{sdkState:s}=l.Vault.of(this._iid);if(!s.userId||this.isExclusive||this.isSuper||this.isBroadcast)return[];const n=e instanceof _.SendableMessage?e.sender:null,i=[];return this.members.forEach((a=>{if(t||a.userId!==s.userId&&a.userId!==(null==n?void 0:n.userId)){const t=this._unreadMemberStateMap.get(a.userId);t&&t>=e.createdAt&&i.push(a)}})),i}getUnreadMembers(e,t=!1){const{sdkState:s}=l.Vault.of(this._iid);if(!s.userId||this.isExclusive||this.isSuper||this.isBroadcast)return[];const n=e instanceof _.SendableMessage?e.sender:null,i=[];return this.members.forEach((a=>{if(t||a.userId!==s.userId&&a.userId!==(null==n?void 0:n.userId)){const t=this._unreadMemberStateMap.get(a.userId);t&&t<e.createdAt&&i.push(a)}})),i}getReadStatus(e=!1){const{sdkState:t}=l.Vault.of(this._iid);if(!t.userId||this.isExclusive||this.isSuper||this.isBroadcast)return null;const s={};return this.members.forEach((n=>{if(e||n.userId!==t.userId){const e=this._unreadMemberStateMap.get(n.userId);s[n.userId]=new g(this._iid,{channel_url:this.url,channel_type:this.channelType,user:m.payloadify(n),ts:null!=e?e:0})}})),s}getTypingUsers(){const e=[];return this._typingStatus.forEach((t=>{const{user:s}=t;e.push(s)})),e}invalidateTypingStatus(){const{typingIndicatorInvalidateTime:e}=l.Vault.of(this._iid),t=Date.now();let s=!1;return this._typingStatus.forEach(((n,i)=>{const{ts:a}=n;t-a>=e&&(this._typingStatus.delete(i),s=!0)})),s}refresh(){return l.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,dispatcher:t}=l.Vault.of(this._iid),s=new x({channelUrl:this.url}),n=yield e.send(s),{channel:i}=n.as(R);return this._update(i),t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[i],source:u.GroupChannelEventSource.REQUEST_CHANNEL})),this}))}freeze(){const e=Object.create(null,{freeze:{get:()=>super.freeze}});return l.__awaiter(this,void 0,void 0,(function*(){yield e.freeze.call(this);const{dispatcher:t}=l.Vault.of(this._iid);t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_FROZEN,isWebSocketEventComing:!0}))}))}unfreeze(){const e=Object.create(null,{unfreeze:{get:()=>super.unfreeze}});return l.__awaiter(this,void 0,void 0,(function*(){yield e.unfreeze.call(this);const{dispatcher:t}=l.Vault.of(this._iid);t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_UNFROZEN,isWebSocketEventComing:!0}))}))}updateChannel(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ze),e);l.unless((e=>l.isTypeOf("string",e.coverUrl,!0)&&(l.isFile(e.coverImage)||l.isTypeOf("string",e.coverImage,!0))&&l.isTypeOf("boolean",e.isDistinct,!0)&&l.isTypeOf("boolean",e.isPublic,!0)&&l.isTypeOf("boolean",e.isDiscoverable,!0)&&l.isTypeOf("string",e.accessCode,!0)&&l.isTypeOf("string",e.name,!0)&&l.isTypeOf("string",e.data,!0)&&l.isTypeOf("string",e.customType,!0)&&l.isArrayOf("string",e.operatorUserIds,!0)&&l.isTypeOf("number",e.messageSurvivalSeconds,!0))(t)).throw(l.SendbirdError.invalidParameters);const{dispatcher:s,requestQueue:n}=l.Vault.of(this._iid),i=new st(Object.assign({channelUrl:this.url},t)),a=yield n.send(i),{channel:r}=a.as(nt);return this._update(r),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[r],source:u.GroupChannelEventSource.EVENT_CHANNEL_UPDATED,isWebSocketEventComing:!0})),this}))}invite(e){return l.__awaiter(this,void 0,void 0,(function*(){return l.unless(e.every((e=>e instanceof l.User))).throw(l.SendbirdError.invalidParameters),this.inviteWithUserIds(e.map((e=>e.userId)))}))}inviteWithUserIds(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isArrayOf("string",e)).throw(l.SendbirdError.invalidParameters);const{dispatcher:t,requestQueue:s}=l.Vault.of(this._iid),n=new ne({channelUrl:this.url,userIds:e}),i=yield s.send(n),{channel:a}=i.as(ie);return this._update(a),t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[a],source:u.GroupChannelEventSource.EVENT_CHANNEL_INVITED,isWebSocketEventComing:!0})),this}))}join(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("string",e,!0)).throw(l.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=l.Vault.of(this._iid),i=new X({channelUrl:this.url,userId:s.userId,accessCode:e}),a=yield n.send(i),{channel:r}=a.as(Z);return r.myMemberState=this.myMemberState=exports.MemberState.JOINED,this._update(r),t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[r],source:u.GroupChannelEventSource.EVENT_CHANNEL_JOINED,isWebSocketEventComing:!0})),this}))}leave(e=!1){return l.__awaiter(this,void 0,void 0,(function*(){const{sdkState:t,requestQueue:s}=l.Vault.of(this._iid),n=new te({channelUrl:this.url,userId:t.userId,shouldRemoveOperatorStatus:e});yield s.send(n),this.myMemberState=exports.MemberState.NONE}))}acceptInvitation(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("string",e,!0)).throw(l.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=l.Vault.of(this._iid),i=new et({channelUrl:this.url,userId:s.userId,accessCode:e}),a=yield n.send(i),{channel:r}=a.as(tt);return r.myMemberState=this.myMemberState=exports.MemberState.JOINED,this._update(r),t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[r],source:u.GroupChannelEventSource.EVENT_CHANNEL_ACCEPTED_INVITE,isWebSocketEventComing:!0})),this}))}declineInvitation(){return l.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=l.Vault.of(this._iid),s=new re({channelUrl:this.url,userId:e.userId});return yield t.send(s),this.myMemberState=exports.MemberState.NONE,this}))}sendUserMessage(e){const t=new _.MessageRequestHandler,{dispatcher:s}=l.Vault.of(this._iid),n=u.AutoResendManager.of(this._iid);return super.sendUserMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{s&&n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{this.hiddenState===exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE&&(this.hiddenState=exports.HiddenState.UNHIDDEN),n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e);Ae.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}updateUserMessage(e,t){const s=Object.create(null,{updateUserMessage:{get:()=>super.updateUserMessage}});return l.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:n}=l.Vault.of(this._iid),i=yield s.updateUserMessage.call(this,e,t);let a=!1;!i.silent&&this._shouldUpdateLastMessageWith(i)&&(this.lastMessage=i,a=!0);let r=!1;if(this.lastPinnedMessage&&this.lastPinnedMessage.messageId===i.messageId&&(this.lastPinnedMessage=i,a=!0,r=!0),a){Ae.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),n.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:r?u.GroupChannelEventSource.EVENT_PINNED_MESSAGE_UPDATED:u.GroupChannelEventSource.EVENT_MESSAGE_UPDATED}))}if(r){Ae.of(this._iid).handlers.map((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(this)}))}return n.dispatch(new l.MessageUpdateEventCommand({messages:[i],source:l.MessageEventSource.EVENT_MESSAGE_UPDATED})),i}))}_autoResendUserMessage(e){const t=new _.MessageRequestHandler,{dispatcher:s}=l.Vault.of(this._iid),n=u.AutoResendManager.of(this._iid);return super._autoResendUserMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ae.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}sendFileMessage(e){const t=new _.MessageRequestHandler,{dispatcher:s}=l.Vault.of(this._iid),n=u.AutoResendManager.of(this._iid);return super.sendFileMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{s&&n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ae.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}sendMultipleFilesMessage(e){const t=new _.MultipleFilesMessageRequestHandler,{dispatcher:s}=l.Vault.of(this._iid);return super.sendMultipleFilesMessage(e).onPending((e=>{t._trigger(e)})).onFailed(((e,s)=>{t._triggerFailed(e,s)})).onSucceeded((e=>{const n=Ae.of(this._iid);this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),n.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})).onFileUploaded(((e,s,n,i)=>{t._triggerOnFileUploaded(e,s,n,i)})),t}updateFileMessage(e,t){const s=Object.create(null,{updateFileMessage:{get:()=>super.updateFileMessage}});return l.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:n}=l.Vault.of(this._iid),i=yield s.updateFileMessage.call(this,e,t);let a=!1;!i.silent&&this._shouldUpdateLastMessageWith(i)&&(this.lastMessage=i,a=!0);let r=!1;if(this.lastPinnedMessage&&this.lastPinnedMessage.messageId===i.messageId&&(this.lastPinnedMessage=i,a=!0,r=!0),a){Ae.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),n.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:r?u.GroupChannelEventSource.EVENT_PINNED_MESSAGE_UPDATED:u.GroupChannelEventSource.EVENT_MESSAGE_UPDATED}))}if(r){Ae.of(this._iid).handlers.map((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(this)}))}return n.dispatch(new l.MessageUpdateEventCommand({messages:[i],source:l.MessageEventSource.EVENT_MESSAGE_UPDATED})),i}))}_autoResendFileMessage(e){const t=new _.MessageRequestHandler,{dispatcher:s}=l.Vault.of(this._iid),n=u.AutoResendManager.of(this._iid);return super._autoResendFileMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ae.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}deleteMessage(e){const t=Object.create(null,{deleteMessage:{get:()=>super.deleteMessage}});return l.__awaiter(this,void 0,void 0,(function*(){if(yield t.deleteMessage.call(this,e),0===e.messageId&&e instanceof _.SendableMessage){const{dispatcher:t}=l.Vault.of(this._iid);t.dispatch(new l.UnsentMessageRemoveEventCommand({reqId:e.reqId,source:l.MessageEventSource.EVENT_MESSAGE_DELETED}))}}))}hide(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ce),e);l.unless((e=>l.isTypeOf("boolean",e.hidePreviousMessages,!0)&&l.isTypeOf("boolean",e.allowAutoUnhide,!0))(t)).throw(l.SendbirdError.invalidParameters);const{dispatcher:s,sdkState:n,requestQueue:i}=l.Vault.of(this._iid),a=new _e(Object.assign({channelUrl:this.url,userId:n.userId},t)),r=yield i.send(a),{messageOffsetTimestamp:o}=r.as(pe);return this.hiddenState=t.allowAutoUnhide?exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE:exports.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE,t.hidePreviousMessages&&this._updateUnreadCount(0,0),o&&(this.messageOffsetTimestamp=o),s.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_HIDDEN,isWebSocketEventComing:!0})),this}))}unhide(){return l.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:e,requestQueue:t}=l.Vault.of(this._iid),s=new at({channelUrl:this.url});return yield t.send(s),this.hiddenState=exports.HiddenState.UNHIDDEN,e.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_UNHIDDEN,isWebSocketEventComing:!0})),this}))}delete(){return l.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=l.Vault.of(this._iid),t=new it({channelUrl:this.url});yield e.send(t)}))}markAsRead(){return l.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,dispatcher:t,requestQueue:s}=l.Vault.of(this._iid),n=new de({channelUrl:this.url}),i=yield s.send(n),{readStatus:a}=i.as(le);if(this._updateUnreadMemberState(e.userId,a.readAt),this.unreadMessageCount>0||this.unreadMentionCount>0){this._updateUnreadCount(0,0);Ae.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)}))}t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_READ}))}))}markAsDelivered(){return l.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=l.Vault.of(this._iid),s=new he({channelUrl:this.url,userId:e.userId});yield t.send(s)}))}startTyping(){return l.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,typingIndicatorThrottle:t}=l.Vault.of(this._iid),s=(new Date).getTime();if(s-this._typingStarted>=t){this._typingStarted=s,this._typingEnded=0;const t=new ge({channelUrl:this.url,time:this._typingStarted});e.send(t)}}))}endTyping(){return l.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,typingIndicatorThrottle:t}=l.Vault.of(this._iid),s=(new Date).getTime();if(s-this._typingEnded>=t){this._typingStarted=0,this._typingEnded=s;const t=new ve({channelUrl:this.url,time:this._typingStarted});e.send(t)}}))}createScheduledUserMessage(e){e=Object.assign(Object.assign({},u.ScheduledUserMessageCreateParamsDefault),e),l.unless(u.validateScheduledUserMessageCreateParams(e)).throw(l.SendbirdError.invalidParameters);const t=new _.MessageRequestHandler;return this._createScheduledUserMessage(e,t),t}updateScheduledUserMessage(e,t){return l.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},ut),t);l.unless((e=>h.validateUserMessageUpdateParams(e)&&l.isTypeOf("number",e.scheduledAt,!0))(s)).throw(l.SendbirdError.invalidParameters);const{requestQueue:n}=l.Vault.of(this._iid),i=new pt(Object.assign({reqId:this._generateRequestId(),scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url},s)),a=yield n.send(i),{message:r}=a.as(h.CreateScheduledUserMessageResponseCommand);return r}))}createScheduledFileMessage(e){e=Object.assign(Object.assign({},u.ScheduledFileMessageCreateParamsDefault),e),l.unless(u.validateScheduledFileMessageCreateParams(e)).throw(l.SendbirdError.invalidParameters);const t=Date.now(),s=this._generateRequestId(),n=new _.MessageRequestHandler;return l.sleep(h.PENDING_MESSAGE_DELAY).then((()=>{const i=this._createPendingScheduledFileMessage(e,s,t);l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){return n._trigger(i)}))))})),l.isFile(e.file)?this._uploadFileAndUpdateParams(e).then((()=>this._createScheduledFileMessage(e,n,s,t))):this._createScheduledFileMessage(e,n,s,t),n}updateScheduledFileMessage(e,t){return l.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},ht),t);l.unless((e=>h.validateBaseMessageUpdateParams(e)&&l.isTypeOf("number",e.scheduledAt,!0)&&(l.isFile(e.file)||l.isTypeOf("string",e.fileUrl))&&l.isTypeOf("string",e.fileName,!0)&&l.isTypeOf("string",e.mimeType,!0)&&l.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||e.thumbnailSizes.every((e=>l.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))))(s)).throw(l.SendbirdError.invalidParameters),l.isFile(s.file)&&(yield this._uploadFileAndUpdateParams(s));const n=new ct(Object.assign({reqId:this._generateRequestId(),scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url},s)),{requestQueue:i}=l.Vault.of(this._iid),a=yield i.send(n),{message:r}=a.as(_t);return r}))}cancelScheduledMessage(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=new mt({scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url}),{requestQueue:s}=l.Vault.of(this._iid);yield s.send(t)}))}sendScheduledMessageNow(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=new gt({scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url}),{requestQueue:s}=l.Vault.of(this._iid);yield s.send(t)}))}getMyPushTriggerOption(){return l.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=l.Vault.of(this._iid),s=new Et({userId:e.userId,channelUrl:this.url}),n=yield t.send(s),{pushTriggerOption:i}=n.as(ft);return this.myPushTriggerOption=i,i}))}setMyPushTriggerOption(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isEnumOf(l.PushTriggerOption,e)).throw(l.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=l.Vault.of(this._iid),i=new Ct({userId:s.userId,channelUrl:this.url,pushTriggerOption:e}),a=yield n.send(i),{pushTriggerOption:r}=a.as(vt);return this.myPushTriggerOption=r,t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_UPDATED,isWebSocketEventComing:!0})),r}))}setMyCountPreference(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isEnumOf(exports.CountPreference,e)).throw(l.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=l.Vault.of(this._iid),i=new rt({channelUrl:this.url,userId:s.userId,countPreference:e}),a=yield n.send(i),{countPreference:r}=a.as(ot);return this.myCountPreference=r,this._updateUnreadCount(this.unreadMessageCount,this.unreadMentionCount),t.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_UPDATED,isWebSocketEventComing:!0})),r}))}resetMyHistory(){return l.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:e,requestQueue:t}=l.Vault.of(this._iid),s=new dt({channelUrl:this.url}),n=yield t.send(s),{messageOffsetTimestamp:i}=n.as(lt);return this.messageOffsetTimestamp=i,this.lastMessage&&this.lastMessage.createdAt<i&&(this.lastMessage=null),e.dispatch(new u.GroupChannelUpdateEventCommand({channels:[this],source:u.GroupChannelEventSource.EVENT_CHANNEL_RESET_HISTORY,isWebSocketEventComing:!0})),this}))}pinMessage(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("number",e)&&e>0).throw(l.SendbirdError.invalidParameters);const{requestQueue:t}=l.Vault.of(this._iid),s=new Mt({channelType:this.channelType,channelUrl:this.url,messageId:e});yield t.send(s)}))}unpinMessage(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("number",e)&&e>0).throw(l.SendbirdError.invalidParameters);const{requestQueue:t}=l.Vault.of(this._iid),s=new yt({channelType:this.channelType,channelUrl:this.url,messageId:e});yield t.send(s)}))}_uploadFileAndUpdateParams(e){return l.__awaiter(this,void 0,void 0,(function*(){if(l.isFile(e.file)){const{requestQueue:t}=l.Vault.of(this._iid),s=new _.UploadFileRequestCommand({file:e.file,channelUrl:this.url,thumbnailSizes:e.thumbnailSizes,requestId:this._generateRequestId()}),n=yield t.send(s),{url:i,fileSize:a=e.fileSize,thumbnailSizes:r=e.thumbnailSizes,requireAuth:o=!1}=n.as(_.UploadFileResponseCommand);e.fileUrl=i,e.fileSize=a,e.thumbnailSizes=r,e.requireAuth=o}}))}}const Pt={};class wt{constructor({_iid:e,limit:t=100}){this.ref=0,this._iid=e,this._limit=t;const{sdkState:s,dispatcher:n,logger:i}=l.Vault.of(this._iid);this._metadataKey=`sendbird:${s.userId}@groupchannel/sync.meta`;const a=(e=>`sendbird:${e}@groupchannel/sync`)(s.userId);this._sync=new Te(a,(()=>l.__awaiter(this,void 0,void 0,(function*(){var e,t,s,n;const a={hasNext:!0,nextToken:""};if(yield this.loadMetadata(),i.debug("channel background sync from",null===(e=this._metadata)||void 0===e?void 0:e.token),null===(t=this._metadata)||void 0===t?void 0:t.completed)a.hasNext=!1,a.nextToken="";else try{const e=Ae.of(this._iid),{channels:t,token:r}=yield e.getMyGroupChannels(null!==(n=null===(s=this._metadata)||void 0===s?void 0:s.token)&&void 0!==n?n:"",{includeEmpty:!0,order:u.GroupChannelListOrder.CHRONOLOGICAL},this._limit,u.GroupChannelEventSource.SYNC_CHANNEL_BACKGROUND);a.hasNext=t.length>=this._limit&&!!r,a.nextToken=r,this._metadata&&(this._metadata.token=r,this._metadata.range.extends(...t.map((e=>e.createdAt))),this._metadata.completed=!a.hasNext),i.debug("channel background sync progress",a),yield this.saveMetadata()}catch(e){throw i.debug("channel background sync error",e),e instanceof l.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetaData()),e}return a})))),this._connectionEventContext=n.on((e=>{if(e instanceof l.ConnectionStateChangeCommand)if(e.stateType===l.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e){return Pt[e]||(Pt[e]=new wt({_iid:e})),Pt[e].ref++,Pt[e]}static clear(e){Pt[e]&&(Pt[e].close(),delete Pt[e])}get range(){var e,t;return null!==(t=null===(e=this._metadata)||void 0===e?void 0:e.range)&&void 0!==t?t:new ye({})}get completed(){var e;return!!(null===(e=this._metadata)||void 0===e?void 0:e.completed)}loadMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e}=l.Vault.of(this._iid),t=yield e.preference.get(this._metadataKey);this._metadata={token:t?t.token:"",range:new ye(t?t.range:{top:Number.MAX_SAFE_INTEGER,bottom:0}),completed:!!t&&t.completed}}return this._metadata}))}saveMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=l.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetaData(){return l.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=l.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){var e,t;const{logger:s,connectionManager:n}=l.Vault.of(this._iid);n.isConnected&&(s.debug("channel background sync resume()"),this._sync.start(null!==(t=null===(e=this._metadata)||void 0===e?void 0:e.token)&&void 0!==t?t:""))}pause(){const{logger:e}=l.Vault.of(this._iid);e.debug("channel background sync stop()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete Pt[this._iid])}}const xt={};class Rt{constructor({_iid:e}){this.ref=0,this._iid=e;const{logger:t,sdkState:s,dispatcher:n}=l.Vault.of(this._iid);this._metadataKey=`sendbird:${s.userId}@groupchannel/changelogs.meta`;const i=(e=>`sendbird:${e}@groupchannel/changelogs`)(s.userId);this._sync=new Te(i,(()=>l.__awaiter(this,void 0,void 0,(function*(){var e,s,n;const i={hasNext:!0,nextToken:0};yield this.loadMetadata(),t.debug("channel changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token);try{const e=Ae.of(this._iid),{hasMore:a,token:r}=yield e.getMyGroupChannelChangeLogs(null!==(n=null===(s=this._metadata)||void 0===s?void 0:s.token)&&void 0!==n?n:"",{includeEmpty:!0},u.GroupChannelEventSource.SYNC_CHANNEL_CHANGELOGS);i.hasNext=a,i.nextToken=r,this._metadata&&(this._metadata.token=r),t.debug("channel changelog sync progress",i),yield this.saveMetadata()}catch(e){throw t.debug("channel changelog sync error",e),e instanceof l.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return i})))),this._connectionEventContext=n.on((e=>{if(e instanceof l.ConnectionStateChangeCommand)if(e.stateType===l.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e){return xt[e]||(xt[e]=new Rt({_iid:e})),xt[e].ref++,xt[e]}static clear(e){xt[e]&&(xt[e].close(),delete xt[e])}loadMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e,firstConnectedAt:t}=l.Vault.of(this._iid),s=yield e.preference.get(this._metadataKey);this._metadata={token:s?s.token:t}}return this._metadata}))}saveMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=l.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return l.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=l.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{connectionManager:e}=l.Vault.of(this._iid);e.isConnected&&this._sync.start(0)}pause(){this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete xt[this._iid])}}class Lt{constructor(e,{filter:t,order:s,limit:n}){this.channels=[],this._iid=e,this._key=`gcc-${l.uuid()}`,this._isDisposed=!1,this._isGetRemoteChannelsSucceeded=!0,this.filter=null!=t?t:new C,this.order=null!=s?s:u.GroupChannelListOrder.LATEST_LAST_MESSAGE,this._hasMore=!0,this._token="",this._limit=null!=n?n:h.DEFAULT_GROUPCHANNEL_LIMIT;const{sdkState:i,cacheContext:a,dispatcher:r}=l.Vault.of(this._iid);a.localCacheEnabled&&(this._backgroundSync=wt.of(e),this._backgroundSync.resume()),this._changelogSync=Rt.of(e),this._changelogSync.resume();Ae.of(this._iid).subscribeGroupChannelEvent(this._key,{onUpdate:(e,t)=>{if(u.shouldGiveEvent(t)){const s=e.filter((e=>this.filter.match(e,i.userId))),n=e.filter((e=>!this.filter.match(e,i.userId))).map((e=>e.url));s.length>0&&this._addChannelsToView(s,t),n.length>0&&this._removeChannelsFromView(n,t)}},onRemove:(e,t)=>{this._removeChannelsFromView(e,t)}});const{statLogCollector:o}=l.Vault.of(this._iid);o.put(new l.DailyRecordStatLog({type:l.StatType.FEATURE_LOCALCACHE,data:{use_local_cache:a.localCacheEnabled,collection_interface:{group_channel:!0}}})),r.on((e=>{e instanceof l.ConnectionStateChangeCommand&&(e.stateType===l.ConnectionStateType.CONNECTED?this._isGetRemoteChannelsSucceeded||(()=>{l.__awaiter(this,void 0,void 0,(function*(){yield this._revokeLoadMore()}))})():e.stateType===l.ConnectionStateType.LOGOUT&&this.dispose())}))}get hasMore(){return!this._isDisposed&&this._hasMore}setGroupChannelCollectionHandler(e){this._handler=e}_addChannelsToView(e,t,s=!1){const n=[],i=[],a=[];for(const r of e){const e=De(this.channels,r);e>=0&&this.channels.splice(e,1);const{place:o}=Ge(this.channels,r,this.order);if(e<0)o===this.channels.length?!s&&this._hasMore||(n.push(r),this.channels.push(r)):(n.push(r),this.channels.splice(o,0,r));else switch(t){case u.GroupChannelEventSource.EVENT_CHANNEL_UPDATED:case u.GroupChannelEventSource.EVENT_MESSAGE_RECEIVED:case u.GroupChannelEventSource.SYNC_CHANNEL_CHANGELOGS:case u.GroupChannelEventSource.EVENT_MESSAGE_SENT:o!==e&&this._hasMore&&o===this.channels.length?a.push(r):(this.channels.splice(o,0,r),i.push(r));break;default:this.channels.splice(o,0,r),i.push(r)}}if(a.length>0)for(const e of a){const t=De(this.channels,e);-1!==t&&this.channels.splice(t,1)}u.shouldGiveEvent(t)&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e,s,r;const o=new Ne(t);n.length>0&&(null===(e=this._handler)||void 0===e?void 0:e.onChannelsAdded)&&this._handler.onChannelsAdded(o,n),i.length>0&&(null===(s=this._handler)||void 0===s?void 0:s.onChannelsUpdated)&&this._handler.onChannelsUpdated(o,i),a.length>0&&(null===(r=this._handler)||void 0===r?void 0:r.onChannelsDeleted)&&this._handler.onChannelsDeleted(o,a.map((e=>e.url)))}))))}_removeChannelsFromView(e,t){const s=[];for(const t of e){const e=this.channels.findIndex((e=>e.url===t));e>=0&&(s.push(this.channels[e].url),this.channels.splice(e,1))}return u.shouldGiveEvent(t)&&s.length>0&&l.runAsCallback((()=>l.__awaiter(this,void 0,void 0,(function*(){var e;const n=new Ne(t);(null===(e=this._handler)||void 0===e?void 0:e.onChannelsDeleted)&&this._handler.onChannelsDeleted(n,s)})))),s}_getLocalChannels(){return l.__awaiter(this,void 0,void 0,(function*(){const e=Ae.of(this._iid),t=this.channels.length>0?((e,t)=>{var s,n,i,a;switch(t){case u.GroupChannelListOrder.LATEST_LAST_MESSAGE:return null!==(n=null===(s=e.lastMessage)||void 0===s?void 0:s.createdAt)&&void 0!==n?n:e.createdAt;case u.GroupChannelListOrder.CHRONOLOGICAL:return e.createdAt;case u.GroupChannelListOrder.CHANNEL_NAME_ALPHABETICAL:return e.name;default:return null!==(a=null===(i=e.lastMessage)||void 0===i?void 0:i.createdAt)&&void 0!==a?a:e.createdAt}})(this.channels[this.channels.length-1],this.order):null;return yield e.getChannelsFromCache(t,this.filter,this.order,this._limit,t?this.channels[this.channels.length-1].url:void 0)}))}_getRemoteChannels(){return l.__awaiter(this,void 0,void 0,(function*(){const e=Ae.of(this._iid),{channels:t,token:s}=yield e.getMyGroupChannels(this._token,l.undefineNullProps(Object.assign(Object.assign({},this.filter),{order:this.order})),this._limit);return this._token=s,this._hasMore=!!s,t}))}_revokeLoadMore(){return l.__awaiter(this,void 0,void 0,(function*(){if(!this._isDisposed)try{const e=yield this._getRemoteChannels();this._isGetRemoteChannelsSucceeded=!0,this._addChannelsToView(e,u.GroupChannelEventSource.REQUEST_CHANNEL,!0)}catch(e){this._isGetRemoteChannelsSucceeded=!1}}))}loadMore(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new l.SendbirdError({code:l.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});if(this._hasMore){const{cacheContext:e,connectionManager:t}=l.Vault.of(this._iid);let s=[];if(!e.localCacheEnabled||t.isConnected&&!this._backgroundSync.completed)try{s=yield this._getRemoteChannels(),this._isGetRemoteChannelsSucceeded=!0}catch(e){this._isGetRemoteChannelsSucceeded=!1}else yield l.runOrNothing((()=>l.__awaiter(this,void 0,void 0,(function*(){s=yield this._getLocalChannels()})))),this._hasMore=s.length>=this._limit;return this._addChannelsToView(s,u.GroupChannelEventSource.REQUEST_CHANNEL,!0),s}return[]}))}dispose(){var e,t;if(this._isDisposed)return;this._isDisposed=!0,this.channels.length>0&&this.channels.splice(0,this.channels.length),null===(e=this._backgroundSync)||void 0===e||e.close(),null===(t=this._changelogSync)||void 0===t||t.close();Ae.of(this._iid).unsubscribeGroupChannelEvent(this._key)}}class Ft extends l.APIRequestCommand{constructor(e){const{token:t,limit:s,order:n,includeEmpty:i,membershipFilter:a,channelNameContainsFilter:r,channelUrlsFilter:o,customTypesFilter:d,customTypeStartsWithFilter:h,superChannelFilter:u,metadataOrderKeyFilter:c,metadataKey:_,metadataValues:p,metadataValueStartsWith:m,includeFrozen:g,includeMetaData:C}=e;super(),this.method=l.APIRequestMethod.GET,this.path=l.API_PATH_GROUP_CHANNELS,this.params=l.deundefined(l.undefineNullProps({token:t,limit:s,order:n,show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0,show_empty:i,public_mode:exports.PublicChannelFilter.PUBLIC,public_membership_mode:a,name_contains:r,channel_urls:o,custom_types:d,custom_type_startswith:h,super_mode:u,metadata_order_key:c,metadata_key:_,metadata_values:p,metadata_value_startswith:m,show_frozen:g,show_metadata:C}))}}class kt extends l.APIResponseCommand{constructor(e,t){super(e,t),this.channels=[];const{next:s,channels:n,ts:i}=t;this.token=s,n&&n.length>0&&(this.channels=n.map((t=>(t.ts=i,new Ot(e,t))))),this.ts="number"==typeof i?i:0}}var Dt;exports.MembershipFilter=void 0,(Dt=exports.MembershipFilter||(exports.MembershipFilter={})).ALL="all",Dt.JOINED="joined";class Gt extends l.BaseListQuery{constructor(e,t){var s,n,i,a,r,o,d,l,h,c,_,p,m,g;super(e,t),this.includeEmpty=!1,this.includeFrozen=!0,this.includeMetaData=!0,this.channelUrlsFilter=null,this.customTypesFilter=null,this.customTypeStartsWithFilter=null,this.channelNameContainsFilter=null,this.membershipFilter=exports.MembershipFilter.ALL,this.superChannelFilter=exports.SuperChannelFilter.ALL,this.metadataKey=null,this.metadataValues=null,this.metadataOrderKeyFilter=null,this.metadataValueStartsWith=null,this.order=u.PublicGroupChannelListOrder.CHRONOLOGICAL,this.includeEmpty=null!==(s=t.includeEmpty)&&void 0!==s&&s,this.includeFrozen=null===(n=t.includeFrozen)||void 0===n||n,this.includeMetaData=null===(i=t.includeMetaData)||void 0===i||i,this.channelUrlsFilter=null!==(a=t.channelUrlsFilter)&&void 0!==a?a:null,this.customTypesFilter=null!==(r=t.customTypesFilter)&&void 0!==r?r:null,this.customTypeStartsWithFilter=null!==(o=t.customTypeStartsWithFilter)&&void 0!==o?o:null,this.channelNameContainsFilter=null!==(d=t.channelNameContainsFilter)&&void 0!==d?d:null,this.membershipFilter=null!==(l=t.membershipFilter)&&void 0!==l?l:exports.MembershipFilter.ALL,this.superChannelFilter=null!==(h=t.superChannelFilter)&&void 0!==h?h:exports.SuperChannelFilter.ALL,this.metadataKey=null!==(c=t.metadataKey)&&void 0!==c?c:null,this.metadataValues=null!==(_=t.metadataValues)&&void 0!==_?_:null,this.metadataOrderKeyFilter=null!==(p=t.metadataOrderKeyFilter)&&void 0!==p?p:null,this.metadataValueStartsWith=null!==(m=t.metadataValueStartsWith)&&void 0!==m?m:null,this.order=null!==(g=t.order)&&void 0!==g?g:u.PublicGroupChannelListOrder.CHRONOLOGICAL}_validate(){return super._validate()&&l.isTypeOf("boolean",this.includeEmpty)&&l.isTypeOf("boolean",this.includeFrozen)&&l.isTypeOf("boolean",this.includeMetaData)&&l.isTypeOf("string",this.channelNameContainsFilter,!0)&&l.isArrayOf("string",this.channelUrlsFilter,!0)&&l.isArrayOf("string",this.customTypesFilter,!0)&&l.isTypeOf("string",this.customTypeStartsWithFilter,!0)&&l.isEnumOf(exports.MembershipFilter,this.membershipFilter)&&l.isEnumOf(exports.SuperChannelFilter,this.superChannelFilter)&&l.isEnumOf(u.PublicGroupChannelListOrder,this.order)&&l.isTypeOf("string",this.metadataOrderKeyFilter,!0)&&l.isTypeOf("string",this.metadataKey,!0)&&l.isArrayOf("string",this.metadataValues,!0)&&l.isTypeOf("string",this.metadataValueStartsWith,!0)}next(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw l.SendbirdError.queryInProgress;{const e=[];if(this._hasNext){this._isLoading=!0;const{requestQueue:e,dispatcher:t}=l.Vault.of(this._iid),s=new Ft(l.undefineNullProps(Object.assign(Object.assign({},this),{token:this._token}))),n=yield e.send(s),{channels:i,token:a}=n.as(kt);return this._token=a,this._hasNext=!!a,this._isLoading=!1,i}return e}}throw l.SendbirdError.invalidParameters}))}}class Ht extends c.BaseChannelHandlerParams{constructor(){super(...arguments),this.onUserJoined=l.noop,this.onUserLeft=l.noop,this.onUserReceivedInvitation=l.noop,this.onUserDeclinedInvitation=l.noop,this.onChannelHidden=l.noop,this.onUnreadMemberStatusUpdated=l.noop,this.onUndeliveredMemberStatusUpdated=l.noop,this.onTypingStatusUpdated=l.noop,this.onPollUpdated=l.noop,this.onPollVoted=l.noop,this.onPollDeleted=l.noop,this.onPinnedMessageUpdated=l.noop}}class Vt extends Ht{constructor(e={}){super(),Object.keys(e).forEach((t=>{this.hasOwnProperty(t)&&(this[t]=e[t])}))}}class qt extends l.APIRequestCommand{constructor(e){const{token:t,limit:s,order:n,reverse:i,channelUrl:a,messageTypeFilter:r,scheduledStatus:o}=e;super(),this.method=l.APIRequestMethod.GET,this.path=`${l.API_PATH_SCHEDULED_MESSAGES}`,this.params=l.deundefined(l.undefineNullProps({token:t,limit:s,reverse:i,channel_url:a,order:n,message_type:r,status:o}))}}class jt extends l.APIResponseCommand{constructor(e,t){super(e,t),this.scheduledMessages=[];const{next:s,scheduled_messages:n}=t;this.token=s,this.scheduledMessages=n.map((t=>_.parseMessagePayload(e,t)))}}class Bt extends l.BaseListQuery{constructor(e,t){var s,n,i,a,r;super(e,t),this.channelUrl=null,this.order=null,this.reverse=!1,this.scheduledStatus=null,this.messageTypeFilter=l.MessageTypeFilter.ALL,this.channelUrl=null!==(s=t.channelUrl)&&void 0!==s?s:null,this.order=null!==(n=t.order)&&void 0!==n?n:null,this.reverse=null!==(i=t.reverse)&&void 0!==i&&i,this.scheduledStatus=null!==(a=t.scheduledStatus)&&void 0!==a?a:null,this.messageTypeFilter=null!==(r=t.messageTypeFilter)&&void 0!==r?r:l.MessageTypeFilter.ALL}_validate(){return super._validate()&&l.isTypeOf("string",this.channelUrl,!0)&&(l.isEnumOf(u.ScheduledMessageListOrder,this.order)||null===this.order)&&l.isTypeOf("boolean",this.reverse)&&(l.isArrayOf(_.ScheduledStatus,this.scheduledStatus)||null===this.scheduledStatus)&&l.isEnumOf(l.MessageTypeFilter,this.messageTypeFilter)}next(){return l.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw l.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=l.Vault.of(this._iid),t=new qt(l.undefineNullProps(Object.assign(Object.assign({},this),{token:this._token}))),s=yield e.send(t),{scheduledMessages:n,token:i}=s.as(jt);return this._token=i,this._hasNext=!!i,this._isLoading=!1,n}return[]}throw l.SendbirdError.invalidParameters}))}}class Wt extends l.Module{constructor(){super(...arguments),this.name="groupChannel"}init(e,{sdkState:t,dispatcher:s,sessionManager:n,requestQueue:i,logger:a,onlineDetector:r,cacheContext:o}){super.init(e,{sdkState:t,dispatcher:s,sessionManager:n,requestQueue:i,logger:a,onlineDetector:r,cacheContext:o}),this._manager=new Ae(e,{sdkState:t,cacheContext:o,dispatcher:s,sessionManager:n,requestQueue:i,logger:a})}createGroupChannelCollection(e={}){return new Lt(this._iid,e)}createMyGroupChannelListQuery(e={}){return new Me(this._iid,e)}createPublicGroupChannelListQuery(e={}){return new Gt(this._iid,e)}createScheduledMessageListQuery(e={}){return new Bt(this._iid,e)}addGroupChannelHandler(e,t){l.unless(l.isTypeOf("string",e)&&t instanceof Vt).throw(l.SendbirdError.invalidParameters),this._manager.addHandler(e,t)}removeGroupChannelHandler(e){l.unless(l.isTypeOf("string",e)).throw(l.SendbirdError.invalidParameters),this._manager.removeHandler(e)}removeAllGroupChannelHandlers(){this._manager.clearHandler()}buildGroupChannelFromSerializedData(e){return this._manager.buildGroupChannelFromSerializedData(e)}buildGroupChannelListQueryFromSerializedData(e){return this._manager.buildGroupChannelListQueryFromSerializedData(e)}buildMemberFromSerializedData(e){return this._manager.buildMemberFromSerializedData(e)}getChannel(e){return l.__awaiter(this,void 0,void 0,(function*(){return l.unless(l.isTypeOf("string",e)).throw(l.SendbirdError.invalidParameters),this._manager.getChannel(e)}))}getChannelWithoutCache(e){return l.__awaiter(this,void 0,void 0,(function*(){return l.unless(l.isTypeOf("string",e)).throw(l.SendbirdError.invalidParameters),this._manager.getChannelWithoutCache(e)}))}getMyGroupChannelChangeLogsByToken(e,t={}){return l.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},M),t);return l.unless(l.isTypeOf("string",e)&&y(s)).throw(l.SendbirdError.invalidParameters),yield this._manager.getMyGroupChannelChangeLogs(e,s)}))}getMyGroupChannelChangeLogsByTimestamp(e,t={}){return l.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},M),t);return l.unless(l.isTypeOf("number",e)&&y(s)).throw(l.SendbirdError.invalidParameters),yield this._manager.getMyGroupChannelChangeLogs(e,s)}))}getGroupChannelCount(e){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},S),e);return l.unless(b(t)).throw(l.SendbirdError.invalidParameters),this._manager.getGroupChannelCount(t)}))}getUnreadItemCount(e={}){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getUnreadItemCount(e)}))}getTotalUnreadChannelCount(){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getTotalUnreadChannelCount()}))}getTotalUnreadMessageCount(e={}){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getTotalUnreadMessageCount(e)}))}getTotalScheduledMessageCount(e={}){return l.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getTotalScheduledMessageCount(e)}))}getSubscribedTotalUnreadMessageCount(){return this._manager.getSubscribedTotalUnreadMessageCount()}getSubscribedCustomTypeTotalUnreadMessageCount(){return this._manager.getSubscribedCustomTypeTotalUnreadMessageCount()}getSubscribedCustomTypeUnreadMessageCount(e){return this._manager.getSubscribedCustomTypeUnreadMessageCount(e)}createChannel(e={}){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},E),e);return l.unless(f(t)).throw(l.SendbirdError.invalidParameters),this._manager.createChannel(t)}))}createDistinctChannelIfNotExist(e={}){return l.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},E),e);return l.unless(f(t)).throw(l.SendbirdError.invalidParameters),t&&(t.isDistinct=!0),this.createChannel(t)}))}createChannelWithUserIds(e,t=!1,s,n,i="",a=""){return l.__awaiter(this,void 0,void 0,(function*(){const r=Object.assign(Object.assign({},E),{invitedUserIds:e,isDistinct:t,name:s,data:i,customType:a});return"string"==typeof n?r.coverUrl=n:r.coverImage=n,this.createChannel(r)}))}markAsReadAll(){return l.__awaiter(this,void 0,void 0,(function*(){this._manager.markAsReadAll()}))}markAsReadWithChannelUrls(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isArrayOf("string",e)).throw(l.SendbirdError.invalidParameters),this._manager.markAsReadWithChannelUrls(e)}))}markAsDelivered(e){return l.__awaiter(this,void 0,void 0,(function*(){l.unless(l.isTypeOf("string",e)).throw(l.SendbirdError.invalidParameters);const t=yield this.getChannel(e);yield t.markAsDelivered()}))}}Object.defineProperty(exports,"MessageEventSource",{enumerable:!0,get:function(){return l.MessageEventSource}}),Object.defineProperty(exports,"GroupChannelEventSource",{enumerable:!0,get:function(){return u.GroupChannelEventSource}}),Object.defineProperty(exports,"GroupChannelListOrder",{enumerable:!0,get:function(){return u.GroupChannelListOrder}}),exports.MessageFilter=u.MessageFilter,Object.defineProperty(exports,"PublicGroupChannelListOrder",{enumerable:!0,get:function(){return u.PublicGroupChannelListOrder}}),Object.defineProperty(exports,"ScheduledMessageListOrder",{enumerable:!0,get:function(){return u.ScheduledMessageListOrder}}),Object.defineProperty(exports,"ScheduledStatus",{enumerable:!0,get:function(){return _.ScheduledStatus}}),exports.GroupChannel=Ot,exports.GroupChannelCollection=Lt,exports.GroupChannelEventContext=Ne,exports.GroupChannelFilter=C,exports.GroupChannelHandler=Vt,exports.GroupChannelListQuery=Me,exports.GroupChannelModule=Wt,exports.Member=m,exports.MemberListQuery=Ze,exports.MessageCollection=$e,exports.MessageCollectionInitHandler=We,exports.MessageEventContext=Ie,exports.PinnedMessage=St,exports.PinnedMessageListQuery=Ut,exports.PublicGroupChannelListQuery=Gt,exports.ReadStatus=g,exports.ScheduledMessageListQuery=Bt;
