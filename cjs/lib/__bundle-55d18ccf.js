"use strict";var e,t,s,n,i,a,r,o,l,d=require("./__bundle-2596e4e9.js"),h=require("./__bundle-2552e860.js"),c=require("./__bundle-ad5304cd.js"),u=require("./__bundle-0e2baf5f.js"),_=require("./__bundle-264767b5.js"),p=require("./__bundle-838cae54.js");exports.MemberState=void 0,(e=exports.MemberState||(exports.MemberState={})).NONE="none",e.JOINED="joined",e.INVITED="invited",e.LEFT="left";class m extends h.RestrictedUser{constructor(e,t){super(e,t),this.state=null,this.role=null,this.isMuted=!1,this.isBlockedByMe=!1,this.isBlockingMe=!1,this.state=d.isEnumOf(exports.MemberState,t.state)?t.state:null,this.role=d.isEnumOf(d.Role,t.role)?t.role:null,"boolean"==typeof t.is_muted&&(this.isMuted=t.is_muted),"boolean"==typeof t.is_blocked_by_me&&(this.isBlockedByMe=t.is_blocked_by_me),"boolean"==typeof t.is_blocking_me&&(this.isBlockingMe=t.is_blocking_me)}static payloadify(e){return d.deundefined(d.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{state:e.state,role:e.role,is_muted:e.isMuted,is_blocked_by_me:e.isBlockedByMe,is_blocking_me:e.isBlockingMe})))}}class C extends d.InstancedObject{constructor(e,t){var s,n;super(e),this.channelUrl=null!==(s=t.channel_url)&&void 0!==s?s:"",this.channelType=null!==(n=t.channel_type)&&void 0!==n?n:d.ChannelType.GROUP,this.reader=new d.User(this._iid,t.user),this.readAt=t.ts}}exports.PublicChannelFilter=void 0,(t=exports.PublicChannelFilter||(exports.PublicChannelFilter={})).ALL="all",t.PUBLIC="public",t.PRIVATE="private",exports.MyMemberStateFilter=void 0,(s=exports.MyMemberStateFilter||(exports.MyMemberStateFilter={})).ALL="all",s.JOINED="joined_only",s.INVITED="invited_only",s.INVITED_BY_FRIEND="invited_by_friend",s.INVITED_BY_NON_FRIEND="invited_by_non_friend",exports.SuperChannelFilter=void 0,(n=exports.SuperChannelFilter||(exports.SuperChannelFilter={})).ALL="all",n.SUPER="super",n.NON_SUPER="nonsuper",n.BROADCAST_ONLY="broadcast_only",n.EXCLUSIVE_ONLY="exclusive_only",exports.UnreadChannelFilter=void 0,(i=exports.UnreadChannelFilter||(exports.UnreadChannelFilter={})).ALL="all",i.UNREAD_MESSAGE="unread_message",exports.HiddenChannelFilter=void 0,(a=exports.HiddenChannelFilter||(exports.HiddenChannelFilter={})).ALL="all",a.UNHIDDEN="unhidden_only",a.HIDDEN="hidden_only",a.HIDDEN_ALLOW_AUTO_UNHIDE="hidden_allow_auto_unhide",a.HIDDEN_PREVENT_AUTO_UNHIDE="hidden_prevent_auto_unhide",exports.OperatorFilter=void 0,(r=exports.OperatorFilter||(exports.OperatorFilter={})).ALL="all",r.OPERATOR="operator",r.NONOPERATOR="nonoperator",exports.QueryType=void 0,(o=exports.QueryType||(exports.QueryType={})).AND="AND",o.OR="OR",exports.GroupChannelSearchField=void 0,(l=exports.GroupChannelSearchField||(exports.GroupChannelSearchField={})).MEMBER_NICKNAME="member_nickname",l.CHANNEL_NAME="channel_name";class g{constructor(){this._searchFilter=null,this._userIdsFilter=null,this.includeEmpty=!1,this.nicknameContainsFilter=null,this.nicknameStartsWithFilter=null,this.nicknameExactMatchFilter=null,this.channelNameContainsFilter="",this.myMemberStateFilter=exports.MyMemberStateFilter.ALL,this.customTypesFilter=null,this.channelUrlsFilter=null,this.superChannelFilter=exports.SuperChannelFilter.ALL,this.publicChannelFilter=exports.PublicChannelFilter.ALL,this.customTypeStartsWithFilter=null,this.unreadChannelFilter=exports.UnreadChannelFilter.ALL,this.hiddenChannelFilter=exports.HiddenChannelFilter.UNHIDDEN,this.includeFrozen=!0}_isFriend(e){return!(!e||!e.friendDiscoveryKey&&!e.friendName)}get searchFilter(){return this._searchFilter}setSearchFilter(e,t){Array.isArray(e)&&0!==e.length&&"string"==typeof t&&t&&(this._searchFilter={query:t,fields:e})}get userIdsFilter(){return this._userIdsFilter}setUserIdsFilter(e,t,s=exports.QueryType.AND){this._userIdsFilter={userIds:e,includeMode:t,queryType:s}}clone(){var e;const t=new g;this.searchFilter&&t.setSearchFilter(this.searchFilter.fields,null!==(e=this.searchFilter.query)&&void 0!==e?e:void 0),this.userIdsFilter&&t.setUserIdsFilter(this.userIdsFilter.userIds,this.userIdsFilter.includeMode,this.userIdsFilter.queryType);const s=JSON.parse(JSON.stringify(this));return Object.keys(s).forEach((e=>{t[e]=s[e]})),t}match(e,t){if(this._searchFilter){const{query:t,fields:s}=this._searchFilter;if(t&&s&&s.length>0&&!s.some((s=>{switch(s){case exports.GroupChannelSearchField.CHANNEL_NAME:return e.name.toLowerCase().includes(t.toLowerCase());case exports.GroupChannelSearchField.MEMBER_NICKNAME:return e.members.some((e=>e.nickname.toLowerCase().includes(t.toLowerCase())));default:return!0}})))return!1}if(this._userIdsFilter){const{userIds:s,includeMode:n,queryType:i}=this._userIdsFilter,a=e.members.map((e=>e.userId));if(n){if(s.length>0)switch(i){case exports.QueryType.AND:if(s.some((e=>!a.includes(e))))return!1;break;case exports.QueryType.OR:if(s.every((e=>!a.includes(e))))return!1}}else{if(s.includes(t)||s.push(t),e.members.length>s.length)return!1;if(!d.hasSameMembers(s,a))return!1}}if(!this.includeEmpty&&!e.lastMessage)return!1;if(!this.includeFrozen&&e.isFrozen)return!1;if(this.customTypesFilter&&this.customTypesFilter.length>0&&!this.customTypesFilter.includes(e.customType))return!1;if(this.customTypeStartsWithFilter&&!new RegExp(`^${this.customTypeStartsWithFilter}`).test(e.customType))return!1;if(this.channelNameContainsFilter&&!e.name.toLowerCase().includes(this.channelNameContainsFilter.toLowerCase()))return!1;if(this.nicknameContainsFilter){const s=this.nicknameContainsFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase().includes(s))))return!1}if(this.nicknameStartsWithFilter){const s=this.nicknameStartsWithFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase().startsWith(s))))return!1}if(this.nicknameExactMatchFilter){const s=this.nicknameExactMatchFilter.toLowerCase();if(!e.members.some((e=>e.userId!==t&&e.nickname.toLowerCase()!=s)))return!1}if(this.channelUrlsFilter&&this.channelUrlsFilter.length>0&&!this.channelUrlsFilter.includes(e.url))return!1;if(this.myMemberStateFilter)switch(this.myMemberStateFilter){case exports.MyMemberStateFilter.JOINED:if("joined"!==e.myMemberState)return!1;break;case exports.MyMemberStateFilter.INVITED:if("invited"!==e.myMemberState)return!1;break;case exports.MyMemberStateFilter.INVITED_BY_FRIEND:if("invited"!==e.myMemberState||!this._isFriend(e.inviter))return!1;break;case exports.MyMemberStateFilter.INVITED_BY_NON_FRIEND:if("invited"!==e.myMemberState||this._isFriend(e.inviter))return!1}if(this.hiddenChannelFilter)switch(this.hiddenChannelFilter){case exports.HiddenChannelFilter.UNHIDDEN:if(e.isHidden||"unhidden"!==e.hiddenState)return!1;break;case exports.HiddenChannelFilter.HIDDEN:if(!e.isHidden)return!1;break;case exports.HiddenChannelFilter.HIDDEN_ALLOW_AUTO_UNHIDE:if(!e.isHidden||"hidden_allow_auto_unhide"!==e.hiddenState)return!1;break;case exports.HiddenChannelFilter.HIDDEN_PREVENT_AUTO_UNHIDE:if(!e.isHidden||"hidden_prevent_auto_unhide"!==e.hiddenState)return!1}if(this.unreadChannelFilter&&this.unreadChannelFilter===exports.UnreadChannelFilter.UNREAD_MESSAGE)if(0===e.unreadMessageCount)return!1;if(this.publicChannelFilter)switch(this.publicChannelFilter){case exports.PublicChannelFilter.PUBLIC:if(!e.isPublic)return!1;break;case exports.PublicChannelFilter.PRIVATE:if(e.isPublic)return!1}if(this.superChannelFilter)switch(this.superChannelFilter){case exports.SuperChannelFilter.SUPER:if(!e.isSuper)return!1;break;case exports.SuperChannelFilter.NON_SUPER:if(e.isSuper)return!1}return!0}}class E extends d.InstancedObject{constructor(e,{sdkState:t,cacheContext:s}){super(e),this._channels=new Map,this._sdkState=t,this._cacheContext=s}get collection(){const{nestdb:e}=this._cacheContext;return d.unless(!!e).throw(d.SendbirdError.databaseError),e.collection(u.NESTDB_GROUPCHANNEL_COLLECTION_NAME)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e,t=0){return Object.assign(Object.assign({},e.serialize()),{lastMessageUpdatedAt:e.lastMessage?e.lastMessage.createdAt:0,syncIndex:t})}_deserialize(e){return Ue.of(this._iid).buildGroupChannelFromSerializedData(e)}get channels(){return[...this._channels.values()]}isCachedInMemory(e){return this._channels.has(e)}filterOffsetChanged(e){return e.filter((e=>{if(this._channels.has(e.url)){return this._channels.get(e.url).messageOffsetTimestamp<e.messageOffsetTimestamp}}))}get(e){return d.__awaiter(this,void 0,void 0,(function*(){if(this._channels.has(e))return this._channels.get(e);if(this.localCacheEnabled){const t=yield this.collection.getByKey(e);if(t){const s=this._deserialize(t);return this._channels.set(e,s),s}}}))}fetch({token:e,limit:t=u.DEFAULT_GROUPCHANNEL_LIMIT,backward:s=!1,filter:n=new g,order:i=c.GroupChannelListOrder.LATEST_LAST_MESSAGE,borderlineChannelUrl:a}){return d.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const r={where:t=>{if(e)switch(i){case c.GroupChannelListOrder.CHANNEL_NAME_ALPHABETICAL:if(!s&&t.name.localeCompare(e)<0||s&&t.name.localeCompare(e)>0)return!1;if(a&&a===t.url)return!1;break;case c.GroupChannelListOrder.CHRONOLOGICAL:if(!s&&t.createdAt>e||s&&t.createdAt<e)return!1;if(a&&a===t.url)return!1;break;case c.GroupChannelListOrder.LATEST_LAST_MESSAGE:if(!s&&t.lastMessageUpdatedAt>e||s&&t.lastMessageUpdatedAt<e)return!1;if(a&&a===t.url)return!1}return n.match(this._deserialize(t),this._sdkState.userId)},index:c.getGroupChannelIndexBy(i),backward:s},o=yield this.collection.query(r),l=(yield o.fetch({limit:t})).map((e=>this._deserialize(e)));return l.forEach((e=>{this._channels.has(e.url)||this._channels.set(e.url,e)})),l}return[]}))}upsert(e,t){return d.__awaiter(this,void 0,void 0,(function*(){const s=[];if(e.forEach((e=>{if(this._channels.has(e.url)){const n=this._channels.get(e.url);n._pinnedMessagesUpdatedAt<e._pinnedMessagesUpdatedAt&&(n._pinnedMessagesUpdatedAt=e._pinnedMessagesUpdatedAt),e.cachedMetaData&&t&&(n._updateCachedMetaData(e.cachedMetaData,t),Object.assign(e,{_cachedMetaData:void 0})),n._update(e),s.push(n)}else this._channels.set(e.url,e),s.push(e)})),this.localCacheEnabled){const e=[];for(const t in s)e.push(this._serialize(s[t],parseInt(t)));yield this.collection.upsertMany(e)}return s}))}remove(e){return d.__awaiter(this,void 0,void 0,(function*(){for(const t of e)this._channels.delete(t),this.localCacheEnabled&&(yield this.collection.remove(t))}))}clear(){return d.__awaiter(this,void 0,void 0,(function*(){this.clearMemoryCache(),this.localCacheEnabled&&(yield this.collection.clear())}))}clearMemoryCache(){this._channels.clear()}_setBlockStateOfAllChannels(e,t,s){return d.__awaiter(this,void 0,void 0,(function*(){const n=[];if(e===this._sdkState.userId){for(const e of this._channels.values())for(const i of e.members)if(i.userId===t){i.isBlockedByMe=s,n.push(e);break}}else if(t===this._sdkState.userId)for(const t of this._channels.values())for(const i of t.members)if(i.userId===e){i.isBlockingMe=s,n.push(t);break}n.length>0&&(yield this.upsert(n))}))}block(e,t){return d.__awaiter(this,void 0,void 0,(function*(){yield this._setBlockStateOfAllChannels(e,t,!0)}))}unblock(e,t){return d.__awaiter(this,void 0,void 0,(function*(){yield this._setBlockStateOfAllChannels(e,t,!1)}))}markAsRead(e,t=[...this._channels.keys()]){return d.__awaiter(this,void 0,void 0,(function*(){const s=[];for(const n of t){const t=yield this.get(n);(null==t?void 0:t._updateUnreadMemberState(this._sdkState.userId,e))&&(t._updateUnreadCount(0,0),s.push(t))}s.length>0&&(yield this.upsert(s))}))}}const v={invitedUserIds:void 0,channelUrl:void 0,coverUrl:void 0,coverImage:void 0,isDistinct:void 0,isSuper:void 0,isBroadcast:void 0,isExclusive:void 0,isPublic:void 0,isDiscoverable:void 0,isStrict:void 0,isEphemeral:void 0,accessCode:void 0,name:void 0,data:void 0,customType:void 0,operatorUserIds:void 0,messageSurvivalSeconds:void 0},f=e=>d.isArrayOf("string",e.invitedUserIds,!0)&&d.isTypeOf("string",e.channelUrl,!0)&&d.isTypeOf("string",e.coverUrl,!0)&&(d.isFile(e.coverImage)||d.isTypeOf("string",e.coverImage,!0))&&d.isTypeOf("boolean",e.isDistinct,!0)&&d.isTypeOf("boolean",e.isSuper,!0)&&d.isTypeOf("boolean",e.isBroadcast,!0)&&d.isTypeOf("boolean",e.isExclusive,!0)&&d.isTypeOf("boolean",e.isPublic,!0)&&d.isTypeOf("boolean",e.isStrict,!0)&&d.isTypeOf("boolean",e.isDiscoverable,!0)&&d.isTypeOf("boolean",e.isEphemeral,!0)&&d.isTypeOf("string",e.accessCode,!0)&&d.isTypeOf("string",e.name,!0)&&d.isTypeOf("string",e.data,!0)&&d.isTypeOf("string",e.customType,!0)&&d.isArrayOf("string",e.operatorUserIds,!0)&&d.isTypeOf("number",e.messageSurvivalSeconds,!0),M={customTypes:void 0,includeEmpty:!1,includeFrozen:!0,includeChatNotification:!1},S=e=>d.isArrayOf("string",e.customTypes,!0)&&d.isTypeOf("boolean",e.includeEmpty)&&d.isTypeOf("boolean",e.includeFrozen)&&d.isTypeOf("boolean",e.includeChatNotification),y={myMemberStateFilter:exports.MyMemberStateFilter.ALL},A=e=>d.isEnumOf(exports.MyMemberStateFilter,e.myMemberStateFilter);var b;exports.UnreadItemKey=void 0,(b=exports.UnreadItemKey||(exports.UnreadItemKey={})).GROUP_CHANNEL_UNREAD_MENTION_COUNT="group_channel_unread_mention_count",b.NONSUPER_UNREAD_MENTION_COUNT="non_super_group_channel_unread_mention_count",b.SUPER_UNREAD_MENTION_COUNT="super_group_channel_unread_mention_count",b.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT="group_channel_unread_message_count",b.NONSUPER_UNREAD_MESSAGE_COUNT="non_super_group_channel_unread_message_count",b.SUPER_UNREAD_MESSAGE_COUNT="super_group_channel_unread_message_count",b.GROUP_CHANNEL_INVITATION_COUNT="group_channel_invitation_count",b.NONSUPER_INVITATION_COUNT="non_super_group_channel_invitation_count",b.SUPER_INVITATION_COUNT="super_group_channel_invitation_count";const N={keys:[]},T={channelCustomTypesFilter:void 0,superChannelFilter:exports.SuperChannelFilter.ALL},U=e=>d.isArrayOf("string",e.channelCustomTypesFilter,!0)&&d.isEnumOf(exports.SuperChannelFilter,e.superChannelFilter),I={channelUrl:void 0,scheduledStatus:void 0,messageTypeFilter:d.MessageTypeFilter.ALL},P=Object.assign({},d.CollectionEventSource),x=e=>e.startsWith("EVENT_")||e===d.CollectionEventSource.SYNC_CHANNEL_CHANGELOGS||e===d.CollectionEventSource.REFRESH_CHANNEL;class O extends d.BaseCommand{constructor({channels:e,source:t,isWebSocketEventComing:s=!1,data:n=null,ts:i}){super(),this.channels=e,this.source=t,this.isWebSocketEventComing=s,this.data=n,this.ts=i}}class R extends d.BaseCommand{constructor({channelUrls:e,source:t,isWebSocketEventComing:s=!1}){super(),this.channelUrls=e,this.source=t,this.isWebSocketEventComing=s}}class w{constructor({groupChannelCache:e,messageCache:t,unsentMessageCache:s,dispatcher:n}){this._observers=new Map,n.on((n=>d.__awaiter(this,void 0,void 0,(function*(){if(n instanceof O){const{channels:s,source:i,isWebSocketEventComing:a,data:r}=n,o=s.filter((e=>e instanceof Lt)),l=e.filterOffsetChanged(o);for(const e of l)yield t.removeUnderOffset(e.url,e.messageOffsetTimestamp);const d=yield e.upsert(o,n.ts);a||this._broadcastUpdateEvent(d,i,r)}else if(n instanceof R){const{channelUrls:i,source:a,isWebSocketEventComing:r}=n;yield e.remove(i),yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of i)yield t.removeMessagesOfChannel(e),yield s.removeMessagesOfChannel(e)})))),r||this._broadcastRemoveEvent(i,a)}else n instanceof c.DatabaseOpenCommand&&(yield e.fetch({token:Number.MAX_SAFE_INTEGER,limit:Number.MAX_SAFE_INTEGER}))}))))}_broadcastUpdateEvent(e,t,s){for(const n of this._observers.values())n.onUpdate&&n.onUpdate(e,t,s)}_broadcastRemoveEvent(e,t){for(const s of this._observers.values())s.onRemove&&s.onRemove(e,t)}subscribe(e,t){this._observers.set(e,t)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}class D extends d.APIRequestCommand{constructor({userId:e,ts:t,token:s,filter:n,includeChatNotification:i=!1}){super();const{customTypes:a,includeEmpty:r,includeFrozen:o}=Object.assign(Object.assign({},M),n);this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/my_group_channels/changelogs`,this.params=d.deundefined(d.undefineNullProps({show_delivery_receipt:!0,show_member:!0,show_read_receipt:!0,change_ts:t||null,token:s,custom_types:a,show_empty:r,show_frozen:o,include_chat_notification:i}))}}class L extends d.APIResponseCommand{constructor(e,t){super(e,t),this.updatedChannels=t.updated.map((s=>new Lt(e,Object.assign(s,{ts:t.ts})))),this.deletedChannelUrls=t.deleted,this.hasMore=t.has_more,this.token=t.next,this.ts=t.ts}}class F extends d.APIRequestCommand{constructor({channelUrl:e,isInternalCall:t}){super(),this.method=d.APIRequestMethod.GET,this.path=`${t?d.API_PATH_GROUP_CHANNELS_INTERNAL:d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}`,this.params={show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0}}}class k extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Lt(e,t)}}const H={includeEmpty:!1,includeFrozen:!0,includeMetaData:!0,includeChatNotification:!1,channelUrlsFilter:void 0,customTypesFilter:void 0,customTypeStartsWithFilter:void 0,nicknameContainsFilter:void 0,nicknameStartsWithFilter:void 0,nicknameExactMatchFilter:void 0,channelNameContainsFilter:void 0,myMemberStateFilter:exports.MyMemberStateFilter.ALL,unreadChannelFilter:exports.UnreadChannelFilter.ALL,superChannelFilter:exports.SuperChannelFilter.ALL,publicChannelFilter:exports.PublicChannelFilter.ALL,hiddenChannelFilter:exports.HiddenChannelFilter.ALL,userIdsFilter:{userIds:[],includeMode:!0,queryType:exports.QueryType.AND},searchFilter:{query:void 0,fields:[]},metadataKey:void 0,metadataValues:void 0,metadataOrderKeyFilter:void 0,metadataValueStartsWith:void 0,order:c.GroupChannelListOrder.LATEST_LAST_MESSAGE};class V extends d.APIRequestCommand{constructor(e){const{userId:t,token:s,limit:n,order:i,includeEmpty:a,myMemberStateFilter:r,superChannelFilter:o,publicChannelFilter:l,unreadChannelFilter:h,nicknameContainsFilter:c,nicknameStartsWithFilter:u,nicknameExactMatchFilter:_,channelNameContainsFilter:p,channelUrlsFilter:m,customTypesFilter:C,customTypeStartsWithFilter:g,hiddenChannelFilter:E,metadataOrderKeyFilter:v,metadataKey:f,metadataValues:M,metadataValueStartsWith:S,includeFrozen:y,includeMetaData:A,searchFilter:b,userIdsFilter:N,includeChatNotification:T=!1}=e;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(t)}/my_group_channels`,this.params=d.deundefined({token:s,limit:n,order:null!=i?i:H.order,show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0,show_empty:null!=a?a:H.includeEmpty,member_state_filter:null!=r?r:H.myMemberStateFilter,super_mode:null!=o?o:H.superChannelFilter,public_mode:null!=l?l:H.publicChannelFilter,unread_filter:null!=h?h:H.unreadChannelFilter,members_nickname_contains:c,members_nickname_startswith:u,members_nickname:_,name_contains:p,channel_urls:m,custom_types:C,custom_type_startswith:g,hidden_mode:E,metadata_order_key:v,metadata_key:f,metadata_values:M,metadata_value_startswith:S,show_frozen:y,show_metadata:A,include_chat_notification:T}),b&&b.query&&b.fields&&(this.params.search_query=b.query,this.params.search_fields=b.fields),N&&N.userIds&&N.userIds.length>0&&(N.includeMode?(this.params.members_include_in=N.userIds,this.params.query_type=N.queryType.toUpperCase()):this.params.members_exactly_in=N.userIds)}}class G extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channels=[];const{next:s,channels:n,ts:i}=t;this.token=s,n&&n.length>0&&(this.channels=n.map((t=>(t.ts=i,new Lt(e,t))))),this.ts=null!=i?i:0}}class q extends d.APIRequestCommand{constructor({userId:e,filter:t}){super();const{myMemberStateFilter:s}=t;this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/group_channel_count`,this.params={state:null!=s?s:exports.MyMemberStateFilter.ALL}}}class B extends d.APIResponseCommand{constructor(e,t){super(e,t),this.groupChannelCount=t.group_channel_count}}class j extends d.APIRequestCommand{constructor({userId:e,filter:t}){super();const{keys:s}=t;this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/unread_item_count`,this.params=d.deundefined({item_keys:s})}}class W extends d.APIResponseCommand{constructor(e,t){super(e,t),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT]&&(this.groupChannelUnreadMentionCount=t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT]&&(this.groupChannelUnreadMessageCount=t[exports.UnreadItemKey.GROUP_CHANNEL_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT]&&(this.groupChannelInvitationCount=t[exports.UnreadItemKey.GROUP_CHANNEL_INVITATION_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT]&&(this.superGroupChannelUnreadMentionCount=t[exports.UnreadItemKey.SUPER_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT]&&(this.superGroupChannelUnreadMessageCount=t[exports.UnreadItemKey.SUPER_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.SUPER_INVITATION_COUNT]&&(this.superGroupChannelInvitationCount=t[exports.UnreadItemKey.SUPER_INVITATION_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT]&&(this.nonSuperGroupChannelUnreadMentionCount=t[exports.UnreadItemKey.NONSUPER_UNREAD_MENTION_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT]&&(this.nonSuperGroupChannelUnreadMessageCount=t[exports.UnreadItemKey.NONSUPER_UNREAD_MESSAGE_COUNT]),"number"==typeof t[exports.UnreadItemKey.NONSUPER_INVITATION_COUNT]&&(this.nonSuperGroupChannelInvitationCount=t[exports.UnreadItemKey.NONSUPER_INVITATION_COUNT])}}class $ extends d.APIRequestCommand{constructor({userId:e}){super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/unread_channel_count`}}class z extends d.APIResponseCommand{constructor(e,t){super(e,t),this.unreadCount=t.unread_count}}class Q extends d.APIRequestCommand{constructor({userId:e,filter:t,includeFeedChannel:s=!1}){super();const{channelCustomTypesFilter:n,superChannelFilter:i}=t;this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/unread_message_count`,this.params={super_mode:null!=i?i:exports.SuperChannelFilter.ALL,custom_types:n,include_feed_channel:s}}}class K extends d.APIResponseCommand{constructor(e,t){super(e,t),this.unreadCount=t.unread_count,this.unreadFeedCount=t.unread_feed_count}}class Y extends d.APIRequestCommand{constructor({channelUrl:e,scheduledStatus:t,messageTypeFilter:s}){super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_SCHEDULED_MESSAGES}/count`,this.params={channel_url:e,status:Z(t)},s&&(this.params.message_type=s)}}class J extends d.APIResponseCommand{constructor(e,t){super(e,t),this.count=t.count}}const Z=e=>{if(!e)return[];const t=[];return e.forEach((e=>{switch(e){case u.ScheduledStatus.PENDING:t.push(u.InternalScheduledStatus.PENDING);break;case u.ScheduledStatus.SENT:t.push(u.InternalScheduledStatus.IN_QUEUE),t.push(u.InternalScheduledStatus.SENT);break;case u.ScheduledStatus.CANCELED:t.push(u.InternalScheduledStatus.CANCELED);break;case u.ScheduledStatus.FAILED:t.push(u.InternalScheduledStatus.FAILED)}})),t};class X extends d.APIRequestCommand{constructor(e){const{userId:t,channelUrl:s,coverUrl:n,coverImage:i,isDistinct:a,isSuper:r,isBroadcast:o,isPublic:l,isExclusive:h,isDiscoverable:c,isStrict:u,isEphemeral:_,accessCode:p,name:m,data:C,customType:g,messageSurvivalSeconds:E,invitedUserIds:v,operatorUserIds:f}=e;super(),this.method=d.APIRequestMethod.POST,this.path=d.API_PATH_GROUP_CHANNELS,this.params=d.deundefined({user_ids:[t,...null!=v?v:[]].filter(((e,t,s)=>t===s.indexOf(e))),channel_url:s,cover_url:n,cover_file:i,is_distinct:a,is_super:r,is_broadcast:o,is_exclusive:h,is_public:l,is_discoverable:c,strict:u,is_ephemeral:_,access_code:p,name:m,data:C,custom_type:g,operator_ids:f,message_survival_seconds:E})}}class ee extends d.APIResponseCommand{constructor(e,t){var s;super(e,t),this.channel=new Lt(e,t),this.isCreated=null===(s=t.is_created)||void 0===s||s}}class te extends d.APIRequestCommand{constructor({userId:e,channelUrls:t}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/mark_as_read_all`,this.params={channel_urls:t}}}class se extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,accessCode:n}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/join`,this.params={user_id:s,access_code:n}}}class ne extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Lt(e,t)}}class ie extends _.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n=0,joined_member_count:i=0,users:a=null}=s.data;this.memberCount=n,this.joinedMemberCount=i,this.members=Array.isArray(a)?a.map((t=>new m(e,t))):[new m(e,s.data)]}}class ae extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,shouldRemoveOperatorStatus:n}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/leave`,this.params={user_id:s,should_remove_operator_status:n}}}class re extends _.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n=0,joined_member_count:i=0}=s.data;this.memberCount=n,this.joinedMemberCount=i,this.member=new m(this._iid,s.data)}}class oe extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userIds:s}=e;super(),this.method=d.APIRequestMethod.POST,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/invite`,this.params={user_ids:s}}}class le extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Lt(e,t)}}class de extends _.ChannelEventCommand{constructor(e,t,s){super(e,t,s),this.inviter=null;const{member_count:n=0,joined_member_count:i=0,inviter:a,invitees:r=[]}=s.data;this.memberCount=n,this.joinedMemberCount=i,a&&Object.keys(a).length>0&&(this.inviter=new d.User(e,a)),this.invitees=r.map((t=>new m(e,t)))}}class he extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/decline`,this.params={user_id:s}}}class ce extends _.ChannelEventCommand{constructor(e,t,s){super(e,t,s);const{member_count:n,joined_member_count:i,inviter:a,invitee:r}=s.data;this.memberCount=null!=n?n:0,this.joinedMemberCount=null!=i?i:0,this.inviter=new d.User(e,a),this.invitee=new m(e,r)}}const ue={hidePreviousMessages:!1,allowAutoUnhide:!0};class _e extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,hidePreviousMessages:n,allowAutoUnhide:i}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/hide`,this.params={user_id:s,hide_previous_messages:null!=n?n:ue.hidePreviousMessages,allow_auto_unhide:null!=i?i:ue.allowAutoUnhide}}}class pe extends d.APIResponseCommand{constructor(e,t){super(e,t);const{ts_message_offset:s}=t;this.messageOffsetTimestamp=s}}class me extends d.WebSocketEventCommand{constructor(e,t,s){var n,i,a;super(e,"SYEV",s),this.allowAutoUnhide=null,this.hidePreviousMessages=null,this.messageOffsetTimestamp=null,s.data&&(this.allowAutoUnhide=null!==(n=s.data.allow_auto_unhide)&&void 0!==n?n:null,this.hidePreviousMessages=null!==(i=s.data.hide_previous_messages)&&void 0!==i?i:null),this.messageOffsetTimestamp=null!==(a=s.ts_message_offset)&&void 0!==a?a:null}}class Ce extends d.WebSocketRequestCommand{constructor({channelUrl:e,time:t}){super({code:"TPST",ackRequired:!1,payload:{channel_url:e,time:t}})}}class ge extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new d.User(e,s.data)}}class Ee extends d.WebSocketRequestCommand{constructor({channelUrl:e,time:t}){super({code:"TPEN",ackRequired:!1,payload:{channel_url:e,time:t}})}}class ve extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"SYEV",s),this.user=new d.User(e,s.data)}}class fe extends d.WebSocketRequestCommand{constructor({channelUrl:e,messageId:t}){super({code:"MACK",ackRequired:!1,payload:{channel_url:e,msg_id:t}})}}class Me extends d.BaseListQuery{constructor(e,t){var s,n,i,a,r,o,l,d,h,u,_,p,m,C,g,E,v,f,M,S,y,A,b;super(e,t),this.includeEmpty=!1,this.includeFrozen=!0,this.includeMetaData=!0,this.includeChatNotification=!1,this.channelUrlsFilter=null,this.customTypesFilter=null,this.customTypeStartsWithFilter=null,this.nicknameContainsFilter=null,this.nicknameStartsWithFilter=null,this.nicknameExactMatchFilter=null,this.channelNameContainsFilter="",this.myMemberStateFilter=exports.MyMemberStateFilter.ALL,this.unreadChannelFilter=exports.UnreadChannelFilter.ALL,this.superChannelFilter=exports.SuperChannelFilter.ALL,this.publicChannelFilter=exports.PublicChannelFilter.ALL,this.hiddenChannelFilter=exports.HiddenChannelFilter.UNHIDDEN,this.searchFilter={fields:[],query:null},this.userIdsFilter={userIds:[],includeMode:!0,queryType:exports.QueryType.AND},this.metadataKey=null,this.metadataValues=null,this.metadataOrderKeyFilter=null,this.metadataValueStartsWith=null,this.order=c.GroupChannelListOrder.LATEST_LAST_MESSAGE,this.includeEmpty=null!==(s=t.includeEmpty)&&void 0!==s&&s,this.includeFrozen=null===(n=t.includeFrozen)||void 0===n||n,this.includeMetaData=null===(i=t.includeMetaData)||void 0===i||i,this.includeChatNotification=null!==(a=t.includeChatNotification)&&void 0!==a&&a,this.channelUrlsFilter=null!==(r=t.channelUrlsFilter)&&void 0!==r?r:null,this.customTypesFilter=null!==(o=t.customTypesFilter)&&void 0!==o?o:null,this.customTypeStartsWithFilter=null!==(l=t.customTypeStartsWithFilter)&&void 0!==l?l:"",this.nicknameContainsFilter=null!==(d=t.nicknameContainsFilter)&&void 0!==d?d:null,this.nicknameStartsWithFilter=null!==(h=t.nicknameStartsWithFilter)&&void 0!==h?h:null,this.nicknameExactMatchFilter=null!==(u=t.nicknameExactMatchFilter)&&void 0!==u?u:null,this.channelNameContainsFilter=null!==(_=t.channelNameContainsFilter)&&void 0!==_?_:"",this.myMemberStateFilter=null!==(p=t.myMemberStateFilter)&&void 0!==p?p:exports.MyMemberStateFilter.ALL,this.unreadChannelFilter=null!==(m=t.unreadChannelFilter)&&void 0!==m?m:exports.UnreadChannelFilter.ALL,this.superChannelFilter=null!==(C=t.superChannelFilter)&&void 0!==C?C:exports.SuperChannelFilter.ALL,this.publicChannelFilter=null!==(g=t.publicChannelFilter)&&void 0!==g?g:exports.PublicChannelFilter.ALL,this.hiddenChannelFilter=null!==(E=t.hiddenChannelFilter)&&void 0!==E?E:exports.HiddenChannelFilter.UNHIDDEN,this.searchFilter=null!==(v=t.searchFilter)&&void 0!==v?v:{fields:[],query:null},this.userIdsFilter=null!==(f=t.userIdsFilter)&&void 0!==f?f:{userIds:[],includeMode:!0,queryType:exports.QueryType.AND},this.metadataKey=null!==(M=t.metadataKey)&&void 0!==M?M:null,this.metadataValues=null!==(S=t.metadataValues)&&void 0!==S?S:null,this.metadataOrderKeyFilter=null!==(y=t.metadataOrderKeyFilter)&&void 0!==y?y:null,this.metadataValueStartsWith=null!==(A=t.metadataValueStartsWith)&&void 0!==A?A:null,this.order=null!==(b=t.order)&&void 0!==b?b:c.GroupChannelListOrder.LATEST_LAST_MESSAGE}_validate(){return super._validate()&&d.isTypeOf("boolean",this.includeEmpty)&&d.isTypeOf("boolean",this.includeFrozen)&&d.isTypeOf("boolean",this.includeMetaData)&&d.isTypeOf("string",this.channelNameContainsFilter)&&d.isArrayOf("string",this.channelUrlsFilter,!0)&&d.isArrayOf("string",this.customTypesFilter,!0)&&d.isTypeOf("string",this.customTypeStartsWithFilter)&&d.isTypeOf("string",this.nicknameContainsFilter,!0)&&d.isTypeOf("string",this.nicknameStartsWithFilter,!0)&&d.isTypeOf("string",this.nicknameExactMatchFilter,!0)&&d.isEnumOf(exports.MyMemberStateFilter,this.myMemberStateFilter)&&d.isEnumOf(exports.SuperChannelFilter,this.superChannelFilter)&&d.isEnumOf(exports.PublicChannelFilter,this.publicChannelFilter)&&d.isEnumOf(exports.UnreadChannelFilter,this.unreadChannelFilter)&&d.isEnumOf(exports.HiddenChannelFilter,this.hiddenChannelFilter)&&d.isArrayOf(exports.GroupChannelSearchField,this.searchFilter.fields)&&d.isTypeOf("string",this.searchFilter.query,!0)&&d.isArrayOf("string",this.userIdsFilter.userIds)&&d.isTypeOf("boolean",this.userIdsFilter.includeMode)&&d.isEnumOf(exports.QueryType,this.userIdsFilter.queryType)&&d.isEnumOf(c.GroupChannelListOrder,this.order)&&d.isTypeOf("string",this.metadataOrderKeyFilter,!0)&&d.isTypeOf("string",this.metadataKey,!0)&&d.isArrayOf("string",this.metadataValues,!0)&&d.isTypeOf("string",this.metadataValueStartsWith,!0)}serialize(){return d.serialize(this)}next(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw d.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const e=Ue.of(this._iid),{channels:t,token:s}=yield e.getMyGroupChannels(this._token,d.undefineNullProps(Object.assign({},this)),this.limit);return this._token=s,this._hasNext=!!s,this._isLoading=!1,t}return[]}throw d.SendbirdError.invalidParameters}))}}class Se extends d.WebSocketEventCommand{constructor(e,t,s){var n;super(e,"SYEV",s),this.pinnedMessageIds=[],this.latestPinnedMessage=null,this.ts=0,s.data&&(this.pinnedMessageIds=null!==(n=s.data.pinned_message_ids)&&void 0!==n?n:[],this.latestPinnedMessage=s.data.latest_pinned_message?u.parseMessagePayload(e,Object.assign({},s.data.latest_pinned_message)):null),this.ts=s.ts}}class ye extends d.WebSocketRequestCommand{constructor({channelUrl:e}){super({code:"READ",ackRequired:!0,payload:{channel_url:e}})}}class Ae extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"READ",s),this.readStatus=new C(e,s)}}class be extends d.APIRequestCommand{constructor({channelUrl:e,userId:t}){super(),super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}/messages/mark_as_delivered`,this.params=d.deundefined({userId:t})}}class Ne extends d.WebSocketEventCommand{constructor(e,t,s){super(e,"DLVR",s),this.channelUrl=s.channel_url,this.deliveredStateUpdate=s.updated}}const Te={};class Ue extends _.BaseChannelManager{constructor(e,t){var s;super(e,Object.assign(Object.assign({},t),{channelType:d.ChannelType.GROUP})),this._leftChannels=new Map,this._disableMack=!1,this._markAsReadAllLastSentAt=0,this._disableMack=null!==(s=t.disableMack)&&void 0!==s&&s,this._groupChannelHandlers=new Map,this._groupChannelCache=new E(this._iid,{sdkState:t.sdkState,cacheContext:t.cacheContext}),this._groupChannelBroadcast=new w({dispatcher:t.dispatcher,groupChannelCache:this._groupChannelCache,messageCache:u.MessageCache.of(this._iid),unsentMessageCache:u.UnsentMessageCache.of(this._iid)}),setInterval((()=>{for(const e of this._groupChannelCache.channels)e.invalidateTypingStatus()&&(this._dispatcher.dispatch(new O({channels:[e],source:d.CollectionEventSource.EVENT_CHANNEL_TYPING_STATUS_UPDATE})),this._groupChannelHandlers.forEach((t=>{t.onTypingStatusUpdated&&t.onTypingStatusUpdated(e)})))}),1e3),this._dispatcher.on((e=>{e instanceof d.WebSocketEventCommand?this._handleEvent(e):e instanceof c.AutoResendRequestCommand?(()=>{d.__awaiter(this,void 0,void 0,(function*(){const{message:t}=e,s=yield this.getChannel(t.channelUrl,!0);t instanceof u.UserMessage?s._autoResendUserMessage(t):t instanceof u.FileMessage&&s._autoResendFileMessage(t)}))})():e instanceof c.ReduceDBSizeEventCommand&&this.reduceDBSize()})),Te[e]||(Te[e]=this)}static of(e){return Te[e]||(Te[e]=new Ue(e,d.Vault.of(e))),Te[e]}static clear(e){Te[e]&&delete Te[e]}get handlers(){return[...this._groupChannelHandlers.values()]}buildGroupChannelFromSerializedData(e){const t=d.deserialize(e);return new Lt(this._iid,Lt.payloadify(t))}buildGroupChannelListQueryFromSerializedData(e){const t=d.deserialize(e);return new Me(this._iid,t)}buildMemberFromSerializedData(e){const t=d.deserialize(e);return new m(this._iid,m.payloadify(t))}getChannelFromCache(e){var t;return d.__awaiter(this,void 0,void 0,(function*(){return null!==(t=yield this._groupChannelCache.get(e))&&void 0!==t?t:null}))}getChannelsFromCache(e,t,s,n,i){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannelCache.fetch({token:e,filter:t,order:s,limit:n,borderlineChannelUrl:i})}))}upsertChannelsToCache(e){return d.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannelCache.upsert(e)}))}removeChannelsFromCache(e){return d.__awaiter(this,void 0,void 0,(function*(){yield this._groupChannelCache.remove(e)}))}clearChannelsFromCache(){return d.__awaiter(this,void 0,void 0,(function*(){yield this._groupChannelCache.clear()}))}reduceDBSize(){return d.__awaiter(this,void 0,void 0,(function*(){const e=u.MessageCache.of(this._iid),{cacheContext:t}=d.Vault.of(this._iid),{localCacheConfig:s,nestdb:n}=t;if(!t.localCacheEnabled||!n||n.state!=u.NestDBState.OPENED)return;const i=1024*s.maxSize*1024;let a=yield n.estimateUsage();if(a<i)return;const r=[],o=this._groupChannelCache.channels,l={};for(let e=0;e<o.length;e++){const t=yield this.getMessagesFromCache(o[e].url,0,"prev",new u.MessageFilter);l[o[e].url]=JSON.stringify(t).length;const s=new d.CachedChannelInfo({channel:o[e],cachedMessageCount:t.length});r.push(s)}const h=r.sort(s.clearOrderComparator);for(let t=0;t<h.length;t++){yield e.removeMessagesOfChannel(h[t].channel.url);const s=yield e._getGroupChannelPreferenceSize(h[t].channel.url);if(a-=l[h[t].channel.url]+s,a<i)break}}))}_handleEvent(e){var t;return d.__awaiter(this,void 0,void 0,(function*(){try{switch(e.code){case"MESG":case"FILE":case"ADMM":case"BRDM":{let s=null;if("MESG"===e.code?s=e.as(h.UserMessageEventCommand):"FILE"===e.code?s=e.as(u.FileMessageEventCommand):"ADMM"!==e.code&&"BRDM"!=e.code||(s=e.as(_.AdminMessageEventCommand)),s){const{message:e,isMentioned:n,forceUpdateLastMessage:i}=s;if(e.channelType===d.ChannelType.GROUP){this._disableMack||d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const t=new fe(e);this._requestQueue.send(t)}))));const s=this._groupChannelCache.isCachedInMemory(e.channelUrl),a=e instanceof u.SendableMessage&&e.sender.userId===this._sdkState.userId,r=yield this.getChannel(e.channelUrl,!0);if(r.hiddenState===exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE&&(r.hiddenState=exports.HiddenState.UNHIDDEN),e instanceof u.SendableMessage){const{useMemberInfoInMessage:s}=d.Vault.of(this._iid);for(const t of r.members)if(t.userId===e.sender.userId){s||(e.sender.nickname=t.nickname,e.sender.plainProfileUrl=t.plainProfileUrl,e.sender.metaData=t.metaData,e.sender.isBlockedByMe=t.isBlockedByMe);break}if(!s&&n&&(null===(t=e.mentionedUsers)||void 0===t||t.forEach((e=>{for(const t of r.members)if(e.userId===t.userId){e.nickname=t.nickname,e.plainProfileUrl=t.plainProfileUrl,e.metaData=t.metaData;break}}))),a){const{currentUser:t}=this._sessionManager;t&&(t.nickname=e.sender.nickname,t.plainProfileUrl=e.sender.plainProfileUrl,t.metaData=e.sender.metaData)}}e.silent&&!a||(r.isEphemeral||s)&&((!r.lastMessage||r.lastMessage.createdAt<e.createdAt)&&(r.lastMessage=e),a||r._updateUnreadCount(r.unreadMessageCount+1,r.unreadMentionCount+(n?1:0))),i&&(!r.lastMessage||r.lastMessage.createdAt<e.createdAt)&&(r.lastMessage=e),this._dispatcher.dispatch(new O({channels:[r],source:d.CollectionEventSource.EVENT_MESSAGE_RECEIVED})),e.silent&&!a||d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(r)})))),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[e],source:d.CollectionEventSource.EVENT_MESSAGE_RECEIVED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageReceived&&t.onMessageReceived(r,e),n&&t.onMentionReceived&&t.onMentionReceived(r,e)}))))}}break}case"MEDI":case"FEDI":case"AEDI":{let t=null;if("MEDI"===e.code?t=e.as(h.UpdateUserMessageEventCommand):"FEDI"===e.code?t=e.as(h.UpdateFileMessageEventCommand):"AEDI"===e.code&&(t=e.as(_.UpdateAdminMessageEventCommand)),t){const{message:e,mentionCountChange:s}=t;if(e.channelType===d.ChannelType.GROUP){const t=this._groupChannelCache.isCachedInMemory(e.channelUrl),n=yield this.getChannel(e.channelUrl,!0),i=e instanceof u.SendableMessage&&e.sender.userId===this._sdkState.userId;let a=!1;if(i){const t=e.sender,{currentUser:s}=this._sessionManager;s&&(s.nickname=t.nickname,s.plainProfileUrl=t.plainProfileUrl,s.metaData=t.metaData)}else n.isReadMessage(e)||0!==s&&!e.silent&&t&&(n._updateUnreadCount(n.unreadMessageCount,n.unreadMentionCount+s),a=!0);!n.lastMessage||n.lastMessage.createdAt<e.createdAt?(n.lastMessage=e,a=!0):n.lastMessage.isIdentical(e)&&(t?n.lastMessage.updatedAt<e.updatedAt&&(n.lastMessage=e,a=!0):a=!0);let r=!1;n.lastPinnedMessage&&n.lastPinnedMessage.messageId===e.messageId&&(n.lastPinnedMessage=e,a=!0,r=!0),a&&(this._dispatcher.dispatch(new O({channels:[n],source:r?d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),e.silent&&!i||d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(n)})))),r&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(n)}))))),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[e],source:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageUpdated&&t.onMessageUpdated(n,e),0!==s&&t.onMentionReceived&&t.onMentionReceived(n,e)}))))}}break}case"DELM":{const{channelUrl:t,channelType:s,messageId:n}=e.as(h.DeleteMessageEventCommand);if(s===d.ChannelType.GROUP){const e=yield this.getChannel(t,!0);this._dispatcher.dispatch(new d.MessageRemoveEventCommand({messageIds:[n],source:d.CollectionEventSource.EVENT_MESSAGE_DELETED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onMessageDeleted&&t.onMessageDeleted(e,n)}))))}break}case"READ":{const{readStatus:t}=e.as(Ae);if(t.channelType===d.ChannelType.GROUP){const e=this._groupChannelCache.isCachedInMemory(t.channelUrl),s=yield this.getChannel(t.channelUrl,!0);e&&s._updateUnreadMemberState(t.reader.userId,t.readAt),t.reader.userId===this._sdkState.userId?e?(s.unreadMessageCount>0||s.unreadMentionCount>0)&&(s._updateUnreadCount(0,0),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_READ})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)}))))):0!==s.unreadMessageCount&&0!==s.unreadMentionCount||(this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_READ})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)}))))):(this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_READ})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onUnreadMemberStatusUpdated&&e.onUnreadMemberStatusUpdated(s)})))))}break}case"DLVR":{const{channelUrl:t,deliveredStateUpdate:s={}}=e.as(Ne),n=this._groupChannelCache.isCachedInMemory(t),i=yield this.getChannel(t,!0);if(n)for(const e in s)i._updateUndeliveredMemberState(e,s[e]);Object.keys(s).some((e=>e!==this._sdkState.userId))&&(this._dispatcher.dispatch(new O({channels:[i],source:d.CollectionEventSource.EVENT_CHANNEL_DELIVERED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onUndeliveredMemberStatusUpdated&&e.onUndeliveredMemberStatusUpdated(i)})))));break}case"MRCT":{const{channelUrl:t,channelType:s,event:n}=e.as(_.ReactionEventCommand);if(s===d.ChannelType.GROUP){const e=yield this.getChannel(t,!0),s=yield this.getMessageFromCache(n.messageId);s&&(s.applyReactionEvent(n),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[s],source:d.CollectionEventSource.EVENT_MESSAGE_REACTION_UPDATED}))),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const t of this._groupChannelHandlers.values())t.onReactionUpdated&&t.onReactionUpdated(e,n)}))))}break}case"MTHD":{const{event:t}=e.as(_.ThreadInfoUpdateEventCommand);if(t.channelType===d.ChannelType.GROUP){const e=yield this.getChannel(t.channelUrl,!0),s=yield this.getMessageFromCache(t.targetMessageId);s&&(s.applyThreadInfoUpdateEvent(t),this._dispatcher.dispatch(new d.MessageUpdateEventCommand({messages:[s],source:d.CollectionEventSource.EVENT_MESSAGE_THREADINFO_UPDATED}))),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onThreadInfoUpdated&&s.onThreadInfoUpdated(e,t)}))))}break}case"MCNT":{const{groupChannelMemberCounts:t}=e.as(_.MemberCountUpdateEventCommand),s=[];for(const e of t){const{channelUrl:t,memberCount:n,joinedMemberCount:i,updatedAt:a}=e,r=yield this.getChannelFromCache(t);r&&r._setLatestMemberCount(n,i,a)&&s.push(r)}s.length>0&&(this._dispatcher.dispatch(new O({channels:s,source:d.CollectionEventSource.EVENT_CHANNEL_MEMBER_COUNT_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged(s)})))));break}case"PEDI":{const{event:t,status:s,channelUrl:n,channelType:i}=e.as(_.PollUpdateEventCommand);if(n&&i===d.ChannelType.GROUP){const e=yield this.getChannel(n,!0);this._dispatcher.dispatch(new d.PollUpdateInternalEventCommand({event:t,source:d.CollectionEventSource.EVENT_POLL_UPDATED})),s===d.POLL_REMOVED_STATUS?d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollDeleted&&s.onPollDeleted(e,t.pollId)})))):d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollUpdated&&s.onPollUpdated(e,t)}))))}break}case"VOTE":{const{event:t,channelUrl:s,channelType:n}=e.as(h.PollVoteEventCommand);if(s&&n===d.ChannelType.GROUP){const e=yield this.getChannel(s,!0);this._dispatcher.dispatch(new d.PollVoteInternalEventCommand({event:t,source:d.CollectionEventSource.EVENT_POLL_VOTED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const s of this._groupChannelHandlers.values())s.onPollVoted&&s.onPollVoted(e,t)}))))}break}case"SYEV":{const{event:t}=e.as(_.ChannelEventCommand);if(t.isGroupChannelEvent)switch(t.category){case _.ChannelEventCategory.CHANNEL_JOIN:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,members:a}=e.as(ie);let r=!1;a.forEach((e=>{s.isExclusive||s.isSuper||s.isBroadcast?r=r||s._setLatestMemberCount(n,i,t.ts):(e.state=exports.MemberState.JOINED,s.addMember(e,t.ts),this._updateJoinedMemberCount(s)),e.userId===this._sdkState.userId&&(s.myMemberState=exports.MemberState.JOINED)})),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_JOINED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{for(const t of a)e.onUserJoined&&e.onUserJoined(s,t);s.isBroadcast&&r&&e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged([s])}))}))));break}case _.ChannelEventCategory.CHANNEL_LEAVE:{const s=this._leftChannels.get(t.channelUrl),n=s?s.channel:yield this.getChannel(t.channelUrl,!0),{memberCount:i,joinedMemberCount:a,member:r}=e.as(re);let o=!1;const{appInfo:l}=d.Vault.of(this._iid);if(n.isExclusive||n.isSuper||n.isBroadcast)o=n._setLatestMemberCount(i,a,t.ts);else{if(null==l?void 0:l.enabledChannelMemberShipHistory){const e=n.members.find((t=>t.userId===e.userId));e&&(e.state=exports.MemberState.LEFT),n.memberCount=i}else n.removeMember(r);this._updateJoinedMemberCount(n)}r.userId===this._sdkState.userId?(n.myMemberState=exports.MemberState.NONE,n.invitedAt=0,n.joinedAt=0,n._updateUnreadCount(0,0),n.isPublic?this._dispatcher.dispatch(new O({channels:[n],source:d.CollectionEventSource.EVENT_CHANNEL_LEFT})):(this._markAsLeave(n),this._dispatcher.dispatch(new R({channelUrls:[n.url],source:d.CollectionEventSource.EVENT_CHANNEL_LEFT})))):this._dispatcher.dispatch(new O({channels:[n],source:d.CollectionEventSource.EVENT_CHANNEL_LEFT})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserLeft&&e.onUserLeft(n,r),n.isBroadcast&&o&&e.onChannelMemberCountChanged&&e.onChannelMemberCountChanged([n])}))}))));break}case _.ChannelEventCategory.CHANNEL_OPERATOR_UPDATE:{const s=yield this.getChannel(t.channelUrl,!0),{operators:n}=e.as(_.OperatorUpdateEventCommand),i=n.map((e=>e.userId));for(const e of s.members)e.role=i.includes(e.userId)?d.Role.OPERATOR:d.Role.NONE;s.myRole=i.includes(this._sdkState.userId)?d.Role.OPERATOR:d.Role.NONE,this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_OPERATOR_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onOperatorUpdated&&e.onOperatorUpdated(s,n)}))}))));break}case _.ChannelEventCategory.CHANNEL_INVITE:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,inviter:a,invitees:r}=e.as(de);r.forEach((e=>e.state=exports.MemberState.INVITED));for(const e of r)s.isExclusive||s.isSuper||s.isBroadcast?s._setLatestMemberCount(n,i,t.ts):s.addMember(e,t.ts),this._sdkState.userId===e.userId&&(s.hiddenState=exports.HiddenState.UNHIDDEN,s.myMemberState!==exports.MemberState.JOINED&&(s.myMemberState=exports.MemberState.INVITED),s.invitedAt=t.ts);this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_INVITED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserReceivedInvitation&&e.onUserReceivedInvitation(s,a,r)}))}))));break}case _.ChannelEventCategory.CHANNEL_DECLINE_INVITE:{const s=yield this.getChannel(t.channelUrl,!0),{memberCount:n,joinedMemberCount:i,inviter:a,invitee:r}=e.as(ce);s.isExclusive||s.isSuper||s.isBroadcast?s._setLatestMemberCount(n,i,t.ts):s.removeMember(r),this._sdkState.userId===r.userId?(s.invitedAt=0,s.myMemberState=exports.MemberState.NONE,s.isPublic?this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE})):this._dispatcher.dispatch(new R({channelUrls:[s.url],source:d.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE}))):this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserDeclinedInvitation&&e.onUserDeclinedInvitation(s,a,r)}))}))));break}case _.ChannelEventCategory.TYPING_START:case _.ChannelEventCategory.TYPING_END:{const s=yield this.getChannel(t.channelUrl,!0),n=t.category===_.ChannelEventCategory.TYPING_START,{user:i}=e.as(n?ge:ve);s._updateTypingStatus(i,n?t.ts:0),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_TYPING_STATUS_UPDATE})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onTypingStatusUpdated&&e.onTypingStatusUpdated(s)}))}))));break}case _.ChannelEventCategory.USER_CHANNEL_MUTE:case _.ChannelEventCategory.USER_CHANNEL_UNMUTE:{const s=yield this.getChannel(t.channelUrl,!0),n=t.category===_.ChannelEventCategory.USER_CHANNEL_MUTE,{user:i}=e.as(n?h.MuteUserEventCommand:h.UnmuteUserEventCommand);i.userId===this._sdkState.userId&&(s.myMutedState=n?d.MutedState.MUTED:d.MutedState.UNMUTED,s._myMutedRemainingTime=i.restrictionInfo.remainingDuration);for(const e of s.members)if(e.userId===i.userId){e.isMuted=n;break}this._dispatcher.dispatch(new O({channels:[s],source:n?d.CollectionEventSource.EVENT_CHANNEL_MUTED:d.CollectionEventSource.EVENT_CHANNEL_UNMUTED,data:i.userId})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n?e.onUserMuted&&e.onUserMuted(s,i):e.onUserUnmuted&&e.onUserUnmuted(s,i)}))}))));break}case _.ChannelEventCategory.USER_CHANNEL_BAN:{const s=this._leftChannels.get(t.channelUrl),n=s?s.channel:yield this.getChannel(t.channelUrl,!0);this._markAsLeave(n);const{user:i}=e.as(h.BanUserEventCommand);i.userId===this._sdkState.userId&&this._dispatcher.dispatch(new R({channelUrls:[n.url],source:d.CollectionEventSource.EVENT_CHANNEL_BANNED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserBanned&&e.onUserBanned(n,i)}))}))));break}case _.ChannelEventCategory.USER_CHANNEL_UNBAN:{const s=yield this.getChannel(t.channelUrl,!0),{user:n}=e.as(h.UnbanUserEventCommand);n.userId===this._sdkState.userId&&this._dispatcher.dispatch(new R({channelUrls:[s.url],source:d.CollectionEventSource.EVENT_CHANNEL_UNBANNED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onUserUnbanned&&e.onUserUnbanned(s,n)}))}))));break}case _.ChannelEventCategory.CHANNEL_FREEZE:case _.ChannelEventCategory.CHANNEL_UNFREEZE:{const s=yield this.getChannel(t.channelUrl,!0),{freeze:n}=e.as(h.FreezeEventCommand);s.isFrozen=n,this._dispatcher.dispatch(new O({channels:[s],source:n?d.CollectionEventSource.EVENT_CHANNEL_FROZEN:d.CollectionEventSource.EVENT_CHANNEL_UNFROZEN})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n?e.onChannelFrozen&&e.onChannelFrozen(s):e.onChannelUnfrozen&&e.onChannelUnfrozen(s)}))}))));break}case _.ChannelEventCategory.CHANNEL_HIDE:{const s=yield this.getChannel(t.channelUrl,!0),{allowAutoUnhide:n,hidePreviousMessages:i,messageOffsetTimestamp:a}=e.as(me);null!==n&&(s.hiddenState=n?exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE:exports.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE),null!==i&&i&&s._updateUnreadCount(0,0),null!==a&&(s.messageOffsetTimestamp=a),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_HIDDEN})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onChannelHidden&&e.onChannelHidden(s)}))}))));break}case _.ChannelEventCategory.CHANNEL_UNHIDE:{const e=yield this.getChannel(t.channelUrl,!0);e.hiddenState=exports.HiddenState.UNHIDDEN,this._dispatcher.dispatch(new O({channels:[e],source:d.CollectionEventSource.EVENT_CHANNEL_UNHIDDEN})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelChanged&&t.onChannelChanged(e)}))}))));break}case _.ChannelEventCategory.CHANNEL_DELETED:{const e=yield this.getChannel(t.channelUrl,!0);this._dispatcher.dispatch(new R({channelUrls:[t.channelUrl],source:d.CollectionEventSource.EVENT_CHANNEL_DELETED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelDeleted&&t.onChannelDeleted(e.url,e.channelType)}))}))));break}case _.ChannelEventCategory.CHANNEL_PROP_CHANGED:{const e=yield this.getChannelWithoutCache(t.channelUrl,!0);this._dispatcher.dispatch(new O({channels:[e],source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((t=>{t.onChannelChanged&&t.onChannelChanged(e)}))}))));break}case _.ChannelEventCategory.CHANNEL_META_DATA_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{created:n,updated:i,deleted:a}=e.as(h.UpdateMetaDataEventCommand);n&&(s._upsertCachedMetaData(n,t.ts),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_METADATA_CREATED}))),i&&(s._upsertCachedMetaData(i,t.ts),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_METADATA_UPDATED}))),a&&(s._removeFromCachedMetaData(a,t.ts),this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_METADATA_DELETED}))),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n&&e.onMetaDataCreated&&e.onMetaDataCreated(s,n),i&&e.onMetaDataUpdated&&e.onMetaDataUpdated(s,i),a&&e.onMetaDataDeleted&&e.onMetaDataDeleted(s,a)}))}))));break}case _.ChannelEventCategory.CHANNEL_META_COUNTERS_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{created:n,updated:i,deleted:a}=e.as(h.UpdateMetaCounterEventCommand);n&&this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_METACOUNTER_CREATED})),i&&this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_METACOUNTER_UPDATED})),a&&this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_CHANNEL_METACOUNTER_DELETED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{n&&e.onMetaCounterCreated&&e.onMetaCounterCreated(s,n),i&&e.onMetaCounterUpdated&&e.onMetaCounterUpdated(s,i),a&&e.onMetaCounterDeleted&&e.onMetaCounterDeleted(s,a)}))}))));break}case _.ChannelEventCategory.PINNED_MESSAGE_CHANGED:{const s=yield this.getChannel(t.channelUrl,!0),{pinnedMessageIds:n,latestPinnedMessage:i,ts:a}=e.as(Se);a>s._pinnedMessagesUpdatedAt&&(s.pinnedMessageIds=n,s.lastPinnedMessage=i,s._pinnedMessagesUpdatedAt=a,this._dispatcher.dispatch(new O({channels:[s],source:d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED})),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){for(const e of this._groupChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(s)})))),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){this._groupChannelHandlers.forEach((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(s)}))})))));break}}break}case"USEV":{const{event:t}=e.as(c.UserEventCommand);switch(t.category){case c.UserEventCategory.USER_BLOCK:{const{blocker:e,blockee:s}=c.UserEvent.getDataAsUserBlockEvent(this._iid,t);this._groupChannelCache.block(e.userId,s.userId);break}case c.UserEventCategory.USER_UNBLOCK:{const{blocker:e,blockee:s}=c.UserEvent.getDataAsUserBlockEvent(this._iid,t);this._groupChannelCache.unblock(e.userId,s.userId);break}}break}}}catch(e){if(d.isThrowingOutside(e))throw e}}))}_markAsLeave(e){var t;const s=null!==(t=this._leftChannels.get(e.url))&&void 0!==t?t:{channel:e,ref:0};s.ref++,this._leftChannels.set(e.url,s),setTimeout((()=>{s.ref--,0===s.ref&&this._leftChannels.delete(e.url)}),1e4)}addHandler(e,t){this._groupChannelHandlers.set(e,t)}removeHandler(e){this._groupChannelHandlers.delete(e)}clearHandler(){this._groupChannelHandlers.clear()}subscribeChannelEvent(e,t){this._groupChannelBroadcast.subscribe(e,t)}unsubscribeChannelEvent(e){this._groupChannelBroadcast.unsubscribe(e)}_updateJoinedMemberCount(e){e.joinedMemberCount=e.members.filter((e=>e.state===exports.MemberState.JOINED)).length}getChannel(e,t=!1){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e)).throw(d.SendbirdError.invalidParameters);try{const t=yield this.getChannelFromCache(e);if(t)return t}catch(e){}return yield this.getChannelWithoutCache(e,t)}))}getChannelWithoutCache(e,t=!1){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e)).throw(d.SendbirdError.invalidParameters);const s=new F({channelUrl:e,isInternalCall:t}),n=yield this._requestQueue.send(s),{channel:i}=n.as(k);let{unreadMessageCount:a,unreadMentionCount:r}=i;switch(i.myCountPreference){case exports.CountPreference.UNREAD_MESSAGE_COUNT_ONLY:r=0;break;case exports.CountPreference.UNREAD_MENTION_COUNT_ONLY:a=0;break;case exports.CountPreference.OFF:a=0,r=0}return i._updateUnreadCount(a,r),(yield this.upsertChannelsToCache([i]))[0]}))}refreshChannel(e,t=!0,s=d.CollectionEventSource.REFRESH_CHANNEL){return d.__awaiter(this,void 0,void 0,(function*(){try{const n=new F({channelUrl:e,isInternalCall:t}),i=yield this._requestQueue.send(n),{channel:a}=i.as(k);if(a.myMemberState===exports.MemberState.NONE)this._dispatcher.dispatch(new R({channelUrls:[a.url],source:s}));else{const e=yield this.upsertChannelsToCache([a]);this._dispatcher.dispatch(new O({channels:e,source:s}))}}catch(t){t.code!==d.SendbirdErrorCode.NON_AUTHORIZED&&t.code!==d.SendbirdErrorCode.NOT_FOUND_IN_DATABASE||this._dispatcher.dispatch(new R({channelUrls:[e],source:s}))}}))}getMyGroupChannels(e,t,s,n=d.CollectionEventSource.REQUEST_CHANNEL){return d.__awaiter(this,void 0,void 0,(function*(){const i=new V(Object.assign(Object.assign({},t),{userId:this._sdkState.userId,token:e,limit:s})),a=yield this._requestQueue.send(i),{channels:r,token:o}=a.as(G);return this._dispatcher.dispatch(new O({channels:r,source:n})),{channels:r,token:o}}))}getMyGroupChannelChangeLogs(e,t,s=d.CollectionEventSource.REQUEST_CHANNEL_CHANGELOGS){return d.__awaiter(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},M),t);d.unless((d.isTypeOf("string",e)||d.isTypeOf("number",e))&&S(n)).throw(d.SendbirdError.invalidParameters);const i=new D(d.undefineNullProps({userId:this._sdkState.userId,ts:"number"==typeof e?e:null,token:"string"==typeof e?e:null,filter:n})),a=(yield this._requestQueue.send(i)).as(L),{updatedChannels:r,deletedChannelUrls:o,hasMore:l,ts:h}=a;return r.length>0&&this._dispatcher.dispatch(new O({channels:r,source:s,ts:h})),o.length>0&&this._dispatcher.dispatch(new R({channelUrls:o,source:s})),{updatedChannels:r,deletedChannelUrls:o,hasMore:l,token:a.token}}))}getGroupChannelCount(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},y),e);d.unless(A(t)).throw(d.SendbirdError.invalidParameters);const s=new q({userId:this._sdkState.userId,filter:t}),n=yield this._requestQueue.send(s),{groupChannelCount:i}=n.as(B);return i}))}getUnreadItemCount(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},N),e);d.unless((e=>d.isArrayOf(exports.UnreadItemKey,e.keys))(t)).throw(d.SendbirdError.invalidParameters);const{sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new j({userId:s.userId,filter:t}),a=yield n.send(i),{groupChannelUnreadMentionCount:r,groupChannelUnreadMessageCount:o,groupChannelInvitationCount:l,superGroupChannelUnreadMentionCount:h,superGroupChannelUnreadMessageCount:c,superGroupChannelInvitationCount:u,nonSuperGroupChannelUnreadMentionCount:_,nonSuperGroupChannelUnreadMessageCount:p,nonSuperGroupChannelInvitationCount:m}=a.as(W);return d.deundefined({groupChannelUnreadMentionCount:r,groupChannelUnreadMessageCount:o,groupChannelInvitationCount:l,superGroupChannelUnreadMentionCount:h,superGroupChannelUnreadMessageCount:c,superGroupChannelInvitationCount:u,nonSuperGroupChannelUnreadMentionCount:_,nonSuperGroupChannelUnreadMessageCount:p,nonSuperGroupChannelInvitationCount:m})}))}getTotalUnreadChannelCount(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new $({userId:e.userId}),n=yield t.send(s),{unreadCount:i}=n.as(z);return i}))}getTotalUnreadMessageCount(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},T),e);d.unless(U(t)).throw(d.SendbirdError.invalidParameters);const{sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new Q({userId:s.userId,filter:t}),a=yield n.send(i),{unreadCount:r}=a.as(K);return r}))}getTotalScheduledMessageCount(e={}){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},I),e);d.unless((e=>d.isTypeOf("string",e.channelUrl,!0)&&d.isArrayOf(u.ScheduledStatus,e.scheduledStatus,!0)&&d.isEnumOf(d.MessageTypeFilter,e.messageTypeFilter))(t)).throw(d.SendbirdError.invalidParameters);const{requestQueue:s}=d.Vault.of(this._iid),n=new Y(t),i=yield s.send(n),{count:a}=i.as(J);return a}))}getSubscribedTotalUnreadMessageCount(){const{subscribedUnreadMessageCount:e}=d.Vault.of(this._iid);return e.all>=0?e.all:0}getSubscribedCustomTypeTotalUnreadMessageCount(){let e=0;const{subscribedUnreadMessageCount:t}=d.Vault.of(this._iid);for(const s in t.customTypes)e+=t.customTypes[s];return e}getSubscribedCustomTypeUnreadMessageCount(e){var t;const{subscribedUnreadMessageCount:s}=d.Vault.of(this._iid);return null!==(t=s.customTypes[e])&&void 0!==t?t:0}createChannel(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},v),e);d.unless(f(t)).throw(d.SendbirdError.invalidParameters),t.isPublic||(t.accessCode=void 0);const s=new X(Object.assign({userId:this._sdkState.userId},t)),n=yield this._requestQueue.send(s),{channel:i}=n.as(ee);return yield this.upsertChannelsToCache([i]),i}))}markAsReadAll(){return d.__awaiter(this,void 0,void 0,(function*(){const e=Date.now();d.unless(e-this._markAsReadAllLastSentAt>=1e3).throw(d.SendbirdError.markAsReadAllRateLimitExceeded),this._markAsReadAllLastSentAt=e;const t=new te({userId:this._sdkState.userId});yield this._requestQueue.send(t);const s=this._groupChannelCache.channels;for(const t of s)t._updateUnreadMemberState(this._sdkState.userId,e),t._updateUnreadCount(0,0);s.length>0&&(yield this.upsertChannelsToCache(s))}))}markAsReadWithChannelUrls(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Date.now();d.unless(d.isArrayOf("string",e)&&t-this._markAsReadAllLastSentAt>=1e3).throw(d.SendbirdError.markAsReadAllRateLimitExceeded),this._markAsReadAllLastSentAt=t;const s=new te({userId:this._sdkState.userId,channelUrls:e});yield this._requestQueue.send(s);const n=this._groupChannelCache.channels,i=[];for(const s of n)e.includes(s.url)&&(s._updateUnreadMemberState(this._sdkState.userId,t),s._updateUnreadCount(0,0),i.push(s));i.length>0&&(yield this.upsertChannelsToCache(i))}))}markAsDelivered(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=yield this.getChannel(e);yield t.markAsDelivered()}))}}var Ie;!function(e){e[e.IDLE=0]="IDLE",e[e.RUNNING=1]="RUNNING",e[e.END=2]="END"}(Ie||(Ie={}));class Pe extends d.EventDispatcher{constructor(e,t,s=2,n=10){super(),this._state=Ie.IDLE,this._retryCount=0,this._retryLimit=3,this.priority=0,this._worker=t}get isIdle(){return this._state===Ie.IDLE}get isRunning(){return this._state===Ie.RUNNING}get isDone(){return this._state===Ie.END}get retryCount(){return this._retryCount}get retryLimit(){return this._retryLimit}_run(e){return d.__awaiter(this,void 0,void 0,(function*(){if(this.isRunning)try{const t=yield this._worker(e);this._retryCount=0,this.dispatch("progress",t),t.hasNext?this._run(t.nextToken):this.end()}catch(t){this.dispatch("error",t),this._retryCount<this._retryLimit?(this._retryCount++,this._run(e)):this.stop()}}))}start(e){this.isIdle&&(this._state=Ie.RUNNING,this._run(e))}stop(){this._state=Ie.IDLE,this.dispatch("stop")}end(){this._state=Ie.END,this.dispatch("end")}}const xe={};class Oe{constructor({_iid:e,channel:t,limit:s=100}){this.ref=0,this._iid=e,this._channel=t,this._limit=s,this._prevSyncLoopCount=0,this._nextSyncLoopCount=0;const{sdkState:n,dispatcher:i,logger:a}=d.Vault.of(this._iid);var r,o;this._metadataKey=(r=n.userId,o=t.url,`sendbird:${r}@groupchannel/${o}/message/sync.meta`);const l=((e,t)=>`sendbird:${e}@groupchannel/${t}/message/sync`)(n.userId,t.url);this._prevSync=new Pe(l,(e=>d.__awaiter(this,void 0,void 0,(function*(){var t,s,n,i,r;const o={hasNext:!0,nextToken:0};if(this._prevSyncLoopCount++,yield this.loadMetadata(e),a.debug("message background prev sync from",null===(t=this._metadata)||void 0===t?void 0:t.range.top),null===(s=this._metadata)||void 0===s?void 0:s.previousComplete)o.hasNext=!1;else try{const t=u.MessageManager.of(this._iid),s=yield t.getMessagesByTimestamp(this._channel.url,this._channel.channelType,(null===(i=null===(n=this._metadata)||void 0===n?void 0:n.range)||void 0===i?void 0:i.top)?this._metadata.range.top:e,{prevResultSize:this._limit,nextResultSize:0,replyType:d.ReplyType.ALL,includeReactions:!0,includeMetaArray:!0,includeParentMessageInfo:!0,includeThreadInfo:!0},d.CollectionEventSource.SYNC_MESSAGE_BACKGROUND);if(s.length>0){const e=s.map((e=>e.createdAt));(null===(r=this._metadata)||void 0===r?void 0:r.range.intersect(...e))?this.extendRange(s):this._metadata={range:new _.TimeRange({top:Math.min(...e),bottom:Math.max(...e)}),previousComplete:!1}}o.hasNext=s.length>=this._limit&&this._prevSyncLoopCount<1,this._metadata&&(o.nextToken=this._metadata.range.top,this._metadata.previousComplete=s.length<this._limit),a.debug("message background prev sync progress",o),yield this.saveMetadata()}catch(e){throw a.debug("message background prev sync error",e),e instanceof d.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return o})))),this._nextSync=new Pe(l,(e=>d.__awaiter(this,void 0,void 0,(function*(){var t,s,n,i;const r={hasNext:!0,nextToken:0};this._nextSyncLoopCount++,yield this.loadMetadata(e),a.debug("message background next sync from",null===(t=this._metadata)||void 0===t?void 0:t.range.bottom);try{const t=u.MessageManager.of(this._iid),o=yield t.getMessagesByTimestamp(this._channel.url,this._channel.channelType,(null===(n=null===(s=this._metadata)||void 0===s?void 0:s.range)||void 0===n?void 0:n.bottom)?this._metadata.range.bottom:e,{prevResultSize:0,nextResultSize:this._limit,replyType:d.ReplyType.ALL,includeReactions:!0,includeMetaArray:!0,includeParentMessageInfo:!0,includeThreadInfo:!0},d.CollectionEventSource.SYNC_MESSAGE_BACKGROUND);if(o.length>0){const e=o.map((e=>e.createdAt));(null===(i=this._metadata)||void 0===i?void 0:i.range.intersect(...e))?this.extendRange(o):this._metadata={range:new _.TimeRange({top:Math.min(...e),bottom:Math.max(...e)}),previousComplete:!1}}r.hasNext=o.length>=this._limit&&this._nextSyncLoopCount<1,this._metadata&&(r.nextToken=this._metadata.range.bottom),a.debug("message background next sync progress",r),yield this.saveMetadata()}catch(e){throw a.debug("message background next sync error",e),e}return r})))),this._connectionEventContext=i.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)if(e.stateType===d.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t){return xe[e]||(xe[e]={}),xe[e][t.url]||(xe[e][t.url]=new Oe({_iid:e,channel:t})),xe[e][t.url].ref++,xe[e][t.url]}static clear(e,t){xe[e]&&xe[e][t]&&(xe[e][t].close(),delete xe[e])}get range(){var e,t;return null!==(t=null===(e=this._metadata)||void 0===e?void 0:e.range)&&void 0!==t?t:new _.TimeRange({})}get previousComplete(){var e;return!!(null===(e=this._metadata)||void 0===e?void 0:e.previousComplete)}isWrappingMessages(e){var t;return null===(t=this.range)||void 0===t?void 0:t.includes(...e.map((e=>e.createdAt)))}extendRange(e){this._metadata&&this._metadata.range.extends(...e.map((e=>e.createdAt)))}loadMetadata(e){return d.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:t}=d.Vault.of(this._iid),s=yield t.preference.get(this._metadataKey);s?s.range.bottom<e?this._metadata={range:new _.TimeRange({}),previousComplete:!1}:this._metadata={range:new _.TimeRange(s.range),previousComplete:s.previousComplete}:this._metadata={range:new _.TimeRange({}),previousComplete:!1}}return this._metadata}))}saveMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=d.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(e=Date.now()){var t,s,n,i;const{logger:a,connectionManager:r}=d.Vault.of(this._iid);r.isConnected&&(a.debug("message background sync resume()"),this._prevSyncLoopCount=this._nextSyncLoopCount=0,this._metadata&&this._metadata.previousComplete||this._prevSync.start(null!==(s=null===(t=this._metadata)||void 0===t?void 0:t.range.top)&&void 0!==s?s:e),this._nextSync.start(null!==(i=null===(n=this._metadata)||void 0===n?void 0:n.range.bottom)&&void 0!==i?i:e))}pause(){const{logger:e}=d.Vault.of(this._iid);e.debug("message background sync stop()"),this._prevSync.stop(),this._nextSync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete xe[this._iid][this._channel.url])}}const Re={};class we{constructor({_iid:e,channel:t}){this.ref=0,this._iid=e,this._channel=t;const{logger:s,sdkState:n,dispatcher:i}=d.Vault.of(this._iid);var a,r;this._metadataKey=(a=n.userId,r=t.url,`sendbird:${a}@groupchannel/${r}/message/changelogs.meta`);const o=((e,t)=>`sendbird:${e}@groupchannel/${t}/message/changelogs`)(n.userId,this._channel.url);this._sync=new Pe(o,(()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const t={hasNext:!0,nextToken:0};yield this.loadMetadata(),s.debug("message changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token);try{const e=u.MessageManager.of(this._iid),{updatedMessages:n,deletedMessageIds:i,hasMore:a,token:r}=yield e.getMessageChangelogs(this._channel.url,this._channel.channelType,this._metadata.token,{replyType:d.ReplyType.ALL,includeReactions:!0,includeThreadInfo:!0,includeMetaArray:!0,includeParentMessageInfo:!0},d.CollectionEventSource.SYNC_MESSAGE_CHANGELOGS);t.hasNext=a,t.nextToken=r,(n.length>0||i.length>0)&&this._metadata&&(this._metadata.token=r),s.debug("message changelog sync progress",t),yield this.saveMetadata()}catch(e){throw s.debug("message changelog sync error",e),e instanceof d.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return t})))),this._connectionEventContext=i.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)if(e.stateType===d.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t){return Re[e]||(Re[e]={}),Re[e][t.url]||(Re[e][t.url]=new we({_iid:e,channel:t})),Re[e][t.url].ref++,Re[e][t.url]}static clear(e,t){Re[e]&&Re[e][t]&&(Re[e][t].close(),delete Re[e])}loadMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e,firstConnectedAt:t}=d.Vault.of(this._iid),s=yield e.preference.get(this._metadataKey);this._metadata={token:s?s.token:t}}return this._metadata}))}saveMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=d.Vault.of(this._iid);return yield e.preference.set(this._metadataKey,this._metadata),!0}return!1}))}clearMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{logger:e,connectionManager:t}=d.Vault.of(this._iid);t.isConnected&&(e.debug("message changelog sync resume()"),this._sync.start(0))}pause(){const{logger:e,connectionManager:t}=d.Vault.of(this._iid);e.debug("message changelog sync pause()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete Re[this._iid][this._channel.url])}}const De={};class Le{constructor({_iid:e,channel:t,hasPollMessage:s}){this.ref=0,this._iid=e,this._channel=t;const{logger:n,sdkState:i,dispatcher:a}=d.Vault.of(this._iid);var r,o;this._metadataKey=(r=i.userId,o=t.url,`sendbird:${r}@groupchannel/${o}/poll/changelogs.meta`);const l=((e,t)=>`sendbird:${e}@groupchannel/${t}/poll/changelogs`)(i.userId,this._channel.url);this._sync=new Pe(l,(()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const t={hasNext:!0,nextToken:0};if(yield this.loadMetadata(),n.debug("poll changelog sync from",null===(e=this._metadata)||void 0===e?void 0:e.token),!(this._metadata&&this._metadata.token||(yield s()))){return{hasNext:!1,nextToken:0}}if(!this._metadata){const{firstConnectedAt:e}=d.Vault.of(this._iid);this._metadata={token:e}}try{const e=p.PollManager.of(this._iid),{hasMore:s,token:i}=yield e.getPollChangeLogs(this._channel.url,this._channel.channelType,this._metadata.token);t.hasNext=s,t.nextToken=i,this._metadata.token=i,n.debug("poll changelog sync progress",t),yield this.saveMetadata()}catch(e){throw n.debug("poll changelog sync error",e),e instanceof d.SendbirdError&&e.isInvalidTokenError&&(yield this.clearMetadata()),e}return t})))),this._connectionEventContext=a.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)if(e.stateType===d.ConnectionStateType.CONNECTED)this.resume();else this.pause()}))}static of(e,t,s){return De[e]||(De[e]={}),De[e][t.url]||(De[e][t.url]=new Le({_iid:e,channel:t,hasPollMessage:s})),De[e][t.url].ref++,De[e][t.url]}loadMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(!this._metadata){const{cacheContext:e}=d.Vault.of(this._iid),t=yield e.preference.get(this._metadataKey);this._metadata=t?{token:t.token}:void 0}}))}saveMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._metadata){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.set(this._metadataKey,this._metadata)}}))}clearMetadata(){return d.__awaiter(this,void 0,void 0,(function*(){const{cacheContext:e}=d.Vault.of(this._iid);yield e.preference.remove(this._metadataKey),this._metadata=void 0}))}resume(){const{logger:e}=d.Vault.of(this._iid);e.debug("poll changelog sync resume()"),this._sync.start(0)}pause(){const{logger:e}=d.Vault.of(this._iid);e.debug("poll changelog sync pause()"),this._sync.stop()}close(){this.ref--,this.ref<=0&&(this.ref=0,this.pause(),this._connectionEventContext.close(),delete De[this._iid][this._channel.url])}}class Fe extends d.BaseCommand{constructor({channels:e,source:t,isWebSocketEventComing:s=!1,data:n=null}){super(),this.channels=e,this.source=t,this.isWebSocketEventComing=s,this.data=n}}class ke extends d.BaseCommand{constructor({channelUrls:e,source:t,isWebSocketEventComing:s=!1}){super(),this.channelUrls=e,this.source=t,this.isWebSocketEventComing=s}}class He extends d.APIRequestCommand{constructor(e){var t,s,n,i,a,r;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.getChannelApiPathByType(e.channelType)}/${e.channelUrl}/messages_gap`,this.params=d.deundefined({prev_start_ts:e.prevStart,prev_end_ts:e.prevEnd,prev_cache_count:e.prevCount,next_start_ts:e.nextStart,next_end_ts:e.nextEnd,next_cache_count:e.nextCount,huge_gap_threshold:null!==(t=e.threshold)&&void 0!==t?t:null,reverse:!0,custom_types:null!==(s=e.customTypes)&&void 0!==s?s:["*"],message_type:null!==(n=e.messageType)&&void 0!==n?n:null,include_reactions:null===(i=e.includeReactions)||void 0===i||i,with_sorted_meta_array:null===(a=e.includeMetaArray)||void 0===a||a,show_subchannel_messages_only:null!==(r=e.showSubchannelMessagesOnly)&&void 0!==r&&r,include_poll_details:!0,checking_continuous_messages:e.checkingContinuousMessages})}}class Ve extends d.APIResponseCommand{constructor(e,t){var s,n,i,a,r,o;super(e,t),this.isHugeGap=t.is_huge_gap,this.prevMessages=(null!==(s=t.prev_messages)&&void 0!==s?s:[]).map((t=>u.parseMessagePayload(e,t))),this.prevHasMore=null!==(n=t.prev_hasmore)&&void 0!==n&&n,this.isContinuousPrevMessages=null!==(i=t.is_continuous_prev_messages)&&void 0!==i&&i,this.nextMessages=(null!==(a=t.next_messages)&&void 0!==a?a:[]).map((t=>u.parseMessagePayload(e,t))),this.nextHasmore=null!==(r=t.next_hasmore)&&void 0!==r&&r,this.isContinuousNextMessages=null!==(o=t.is_continuous_next_messages)&&void 0!==o&&o}}const Ge=(e,t)=>t instanceof u.SendableMessage?e.findIndex((e=>e instanceof u.SendableMessage&&t.isIdentical(e))):e.findIndex((e=>e.isIdentical(t))),qe=(e,t)=>e.findIndex((e=>e.messageId===t)),Be=(e,t)=>{if(e.length>0){let s=0,n=e.length-1,i=Math.floor((s+n)/2);for(;s<n;){const a=e[i].createdAt-t.createdAt;if(a>0)n=i,i=Math.floor((s+n)/2);else{if(!(a<0))return i;s=i+1,i=Math.floor((s+n)/2)}}return e[i].createdAt>t.createdAt?i:i+1}return e.length};class je{constructor(e){this.source=e}}class We extends je{}class $e extends je{}class ze{constructor(e){this.source=e}}class Qe extends ze{}class Ke extends ze{}const Ye=6e5;exports.MessageCollectionInitPolicy=void 0,(exports.MessageCollectionInitPolicy||(exports.MessageCollectionInitPolicy={})).CACHE_AND_REPLACE_BY_API="cache_and_replace_by_api";class Je{_invokeResponse(e,t,s){d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){switch(e){case"local":this._onCacheResult(t,s);break;case"remote":this._onApiResult(t,s)}}))))}onCacheResult(e){return this._onCacheResult=e,this}onApiResult(e){return this._onApiResult=e,this}}class Ze{constructor(e,{filter:t,startingPoint:s,limit:n,channel:i,channelManager:a}){this._messages=[],this._unsentMessages=[],this._iid=e,this._key=`mc-${d.uuid()}`,this._isDisposed=!1,this.filter=null!=t?t:new u.MessageFilter,this._channel=i,this._syncRange=new _.TimeRange({}),this._hasPrevious=!0,this._hasNext=!0,this._startingPoint="number"==typeof s?s:Date.now()+Ye,this._limit=n||u.DEFAULT_MESSAGE_LIMIT,this._channelManager=a,this._channelManager.subscribeChannelEvent(this._key,{onUpdate:(e,t,s)=>{const n=e.findIndex((e=>e.isIdentical(this.channel)));n>=0&&(this._replaceChannelOfCollection(e[n]),this.channel._runIfHandleableWithGroupChannel((e=>{switch(t){case d.CollectionEventSource.EVENT_CHANNEL_UPDATED:{let t=!1;for(const s in this._messages){if(this._messages[s].createdAt>=e.messageOffsetTimestamp){t=!0;const e=parseInt(s);if(e>0){const t=this._messages.splice(0,e);this._removeMessagesFromView(t.map((e=>e.messageId)),d.CollectionEventSource.EVENT_MESSAGE_OFFSET_UPDATED)}break}}!t&&this._messages.length>0&&this._removeMessagesFromView(this._messages.map((e=>e.messageId)),d.CollectionEventSource.EVENT_MESSAGE_OFFSET_UPDATED);break}case d.CollectionEventSource.EVENT_CHANNEL_UNMUTED:{const{sdkState:e}=d.Vault.of(this._iid),t=s;e.userId===t&&this._clearCheckMyMutedTimer();break}case d.CollectionEventSource.EVENT_CHANNEL_MUTED:{const{sdkState:t}=d.Vault.of(this._iid),n=s;t.userId===n&&-1!==e._myMutedRemainingTime&&this._startCheckMyMutedTimer(e._myMutedRemainingTime);break}case d.CollectionEventSource.EVENT_CHANNEL_LEFT:e.isPublic&&this._clearCheckMyMutedTimer()}d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const s=this._createChannelEventContext(t);x(t)&&(null===(e=this._handler)||void 0===e?void 0:e.onChannelUpdated)&&this._handler.onChannelUpdated(s,this.channel)}))))})))},onRemove:(e,t)=>{e.indexOf(this.channel.url)>=0&&(this._clearCheckMyMutedTimer(),d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;const s=this._createChannelEventContext(t);(null===(e=this._handler)||void 0===e?void 0:e.onChannelDeleted)&&this._handler.onChannelDeleted(s,this.channel.url)})))))}}),this._channelManager.subscribeMessageEvent(this._key,{onUpdate:(e,t)=>{const s=[],n=[];for(const t of e)t.channelUrl===this._channel.url&&(this.filter.match(t)?s.push(t):n.push(t.messageId));if(d.shouldGiveEvent(t)){if(s.length>0)switch(t){case d.CollectionEventSource.LOCAL_MESSAGE_CANCELED:case d.CollectionEventSource.LOCAL_MESSAGE_RESEND_STARTED:case d.CollectionEventSource.EVENT_MESSAGE_SENT_FAILED:case d.CollectionEventSource.EVENT_MESSAGE_SENT_SUCCESS:case d.CollectionEventSource.EVENT_MESSAGE_UPDATED:case d.CollectionEventSource.EVENT_MESSAGE_THREADINFO_UPDATED:case d.CollectionEventSource.EVENT_MESSAGE_REACTION_UPDATED:case d.CollectionEventSource.SYNC_MESSAGE_CHANGELOGS:this._updateMessagesToView(s,t);break;case d.CollectionEventSource.EVENT_MESSAGE_SENT_PENDING:this._addMessagesToView(s,t);break;case d.CollectionEventSource.EVENT_MESSAGE_RECEIVED:this.hasNext||this._addMessagesToView(s,t);break;case d.CollectionEventSource.SYNC_MESSAGE_FILL:this._addMessagesToView(s,t)}n.length>0&&this._removeMessagesFromView(n,t)}},onRemove:(e,t)=>{this._removeMessagesFromView(e,t)},onRemoveUnsent:(e,t)=>{this._removeUnsentMessageFromView(e,t)},onPollChangeLogUpdate:(e,t)=>{this._updatePollsToView(e,t)},onPollUpdate:(e,t)=>{this._applyPollUpdateEventToView(e,t)},onPollVote:(e,t)=>{this._applyPollVoteEventToView(e,t)}});const{cacheContext:r,dispatcher:o,logger:l}=d.Vault.of(this._iid);this._channel._updateMessageCollectionLastAccessedAt();const h=this._createChannelUpdateEventCommand(d.CollectionEventSource.CHANNEL_LASTACCESSEDAT_UPDATED);h&&o.dispatch(h),this._shouldStartBackgroundSync()&&(this._backgroundSync=Oe.of(this._iid,this._channel),this._backgroundSync.resume(this._startingPoint)),this._changelogSync=we.of(this._iid,this._channel),this._changelogSync.resume(),this._pollChangelogSync=Le.of(this._iid,this._channel,this._hasPollMessage.bind(this)),this._pollChangelogSync.resume(),this._prevFill=new Pe(this._key,(e=>d.__awaiter(this,void 0,void 0,(function*(){var t;const{messages:s,isContinuousMessages:n}=yield this._getRemoteMessages(e,{prevLimit:this._limit,source:d.CollectionEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:r.localCacheEnabled});if(s.length>0){const e=Math.min(...s.map((e=>e.createdAt)));return this._syncRange.extends(e),n&&(null===(t=this._backgroundSync)||void 0===t||t.range.extends(e)),{hasNext:s.length>=this._limit&&this.viewTop<e,nextToken:this._syncRange.top}}return{hasNext:!1,nextToken:0}})))),this._nextFill=new Pe(this._key,(e=>d.__awaiter(this,void 0,void 0,(function*(){var t;const{messages:s,isContinuousMessages:n}=yield this._getRemoteMessages(e,{nextLimit:this._limit,source:d.CollectionEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:r.localCacheEnabled});if(s.length>0){const e=Math.max(...s.map((e=>e.createdAt)));return this._syncRange.extends(e),n&&(null===(t=this._backgroundSync)||void 0===t||t.range.extends(e)),{hasNext:!(s.length>=this._limit&&this._hasNext)||this.viewBottom>e,nextToken:this._syncRange.bottom}}return{hasNext:!1,nextToken:0}})))),this._connectionEventContext=o.on((e=>{if(e instanceof d.ConnectionStateChangeCommand)switch(e.stateType){case d.ConnectionStateType.CONNECTED:this._refreshChannel(d.CollectionEventSource.SYNC_CHANNEL_CHANGELOGS),d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const e=yield this.channel.getMyMutedInfo();e.isMuted&&-1!==e.remainingDuration&&this._startCheckMyMutedTimer(e.remainingDuration)})))),l.debug("check huge gap"),this._checkHugeGap();break;case d.ConnectionStateType.LOGOUT:this.dispose();break;default:this._clearCheckMyMutedTimer(),this._prevFill.stop(),this._nextFill.stop()}}));const{statLogCollector:c}=d.Vault.of(this._iid);c.put(new d.DailyRecordStatLog({type:d.StatType.FEATURE_LOCALCACHE,data:{use_local_cache:r.localCacheEnabled,collection_interface:{message:!0}}}))}get channel(){return this._channel}get succeededMessages(){return[...this._messages]}get failedMessages(){return this._unsentMessages.filter((e=>e.sendingStatus===d.SendingStatus.FAILED))}get pendingMessages(){return this._unsentMessages.filter((e=>e.sendingStatus===d.SendingStatus.PENDING))}get hasPrevious(){return this._hasPrevious}get hasNext(){return this._hasNext}get viewTop(){return Math.min(...this._messages.map((e=>e.createdAt)),Number.MAX_SAFE_INTEGER)}get viewBottom(){return Math.max(...this._messages.map((e=>e.createdAt)),0)}_replaceChannelOfCollection(e){this._channel.isGroupChannel()?this._channel=e:this._channel.isFeedChannel()&&(this._channel._groupChannel=e._groupChannel)}_shouldStartBackgroundSync(){const{cacheContext:e}=d.Vault.of(this._iid);return this.channel.isGroupChannel()?e.localCacheEnabled&&!this.channel.isSuper:e.localCacheEnabled}_createChannelEventContext(e){switch(!0){case this.channel.isGroupChannel():return new We(e);case this.channel.isFeedChannel():return new $e(e);default:throw new d.SendbirdError({code:d.SendbirdErrorCode.WRONG_CHANNEL_TYPE,message:"Wrong channel type"})}}_createMessageEventContext(e){switch(!0){case this.channel.isGroupChannel():return new Qe(e);case this.channel.isFeedChannel():return new Ke(e);default:throw new d.SendbirdError({code:d.SendbirdErrorCode.WRONG_CHANNEL_TYPE,message:"Wrong channel type"})}}_createChannelUpdateEventCommand(e){switch(!0){case this.channel.isGroupChannel():return new O({channels:[this._channel],source:e});case this.channel.isFeedChannel():return new Fe({channels:[this._channel],source:e});default:return null}}_setBaseMessageCollectionHandler(e){this._handler=e}_filterUnderOffsetMessage(e){return e}_addMessagesToView(e,t){const s=this._filterUnderOffsetMessage(e),n=[],i=[];for(const e of s)if(t===d.CollectionEventSource.SYNC_MESSAGE_FILL){if(e.messageId>0){if(Ge(this._messages,e)<0){Ge(this._unsentMessages,e)<0&&n.push(e);const t=Be(this._messages,e);this._messages.splice(t,0,e)}}else if(e instanceof u.SendableMessage){Ge(this._unsentMessages,e)<0&&Ge(this._messages,e)<0&&(this._unsentMessages.push(e),n.push(e))}}else if(e.messageId>0){const t=Ge(this._messages,e);if(t<0){const t=Ge(this._unsentMessages,e);t<0?n.push(e):(this._unsentMessages.splice(t,1),i.push(e));const s=Be(this._messages,e);this._messages.splice(s,0,e)}else i.push(e),this._messages[t]=e;if(e.updatedAt>0){const t=this._updateChildMessagesInView(e);i.push(...t)}}else if(e instanceof u.SendableMessage){const t=Ge(this._unsentMessages,e);t<0?Ge(this._messages,e)<0&&(this._unsentMessages.push(e),n.push(e)):(i.push(e),this._unsentMessages[t]=e)}d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s,a,r;const o=this._createMessageEventContext(t);n.length>0&&(null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesAdded)||void 0===s||s.call(e,o,this.channel,n)),i.length>0&&(null===(r=null===(a=this._handler)||void 0===a?void 0:a.onMessagesUpdated)||void 0===r||r.call(a,o,this.channel,i))}))))}_updateChildMessagesInView(e){const t=[];return this._messages.forEach((s=>{s.parentMessageId===e.messageId&&s.applyParentMessage(e)&&t.push(s)})),t}_updatePollsToView(e,t){const s=[];for(const t of e){const e=qe(this._messages,t.messageId);if(e>=0){const n=this._messages[e];n&&n.applyPoll(t),s.push(n)}}return s.length>0&&d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,n;const i=this._createMessageEventContext(t);s.length>0&&(null===(n=(e=this._handler).onMessagesUpdated)||void 0===n||n.call(e,i,this.channel,s))})))),s}_applyPollUpdateEventToView(e,t){const s=qe(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&n.isUserMessage()&&n.poll&&n.poll.applyPollUpdateEvent(e)&&d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s;const i=this._createMessageEventContext(t);null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===s||s.call(e,i,this.channel,[n])}))))}}_applyPollVoteEventToView(e,t){const s=qe(this._messages,e.messageId);if(s>=0){const n=this._messages[s];n&&n.isUserMessage()&&n.poll&&n.poll.applyPollVoteEvent(e)&&d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,s;const i=this._createMessageEventContext(t);null===(s=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===s||s.call(e,i,this.channel,[n])}))))}}_updateMessagesToView(e,t){const s=[],n=[],i=[];for(const t of e)if(t.messageId>0){const e=Ge(this._messages,t);if(e>=0)n.push(t),this._messages[e]=t;else{const e=Ge(this._unsentMessages,t);if(e>=0){const s=this._unsentMessages.splice(e,1);if(this.hasNext&&s.length>0)i.push(s[0]);else{n.push(t);const e=Be(this._messages,t);this._messages.splice(e,0,t)}}else{const e=this._messages.map((e=>e.createdAt));(t.createdAt<Math.min(...e)&&!this._hasPrevious||t.createdAt>Math.max(...e)&&!this._hasNext)&&s.push(t)}}}else if(t instanceof u.SendableMessage){const e=Ge(this._unsentMessages,t);e>=0&&(n.push(t),this._unsentMessages[e]=t)}return d.shouldGiveEvent(t)&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,a,r,o;const l=this._createMessageEventContext(t);n.length>0?null===(a=null===(e=this._handler)||void 0===e?void 0:e.onMessagesUpdated)||void 0===a||a.call(e,l,this.channel,n):i.length>0?null===(o=null===(r=this._handler)||void 0===r?void 0:r.onMessagesDeleted)||void 0===o||o.call(r,l,this.channel,[],i):s.length>0&&this._addMessagesToView(s,t)})))),n}_removeMessagesFromView(e,t){const s=[],n=[];for(const t of e){const e=this._messages.findIndex((e=>e.messageId===t));if(e>=0){const t=this._messages[e];s.push(t.messageId),n.push(t),this._messages.splice(e,1)}}return d.shouldGiveEvent(t)&&n.length>0&&d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,i;const a=this._createMessageEventContext(t);null===(i=null===(e=this._handler)||void 0===e?void 0:e.onMessagesDeleted)||void 0===i||i.call(e,a,this.channel,s,n)})))),s}_removeUnsentMessageFromView(e,t){const s=this._unsentMessages.findIndex((t=>t.reqId===e));s>=0&&this._unsentMessages.splice(s,1)}_getLocalMessages(e,{prevLimit:t=0,nextLimit:s=0,inclusive:n=!0}){return d.__awaiter(this,void 0,void 0,(function*(){let i=[];n&&(i=yield this._channelManager.getExactlyMatchingMessagesForTokenFromCache(this._channel.url,e,this.filter));const a=t>0?yield this._channelManager.getMessagesFromCache(this._channel.url,e,"prev",this.filter,t,!1):[],r=s>0?yield this._channelManager.getMessagesFromCache(this._channel.url,e,"next",this.filter,s,!1):[];return[...i,...a,...r].sort(((e,t)=>t.createdAt-e.createdAt))}))}_getRemoteMessages(e,{prevLimit:t=0,nextLimit:s=0,source:n=d.CollectionEventSource.REQUEST_MESSAGE,reverse:i=!1,checkingContinuousMessages:a=!1}){return d.__awaiter(this,void 0,void 0,(function*(){const r=u.MessageManager.of(this._iid);return t>0||s>0?yield r._getMessagesByTimestampForCollection(this._channel.url,this._channel.channelType,e,d.undefineNullProps(Object.assign(Object.assign({},this.filter),{isInclusive:!0,reverse:i,prevResultSize:t,nextResultSize:s,includeMetaArray:!0,includeReactions:!0,includeThreadInfo:!0,includeParentMessageInfo:!0})),n,a):{messages:[],isContinuousMessages:!1}}))}_checkHugeGap(){var e;return d.__awaiter(this,void 0,void 0,(function*(){if(this._messages.length>0){const e=this._syncRange.top,t=this.viewTop,s=this._syncRange.bottom,n=this.hasNext?this.viewBottom:Number.MAX_SAFE_INTEGER,i=yield this._channelManager.getCachedMessageCountBetween(this._channel.url,this.filter,t,e),a=yield this._channelManager.getCachedMessageCountBetween(this._channel.url,this.filter,s,n);yield d.asyncRetry((()=>d.__awaiter(this,void 0,void 0,(function*(){var r;const{dispatcher:o,requestQueue:l,cacheContext:h}=d.Vault.of(this._iid),c=new He(Object.assign({channelUrl:this._channel.url,channelType:this._channel.channelType,prevStart:t,prevEnd:e,prevCount:i,nextStart:s,nextEnd:n,nextCount:a,checkingContinuousMessages:h.localCacheEnabled},this.filter)),u=yield l.send(c),{isHugeGap:_,prevMessages:p=[],prevHasMore:m,isContinuousPrevMessages:C,nextMessages:g=[],nextHasmore:E,isContinuousNextMessages:v}=u.as(Ve);if(_)d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){var e;(null===(e=this._handler)||void 0===e?void 0:e.onHugeGapDetected)&&this._handler.onHugeGapDetected()}))));else{const e=this.viewTop,t=this.viewBottom,s=Math.min(Number.MAX_SAFE_INTEGER,e,...p.map((e=>e.createdAt))),n=Math.max(0,t,...g.map((e=>e.createdAt)));o.dispatch(new d.MessageUpdateEventCommand({messages:p,source:d.CollectionEventSource.SYNC_MESSAGE_FILL})),o.dispatch(new d.MessageUpdateEventCommand({messages:g,source:d.CollectionEventSource.SYNC_MESSAGE_FILL})),this._syncRange.extends(s,n),(C||v)&&(null===(r=this._backgroundSync)||void 0===r||r.range.extends(s,n)),m&&this._prevFill.start(s),E&&this._nextFill.start(n)}}))),1)}else{const{cacheContext:t}=d.Vault.of(this._iid),s=Math.floor(this._limit/2),n=Date.now();try{const{messages:i,isContinuousMessages:a}=yield this._getRemoteMessages(n,{prevLimit:s,nextLimit:s,source:d.CollectionEventSource.SYNC_MESSAGE_FILL,checkingContinuousMessages:t.localCacheEnabled});if(i.length>0){const t=i.map((e=>e.createdAt));let r=0,o=0;for(let e=0;e<t.length;e++){const s=t[e];s<=n?r++:s>=n&&o++}this._hasPrevious=r>=s,this._hasNext=o>=s,this._syncRange.extends(...t),a&&(null===(e=this._backgroundSync)||void 0===e||e.range.extends(this._syncRange.top,this._syncRange.bottom)),this._addMessagesToView(i,d.CollectionEventSource.SYNC_MESSAGE_FILL)}else this._hasPrevious=!1,this._hasNext=!1}catch(e){e instanceof d.SendbirdError&&e.code===d.SendbirdErrorCode.NOT_FOUND_IN_DATABASE&&(this._hasPrevious=!1,this._hasNext=!1)}}}))}_loadUnsentMessages(){return d.__awaiter(this,void 0,void 0,(function*(){this._unsentMessages=yield this._channelManager.getUnsentMessagesFromCache(this._channel.url,this.filter)}))}_hasPollMessage(){return d.__awaiter(this,void 0,void 0,(function*(){return(yield this._channelManager.getPollMessagesFromCache(this._channel.url,Date.now()+Ye,this.filter,1)).length>0}))}_refreshChannel(e){this._channelManager.refreshChannel(this.channel.url,!0,e)}_startCheckMyMutedTimer(e){this._clearCheckMyMutedTimer(),this._checkMyMutedStateTimer=setTimeout((()=>d.__awaiter(this,void 0,void 0,(function*(){this._checkMyMutedStateTimer=void 0;let e=!0;try{e=!(yield this._channel.getMyMutedInfo()).isMuted}catch(t){e=!0}finally{e&&this.channel._runIfHandleableWithGroupChannel((e=>{var t,s;e.myMutedState=d.MutedState.UNMUTED;const n=this._createChannelEventContext(d.CollectionEventSource.EVENT_CHANNEL_UNMUTED);null===(s=null===(t=this._handler)||void 0===t?void 0:t.onChannelUpdated)||void 0===s||s.call(t,n,this.channel)}))}}))),e+1e3)}_clearCheckMyMutedTimer(){this._checkMyMutedStateTimer&&(clearTimeout(this._checkMyMutedStateTimer),this._checkMyMutedStateTimer=void 0)}initialize(e){const t=new Je;this._messages=[],this._unsentMessages=[],this._syncRange=new _.TimeRange({}),this._hasNext=!0,this._hasPrevious=!0,this._refreshChannel(d.CollectionEventSource.REFRESH_CHANNEL),d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){const e=yield this.channel.getMyMutedInfo();e.isMuted&&-1!==e.remainingDuration&&this._startCheckMyMutedTimer(e.remainingDuration)}))));const s=Math.floor(this._limit/2);if(e===exports.MessageCollectionInitPolicy.CACHE_AND_REPLACE_BY_API)this._getLocalMessages(this._startingPoint,{prevLimit:s,nextLimit:s}).then((e=>d.__awaiter(this,void 0,void 0,(function*(){const s=this._filterUnderOffsetMessage(e);this._addMessagesToView(s,d.CollectionEventSource.REQUEST_MESSAGE),yield this._loadUnsentMessages(),t._invokeResponse("local",null,s)})))).catch((e=>{if(d.isThrowingOutside(e))throw e;t._invokeResponse("local",e,null)})).finally((()=>{const{cacheContext:e}=d.Vault.of(this._iid);this._getRemoteMessages(this._startingPoint,{prevLimit:s,nextLimit:s,reverse:!0,checkingContinuousMessages:e.localCacheEnabled}).then((({messages:e,isContinuousMessages:n})=>{var i;this._messages=[];const a=this._filterUnderOffsetMessage(e);if(a.length>0){const e=a.map((e=>e.createdAt));let t=0,r=0;for(let s=0;s<e.length;s++){const n=e[s];n<this._startingPoint?t++:n>this._startingPoint&&r++}this._hasPrevious=t>=s,this._hasNext=r>=s,this._syncRange.extends(...a.map((e=>e.createdAt))),n&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(this._syncRange.top,this._syncRange.bottom)),this._addMessagesToView(a,d.CollectionEventSource.REQUEST_MESSAGE)}else this._hasPrevious=!1,this._hasNext=!1;t._invokeResponse("remote",null,a)})).catch((e=>{if(d.isThrowingOutside(e))throw e;t._invokeResponse("remote",e,null)}))}));const{cacheContext:n,statLogCollector:i}=d.Vault.of(this._iid);return i.put(new d.DailyRecordStatLog({type:d.StatType.FEATURE_LOCALCACHE,data:{use_local_cache:n.localCacheEnabled,collection_interface:{message_init_policy:e}}})),t}loadPrevious(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new d.SendbirdError({code:d.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});if(!this._hasPrevious)return[];const e=Math.floor(this._limit/2),t=this.viewTop;let s=[];return yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){s=this._filterUnderOffsetMessage(yield this._getLocalMessages(t,{prevLimit:e,inclusive:!1}))})))),s.length<e||!this._backgroundSync||!this._backgroundSync.isWrappingMessages(s)?(yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){var n,i;const{cacheContext:a}=d.Vault.of(this._iid),r=yield this._getRemoteMessages(t,{prevLimit:e,reverse:!0,checkingContinuousMessages:a.localCacheEnabled});s=this._filterUnderOffsetMessage(r.messages),s=s.filter((e=>Ge(this._messages,e)<0)),this._hasPrevious=s.length>=e,s.length>0&&(this._syncRange.extends(...s.map((e=>e.createdAt))),(null===(n=this._backgroundSync)||void 0===n?void 0:n.range.overlap(this._syncRange))&&r.isContinuousMessages&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(this._syncRange.top)))})))),this._addMessagesToView(s,d.CollectionEventSource.REQUEST_MESSAGE)):(this._hasPrevious=s.length>=e,s.length>0&&this._addMessagesToView(s,d.CollectionEventSource.REQUEST_MESSAGE)),s}))}loadNext(){var e;return d.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new d.SendbirdError({code:d.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});if(!this._hasNext)return[];const t=Math.floor(this._limit/2),s=this.viewBottom;let n=[];return yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){n=this._filterUnderOffsetMessage(yield this._getLocalMessages(s,{nextLimit:t,inclusive:!1}))})))),n.length<t||!(null===(e=this._backgroundSync)||void 0===e?void 0:e.isWrappingMessages(n))?(yield d.runOrNothing((()=>d.__awaiter(this,void 0,void 0,(function*(){var e,i;const{cacheContext:a}=d.Vault.of(this._iid),r=yield this._getRemoteMessages(s,{nextLimit:t,reverse:!0,checkingContinuousMessages:a.localCacheEnabled});n=this._filterUnderOffsetMessage(r.messages),n=n.filter((e=>Ge(this._messages,e)<0)),this._hasNext=n.length>=t,n.length>0&&(this._syncRange.extends(...n.map((e=>e.createdAt))),(null===(e=this._backgroundSync)||void 0===e?void 0:e.range.overlap(this._syncRange))&&r.isContinuousMessages&&(null===(i=this._backgroundSync)||void 0===i||i.range.extends(this._syncRange.bottom)))})))),this._addMessagesToView(n,d.CollectionEventSource.REQUEST_MESSAGE)):(this._hasNext=n.length>=t,n.length>0&&this._addMessagesToView(n,d.CollectionEventSource.REQUEST_MESSAGE)),n}))}removeFailedMessage(e){return d.__awaiter(this,void 0,void 0,(function*(){if(this._isDisposed)throw new d.SendbirdError({code:d.SendbirdErrorCode.COLLECTION_DISPOSED,message:"Collection has been disposed."});yield this._channelManager.removeFailedMessageFromCache(e);const t=this._unsentMessages.findIndex((t=>t.reqId===e));t>-1&&this._unsentMessages.splice(t,1)}))}dispose(){var e,t,s;if(this._isDisposed)return;this._isDisposed=!0;const{cacheContext:n,dispatcher:i}=d.Vault.of(this._iid);this._messages=[],this._clearCheckMyMutedTimer(),this._channel._updateMessageCollectionLastAccessedAt();const a=this._createChannelUpdateEventCommand(d.CollectionEventSource.CHANNEL_LASTACCESSEDAT_UPDATED);a&&i.dispatch(a),n.localCacheEnabled&&(this._prevFill.stop(),this._nextFill.stop()),null===(e=this._backgroundSync)||void 0===e||e.close(),null===(t=this._changelogSync)||void 0===t||t.close(),null===(s=this._pollChangelogSync)||void 0===s||s.close(),this._channelManager.unsubscribeChannelEvent(this._key),this._channelManager.unsubscribeMessageEvent(this._key),this._connectionEventContext&&this._connectionEventContext.close()}}class Xe extends Ze{constructor(e,t){super(e,Object.assign(Object.assign({},t),{channelManager:Ue.of(e)}))}setMessageCollectionHandler(e){this._setBaseMessageCollectionHandler(e)}}const et={coverUrl:void 0,coverImage:void 0,isDistinct:void 0,isPublic:void 0,isDiscoverable:void 0,accessCode:void 0,name:void 0,data:void 0,customType:void 0,operatorUserIds:void 0,messageSurvivalSeconds:void 0};class tt extends d.APIRequestCommand{constructor(e){const{channelUrl:t,token:s,limit:n,order:i,mutedMemberFilter:a,memberStateFilter:r,nicknameStartsWithFilter:o,operatorFilter:l}=e;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/members`,this.params={token:s,limit:n,order:i,muted_member_filter:a,member_state_filter:r,nickname_startswith:o,operator_filter:l,show_member_is_muted:!0,show_read_receipt:!0,show_delivery_receipt:!0}}}class st extends d.APIResponseCommand{constructor(e,t){super(e,t),this.members=[];const{next:s,members:n}=t;this.token=s,n&&n.length>0&&(this.members=n.map((t=>new m(e,t))))}}var nt,it,at;exports.MutedMemberFilter=void 0,(nt=exports.MutedMemberFilter||(exports.MutedMemberFilter={})).ALL="all",nt.MUTED="muted",nt.UNMUTED="unmuted",exports.MemberListOrder=void 0,(it=exports.MemberListOrder||(exports.MemberListOrder={})).MEMBER_NICKNAME_ALPHABETICAL="member_nickname_alphabetical",it.OPERATOR_THEN_MEMBER_ALPHABETICAL="operator_then_member_alphabetical",exports.MemberStateFilter=void 0,(at=exports.MemberStateFilter||(exports.MemberStateFilter={})).ALL="all",at.JOINED="joined_only",at.INVITED="invited_only",at.INVITED_BY_FRIEND="invited_by_friend",at.INVITED_BY_NON_FRIEND="invited_by_non_friend";class rt extends d.ChannelDataListQuery{constructor(e,t,s){var n,i,a,r;super(e,t,d.ChannelType.GROUP,s),this.mutedMemberFilter=exports.MutedMemberFilter.ALL,this.memberStateFilter=exports.MemberStateFilter.ALL,this.nicknameStartsWithFilter=null,this.operatorFilter=exports.OperatorFilter.ALL,this.order=exports.MemberListOrder.MEMBER_NICKNAME_ALPHABETICAL,this.mutedMemberFilter=null!==(n=s.mutedMemberFilter)&&void 0!==n?n:exports.MutedMemberFilter.ALL,this.memberStateFilter=null!==(i=s.memberStateFilter)&&void 0!==i?i:exports.MemberStateFilter.ALL,this.nicknameStartsWithFilter=null!==(a=s.nicknameStartsWithFilter)&&void 0!==a?a:null,this.order=null!==(r=s.order)&&void 0!==r?r:exports.MemberListOrder.MEMBER_NICKNAME_ALPHABETICAL}_validate(){return super._validate()&&d.isEnumOf(exports.MutedMemberFilter,this.mutedMemberFilter)&&d.isEnumOf(exports.MemberStateFilter,this.memberStateFilter)&&(d.isTypeOf("string",this.nicknameStartsWithFilter)||null===this.nicknameStartsWithFilter)&&d.isEnumOf(exports.OperatorFilter,this.operatorFilter)&&d.isEnumOf(exports.MemberListOrder,this.order)}next(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw d.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=d.Vault.of(this._iid),t=new tt(d.undefineNullProps(Object.assign(Object.assign({},this),{token:this._token}))),s=yield e.send(t),{members:n,token:i}=s.as(st);return this._token=i,this._hasNext=!!i,this._isLoading=!1,n}return[]}throw d.SendbirdError.invalidParameters}))}}class ot extends d.APIRequestCommand{constructor(e){const{channelUrl:t,userId:s,accessCode:n}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/accept`,this.params={user_id:s,access_code:n}}}class lt extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Lt(e,t),this.channel.myMemberState=exports.MemberState.JOINED}}class dt extends d.APIRequestCommand{constructor(e){const{channelUrl:t,isDistinct:s,isPublic:n,isDiscoverable:i,coverUrl:a,coverImage:r,accessCode:o,name:l,data:h,customType:c,operatorUserIds:u,messageSurvivalSeconds:_}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}`,this.params=d.deundefined({is_distinct:s,is_public:n,is_discoverable:i,name:l,data:h,custom_type:c,cover_url:a,cover_file:r,access_code:o,operator_ids:u,message_survival_seconds:_})}}class ht extends d.APIResponseCommand{constructor(e,t){super(e,t),this.channel=new Lt(e,t)}}class ct extends d.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=d.APIRequestMethod.DELETE,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}`}}class ut extends d.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=d.APIRequestMethod.DELETE,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/hide`}}class _t extends d.APIRequestCommand{constructor({userId:e,channelUrl:t,countPreference:s}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/count_preference/${encodeURIComponent(t)}`,this.params={count_preference:s}}}class pt extends d.APIResponseCommand{constructor(e,t){super(e,t),this.countPreference=t.count_preference}}class mt extends d.APIRequestCommand{constructor(e){const{channelUrl:t}=e;super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(t)}/reset_user_history`}}class Ct extends d.APIResponseCommand{constructor(e,t){super(e,t);const{ts_message_offset:s}=t;this.messageOffsetTimestamp=s}}const gt=Object.assign(Object.assign({},u.BaseMessageUpdateParamsDefault),{scheduledAt:void 0,file:void 0,fileUrl:void 0,fileName:void 0,mimeType:void 0,fileSize:void 0,thumbnailSizes:void 0,requireAuth:!1}),Et=Object.assign(Object.assign({},u.UserMessageUpdateParamsDefault),{scheduledAt:void 0});class vt extends d.APIRequestCommand{constructor(e){var t;super();let s=[];e.mentionType===d.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:i,scheduledMessageId:a}=e;this.method=d.APIRequestMethod.PUT,this.path=`${d.getChannelApiPathByType(n)}/${encodeURIComponent(i)}/scheduled_messages/${encodeURIComponent(a)}`,this.params=d.deundefined(d.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:d.ServerSideMessageType.FILE,url:e.fileUrl,file_name:e.fileName,file_size:e.fileSize,file_type:e.mimeType,thumbnails:e.thumbnailSizes?e.thumbnailSizes.map((e=>u.Thumbnail.payloadify(e))):[],custom_type:e.customType,data:e.data,require_auth:e.requireAuth,mention_type:e.mentionType,mentioned_user_ids:s,sorted_metaarray:null===(t=e.metaArrays)||void 0===t?void 0:t.map((e=>u.MessageMetaArray.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?u.AppleCriticalAlertOptions.payloadify(e.appleCriticalAlertOptions):null,push_option:e.pushNotificationDeliveryOption}))}}class ft extends d.APIResponseCommand{constructor(e,t){super(e,t),this.message=new u.FileMessage(e,t)}}class Mt extends d.APIRequestCommand{constructor(e){var t;super();let s=[];e.mentionType===d.MentionType.USERS&&(e.mentionedUserIds?s=e.mentionedUserIds:e.mentionedUsers&&(s=e.mentionedUsers.map((e=>e.userId))));const{channelType:n,channelUrl:i,scheduledMessageId:a}=e;this.method=d.APIRequestMethod.PUT,this.path=`${d.getChannelApiPathByType(n)}/${encodeURIComponent(i)}/scheduled_messages/${encodeURIComponent(a)}`,this.params=d.deundefined(d.undefineNullProps({req_id:e.reqId,scheduled_at:e.scheduledAt,message_type:d.ServerSideMessageType.USER,message:e.message,custom_type:e.customType,data:e.data,mention_type:e.mentionType,mentioned_user_ids:s,sorted_metaarray:null===(t=e.metaArrays)||void 0===t?void 0:t.map((e=>u.MessageMetaArray.payloadify(e))),apple_critical_alert_options:e.appleCriticalAlertOptions?u.AppleCriticalAlertOptions.payloadify(e.appleCriticalAlertOptions):null,target_langs:e.translationTargetLanguages,push_option:e.pushNotificationDeliveryOption}))}}class St extends d.APIRequestCommand{constructor(e){super();const{channelType:t,channelUrl:s,scheduledMessageId:n}=e;this.method=d.APIRequestMethod.DELETE,this.path=`${d.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/scheduled_messages/${encodeURIComponent(n)}`}}class yt extends d.APIRequestCommand{constructor(e){super();const{channelType:t,channelUrl:s,scheduledMessageId:n}=e;this.method=d.APIRequestMethod.POST,this.path=`${d.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/scheduled_messages/${encodeURIComponent(n)}/send_now`}}class At extends d.APIRequestCommand{constructor({userId:e,channelUrl:t,pushTriggerOption:s}){super(),this.method=d.APIRequestMethod.PUT,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/push_preference/${encodeURIComponent(t)}`,this.params={push_trigger_option:s}}}class bt extends d.APIResponseCommand{constructor(e,t){super(e,t),this.pushTriggerOption=t.push_trigger_option,this.enabled=t.enable}}class Nt extends d.APIRequestCommand{constructor({userId:e,channelUrl:t}){super(),this.method=d.APIRequestMethod.GET,this.path=`${d.API_PATH_USERS}/${encodeURIComponent(e)}/push_preference/${encodeURIComponent(t)}`}}class Tt extends d.APIResponseCommand{constructor(e,t){super(e,t),this.pushTriggerOption=t.push_trigger_option,this.enabled=t.enable}}class Ut extends d.APIRequestCommand{constructor({channelType:e,channelUrl:t,messageId:s}){super(),this.method=d.APIRequestMethod.POST,this.path=`${d.getChannelApiPathByType(e)}/${encodeURIComponent(t)}/messages/${s}/pin`}}class It extends d.APIRequestCommand{constructor({channelType:e,channelUrl:t,messageId:s}){super(),this.method=d.APIRequestMethod.DELETE,this.path=`${d.getChannelApiPathByType(e)}/${encodeURIComponent(t)}/messages/${s}/pin`}}class Pt extends d.InstancedObject{constructor(e,t){super(e),this.message=u.parseMessagePayload(e,t.message)}}class xt extends d.APIRequestCommand{constructor(e){const{channelType:t,channelUrl:s,limit:n,token:i,includeReactions:a,includeMetaArray:r,includeParentMessageInfo:o,includeThreadInfo:l,includePollDetails:h}=e;super(),this.method=d.APIRequestMethod.GET,this.path=`${d.getChannelApiPathByType(t)}/${encodeURIComponent(s)}/pinned_messages`,this.params=d.deundefined({limit:n,token:i,include_reactions:a,with_sorted_meta_array:r,include_thread_info:l,include_parent_message_info:o,include_poll_details:h})}}class Ot extends d.APIResponseCommand{constructor(e,t){super(e,t);const{pinned_messages:s,has_more:n,next:i}=t;this.pinnedMessages=s.map((t=>new Pt(e,t))),this.hasMore=n,this.token=i}}class Rt extends d.ChannelDataListQuery{constructor(e,t,s,n){super(e,t,s,n),this.includeMetaArray=n.includeMetaArray,this.includeReactions=n.includeReactions,this.includeParentMessageInfo=n.includeParentMessageInfo,this.includeThreadInfo=n.includeThreadInfo,this.includePollDetails=n.includePollDetails}_validate(){return super._validate()&&d.isTypeOf("boolean",this.includeMetaArray,!0)&&d.isTypeOf("boolean",this.includeReactions,!0)&&d.isTypeOf("boolean",this.includeParentMessageInfo,!0)&&d.isTypeOf("boolean",this.includeThreadInfo,!0)&&d.isTypeOf("boolean",this.includePollDetails,!0)}next(){return d.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw d.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=d.Vault.of(this._iid),t=new xt(Object.assign(Object.assign({},this),{token:this._token})),s=yield e.send(t),{pinnedMessages:n,hasMore:i,token:a}=s.as(Ot);return this._token=a,this._hasNext=!!i,this._isLoading=!1,n}return[]}throw d.SendbirdError.invalidParameters}))}}var wt,Dt;exports.CountPreference=void 0,(wt=exports.CountPreference||(exports.CountPreference={})).ALL="all",wt.UNREAD_MESSAGE_COUNT_ONLY="unread_message_count_only",wt.UNREAD_MENTION_COUNT_ONLY="unread_mention_count_only",wt.OFF="off",exports.HiddenState=void 0,(Dt=exports.HiddenState||(exports.HiddenState={})).UNHIDDEN="unhidden",Dt.HIDDEN_ALLOW_AUTO_UNHIDE="hidden_allow_auto_unhide",Dt.HIDDEN_PREVENT_AUTO_UNHIDE="hidden_prevent_auto_unhide";class Lt extends h.BaseChannel{constructor(e,t){var s,n,i,a,r,o,l,h,c,_,p,C,g,E,v,f,M,S,y;super(e,t),this._unreadMemberStateMap=new Map,this._undeliveredMemberStateMap=new Map,this._typingStatus=new Map,this._lastMemberCountUpdated=0,this._typingStarted=0,this._typingEnded=0,this.isDistinct=!1,this.isSuper=!1,this.isBroadcast=!1,this.isExclusive=!1,this.isPublic=!1,this.isDiscoverable=!0,this.isChatNotification=!1,this.isAccessCodeRequired=!1,this.isPushEnabled=!1,this.unreadMessageCount=0,this.unreadMentionCount=0,this.members=[],this.memberCount=0,this.joinedMemberCount=0,this.hiddenState=exports.HiddenState.UNHIDDEN,this.lastMessage=null,this.messageOffsetTimestamp=0,this.messageSurvivalSeconds=-1,this.myMemberState=exports.MemberState.NONE,this.myRole=d.Role.NONE,this.myMutedState=d.MutedState.UNMUTED,this.myLastRead=0,this.myCountPreference=exports.CountPreference.ALL,this.myPushTriggerOption=d.PushTriggerOption.DEFAULT,this.inviter=null,this.invitedAt=0,this.joinedAt=0,this.pinnedMessageIds=[],this.lastPinnedMessage=null,this._pinnedMessagesUpdatedAt=0,this._myMutedRemainingTime=-1,this.channelType=d.ChannelType.GROUP,this.isDistinct=null!==(s=t.is_distinct)&&void 0!==s&&s,this.isSuper=null!==(n=t.is_super)&&void 0!==n&&n,this.isBroadcast=null!==(i=t.is_broadcast)&&void 0!==i&&i,this.isExclusive=null!==(a=t.is_exclusive)&&void 0!==a&&a,this.isPublic=null!==(r=t.is_public)&&void 0!==r&&r,this.isDiscoverable=null!==(o=t.is_discoverable)&&void 0!==o?o:this.isPublic,this.isChatNotification=null!==(l=t.is_chat_notification)&&void 0!==l&&l,this.isAccessCodeRequired=null!==(h=t.is_access_code_required)&&void 0!==h&&h,this.isPushEnabled=null!==(c=t.is_push_enabled)&&void 0!==c&&c,Array.isArray(t.members)&&this.members.push(...t.members.map((e=>new m(this._iid,e)))),this.memberCount=null!==(_=t.member_count)&&void 0!==_?_:0,this.joinedMemberCount=null!==(p=t.joined_member_count)&&void 0!==p?p:0,this.hiddenState=d.isEnumOf(exports.HiddenState,t.hidden_state)?t.hidden_state:exports.HiddenState.UNHIDDEN,this.messageOffsetTimestamp=null!==(C=t.ts_message_offset)&&void 0!==C?C:0,this.messageSurvivalSeconds=null!==(g=t.message_survival_seconds)&&void 0!==g?g:-1,this.lastMessage=t.last_message?u.parseMessagePayload(this._iid,Object.assign({channel_type:this.channelType},t.last_message)):null,t.read_receipt&&Object.keys(t.read_receipt).forEach((e=>{d.isTypeOf("number",t.read_receipt[e])&&this._updateUnreadMemberState(e,t.read_receipt[e])})),t.delivery_receipt&&Object.keys(t.delivery_receipt).forEach((e=>{d.isTypeOf("number",t.delivery_receipt[e])&&this._updateUndeliveredMemberState(e,t.delivery_receipt[e])})),this.myMemberState=d.isEnumOf(exports.MemberState,t.member_state)?t.member_state:exports.MemberState.NONE,this.myRole=d.isEnumOf(d.Role,t.my_role)?t.my_role:d.Role.NONE,d.isEnumOf(d.MutedState,t.is_muted)?this.myMutedState=t.is_muted:d.isTypeOf("boolean",t.is_muted)?this.myMutedState=t.is_muted?d.MutedState.MUTED:d.MutedState.UNMUTED:this.myMutedState=d.MutedState.UNMUTED,this.myCountPreference=d.isEnumOf(exports.CountPreference,t.count_preference)?t.count_preference:exports.CountPreference.ALL,this.myPushTriggerOption=d.isEnumOf(d.PushTriggerOption,t.push_trigger_option)?t.push_trigger_option:d.PushTriggerOption.ALL,this.myLastRead=null!==(E=t.user_last_read)&&void 0!==E?E:0,this.inviter=t.inviter?new d.User(this._iid,t.inviter):null,this.invitedAt=null!==(v=t.invited_at)&&void 0!==v?v:0,this.joinedAt=null!==(f=t.joined_ts)&&void 0!==f?f:0,this._updateUnreadCount(null!==(M=t.unread_message_count)&&void 0!==M?M:0,null!==(S=t.unread_mention_count)&&void 0!==S?S:0),this.pinnedMessageIds=null!==(y=t.pinned_message_ids)&&void 0!==y?y:[],this.lastPinnedMessage=t.latest_pinned_message?u.parseMessagePayload(this._iid,Object.assign({channel_type:this.channelType},t.latest_pinned_message)):null}get isHidden(){return this.hiddenState!==exports.HiddenState.UNHIDDEN}get isTyping(){return this._typingStatus.size>0}get cachedUnreadMemberState(){const e={};for(const[t,s]of this._unreadMemberStateMap)e[t]=s;return e}get cachedUndeliveredMemberState(){const e={};for(const[t,s]of this._undeliveredMemberStateMap)e[t]=s;return e}static payloadify(e){return d.deundefined(d.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{is_access_code_required:e.isAccessCodeRequired,is_distinct:e.isDistinct,is_super:e.isSuper,is_broadcast:e.isBroadcast,is_exclusive:e.isExclusive,is_public:e.isPublic,is_discoverable:e.isDiscoverable,is_muted:e.myMutedState,is_push_enabled:e.isPushEnabled,unread_message_count:e.unreadMessageCount,unread_mention_count:e.unreadMentionCount,push_trigger_option:e.myPushTriggerOption,count_preference:e.myCountPreference,hidden_state:e.hiddenState,member_count:e.memberCount,joined_member_count:e.joinedMemberCount,member_state:e.myMemberState,my_role:e.myRole,user_last_read:e.myLastRead,ts_message_offset:e.messageOffsetTimestamp,message_survival_seconds:e.messageSurvivalSeconds,read_receipt:e.cachedUnreadMemberState,delivery_receipt:e.cachedUndeliveredMemberState,members:e.members.map((e=>m.payloadify(e))),last_message:e.lastMessage?u.payloadifyMessage(e.lastMessage):null,inviter:e.inviter?d.User.payloadify(e.inviter):null,invited_at:e.invitedAt,joined_ts:e.joinedAt,pinned_message_ids:e.pinnedMessageIds,latest_pinned_message:e.lastPinnedMessage?u.payloadifyMessage(e.lastPinnedMessage):null})))}_shouldUpdateLastMessageWith(e){return!(e instanceof u.SendableMessage&&e.parentMessageId>0&&!e.replyToChannel)&&(!this.lastMessage||this.lastMessage.createdAt<e.createdAt||this.lastMessage.createdAt===e.createdAt&&this.lastMessage.messageId===e.messageId&&this.lastMessage.updatedAt<e.updatedAt)}_updateUnreadCount(e,t){if("number"==typeof e&&e>=0)if(this.myCountPreference===exports.CountPreference.ALL||this.myCountPreference===exports.CountPreference.UNREAD_MESSAGE_COUNT_ONLY)if(this.isExclusive||this.isSuper||this.isBroadcast){const{maxSuperGroupChannelUnreadCount:t}=d.Vault.of(this._iid);this.unreadMessageCount=t&&e>=t?t:e}else this.unreadMessageCount=e;else this.unreadMessageCount=0;else this.unreadMessageCount=0;"number"==typeof t&&t>=0&&(this.myCountPreference===exports.CountPreference.ALL||this.myCountPreference===exports.CountPreference.UNREAD_MENTION_COUNT_ONLY)?this.unreadMentionCount=t:this.unreadMentionCount=0}_updateUnreadMemberState(e,t){const s=this._unreadMemberStateMap.get(e);if(!s||s<t){this._unreadMemberStateMap.set(e,t);const{sdkState:s}=d.Vault.of(this._iid);return s.userId===e&&(this.myLastRead=t),!0}return!1}_updateUndeliveredMemberState(e,t){const s=this._undeliveredMemberStateMap.get(e);return(!s||s<t)&&(this._undeliveredMemberStateMap.set(e,t),!0)}_updateTypingStatus(e,t=(new Date).getTime()){t>0?this._typingStatus.set(e.userId,{user:e,ts:t}):this._typingStatus.delete(e.userId)}_clearTypingStatus(){this._typingStatus.clear(),this._typingStarted=0,this._typingEnded=0}_setLatestMemberCount(e,t,s){let n=!1;return s>=this._lastMemberCountUpdated&&(this._lastMemberCountUpdated=s,n=e!==this.memberCount||t!==this.joinedMemberCount,this.memberCount=e,this.joinedMemberCount=t),n}isReadMessage(e){const{sdkState:t}=d.Vault.of(this._iid),s=this._unreadMemberStateMap.get(t.userId);return!!s&&s>=e.createdAt}serialize(){return d.serialize(this,(e=>{e.cachedUnreadMemberState=this.cachedUnreadMemberState,e.cachedUndeliveredMemberState=this.cachedUndeliveredMemberState}))}createMessageCollection(e={}){return new Xe(this._iid,Object.assign(Object.assign({},e),{channel:this}))}createMemberListQuery(e={}){return new rt(this._iid,this.url,e)}createPinnedMessageListQuery(e={}){return new Rt(this._iid,this.url,this.channelType,e)}addMember(e,t=0){if(!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const s=this.members.findIndex((t=>t.userId===e.userId));if(s>-1){const t=this.members[s];t.state===exports.MemberState.JOINED&&(e.state=t.state),this.members.splice(s,1),this.memberCount--}this.members.push(e),this.memberCount++,this._updateUnreadMemberState(e.userId,t),this._updateUndeliveredMemberState(e.userId,t)}}removeMember(e){if(!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const t=e instanceof m?e.userId:e,s=this.members.findIndex((e=>e.userId===t));if(s>-1)return this.members.splice(s,1),this.memberCount--,!0}return!1}getUnreadMemberCount(e){if(e instanceof u.SendableMessage&&!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const{sdkState:t}=d.Vault.of(this._iid),s=e.createdAt;let n=0;for(const i of this.members)if(t.userId!==i.userId&&i.state===exports.MemberState.JOINED&&e.sender.userId!==i.userId){(this.cachedUnreadMemberState[i.userId]||0)<s&&n++}return n}return 0}getUndeliveredMemberCount(e){if(e instanceof u.SendableMessage&&!this.isExclusive&&!this.isSuper&&!this.isBroadcast){const{sdkState:t}=d.Vault.of(this._iid),s=e.createdAt;let n=0;for(const i of this.members)if(t.userId!==i.userId&&i.state===exports.MemberState.JOINED&&e.sender.userId!==i.userId){(this.cachedUndeliveredMemberState[i.userId]||0)<s&&n++}return n}return 0}getReadMembers(e,t=!1){const{sdkState:s}=d.Vault.of(this._iid);if(!s.userId||this.isExclusive||this.isSuper||this.isBroadcast)return[];const n=e instanceof u.SendableMessage?e.sender:null,i=[];return this.members.forEach((a=>{if(t||a.userId!==s.userId&&a.userId!==(null==n?void 0:n.userId)){const t=this._unreadMemberStateMap.get(a.userId);t&&t>=e.createdAt&&i.push(a)}})),i}getUnreadMembers(e,t=!1){const{sdkState:s}=d.Vault.of(this._iid);if(!s.userId||this.isExclusive||this.isSuper||this.isBroadcast)return[];const n=e instanceof u.SendableMessage?e.sender:null,i=[];return this.members.forEach((a=>{if(t||a.userId!==s.userId&&a.userId!==(null==n?void 0:n.userId)){const t=this._unreadMemberStateMap.get(a.userId);t&&t<e.createdAt&&i.push(a)}})),i}getReadStatus(e=!1){const{sdkState:t}=d.Vault.of(this._iid);if(!t.userId||this.isExclusive||this.isSuper||this.isBroadcast)return null;const s={};return this.members.forEach((n=>{if(e||n.userId!==t.userId){const e=this._unreadMemberStateMap.get(n.userId);s[n.userId]=new C(this._iid,{channel_url:this.url,channel_type:this.channelType,user:m.payloadify(n),ts:null!=e?e:0})}})),s}getTypingUsers(){const e=[];return this._typingStatus.forEach((t=>{const{user:s}=t;e.push(s)})),e}invalidateTypingStatus(){const{typingIndicatorInvalidateTime:e}=d.Vault.of(this._iid),t=Date.now();let s=!1;return this._typingStatus.forEach(((n,i)=>{const{ts:a}=n;t-a>=e&&(this._typingStatus.delete(i),s=!0)})),s}refresh(){return d.__awaiter(this,void 0,void 0,(function*(){return this._refresh()}))}_refresh(e=!1){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:t,dispatcher:s}=d.Vault.of(this._iid),n=new F({channelUrl:this.url}),i=yield t.send(n),{channel:a}=i.as(k);return this._update(a),e&&s.dispatch(new O({channels:[a],source:d.CollectionEventSource.REQUEST_CHANNEL})),this}))}freeze(){const e=Object.create(null,{freeze:{get:()=>super.freeze}});return d.__awaiter(this,void 0,void 0,(function*(){yield e.freeze.call(this);const{dispatcher:t}=d.Vault.of(this._iid);t.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_FROZEN,isWebSocketEventComing:!0}))}))}unfreeze(){const e=Object.create(null,{unfreeze:{get:()=>super.unfreeze}});return d.__awaiter(this,void 0,void 0,(function*(){yield e.unfreeze.call(this);const{dispatcher:t}=d.Vault.of(this._iid);t.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_UNFROZEN,isWebSocketEventComing:!0}))}))}updateChannel(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},et),e);d.unless((e=>d.isTypeOf("string",e.coverUrl,!0)&&(d.isFile(e.coverImage)||d.isTypeOf("string",e.coverImage,!0))&&d.isTypeOf("boolean",e.isDistinct,!0)&&d.isTypeOf("boolean",e.isPublic,!0)&&d.isTypeOf("boolean",e.isDiscoverable,!0)&&d.isTypeOf("string",e.accessCode,!0)&&d.isTypeOf("string",e.name,!0)&&d.isTypeOf("string",e.data,!0)&&d.isTypeOf("string",e.customType,!0)&&d.isArrayOf("string",e.operatorUserIds,!0)&&d.isTypeOf("number",e.messageSurvivalSeconds,!0))(t)).throw(d.SendbirdError.invalidParameters);const{dispatcher:s,requestQueue:n}=d.Vault.of(this._iid),i=new dt(Object.assign({channelUrl:this.url},t)),a=yield n.send(i),{channel:r}=a.as(ht);return this._update(r),s.dispatch(new O({channels:[r],source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED,isWebSocketEventComing:!0})),this}))}invite(e){return d.__awaiter(this,void 0,void 0,(function*(){return d.unless(e.every((e=>e instanceof d.User))).throw(d.SendbirdError.invalidParameters),this.inviteWithUserIds(e.map((e=>e.userId)))}))}inviteWithUserIds(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isArrayOf("string",e)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,requestQueue:s}=d.Vault.of(this._iid),n=new oe({channelUrl:this.url,userIds:e}),i=yield s.send(n),{channel:a}=i.as(le);return this._update(a),t.dispatch(new O({channels:[a],source:d.CollectionEventSource.EVENT_CHANNEL_INVITED,isWebSocketEventComing:!0})),this}))}join(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e,!0)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new se({channelUrl:this.url,userId:s.userId,accessCode:e}),a=yield n.send(i),{channel:r}=a.as(ne);return r.myMemberState=this.myMemberState=exports.MemberState.JOINED,this._update(r),t.dispatch(new O({channels:[r],source:d.CollectionEventSource.EVENT_CHANNEL_JOINED,isWebSocketEventComing:!0})),this}))}leave(e=!1){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:t,requestQueue:s}=d.Vault.of(this._iid),n=new ae({channelUrl:this.url,userId:t.userId,shouldRemoveOperatorStatus:e});yield s.send(n),this.myMemberState=exports.MemberState.NONE}))}acceptInvitation(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("string",e,!0)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new ot({channelUrl:this.url,userId:s.userId,accessCode:e}),a=yield n.send(i),{channel:r}=a.as(lt);return r.myMemberState=this.myMemberState=exports.MemberState.JOINED,this._update(r),t.dispatch(new O({channels:[r],source:d.CollectionEventSource.EVENT_CHANNEL_ACCEPTED_INVITE,isWebSocketEventComing:!0})),this}))}declineInvitation(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new he({channelUrl:this.url,userId:e.userId});return yield t.send(s),this.myMemberState=exports.MemberState.NONE,this}))}sendUserMessage(e){const t=new u.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super.sendUserMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{s&&n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{this.hiddenState===exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE&&(this.hiddenState=exports.HiddenState.UNHIDDEN),n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e);Ue.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}updateUserMessage(e,t){const s=Object.create(null,{updateUserMessage:{get:()=>super.updateUserMessage}});return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:n}=d.Vault.of(this._iid),i=yield s.updateUserMessage.call(this,e,t);let a=!1;!i.silent&&this._shouldUpdateLastMessageWith(i)&&(this.lastMessage=i,a=!0);let r=!1;if(this.lastPinnedMessage&&this.lastPinnedMessage.messageId===i.messageId&&(this.lastPinnedMessage=i,a=!0,r=!0),a){Ue.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),n.dispatch(new O({channels:[this],source:r?d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:d.CollectionEventSource.EVENT_MESSAGE_UPDATED}))}if(r){Ue.of(this._iid).handlers.map((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(this)}))}return n.dispatch(new d.MessageUpdateEventCommand({messages:[i],source:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),i}))}_autoResendUserMessage(e){const t=new u.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super._autoResendUserMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ue.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}sendFileMessage(e){const t=new u.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super.sendFileMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{s&&n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ue.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}sendMultipleFilesMessage(e){const t=new u.MultipleFilesMessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid);return super.sendMultipleFilesMessage(e).onPending((e=>{t._trigger(e)})).onFailed(((e,s)=>{t._triggerFailed(e,s)})).onSucceeded((e=>{const n=Ue.of(this._iid);this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),n.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})).onFileUploaded(((e,s,n,i)=>{t._triggerOnFileUploaded(e,s,n,i)})),t}updateFileMessage(e,t){const s=Object.create(null,{updateFileMessage:{get:()=>super.updateFileMessage}});return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:n}=d.Vault.of(this._iid),i=yield s.updateFileMessage.call(this,e,t);let a=!1;!i.silent&&this._shouldUpdateLastMessageWith(i)&&(this.lastMessage=i,a=!0);let r=!1;if(this.lastPinnedMessage&&this.lastPinnedMessage.messageId===i.messageId&&(this.lastPinnedMessage=i,a=!0,r=!0),a){Ue.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),n.dispatch(new O({channels:[this],source:r?d.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:d.CollectionEventSource.EVENT_MESSAGE_UPDATED}))}if(r){Ue.of(this._iid).handlers.map((e=>{e.onPinnedMessageUpdated&&e.onPinnedMessageUpdated(this)}))}return n.dispatch(new d.MessageUpdateEventCommand({messages:[i],source:d.CollectionEventSource.EVENT_MESSAGE_UPDATED})),i}))}_autoResendFileMessage(e){const t=new u.MessageRequestHandler,{dispatcher:s}=d.Vault.of(this._iid),n=c.AutoResendManager.of(this._iid);return super._autoResendFileMessage(e).onPending((e=>{n.completeCurrentAndProcessNextAutoResend(e),t._trigger(e)})).onFailed(((e,s)=>{n.completeCurrentAndProcessNextAutoResend(s),t._triggerFailed(e,s)})).onSucceeded((e=>{const i=Ue.of(this._iid);n.completeCurrentAndProcessNextAutoResend(e),this._shouldUpdateLastMessageWith(e)&&(this.lastMessage=e),i.handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)})),s.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_MESSAGE_SENT})),t._trigger(e)})),t}deleteMessage(e){const t=Object.create(null,{deleteMessage:{get:()=>super.deleteMessage}});return d.__awaiter(this,void 0,void 0,(function*(){if(yield t.deleteMessage.call(this,e),0===e.messageId&&e instanceof u.SendableMessage){const{dispatcher:t}=d.Vault.of(this._iid);t.dispatch(new d.UnsentMessageRemoveEventCommand({reqId:e.reqId,source:d.CollectionEventSource.EVENT_MESSAGE_DELETED}))}}))}hide(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ue),e);d.unless((e=>d.isTypeOf("boolean",e.hidePreviousMessages,!0)&&d.isTypeOf("boolean",e.allowAutoUnhide,!0))(t)).throw(d.SendbirdError.invalidParameters);const{dispatcher:s,sdkState:n,requestQueue:i}=d.Vault.of(this._iid),a=new _e(Object.assign({channelUrl:this.url,userId:n.userId},t)),r=yield i.send(a),{messageOffsetTimestamp:o}=r.as(pe);return this.hiddenState=t.allowAutoUnhide?exports.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE:exports.HiddenState.HIDDEN_PREVENT_AUTO_UNHIDE,t.hidePreviousMessages&&this._updateUnreadCount(0,0),o&&(this.messageOffsetTimestamp=o),s.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_HIDDEN,isWebSocketEventComing:!0})),this}))}unhide(){return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:e,requestQueue:t}=d.Vault.of(this._iid),s=new ut({channelUrl:this.url});return yield t.send(s),this.hiddenState=exports.HiddenState.UNHIDDEN,e.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_UNHIDDEN,isWebSocketEventComing:!0})),this}))}delete(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e}=d.Vault.of(this._iid),t=new ct({channelUrl:this.url});yield e.send(t)}))}markAsRead(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,dispatcher:t,requestQueue:s}=d.Vault.of(this._iid),n=new ye({channelUrl:this.url}),i=yield s.send(n),{readStatus:a}=i.as(Ae);if(this._updateUnreadMemberState(e.userId,a.readAt),this.unreadMessageCount>0||this.unreadMentionCount>0){this._updateUnreadCount(0,0);Ue.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)}))}t.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_READ}))}))}markAsDelivered(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new be({channelUrl:this.url,userId:e.userId});yield t.send(s)}))}startTyping(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,typingIndicatorThrottle:t}=d.Vault.of(this._iid),s=(new Date).getTime();if(s-this._typingStarted>=t){this._typingStarted=s,this._typingEnded=0;const t=new Ce({channelUrl:this.url,time:this._typingStarted});e.send(t)}}))}endTyping(){return d.__awaiter(this,void 0,void 0,(function*(){const{requestQueue:e,typingIndicatorThrottle:t}=d.Vault.of(this._iid),s=(new Date).getTime();if(s-this._typingEnded>=t){this._typingStarted=0,this._typingEnded=s;const t=new Ee({channelUrl:this.url,time:this._typingStarted});e.send(t)}}))}createScheduledUserMessage(e){e=Object.assign(Object.assign({},u.ScheduledUserMessageCreateParamsDefault),e),d.unless(u.validateScheduledUserMessageCreateParams(e)).throw(d.SendbirdError.invalidParameters);const t=new u.MessageRequestHandler;return this._createScheduledUserMessage(e,t),t}updateScheduledUserMessage(e,t){return d.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},Et),t);d.unless((e=>u.validateUserMessageUpdateParams(e)&&d.isTypeOf("number",e.scheduledAt,!0))(s)).throw(d.SendbirdError.invalidParameters);const{requestQueue:n}=d.Vault.of(this._iid),i=new Mt(Object.assign({reqId:this._generateRequestId(),scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url},s)),a=yield n.send(i),{message:r}=a.as(h.CreateScheduledUserMessageResponseCommand);return r}))}createScheduledFileMessage(e){e=Object.assign(Object.assign({},u.ScheduledFileMessageCreateParamsDefault),e),d.unless(u.validateScheduledFileMessageCreateParams(e)).throw(d.SendbirdError.invalidParameters);const t=Date.now(),s=this._generateRequestId(),n=new u.MessageRequestHandler;return d.sleep(h.PENDING_MESSAGE_DELAY).then((()=>{const i=this._createPendingScheduledFileMessage(e,s,t);d.runAsCallback((()=>d.__awaiter(this,void 0,void 0,(function*(){return n._trigger(i)}))))})),d.isFile(e.file)?this._uploadFileAndUpdateParams(e).then((()=>this._createScheduledFileMessage(e,n,s,t))):this._createScheduledFileMessage(e,n,s,t),n}updateScheduledFileMessage(e,t){return d.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},gt),t);d.unless((e=>u.validateBaseMessageUpdateParams(e)&&d.isTypeOf("number",e.scheduledAt,!0)&&(d.isFile(e.file)||d.isTypeOf("string",e.fileUrl))&&d.isTypeOf("string",e.fileName,!0)&&d.isTypeOf("string",e.mimeType,!0)&&d.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||e.thumbnailSizes.every((e=>d.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))))(s)).throw(d.SendbirdError.invalidParameters),d.isFile(s.file)&&(yield this._uploadFileAndUpdateParams(s));const n=new vt(Object.assign({reqId:this._generateRequestId(),scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url},s)),{requestQueue:i}=d.Vault.of(this._iid),a=yield i.send(n),{message:r}=a.as(ft);return r}))}cancelScheduledMessage(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=new St({scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url}),{requestQueue:s}=d.Vault.of(this._iid);yield s.send(t)}))}sendScheduledMessageNow(e){return d.__awaiter(this,void 0,void 0,(function*(){const t=new yt({scheduledMessageId:e,channelType:this.channelType,channelUrl:this.url}),{requestQueue:s}=d.Vault.of(this._iid);yield s.send(t)}))}getMyPushTriggerOption(){return d.__awaiter(this,void 0,void 0,(function*(){const{sdkState:e,requestQueue:t}=d.Vault.of(this._iid),s=new Nt({userId:e.userId,channelUrl:this.url}),n=yield t.send(s),{pushTriggerOption:i}=n.as(Tt);return this.myPushTriggerOption=i,i}))}setMyPushTriggerOption(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isEnumOf(d.PushTriggerOption,e)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new At({userId:s.userId,channelUrl:this.url,pushTriggerOption:e}),a=yield n.send(i),{pushTriggerOption:r}=a.as(bt);return this.myPushTriggerOption=r,t.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED,isWebSocketEventComing:!0})),r}))}setMyCountPreference(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isEnumOf(exports.CountPreference,e)).throw(d.SendbirdError.invalidParameters);const{dispatcher:t,sdkState:s,requestQueue:n}=d.Vault.of(this._iid),i=new _t({channelUrl:this.url,userId:s.userId,countPreference:e}),a=yield n.send(i),{countPreference:r}=a.as(pt);return this.myCountPreference=r,this._updateUnreadCount(this.unreadMessageCount,this.unreadMentionCount),t.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_UPDATED,isWebSocketEventComing:!0})),r}))}resetMyHistory(){return d.__awaiter(this,void 0,void 0,(function*(){const{dispatcher:e,requestQueue:t}=d.Vault.of(this._iid),s=new mt({channelUrl:this.url}),n=yield t.send(s),{messageOffsetTimestamp:i}=n.as(Ct);return this.messageOffsetTimestamp=i,this.lastMessage&&this.lastMessage.createdAt<i&&(this.lastMessage=null),e.dispatch(new O({channels:[this],source:d.CollectionEventSource.EVENT_CHANNEL_RESET_HISTORY,isWebSocketEventComing:!0})),this}))}pinMessage(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("number",e)&&e>0).throw(d.SendbirdError.invalidParameters);const{requestQueue:t}=d.Vault.of(this._iid),s=new Ut({channelType:this.channelType,channelUrl:this.url,messageId:e});yield t.send(s)}))}unpinMessage(e){return d.__awaiter(this,void 0,void 0,(function*(){d.unless(d.isTypeOf("number",e)&&e>0).throw(d.SendbirdError.invalidParameters);const{requestQueue:t}=d.Vault.of(this._iid),s=new It({channelType:this.channelType,channelUrl:this.url,messageId:e});yield t.send(s)}))}_uploadFileAndUpdateParams(e){return d.__awaiter(this,void 0,void 0,(function*(){if(d.isFile(e.file)){const{requestQueue:t}=d.Vault.of(this._iid),s=new u.UploadFileRequestCommand({file:e.file,channelUrl:this.url,thumbnailSizes:e.thumbnailSizes,requestId:this._generateRequestId()}),n=yield t.send(s),{url:i,fileSize:a=e.fileSize,thumbnailSizes:r=e.thumbnailSizes,requireAuth:o=!1}=n.as(u.UploadFileResponseCommand);e.fileUrl=i,e.fileSize=a,e.thumbnailSizes=r,e.requireAuth=o}}))}}exports.BaseMessageCollection=Ze,exports.DeclineInvitationEventCommand=ce,exports.FeedChannelEventContext=$e,exports.FeedChannelRemoveEventCommand=ke,exports.FeedChannelUpdateEventCommand=Fe,exports.GetTotalUnreadMessageCountRequestCommand=Q,exports.GetTotalUnreadMessageCountResponseCommand=K,exports.GroupChannel=Lt,exports.GroupChannelChangeLogsParamsDefault=M,exports.GroupChannelCountParamsDefault=y,exports.GroupChannelCreateParamsDefault=v,exports.GroupChannelEventContext=We,exports.GroupChannelEventSource=P,exports.GroupChannelFilter=g,exports.GroupChannelListQuery=Me,exports.GroupChannelManager=Ue,exports.InviteToGroupChannelEventCommand=de,exports.Member=m,exports.MemberListQuery=rt,exports.MessageAckCommand=fe,exports.MessageCollection=Xe,exports.MessageCollectionInitHandler=Je,exports.MessageEventContext=Qe,exports.NotificationEventContext=Ke,exports.PinnedMessage=Pt,exports.PinnedMessageListQuery=Rt,exports.ReadEventCommand=Ae,exports.ReadRequestCommand=ye,exports.ReadStatus=C,exports.Sync=Pe,exports.TotalUnreadMessageCountParamsDefault=T,exports.shouldGiveEvent=x,exports.validateGroupChannelChangeLogsParams=S,exports.validateGroupChannelCountParams=A,exports.validateGroupChannelCreateParams=f,exports.validateTotalUnreadMessageCountParams=U;
