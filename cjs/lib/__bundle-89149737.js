"use strict";var e,t,i,s=require("./__bundle-d4a8e3dc.js"),r=require("./__bundle-244bc12f.js"),n=require("./__bundle-73ccac4a.js");exports.GroupChannelListOrder=void 0,(e=exports.GroupChannelListOrder||(exports.GroupChannelListOrder={})).LATEST_LAST_MESSAGE="latest_last_message",e.CHRONOLOGICAL="chronological",e.CHANNEL_NAME_ALPHABETICAL="channel_name_alphabetical",e.METADATA_VALUE_ALPHABETICAL="metadata_value_alphabetical",exports.PublicGroupChannelListOrder=void 0,(t=exports.PublicGroupChannelListOrder||(exports.PublicGroupChannelListOrder={})).CHRONOLOGICAL="chronological",t.CHANNEL_NAME_ALPHABETICAL="channel_name_alphabetical",t.METADATA_VALUE_ALPHABETICAL="metadata_value_alphabetical",exports.ScheduledMessageListOrder=void 0,(i=exports.ScheduledMessageListOrder||(exports.ScheduledMessageListOrder={})).CREATED_AT="created_at",i.SCHEDULED_AT="scheduled_at";class a{constructor(){this.messageTypeFilter=s.MessageTypeFilter.ALL,this.customTypesFilter=null,this.senderUserIdsFilter=null,this.replyType=s.ReplyType.NONE}clone(){const e=new a,t=JSON.parse(JSON.stringify(this));return Object.keys(t).forEach((i=>{e[i]=t[i]})),e}match(e){switch(this.messageTypeFilter){case s.MessageTypeFilter.USER:if(e.messageType!==s.MessageType.USER)return!1;break;case s.MessageTypeFilter.FILE:if(e.messageType!==s.MessageType.FILE)return!1;break;case s.MessageTypeFilter.ADMIN:if(e.messageType!==s.MessageType.ADMIN)return!1}if(this.customTypesFilter&&this.customTypesFilter.length>0&&!this.customTypesFilter.includes(e.customType))return!1;if(this.senderUserIdsFilter&&this.senderUserIdsFilter.length>0){if(!(e instanceof n.SendableMessage))return!1;if(!this.senderUserIdsFilter.includes(e.sender.userId))return!1}switch(this.replyType){case s.ReplyType.NONE:if(e.parentMessageId>0)return!1;break;case s.ReplyType.ONLY_REPLY_TO_CHANNEL:if(e instanceof n.SendableMessage&&e.parentMessageId>0&&!e.replyToChannel)return!1}return!0}}var o;exports.MessageListOrder=void 0,(o=exports.MessageListOrder||(exports.MessageListOrder={})).CHANNEL_LATEST="channel_latest",o.NEWEST_CHILD_MESSAGE="newest_child_message";const d=e=>{switch(e){case exports.MessageListOrder.CHANNEL_LATEST:return["channelUrl","-createdAt","-messageId"];case exports.MessageListOrder.NEWEST_CHILD_MESSAGE:return["channelUrl","-parentMessageId","-createdAt","-messageId"]}},l=()=>"undefined"!=typeof document&&"undefined"!=typeof navigator&&"ReactNative"!==navigator.product,c=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:3&i|8).toString(16)}))};var h,_;!function(e){e[e.PROCESSING=0]="PROCESSING",e[e.DONE=1]="DONE"}(h||(h={})),function(e){e.NEWNODE="newnode",e.REMOVENODE="removenode",e.CLAIM_HOST="claimhost",e.SYNC_HOST="synchost",e.REQUEST_LOCK="requestlock",e.ACQUIRE_LOCK="acquirelock",e.RELEASE_LOCK="releaselock"}(_||(_={}));const u={};class E{constructor(e,t={}){return this._state=h.PROCESSING,this._queue=[],this._activationQueue=[],u[e]&&!t.forceCreate||(this.nodeId=c(),this.key=e,l()&&(t.startAsInvisible?this.registerNode():"visible"===document.visibilityState?this.claimHost():this.registerNode(),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.claimHost()})),window.addEventListener("message",(e=>{const t=e.data,{nodeId:i,requestId:s,key:r,op:n,data:a}=t;if(i!==this.nodeId&&r===this.key)switch(n){case _.NEWNODE:this._sendSync();break;case _.CLAIM_HOST:this._sendSync(),this._hostId=i;break;case _.SYNC_HOST:if(!this.isInSync){this._activationTimeout&&clearTimeout(this._activationTimeout);const{currentItemRequestId:e,queue:t}=a;for(const e of t){this._queue.findIndex((t=>t.requestId===e.requestId))<0&&this._requestLock({nodeId:e.nodeId,requestId:e.requestId,key:this.key,op:_.REQUEST_LOCK,ts:e.ts})}this._currentItem=this._queue.find((t=>t.requestId===e)),this._completeSync()}break;case _.REMOVENODE:this._queue=this._queue.filter((e=>e.nodeId!==t.nodeId)),this._currentItem&&this._currentItem.nodeId===t.nodeId&&(this._currentItem=void 0,this._acquire(this._queue[0]));break;case _.REQUEST_LOCK:this._requestLock(t);break;case _.ACQUIRE_LOCK:{const e=this._queue.find((e=>e.requestId===s));this._acquire(e);break}case _.RELEASE_LOCK:this._release(s)}})),window.addEventListener("beforeunload",(()=>{this._send(_.REMOVENODE)}))),u[e]=this),u[e]}get locked(){return!!this._currentItem}get isHost(){return this._hostId===this.nodeId}get isInSync(){return this._state==h.DONE}_send(e,t={}){var i;const s={nodeId:this.nodeId,requestId:null!==(i=null==t?void 0:t.requestId)&&void 0!==i?i:c(),key:this.key,op:e,data:t.data,ts:Date.now()};return l()&&window.postMessage(s,"*"),s}_acquire(e){e?(this._currentItem=e,this._currentItem.onAcquired&&this._currentItem.onAcquired(e.requestId)):this._currentItem=void 0}_release(e){if(this._currentItem&&this._currentItem.requestId===e){const t=this._currentItem;this._currentItem=void 0,t.nodeId===this.nodeId&&this._send(_.RELEASE_LOCK,{requestId:t.requestId});const i=this._queue.findIndex((t=>t.requestId===e));i>-1&&this._queue.splice(i,1),t.onReleased&&t.onReleased(e)}}_requestLock(e){return new Promise((t=>{const i={nodeId:e.nodeId,requestId:e.requestId,ts:e.ts,onAcquired:e=>{this.isHost&&this._send(_.ACQUIRE_LOCK,{requestId:e}),t()},onReleased:()=>{this._acquire(this._queue[0])}};let s=!1;for(const e in this._queue)if(this._queue[e].ts>i.ts){this._queue.splice(parseInt(e),0,i),s=!0;break}s||this._queue.push(i),this._currentItem||this._acquire(this._queue[0])}))}_sendSync(){var e;this.isHost&&this._send(_.SYNC_HOST,{data:{currentItemRequestId:null===(e=this._currentItem)||void 0===e?void 0:e.requestId,queue:this._queue.map((e=>({nodeId:e.nodeId,requestId:e.requestId,ts:e.ts})))}})}_waitUntilSyncCompleted(){return s.__awaiter(this,void 0,void 0,(function*(){if(this.isHost&&!this.isInSync)return new Promise((e=>{this._activationQueue.push(e)}))}))}_waitSync(){this.isInSync||(this._activationTimeout=setTimeout((()=>{this._completeSync()}),8))}_completeSync(){this.isInSync||(this._state=h.DONE,this._activationQueue.forEach((e=>e())),this._activationQueue=[])}registerNode(){this._send(_.NEWNODE),this._waitSync()}claimHost(){this._hostId=this.nodeId,this._send(_.CLAIM_HOST),this._waitSync()}lock(){return s.__awaiter(this,void 0,void 0,(function*(){yield this._waitUntilSyncCompleted();const e=this._send(_.REQUEST_LOCK);yield this._requestLock(e)}))}unlock(){var e;(null===(e=this._currentItem)||void 0===e?void 0:e.requestId)&&this._release(this._currentItem.requestId)}}const m=Object.assign(Object.assign({},r.UserMessageCreateParamsDefault),{scheduledAt:void 0}),f=Object.assign(Object.assign({},r.BaseMessageCreateParamsDefault),{scheduledAt:0,file:void 0,fileUrl:void 0,fileName:void 0,mimeType:void 0,fileSize:void 0,thumbnailSizes:void 0,requireAuth:!1}),g="UnsentMessage",y={};class N extends s.InstancedObject{constructor(e,{sdkState:t,cacheContext:i}){super(e),this._sdkState=t,this._cacheContext=i,y[e]=this,this._mutex=new E("unsendmessagecache.lock")}static of(e){return y[e]}get collection(){const{nestdb:e}=this._cacheContext,t=null==e?void 0:e.collection(g);if(!t)throw s.SendbirdError.databaseError;return t}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){if(e.messageId>0)throw s.SendbirdError.invalidParameters;const t=Object.assign({},e.serialize());var i;return e instanceof n.UserMessage?(e.messageParams&&(t.messageParams=r.serializeUserMessageCreateParams(e.messageParams)),e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams&&(t.scheduledInfo.scheduledMessageParams=(i=e.scheduledInfo.scheduledMessageParams,Object.assign(Object.assign({},r.serializeUserMessageCreateParams(i)),{scheduledAt:i.scheduledAt})))):e instanceof n.FileMessage?(e.messageParams&&(t.messageParams=r.serializeFileMessageCreateParams(e.messageParams)),e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams&&(t.scheduledInfo.scheduledMessageParams=(e=>Object.assign(Object.assign({},r.serializeFileMessageCreateParams(e)),{scheduledAt:e.scheduledAt}))(e.scheduledInfo.scheduledMessageParams))):e instanceof n.MultipleFilesMessage&&e.messageParams&&(t.messageParams=r.serializeMultipleFilesMessageCreateParams(e.messageParams)),t}_deserialize(e){e=Object.assign(Object.assign({},e),{messageId:parseInt(e.messageId)});return n.MessageManager.of(this._iid).buildMessageFromSerializedData(e)}_deserializeWithMessageCreateParams(e){var t,i,a;return s.__awaiter(this,void 0,void 0,(function*(){const o=n.MessageManager.of(this._iid),d=this._deserialize(e);if(e.messageParams)if(d instanceof n.UserMessage){const t=e.messageParams;d.messageParams=o.buildUserMessageCreateParamsFromSerializedData(t,d)}else if(d instanceof n.FileMessage){const s=e.messageParams;s.fileKey&&"string"==typeof s.fileKey&&r.isFileTypeBlob(null!==(t=s.fileType)&&void 0!==t?t:"")&&(s.file=null!==(i=yield this.collection.getBlob(s.fileKey))&&void 0!==i?i:void 0),d.messageParams=o.buildFileMessageCreateParamsFromSerializedData(s,d)}else if(d instanceof n.MultipleFilesMessage){const t=e.messageParams;t&&t.fileInfoList&&(d.messageParams=o.buildMultipleFilesMessageCreateParamsFromSerializedData(t,d),yield Promise.all(d.messageParams.fileInfoList.map((e=>s.__awaiter(this,void 0,void 0,(function*(){var t,i,s,n;"string"==typeof(null===(t=e._uploadedMetaData)||void 0===t?void 0:t.fileKey)&&r.isFileTypeBlob(null!==(s=null===(i=e._uploadedMetaData)||void 0===i?void 0:i.fileType)&&void 0!==s?s:"")&&(e.file=null!==(n=yield this.collection.getBlob(e._uploadedMetaData.fileKey))&&void 0!==n?n:void 0)}))))))}if(d.scheduledInfo&&e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams)if(d instanceof n.UserMessage){const t=e.scheduledInfo.scheduledMessageParams;d.scheduledInfo.scheduledMessageParams=o.buildScheduledUserMessageCreateParamsFromSerializedData(t,d)}else if(d instanceof n.FileMessage){const t=e.scheduledInfo.scheduledMessageParams;t.fileKey&&"string"==typeof t.fileKey&&"string"==typeof t.fileType&&r.isFileTypeBlob(t.fileType)&&(t.file=null!==(a=yield this.collection.getBlob(t.fileKey))&&void 0!==a?a:void 0),d.scheduledInfo.scheduledMessageParams=o.buildScheduledFileMessageCreateParamsFromSerializedData(t,d)}return d}))}_getFileInfoBlobKey(e,t){return`${e}.${t}`}get(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(`${e}`);if(t)return this._deserializeWithMessageCreateParams(t)}}))}fetch({channelUrl:e,filter:t=new a,order:i=exports.MessageListOrder.CHANNEL_LATEST,sendingStatus:r,backward:n=!1,parentMessageId:o}){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const a=d(i),l={"/where":e=>!!(i!==exports.MessageListOrder.NEWEST_CHILD_MESSAGE||o&&0!==e.parentMessageId&&e.parentMessageId===o)&&t.match(this._deserialize(e))};e&&(l.channelUrl=e),r&&(l.sendingStatus=r);const c={where:l,index:a,backward:n},h=yield this.collection.query(c),_=yield h.fetch({});return Promise.all(_.map((e=>s.__awaiter(this,void 0,void 0,(function*(){return yield this._deserializeWithMessageCreateParams(e)})))))}return[]}))}getAllChildMessages(e,t=new a){return s.__awaiter(this,void 0,void 0,(function*(){return yield this.fetch({filter:t,order:exports.MessageListOrder.NEWEST_CHILD_MESSAGE,channelUrl:e.channelUrl,backward:!1,parentMessageId:e.messageId})}))}upsert(e){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>s.__awaiter(this,void 0,void 0,(function*(){(e instanceof n.FileMessage||e instanceof n.MultipleFilesMessage)&&(yield this._mutex.lock(),yield this.saveBlob(e),yield this._mutex.unlock());const t=this._serialize(e);yield this.collection.upsertOne(t)}))))))}))}upsertChildMessages(e){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>s.__awaiter(this,void 0,void 0,(function*(){let t=[];e.threadInfo&&e.threadInfo.replyCount>0&&(t=yield this.getAllChildMessages(e)),t.length>0&&(t.forEach((t=>t.applyParentMessage(e))),yield this.upsert(t))}))))))}))}remove(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(t)}))}removeMessagesOfChannel(e){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e}}))}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}saveBlob(e){return s.__awaiter(this,void 0,void 0,(function*(){if(e instanceof n.FileMessage){if(e.messageParams){const t=e.messageParams;if(t.file&&r.isBlobInstance(t.file)){const i=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=i,t.fileType=r.FileType.BLOB}}if(e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams){const t=e.scheduledInfo.scheduledMessageParams;if(t.file&&r.isBlobInstance(t.file)){const i=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=i,t.fileType=r.FileType.BLOB}}}else if(e instanceof n.MultipleFilesMessage){const t=e.messageParams;t&&t.fileInfoList&&Array.isArray(t.fileInfoList)&&(yield Promise.all(t.fileInfoList.map(((t,i)=>s.__awaiter(this,void 0,void 0,(function*(){if(t.file&&r.isBlobInstance(t.file)){const s=yield this.collection.saveBlob(t.file,this._getFileInfoBlobKey(e.reqId,i));t._uploadedMetaData||(t._uploadedMetaData={}),t._uploadedMetaData.fileKey=s,t._uploadedMetaData.fileType=r.FileType.BLOB}}))))))}}))}}const v={};class I extends s.InstancedObject{constructor(e,{sdkState:t,cacheContext:i,unsentMessageCache:s}){super(e),this._sdkState=t,this._cacheContext=i,this._unsentMessageCache=s,v[e]=this}static of(e){return v[e]}get collection(){const{nestdb:e}=this._cacheContext;return s.unless(!!e).throw(s.SendbirdError.databaseError),e.collection(r.NESTDB_MESSAGE_COLLECTION_NAME)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){return Object.assign(Object.assign({},e.serialize()),{messageId:`${e.messageId}`})}_deserialize(e){e=Object.assign(Object.assign({},e),{messageId:parseInt(e.messageId)});return n.MessageManager.of(this._iid).buildMessageFromSerializedData(e)}get(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(`${e}`);if(t)return this._deserialize(t)}}))}fetch({channelUrl:e,token:t,limit:i=r.DEFAULT_MESSAGE_LIMIT,filter:n=new a,order:o=exports.MessageListOrder.CHANNEL_LATEST,backward:l=!1,parentMessageId:c,isPollOnly:h=!1,exactMatch:_=!1,inclusive:u=!0}){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const r=d(o),a={where:{channelUrl:e,"/where":e=>{if(t)switch(o){case exports.MessageListOrder.CHANNEL_LATEST:if(_&&e.createdAt!==t)return!1;if(l){if(u&&e.createdAt<t||!u&&e.createdAt<=t)return!1}else if(u&&e.createdAt>t||!u&&e.createdAt>=t)return!1;break;case exports.MessageListOrder.NEWEST_CHILD_MESSAGE:if(!c||0===e.parentMessageId||e.parentMessageId!==c)return!1}return!(h&&!e._poll)&&n.match(this._deserialize(e))}},index:r,backward:l},E=yield this.collection.query(a),m=yield E.fetch({limit:null!=i?i:void 0});return Promise.all(m.map((e=>s.__awaiter(this,void 0,void 0,(function*(){return this._deserialize(e)})))))}return[]}))}getAllChildMessages(e,t=new a){return s.__awaiter(this,void 0,void 0,(function*(){return yield this.fetch({channelUrl:e.channelUrl,token:Date.now(),limit:null,backward:!1,filter:t,order:exports.MessageListOrder.NEWEST_CHILD_MESSAGE,parentMessageId:e.messageId})}))}upsert(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.saveBlobs(e);const t=e.map((e=>this._serialize(e)));yield this.collection.upsertMany(t),yield this.upsertChildMessages(e),yield this._unsentMessageCache.upsertChildMessages(e)}}))}upsertChildMessages(e){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>s.__awaiter(this,void 0,void 0,(function*(){var t;let i=[];(null===(t=e.threadInfo)||void 0===t?void 0:t.replyCount)&&e.threadInfo.replyCount>0&&(i=yield this.getAllChildMessages(e)),i.length>0&&(i.forEach((t=>t.applyParentMessage(e))),yield this.upsert(i))}))))))}))}remove(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(`${t}`)}))}removeMessagesOfChannel(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.collection.removeIf({where:{channelUrl:e},index:d(exports.MessageListOrder.CHANNEL_LATEST)});const{preference:t}=this._cacheContext;yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`)}}))}removeUnderOffset(e,t){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e,createdAt:{"<":t}},index:d(exports.MessageListOrder.CHANNEL_LATEST)}))}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}countBetween(e,t,i){return s.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const s=d(exports.MessageListOrder.CHANNEL_LATEST),r=this.collection.query({where:{channelUrl:e,"/where":e=>{const s=this._deserialize(e);return i.includes(s.createdAt)&&t.match(s)}},index:s});return yield r.count()}return 0}))}saveBlobs(e){return s.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>s.__awaiter(this,void 0,void 0,(function*(){if(e instanceof n.FileMessage&&e.messageParams){const t=e.messageParams;if(t.file&&r.isBlobInstance(t.file)){const i=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=i}}})))))}))}_getGroupChannelPreferenceSize(e){return s.__awaiter(this,void 0,void 0,(function*(){let t=0;const{preference:i}=this._cacheContext,s=yield i.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),r=yield i.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),n=yield i.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),a=yield i.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`);return s&&(t+=JSON.stringify(s).length),r&&(t+=JSON.stringify(r).length),n&&(t+=JSON.stringify(n).length),a&&(t+=JSON.stringify(a).length),t}))}}class p extends s.BaseCommand{constructor({message:e}){super(),this.message=e}}const b={};var T,C;exports.UserEventCategory=void 0,(T=exports.UserEventCategory||(exports.UserEventCategory={}))[T.USER_BLOCK=20001]="USER_BLOCK",T[T.USER_UNBLOCK=2e4]="USER_UNBLOCK",T[T.FRIEND_DISCOVERED=20900]="FRIEND_DISCOVERED";class A{constructor(e){this.category=e.cat,this.data=e.data}static getDataAsUserBlockEvent(e,t){const{blocker:i,blockee:r}=t.data;return{blocker:new s.User(e,i),blockee:new s.User(e,r)}}static getDataAsFriendDiscoveredEvent(e,t){const{friend_discoveries:i}=t.data;return{friendDiscoveries:Array.isArray(i)?i.map((t=>new s.User(e,t))):[]}}}class O extends s.BaseCommand{constructor(e,{userId:t}){super(),this._iid=e,this.userId=t}}exports.GroupChannelEventSource=void 0,(C=exports.GroupChannelEventSource||(exports.GroupChannelEventSource={})).UNKNOWN="UNKNOWN",C.EVENT_CHANNEL_CREATED="EVENT_CHANNEL_CREATED",C.EVENT_CHANNEL_UPDATED="EVENT_CHANNEL_UPDATED",C.EVENT_CHANNEL_DELETED="EVENT_CHANNEL_DELETED",C.EVENT_CHANNEL_READ="EVENT_CHANNEL_READ",C.EVENT_CHANNEL_DELIVERED="EVENT_CHANNEL_DELIVERED",C.EVENT_CHANNEL_INVITED="EVENT_CHANNEL_INVITED",C.EVENT_CHANNEL_JOINED="EVENT_CHANNEL_JOINED",C.EVENT_CHANNEL_LEFT="EVENT_CHANNEL_LEFT",C.EVENT_CHANNEL_ACCEPTED_INVITE="EVENT_CHANNEL_ACCEPTED_INVITE",C.EVENT_CHANNEL_DECLINED_INVITE="EVENT_CHANNEL_DECLINED_INVITE",C.EVENT_CHANNEL_OPERATOR_UPDATED="EVENT_CHANNEL_OPERATOR_UPDATED",C.EVENT_CHANNEL_BANNED="EVENT_CHANNEL_BANNED",C.EVENT_CHANNEL_MUTED="EVENT_CHANNEL_MUTED",C.EVENT_CHANNEL_UNMUTED="EVENT_CHANNEL_UNMUTED",C.EVENT_CHANNEL_FROZEN="EVENT_CHANNEL_FROZEN",C.EVENT_CHANNEL_UNFROZEN="EVENT_CHANNEL_UNFROZEN",C.EVENT_CHANNEL_HIDDEN="EVENT_CHANNEL_HIDDEN",C.EVENT_CHANNEL_UNHIDDEN="EVENT_CHANNEL_UNHIDDEN",C.EVENT_CHANNEL_RESET_HISTORY="EVENT_CHANNEL_RESET_HISTORY",C.EVENT_CHANNEL_TYPING_STATUS_UPDATE="EVENT_CHANNEL_TYPING_STATUS_UPDATE",C.EVENT_CHANNEL_MEMBER_COUNT_UPDATED="EVENT_CHANNEL_MEMBER_COUNT_UPDATED",C.EVENT_MESSAGE_SENT="EVENT_MESSAGE_SENT",C.EVENT_MESSAGE_RECEIVED="EVENT_MESSAGE_RECEIVED",C.EVENT_MESSAGE_UPDATED="EVENT_MESSAGE_UPDATED",C.EVENT_PINNED_MESSAGE_UPDATED="EVENT_PINNED_MESSAGE_UPDATED",C.REQUEST_CHANNEL="REQUEST_CHANNEL",C.REQUEST_CHANNEL_CHANGELOGS="REQUEST_CHANNEL_CHANGELOGS",C.REFRESH_CHANNEL="REFRESH_CHANNEL",C.CHANNEL_LASTACCESSEDAT_UPDATED="CHANNEL_LASTACCESSEDAT_UPDATED",C.SYNC_CHANNEL_BACKGROUND="SYNC_CHANNEL_BACKGROUND",C.SYNC_CHANNEL_CHANGELOGS="SYNC_CHANNEL_CHANGELOGS";class w extends s.BaseCommand{constructor({channels:e,source:t,isWebSocketEventComing:i=!1,data:s=null,ts:r}){super(),this.channels=e,this.source=t,this.isWebSocketEventComing=i,this.data=s,this.ts=r}}class S extends s.BaseCommand{constructor({channelUrls:e,source:t,isWebSocketEventComing:i=!1}){super(),this.channelUrls=e,this.source=t,this.isWebSocketEventComing=i}}class L extends s.BaseCommand{constructor(){super()}}class k extends s.WebSocketEventCommand{constructor(e,t,i){super(e,"USEV",i),this.event=new A(i)}}const x={};class R{constructor({dbname:e,itemSizeLimit:t=1048576,cacheLimit:i=256,blockHashBase:s=2,blockHashMultiplier:r=10,blockHashConstant:n=11,transactionApplyDelay:a=200,disableLogger:o=!1}){return x[e]||(this.itemSizeLimit=t,this.cacheLimit=i,this.blockHashBase=s,this.blockHashMultiplier=r,this.blockHashConstant=n,this.transactionApplyDelay=a,this.disableLogger=o,x[e]=this),x[e]}static get(e){return x[e]}}var M,D;!function(e){e[e.UNKNOWN_ERROR=6e7]="UNKNOWN_ERROR",e[e.STORE_NOT_DEFINED=61001e3]="STORE_NOT_DEFINED",e[e.STORE_NOT_AVAILABLE=61001001]="STORE_NOT_AVAILABLE",e[e.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING=61001002]="STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING",e[e.STORE_IS_FULL=61001003]="STORE_IS_FULL",e[e.STORE_NOT_INITIALIZED=61001004]="STORE_NOT_INITIALIZED",e[e.STORE_INVALID_KEY_TYPE=61002e3]="STORE_INVALID_KEY_TYPE",e[e.STORE_BROKEN_INTEGRITY=61002001]="STORE_BROKEN_INTEGRITY",e[e.STORE_BROKEN_BLOB=61002002]="STORE_BROKEN_BLOB",e[e.STORE_ENCRYPTION_INVALID=61002003]="STORE_ENCRYPTION_INVALID",e[e.STORE_ITEM_SIZE_LIMIT_EXCEEDED=61017e3]="STORE_ITEM_SIZE_LIMIT_EXCEEDED",e[e.STORE_READ_FAILED=61017001]="STORE_READ_FAILED",e[e.STORE_WRITE_FAILED=61017002]="STORE_WRITE_FAILED",e[e.DATABASE_SCHEMA_NOT_ON_UPGRADE=62002e3]="DATABASE_SCHEMA_NOT_ON_UPGRADE",e[e.COLLECTION_NOT_READY=63001e3]="COLLECTION_NOT_READY",e[e.COLLECTION_KEY_NOT_MATCH=63002e3]="COLLECTION_KEY_NOT_MATCH",e[e.COLLECTION_QUERY_NOT_VALID=63002001]="COLLECTION_QUERY_NOT_VALID",e[e.COLLECTION_KEY_NOT_FOUND=63004e3]="COLLECTION_KEY_NOT_FOUND",e[e.COLLECTION_KEY_NOT_GIVEN=63004001]="COLLECTION_KEY_NOT_GIVEN",e[e.COLLECTION_INSERT_DUPLICATE=63009e3]="COLLECTION_INSERT_DUPLICATE",e[e.COLLECTION_WRITE_FAILED=63017e3]="COLLECTION_WRITE_FAILED",e[e.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED=63017001]="COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED",e[e.INDEX_TABLE_IS_REQUIRED=65001e3]="INDEX_TABLE_IS_REQUIRED",e[e.INDEX_TYPE_NOT_MATCH=65002e3]="INDEX_TYPE_NOT_MATCH",e[e.COMPARE_TYPE_NOT_MATCH=69002001]="COMPARE_TYPE_NOT_MATCH",e[e.CIRCULAR_REFERENCE_FOUND=69002002]="CIRCULAR_REFERENCE_FOUND"}(M||(M={}));class P extends Error{constructor({code:e=M.UNKNOWN_ERROR,message:t="Unknown error occurred."}){super(t),this.code=e,Object.setPrototypeOf(this,P.prototype)}static get storeNotDefined(){return new P({code:M.STORE_NOT_DEFINED,message:"Store is not defined. Specify the store on NestDB()"})}static get storeNotAvailable(){return new P({code:M.STORE_NOT_AVAILABLE,message:"Store is not available. Check your environment settings."})}static get storeNotAvailableInPrivateBrowsing(){return new P({code:M.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING,message:"Store is not available because it is in private browsing."})}static get storeIsFull(){return new P({code:M.STORE_IS_FULL,message:"Store is full."})}static get storeNotInitialized(){return new P({code:M.STORE_NOT_INITIALIZED,message:"Store is not initialized."})}static get storeKeyTypeIsInvalid(){return new P({code:M.STORE_INVALID_KEY_TYPE,message:"Store key should be string type."})}static get storeBrokenIntegrity(){return new P({code:M.STORE_BROKEN_INTEGRITY,message:"Data should be in a store but it does not. Integrity is broken."})}static get storeBrokenBlob(){return new P({code:M.STORE_BROKEN_BLOB,message:"Data should be in a store but it does not. Blob data is broken."})}static get storeEncryptionInvalid(){return new P({code:M.STORE_ENCRYPTION_INVALID,message:"Encryption algorithm has changed. All the store should reset."})}static get storeItemSizeExceeded(){return new P({code:M.STORE_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that the store allows."})}static get storeReadFailed(){return new P({code:M.STORE_READ_FAILED,message:"Failed to read from store."})}static get storeWriteFailed(){return new P({code:M.STORE_WRITE_FAILED,message:"Failed to write to store."})}static get databaseSchemaNotOnUpgrade(){return new P({code:M.DATABASE_SCHEMA_NOT_ON_UPGRADE,message:"Committing schema is not allowed when upgrade is not running."})}static get collectionNotReady(){return new P({code:M.COLLECTION_NOT_READY,message:"Collection is not ready due to an error during initialization."})}static get collectionKeyNotMatch(){return new P({code:M.COLLECTION_KEY_NOT_MATCH,message:"keyName of collection could not change."})}static get collectionQueryNotValid(){return new P({code:M.COLLECTION_QUERY_NOT_VALID,message:"Query parameter is not a valid format."})}static get collectionInsertDuplicate(){return new P({code:M.COLLECTION_INSERT_DUPLICATE,message:"The key already exists."})}static get collectionKeyNotFound(){return new P({code:M.COLLECTION_KEY_NOT_FOUND,message:"The key is not found."})}static get collectionKeyNotGiven(){return new P({code:M.COLLECTION_KEY_NOT_GIVEN,message:"The item should contain [keyName] property."})}static get collectionWriteFailed(){return new P({code:M.COLLECTION_WRITE_FAILED,message:"Failed to write an item."})}static get collectionItemSizeExceeded(){return new P({code:M.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that a collection allows."})}static get indexTableIsRequired(){return new P({code:M.INDEX_TABLE_IS_REQUIRED,message:"Index table is required."})}static get indexTypesNotMatch(){return new P({code:M.INDEX_TYPE_NOT_MATCH,message:"Indexed column should have primitive type."})}static get compareTypesNotMatch(){return new P({code:M.COMPARE_TYPE_NOT_MATCH,message:"Values to compare have different types."})}static get circularReferenceFound(){return new P({code:M.CIRCULAR_REFERENCE_FOUND,message:"Cannot handle circular referenced object."})}}!function(e){e.INIT="init",e.READY="ready",e.CLOSED="closed"}(D||(D={}));const B=(e,t=new WeakMap)=>{if("object"==typeof e&&null!==e){if(t.has(e))throw P.circularReferenceFound;{let i;if(t.set(e,!0),Array.isArray(e))i=e.map((e=>B(e,t)));else if(e instanceof RegExp)i=e;else if(e instanceof Date)i=e;else{i={};for(const s in e)i[s]=B(e[s],t)}return t.delete(e),i}}return e},U=(e,t)=>{if(null==t)return 1;if(null==e)return-1;if(typeof e!=typeof t)throw P.compareTypesNotMatch;let i=0;switch(typeof e){case"boolean":case"number":i=e-t;break;case"string":i=e.localeCompare(t)}return i},H=(e,t)=>{let i=0;for(let t=0;t<e.length;t++)i=e.charCodeAt(t)+(i<<6)+(i<<16)-i;return(i>>>0)%t},V=e=>new Promise((t=>{setTimeout((()=>t()),e)})),F=(e,t)=>{if(!t)return!1;if("function"!=typeof e){for(const i in e)if(["/and","&&"].includes(i)){if(e[i].some((e=>!F(e,t))))return!1}else if(["/or","||"].includes(i)){if(e[i].every((e=>!F(e,t))))return!1}else if("/where"===i){if(!(0,e[i])(t))return!1}else{const s=i;if("object"==typeof e[s]){const i=e[s];for(const e in i)switch(e){case"/eq":case"=":if(t[s]!==i[e])return!1;break;case"/neq":case"!=":if(t[s]===i[e])return!1;break;case"/gt":case">":{const r=t[s],n=i[e];if(!(U(r,n)>0))return!1;break}case"/gte":case">=":{const r=t[s],n=i[e];if(!(U(r,n)>=0))return!1;break}case"/lt":case"<":{const r=t[s],n=i[e];if(!(U(r,n)<0))return!1;break}case"/lte":case"<=":{const r=t[s],n=i[e];if(!(U(r,n)<=0))return!1;break}case"/in":{const r=t[s];if(!i[e].includes(r))return!1;break}case"/nin":{const r=t[s];if(i[e].includes(r))return!1;break}case"/contain":{const r=t[s],n=i[e];if(!r.includes(n))return!1;break}case"/regex":{const r=t[s];if(!i[e].test(r))return!1;break}case"/where":{const r=t[s];if(!(0,i[e])(r))return!1;break}}}else if("function"==typeof e[s]){if(!e[s](t[s]))return!1}else if(e[s]!==t[s])return!1}return!0}return e(t)},K=()=>{},q=()=>Promise.resolve(),G=e=>e,z=(e,t)=>{t()};var j;!function(e){e[e.FORWARD=0]="FORWARD",e[e.BACKWARD=1]="BACKWARD"}(j||(j={}));class W{constructor({initialPrevValue:e=null,initialNextValue:t=null,iterator:i,map:s=G,backward:r=q,forward:n=q,complete:a=K}){this._prevValue=e,this._nextValue=t,this._error=null,this._map=s,this._backward=r,this._forward=n,this._iterator=i,this._complete=a}get prevValue(){return this._map(this._prevValue)}get nextValue(){return this._map(this._nextValue)}get error(){return this._error}get hasPrevious(){return!!this._prevValue}get hasNext(){return!!this._nextValue}prev(){return s.__awaiter(this,void 0,void 0,(function*(){if(this.hasPrevious){try{const e=this._prevValue;this._prevValue=(yield this._backward())||null,this._nextValue=e}catch(e){this._error=e}return yield this._iterator(this)}this._complete()}))}next(){return s.__awaiter(this,void 0,void 0,(function*(){if(this.hasNext){try{const e=this._nextValue;this._nextValue=(yield this._forward())||null,this._prevValue=e}catch(e){this._error=e}return yield this._iterator(this)}this._complete()}))}stop(){this._prevValue=null,this._nextValue=null,this._complete()}}class ${constructor({condition:e={},backward:t=!1,blockManager:i,indexer:s}){this.condition=e,this.backward=t,this._blockManager=i,this._indexer=s}findOptimizedStartPosition(){const e=["=","/eq",">",">=","/gt","/gte"],t=["=","/eq","<","<=","/lt","/lte"];if(this.backward){let i=this._indexer.origin.length-1;if("function"!=typeof this.condition)for(const s in this._indexer.fields){let r=this._indexer.fields[s],n=1;if("-"===r[0]&&(r=r.slice(1),n=-1),this.condition[r])if("object"==typeof this.condition[r]){const a=n>0?t:e;for(const e in this.condition[r])if(a.includes(e))for(let t=i;t>=0;t--)if(n*U(this._indexer.origin[t].columnValues[s],this.condition[r][e])<=0){i=t;break}}else for(let e=i;e>=0;e--)if(n*U(this._indexer.origin[e].columnValues[s],this.condition[r])<=0){i=e;break}}return Math.min(i+1,this._indexer.origin.length-1)}{let i=0;if("function"!=typeof this.condition)for(let s=0;s<this._indexer.fields.length;s++){let r=this._indexer.fields[s],n=1;if("-"===r[0]&&(r=r.slice(1),n=-1),this.condition[r])if("object"==typeof this.condition[r])Object.keys(this.condition[r]).forEach((a=>{if((n>0?e:t).includes(a))for(let e=i;e<this._indexer.origin.length;e++)if(n*U(this._indexer.origin[e].columnValues[s],this.condition[r][a])>=0){i=e;break}}));else for(let e=i;e<this._indexer.origin.length;e++)if(n*U(this._indexer.origin[e].columnValues[s],this.condition[r])>=0){i=e;break}}return Math.max(i-1,0)}}each(e){return s.__awaiter(this,void 0,void 0,(function*(){let t=this.findOptimizedStartPosition(),i=0;this.backward&&this._indexer.origin[t]&&(i=this._indexer.origin[t].keys.length-1);const r=()=>{if(this._indexer.origin[t]){if(!this._indexer.origin[t].keys[++i]){if(!this._indexer.origin[++t])return!1;i=0}return!0}return!1},n=()=>{if(this._indexer.origin[t]){if(!this._indexer.origin[t].keys[--i]){if(!this._indexer.origin[--t])return!1;i=this._indexer.origin[t].keys.length-1}return!0}return!1};let a=null;if(this._indexer.origin[t]){const e=this.backward?n:r;do{const e=yield this._blockManager.getFromBlock(this._indexer.origin[t].keys[i]);if(e&&F(this.condition,e)){a=e;break}}while(e())}return yield new Promise((o=>{const d=new W({initialNextValue:B(a),iterator:e,forward:()=>s.__awaiter(this,void 0,void 0,(function*(){const e=this.backward?n:r;for(;e();){const e=yield this._blockManager.getFromBlock(this._indexer.origin[t].keys[i]);if(e&&F(this.condition,e))return B(e)}return null})),backward:()=>s.__awaiter(this,void 0,void 0,(function*(){const e=this.backward?r:n;for(;e();){const e=yield this._blockManager.getFromBlock(this._indexer.origin[t].keys[i]);if(e&&F(this.condition,e))return B(e)}return null})),complete:o});e(d)}))}))}}class Y{constructor({condition:e={},backward:t=!1,mutex:i,blockManager:s,indexer:r}){this._mutex=i,this._iterator=new $({condition:e,backward:t,blockManager:s,indexer:r})}fetch(e={}){return s.__awaiter(this,void 0,void 0,(function*(){let t=Math.max(e.offset||0,0);const i="number"==typeof e.limit?e.limit:Number.MAX_SAFE_INTEGER;if(0===i)return[];if(i<0)throw P.collectionQueryNotValid;try{const e=[];return yield this._mutex.lock(),yield this._iterator.each((r=>s.__awaiter(this,void 0,void 0,(function*(){r.error?r.stop():r.hasNext?0===t?(e.push(r.nextValue),0<i&&i<=e.length?r.stop():r.next()):(t--,r.next()):r.stop()})))),this._mutex.unlock(),e}catch(e){throw this._mutex.unlock(),e}}))}count(){return s.__awaiter(this,void 0,void 0,(function*(){try{let e=0;return yield this._mutex.lock(),yield this._iterator.each((t=>s.__awaiter(this,void 0,void 0,(function*(){t.error?t.stop():t.hasNext?(e++,t.next()):t.stop()})))),this._mutex.unlock(),e}catch(e){throw this._mutex.unlock(),e}}))}}const Q=e=>`nest@${e}`,Z=(e,t)=>`${Q(e)}/${t}`,J=(e,t)=>`${Z(e,t)}.metadata`,X=(e,t)=>`${Z(e,t)}/block.`,ee=(e,t)=>`${Z(e,t)}/blob.`;class te{constructor({dbname:e,collectionName:t,store:i}){this.dbname=e,this.collectionName=t,this.store=i}get(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this.store.get(e);if(t){const{data:e,type:i}=t;if("undefined"!=typeof fetch){const t=yield fetch(e);return yield t.blob()}{const t=512,s=[],r=atob(e.split(",")[1]);for(let e=0;e<r.length;e+=t){const i=r.slice(e,e+t),n=new Array(i.length);for(let e=0;e<i.length;e++)n[e]=i.charCodeAt(e);s.push(new Uint8Array(n))}return new Blob(s,{type:i})}}return null}))}save(e,t=`${Date.now()}`){return s.__awaiter(this,void 0,void 0,(function*(){const{blobId:i,data:s,type:r}=yield new Promise((i=>{const s=((e,t,i,s=0)=>`${ee(e,t)}${i}.${s}`)(this.dbname,this.collectionName,t),r=new FileReader;r.onload=()=>{i({blobId:s,data:r.result,type:e.type})},r.readAsDataURL(e)}));return yield this.store.set({key:i,value:{data:s,type:r}}),i}))}remove(e){return s.__awaiter(this,void 0,void 0,(function*(){yield this.store.remove(e)}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){const e=ee(this.dbname,this.collectionName),t=yield this.store.getAllKeys();yield Promise.all(t.filter((t=>t.startsWith(e))).map((e=>s.__awaiter(this,void 0,void 0,(function*(){return yield this.store.remove(e)})))))}))}}var ie,se,re;!function(e){e[e.COMMIT=0]="COMMIT",e[e.WRITE=1]="WRITE",e[e.ERROR=2]="ERROR"}(ie||(ie={})),function(e){e.PENDING="pending",e.PERSISTENT="persistent",e.VOLATILE="volatile"}(se||(se={})),function(e){e[e.NO_CACHE=0]="NO_CACHE",e[e.DEFAULT=1]="DEFAULT",e[e.PERSISTENT=2]="PERSISTENT"}(re||(re={}));const ne=[se.PENDING,se.VOLATILE],ae={};class oe{constructor({dbname:e,limit:t=256}){return ae[e]||(this.dbname=e,this._items=[],this._limit=t,ae[e]=this),ae[e]}static get(e){return ae[e]}get items(){return this._items}find(e,t,i=re.DEFAULT){return s.__awaiter(this,void 0,void 0,(function*(){let s=this.get(t);if(s)i===re.PERSISTENT&&(s.state=se.PERSISTENT);else{const r=yield e.get(t);r&&(s={key:t,value:r,state:i===re.PERSISTENT?se.PERSISTENT:se.VOLATILE},this.put(s))}return s}))}get(e,t=re.DEFAULT){const i=this._items.map((e=>e.key)).indexOf(e);if(i>-1){const e=this._items[i];return t===re.PERSISTENT&&(e.state=se.PERSISTENT),t!==re.NO_CACHE&&this.put(e),e}return null}put(e){if(this._limit>0){const t=this._items.map((e=>e.key)).indexOf(e.key);if(t>-1)ne.includes(this._items[t].state)&&ne.includes(e.state)?(this._items.splice(t,1),this._items.push(e)):(this._items[t].state=e.state,this._items[t].value=e.value);else{this._items.push(e);const t=this._items.filter((e=>e.state===se.VOLATILE));let i=t.length-this._limit;if(i>0){const e=[];for(const t of this._items)t.state===se.VOLATILE&&i>0?i--:e.push(t);this._items=e}}}}remove(e){const t=this._items.map((e=>e.key)).indexOf(e);t>-1&&this._items.splice(t,1)}clearByCondition(e){this._items=this._items.filter((t=>!e(t)))}clear(e=!1){this._items=e?[]:this._items.filter((e=>e.state!==se.VOLATILE))}}class de{constructor({dbname:e,collectionName:t,store:i}){this._requests=[],this._onCommit=new Map,this._onWrite=new Map,this._onError=new Map,this.dbname=e,this.collectionName=t,this.metadataKey=((e,t)=>`${Z(e,t)}/trans.metadata`)(e,t),this.recordsetKey=((e,t)=>`${Z(e,t)}/trans.recordset`)(e,t),this._store=i}get generation(){return this._metadata?this._metadata.generation:0}get requestCount(){return this._requests.length}_getReducedRecordset(e=[]){return s.__awaiter(this,void 0,void 0,(function*(){const t=(yield this._store.get(this.recordsetKey))||[];return t.push(...e),this._reduceRecordSet(t)}))}_reduceRecordSet(e){const t=[],i={};for(let s=e.length-1;s>=0;s--){const r=e[s],n=[];for(let e=r.requests.length-1;e>=0;e--){const t=r.requests[e],s=t.data;i[s.key]||(n.unshift(t),i[s.key]=!0)}n.length>0&&(r.requests=n,t.unshift(r))}return t}_applyRecord(e,t){return s.__awaiter(this,void 0,void 0,(function*(){const i=oe.get(this.dbname),{generation:s,requests:r}=t;let n=null;try{const e=yield this._store.setMany(r.map((e=>Object.assign(Object.assign({},e.data),{generation:s}))));for(let t=0;t<r.length;t++)if(e[t]instanceof Error){n||(n=e[t]);const{data:s}=r[t];i.put(Object.assign(Object.assign({},s),{state:se.PERSISTENT}))}}catch(e){n=e}if(n)this._onError.forEach((e=>{n&&e(n)}));else{const t=e.filter((e=>e.generation!==s));yield this._store.set({key:this.recordsetKey,value:t}),this._onWrite.forEach((e=>{e(r.map((e=>e.data)))}))}}))}init(){return s.__awaiter(this,void 0,void 0,(function*(){this._metadata=(yield this._store.get(this.metadataKey))||{generation:1};const e=yield this._getReducedRecordset();for(const t of e)yield this._applyRecord(e,t)}))}on(e,t,i){switch(e){case ie.COMMIT:this._onCommit.set(t,i);break;case ie.WRITE:this._onWrite.set(t,i);break;case ie.ERROR:this._onError.set(t,i)}}requestWrite(e,t){this._requests.push({data:e,options:t});oe.get(this.dbname).put(Object.assign({state:se.PENDING},e))}requestMultipleWrite(e,t){const i=oe.get(this.dbname);for(const s of e)this._requests.push({data:s,options:t}),i.put(Object.assign({state:se.PENDING},s))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){oe.get(this.dbname).clearByCondition((e=>e.state===se.PENDING)),this._requests=[]}))}commit(){return s.__awaiter(this,void 0,void 0,(function*(){const e=this._requests;if(e.length>0){const t=[],i={};for(let s=e.length-1;s>=0;s--){const r=e[s],n=r.data;i[n.key]||(i[n.key]=!0,t.unshift(r))}const s={generation:this.generation,requests:t},r=yield this._getReducedRecordset([s]);yield this._store.set({key:this.recordsetKey,value:r}),this._metadata.generation++,yield this._store.set({key:this.metadataKey,value:this._metadata});const n=oe.get(this.dbname);for(let e=0;e<t.length;e++){const{data:i,options:s}=t[e];n.put(Object.assign(Object.assign({},i),{state:s&&s.persistent?se.PERSISTENT:se.VOLATILE}))}this._requests=[],this._onCommit.forEach((t=>{t(e.map((e=>e.data)))}));const a=R.get(this.dbname);setTimeout((()=>{try{this._applyRecord(r,s)}catch(e){this._onError.forEach((t=>t(e)))}}),a.transactionApplyDelay)}}))}}class le{constructor({blockId:e,keyName:t,items:i=[],limit:s}){this.blockId=e,this.keyName=t,this.limit=s,this._items=[...i]}static createFromCacheItem(e){return e?new le(e.value):null}get isEmpty(){return 0===this._items.length}get items(){return this._items}serialize(){return{blockId:this.blockId,keyName:this.keyName,limit:this.limit,items:this._items}}getItemByKey(e){const t=this._items.find((t=>{const i=t[this.keyName];return e===i}));return null!=t?t:null}has(e){return this._items.map((e=>e[this.keyName])).includes(e)}add(e){const t=this._items.map((e=>e[this.keyName])).indexOf(e[this.keyName]);return t<0?this._items.length<this.limit&&(this._items.push(e),!0):(this._items[t]=e,!0)}remove(e){for(const t in this._items)if(this._items[t][this.keyName]===e)return this._items.splice(parseInt(t),1),!0;return!1}clear(){this._items=[]}}class ce{constructor({dbname:e,collectionName:t,metadata:i,hashFunction:s=H,transaction:r,store:n}){this.dbname=e,this.collectionName=t,this.hashFunction=s,this.metadata=i,this._transaction=r,this._store=n}get keyName(){return this.metadata.keyName}createBlockId(e,t=this.metadata.blockLevel){return i=this.dbname,s=this.collectionName,r=t,n=`${((e,t,i)=>{const s=i.base*Math.pow(i.multiplier,t)+i.constant;return(i.hashFunction||H)(e,s)})(e,t,{hashFunction:this.hashFunction,base:this.metadata.blockHashBase,multiplier:this.metadata.blockHashMultiplier,constant:this.metadata.blockHashConstant})}`,`${X(i,s)}${r}.${n}`;var i,s,r,n}_findBlock(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=oe.get(this.dbname);for(let i=this.metadata.blockLevel;i>0;i--){const s=this.createBlockId(e,i),r=yield t.find(this._store,s);if(r){const t=le.createFromCacheItem(r);if(null==t?void 0:t.getItemByKey(e))return t}}return null}))}getFromBlock(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return t?t.getItemByKey(e):null}))}putToBlock(e,t){return s.__awaiter(this,void 0,void 0,(function*(){const i=R.get(this.dbname),s=this.createBlockId(e),r=Math.floor(this._store.itemSizeLimit/i.itemSizeLimit),n=oe.get(this.dbname),a=yield n.find(this._store,s),o=a?le.createFromCacheItem(a):new le({blockId:s,keyName:this.keyName,items:[],limit:r});return!!(null==o?void 0:o.add(t))&&(this._transaction.requestWrite({key:o.blockId,value:o.serialize()}),!0)}))}removeFromBlock(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return!(!t||!t.remove(e))&&(this._transaction.requestWrite({key:t.blockId,value:t.serialize()}),!0)}))}clearAllBlocks(){return s.__awaiter(this,void 0,void 0,(function*(){const e=X(this.dbname,this.collectionName),t=(yield this._store.getAllKeys()).filter((t=>t.startsWith(e)));yield this._store.removeMany(t),yield this._transaction.clear();oe.get(this.dbname).clearByCondition((t=>t.key.startsWith(e)))}))}}const he=e=>{const t=typeof e;return null===e||"undefined"===t||"boolean"===t||"number"===t||"string"===t},_e={};class ue{constructor({dbname:e,collectionName:t,keyName:i,fields:s,transaction:r,store:n}){this._origin=[],this._table=[];const a=((e,t,i)=>`${Z(e,t)}/index.${i}`)(e,t,s.join(">"));return _e[a]||(this.dbname=e,this.collectionName=t,this.keyName=i,this.fields=s,this.indexerKey=a,this._transaction=r,this._store=n,this._transaction.on(ie.COMMIT,this.indexerKey,(()=>this.commit())),this._transaction.on(ie.ERROR,this.indexerKey,(()=>this.abort()))),_e[a]}static createKey(e){return e.join(">")}static parseKey(e){return e.split(">")}static clearIndexerMap(){for(const e in _e)delete _e[e]}_addItem(e){const t=e[this.keyName],i=this.getColumnValues(e),[s,r]=this.indexOf(i);return r?!this._table[s].keys.includes(t)&&(this._table[s].keys.push(t),!0):(this._table.splice(s,0,{columnValues:i,keys:[t]}),!0)}_removeItem(e){const t=e[this.keyName],i=this.getColumnValues(e),[s,r]=this.indexOf(i);if(r){const e=this._table[s].keys.indexOf(t);if(e>-1)return this._table[s].keys.splice(e,1),0===this._table[s].keys.length&&this._table.splice(s,1),!0}return!1}get origin(){return this._origin}get table(){return this._table}getColumnValues(e){const t=[];for(let i of this.fields){if("-"===i[0]&&(i=i.slice(1)),!he(e[i]))throw P.indexTypesNotMatch;t.push(e[i])}return t}diff(e,t){for(const i in this.fields){const s="-"===this.fields[i][0]?-1:1,r=U(e[i],t[i]);if(0!==r)return s*r}return 0}indexOf(e){if(this._table.length>0){let t=0,i=this._table.length-1;for(;t<=i;){const s=Math.floor((t+i)/2),r=this.diff(e,this._table[s].columnValues);if(r>0)t=s+1;else{if(!(r<0))return[s,!0];i=s-1}}return[t,!1]}return[0,!1]}ensure(){return s.__awaiter(this,void 0,void 0,(function*(){const e=oe.get(this.dbname),t=yield e.find(this._store,this.indexerKey,re.PERSISTENT);if(t)this._origin=t.value,this._table=B(this._origin);else{const t=X(this.dbname,this.collectionName),i=yield this._store.getAllKeys();for(const s of i)if(s.startsWith(t)){const t=yield e.find(this._store,s,re.NO_CACHE),i=le.createFromCacheItem(t);if(i)for(const e of i.items)this._addItem(e)}this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}_e[this.indexerKey]=this}))}drop(){return s.__awaiter(this,void 0,void 0,(function*(){oe.get(this.dbname).remove(this.indexerKey),yield this._store.remove(this.indexerKey),delete _e[this.indexerKey]}))}addItem(e){return s.__awaiter(this,void 0,void 0,(function*(){this._addItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}removeItem(e){return s.__awaiter(this,void 0,void 0,(function*(){this._removeItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){this._table=[],this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}commit(){this._origin=this._table,this._table=B(this._origin)}abort(){this._table=B(this._origin)}}class Ee{constructor({dbname:e,collectionName:t,keyName:i,keyHash:s,indexes:r,store:n}){this._state=D.INIT,this._indexers=[],this.dbname=e,this.name=t,this.keyName=i,this.indexes=[[i],...r.filter((e=>ue.createKey(e)!==this.keyName))],this._keyHash=s,this._store=n,this._mutex=new E(((e,t)=>`${Z(e,t)}.lock`)(e,t)),this._blobContainer=new te({dbname:e,collectionName:t,store:n}),this._transaction=new de({dbname:e,collectionName:t,store:n})}static metadataOf(e,t,i){return s.__awaiter(this,void 0,void 0,(function*(){const s=J(e,t);return yield i.get(s)}))}get state(){return this._state}get isReady(){return this._state===D.READY}init(){return s.__awaiter(this,void 0,void 0,(function*(){yield this._mutex.lock();try{const e=R.get(this.dbname),t=yield Ee.metadataOf(this.dbname,this.name,this._store);this._metadata=t||{keyName:this.keyName,blockLevel:1,blockHashBase:e.blockHashBase,blockHashMultiplier:e.blockHashMultiplier,blockHashConstant:e.blockHashConstant,indexes:this.indexes},yield this._transaction.init(),this._blockManager=new ce({dbname:this.dbname,collectionName:this.name,hashFunction:this._keyHash,metadata:this._metadata,transaction:this._transaction,store:this._store});const i=[...this.indexes],s=[],r=i.map((e=>ue.createKey(e))),n=t?t.indexes.map((e=>ue.createKey(e))):[];for(const e of n)r.includes(e)||s.push(ue.parseKey(e));const a=[];if(a.push(...i.map((e=>{const t=new ue({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:e,transaction:this._transaction,store:this._store});return this._indexers.push(t),t.ensure()}))),a.push(...s.map((e=>new ue({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:e,transaction:this._transaction,store:this._store}).drop()))),yield Promise.all(a),yield this._transaction.commit(),r.sort().join(",")!==n.sort().join(",")){const e=J(this.dbname,this.name);this._metadata.indexes=i,yield this._store.set({key:e,value:this._metadata})}this._state=D.READY,this._mutex.unlock()}catch(e){throw this._mutex.unlock(),e}}))}close(){this._state=D.CLOSED}_hasPropertyOfKeyName(e){const t=e[this.keyName];return"string"==typeof t&&!!t}_getIndexerBy(e=null){e||(e=[this.keyName]);const t=ue.createKey(e);for(const e of this._indexers)if(t===ue.createKey(e.fields))return e;throw P.indexTableIsRequired}_upgradeBlockLevel(){return s.__awaiter(this,void 0,void 0,(function*(){const e=J(this.dbname,this.name);this._metadata.blockLevel++,yield this._store.set({key:e,value:this._metadata})}))}_requestInsert(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName];if(yield this._blockManager.getFromBlock(t))throw P.collectionInsertDuplicate;(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}))}_requestUpsert(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName],i=yield this._blockManager.getFromBlock(t);if(i){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(i),t.getColumnValues(e))&&(yield t.removeItem(i),yield t.addItem(e))}else{(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}}))}_requestUpdate(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName],i=yield this._blockManager.getFromBlock(t);if(i){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(i),t.getColumnValues(e))&&(yield t.removeItem(i),yield t.addItem(e))}}))}_requestRemove(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this._blockManager.getFromBlock(e);if(t){yield this._blockManager.removeFromBlock(e);for(const e of this._indexers)yield e.removeItem(t)}}))}_requestClear(){return s.__awaiter(this,void 0,void 0,(function*(){yield this._blockManager.clearAllBlocks();for(const e of this._indexers)yield e.clear()}))}getByKey(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{const t=yield this._blockManager.getFromBlock(e);return this._mutex.unlock(),B(t)}catch(e){throw this._mutex.unlock(),e}}))}query(e={}){if(this.isReady)return new Y({condition:e.where,mutex:this._mutex,blockManager:this._blockManager,indexer:this._getIndexerBy(e.index),backward:!!e.backward});throw P.collectionNotReady}insertOne(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw P.collectionKeyNotGiven;return yield this._requestInsert(B(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}insertMany(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{if(e.some((e=>!this._hasPropertyOfKeyName(e))))throw P.collectionKeyNotGiven;for(const t of e)yield this._requestInsert(B(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}upsertOne(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw P.collectionKeyNotGiven;return yield this._requestUpsert(B(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}upsertMany(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{if(e.some((e=>!this._hasPropertyOfKeyName(e))))throw P.collectionKeyNotGiven;for(const t of e)yield this._requestUpsert(B(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}update(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw P.collectionKeyNotGiven;return yield this._requestUpdate(B(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}updateIf(e,t){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw this._transaction.clear(),P.collectionNotReady;yield this._mutex.lock();try{const{where:i={},index:r=null,backward:n=!1}=e,a=[],o=new $({condition:i,blockManager:this._blockManager,backward:n,indexer:this._getIndexerBy(r)});yield o.each((e=>s.__awaiter(this,void 0,void 0,(function*(){if(e.error)throw e.stop(),e.error;if(e.hasNext){const s=e.nextValue;if(F(i,s)&&t.set){if("function"!=typeof t.set)for(const e in t.set)s[e]=t.set[e];else t.set(s);a.push(s)}e.next()}else e.stop()}))));for(const e of a)yield this._requestUpdate(B(e));return yield this._transaction.commit(),this._mutex.unlock(),a}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}remove(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{yield this._requestRemove(e),yield this._transaction.commit(),this._mutex.unlock()}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}removeIf(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw this._transaction.clear(),P.collectionNotReady;yield this._mutex.lock();try{const{where:t={},index:i=null,backward:r=!1}=e,n=[],a=new $({condition:t,blockManager:this._blockManager,backward:r,indexer:this._getIndexerBy(i)});yield a.each((e=>s.__awaiter(this,void 0,void 0,(function*(){if(e.error)throw e.stop(),e.error;if(e.hasNext){const i=e.nextValue;if(F(t,i)){const e=i[this.keyName];n.push(e)}e.next()}else e.stop()}))));for(const e of n)yield this._requestRemove(e);return yield this._transaction.commit(),this._mutex.unlock(),n}catch(e){throw this._mutex.unlock(),e}}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw P.collectionNotReady;yield this._mutex.lock();try{yield this._requestClear(),yield this._transaction.commit(),this._mutex.unlock()}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}getBlob(e){return s.__awaiter(this,void 0,void 0,(function*(){return yield this._blobContainer.get(e)}))}saveBlob(e,t){return s.__awaiter(this,void 0,void 0,(function*(){return yield this._blobContainer.save(e,t)}))}removeBlob(e){return s.__awaiter(this,void 0,void 0,(function*(){yield this._blobContainer.remove(e)}))}removeAllBlobs(){return s.__awaiter(this,void 0,void 0,(function*(){yield this._blobContainer.clear()}))}}const me="[NESTDB]";let fe=!0;class ge{static off(){fe=!1}static log(...e){fe&&console.log(`${me}[LOG]`,...e)}static warning(...e){fe&&console.warn(`${me}[WARNING]`,...e)}static error(...e){fe&&console.error(`${me}[ERROR]`,...e)}}const ye=[{},{a:700400,n:"error"}];class Ne{constructor(e){var t,i,r;this.encryption=null!==(t=e.encryption)&&void 0!==t?t:s.DEFAULT_ENCRYPTION,this.itemSizeLimit=null!==(i=e.itemSizeLimit)&&void 0!==i?i:4194304,this.metadataBuffer=null!==(r=e.metadataBuffer)&&void 0!==r?r:256}get _encryptionCheckKey(){return`${this.dbname}.encrypt`}get _reservedKeys(){return[this._encryptionCheckKey]}_getRawKey(e,t=""){return`${e}${t}`}_generateShardPostfixArray(e=1){return[...Array(e).keys()]}_shardify(e){const{key:t,value:i}=e,s=JSON.stringify(this.encryption.encrypt(i)),r=Math.ceil(s.length/this.adjustedItemSizeLimit);return this._generateShardPostfixArray(r).map((e=>{const i={key:this._getRawKey(t,`.${e}`),data:s.substring(e*this.adjustedItemSizeLimit,(e+1)*this.adjustedItemSizeLimit)};return 0===e&&(i.metadata={shards:r}),i}))}_resetIfEncryptionChanged(){return s.__awaiter(this,void 0,void 0,(function*(){const e=yield this.get(this._encryptionCheckKey),t={encrypted:ye.map((e=>{var t;return null===(t=this.encryption)||void 0===t?void 0:t.encrypt(e)}))};if(e&&e.encrypted&&Array.isArray(e.encrypted))for(const i in e.encrypted){if(JSON.stringify(e.encrypted[i])!==JSON.stringify(t.encrypted[i])){ge.warning("Encryption algorithm has changed. Stored data would be cleared."),yield this.clear();break}}yield this.set({key:this._encryptionCheckKey,value:t})}))}get adjustedItemSizeLimit(){return Math.max(this.itemSizeLimit-this.metadataBuffer,4)}usage(){return s.__awaiter(this,void 0,void 0,(function*(){let e=0;const t=yield this._getAllRawKeys();for(const i of t){const t=yield this._getRaw(i);t&&(e+=JSON.stringify(t).length)}return e}))}getAllKeys(){return s.__awaiter(this,void 0,void 0,(function*(){return(yield this._getAllRawKeys()).filter((e=>e.endsWith(".0"))).map((e=>e.replace(/\.0$/,""))).filter((e=>!this._reservedKeys.includes(e)))}))}get(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=this._getRawKey(e,".0"),i=yield this._getRaw(t);if(i)try{const{data:t,metadata:r}=i,n=(null==r?void 0:r.shards)&&r.shards>1?yield Promise.all(this._generateShardPostfixArray(null==r?void 0:r.shards).map((i=>s.__awaiter(this,void 0,void 0,(function*(){if(i>0){const t=this._getRawKey(e,`.${i}`),s=yield this._getRaw(t);if(!s)throw P.storeBrokenIntegrity;return s.data}return t}))))):[t];return this.encryption.decrypt(JSON.parse(n.join("")))}catch(e){return null}return null}))}set(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=this._shardify(e);return yield this._setRaw(t),Object.assign({},e.value)}))}setMany(e){return s.__awaiter(this,void 0,void 0,(function*(){return yield this._setRaw([].concat(...e.map((e=>this._shardify(e))))),e.map((e=>e.value))}))}remove(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=this._getRawKey(e,".0"),i=yield this._getRaw(t);if(i){const{metadata:t}=i;return yield this._removeRaw(this._generateShardPostfixArray(null==t?void 0:t.shards).map((t=>this._getRawKey(e,`.${t}`)))),!0}return!1}))}removeMany(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=[];for(const i of e){const e=this._getRawKey(i,".0"),s=yield this._getRaw(e);if(s){const{metadata:e}=s;t.push(...this._generateShardPostfixArray(null==e?void 0:e.shards).map((e=>this._getRawKey(i,`.${e}`))))}}return t.length>0&&(yield this._removeRaw(t)),e}))}}const ve=1,Ie={};class pe extends Ne{constructor(e={}){var t;super(Object.assign(Object.assign({},e),{itemSizeLimit:null!==(t=e.itemSizeLimit)&&void 0!==t?t:4194304}));const{delay:i=ve}=e;this.delay=i,this.observer={}}get rawData(){return Ie[this.dbname]}set rawData(e){Ie[this.dbname]=e}_getAllRawKeys(){return s.__awaiter(this,void 0,void 0,(function*(){if(Ie[this.dbname])return Object.keys(Ie[this.dbname]);throw P.storeNotAvailable}))}_getRaw(e){return s.__awaiter(this,void 0,void 0,(function*(){if(Ie[this.dbname])return yield V(this.delay),Ie[this.dbname][e]?Object.assign({key:e},Ie[this.dbname][e]):null;throw P.storeNotAvailable}))}_setRaw(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!Ie[this.dbname])throw P.storeNotAvailable;yield V(this.delay);for(const t of e){const{key:e,data:i,metadata:s}=t;Ie[this.dbname][e]=Object.freeze({data:i,metadata:s})}}))}_removeRaw(e){return s.__awaiter(this,void 0,void 0,(function*(){if(!Ie[this.dbname])throw P.storeNotAvailable;yield V(this.delay);for(const t of e)Ie[this.dbname][t]&&delete Ie[this.dbname][t]}))}observe(e,t,i){this.observer[e]||(this.observer[e]={}),t.forEach((t=>this.observer[e][t]=i))}checkAvailability(){return s.__awaiter(this,void 0,void 0,(function*(){}))}init(e){return s.__awaiter(this,void 0,void 0,(function*(){this.dbname=e,Ie[this.dbname]||(Ie[this.dbname]={}),yield this._resetIfEncryptionChanged()}))}set(e){const t=Object.create(null,{set:{get:()=>super.set}});return s.__awaiter(this,void 0,void 0,(function*(){const i=this.observer[e.key];if(i&&"function"==typeof i.set){const e=i.set();if(e)throw e}return t.set.call(this,e)}))}setMany(e){const t=Object.create(null,{setMany:{get:()=>super.setMany}});return s.__awaiter(this,void 0,void 0,(function*(){for(const t of e){const e=this.observer[t.key];if(e&&"function"==typeof e.set){const t=e.set();if(t)throw t}}return t.setMany.call(this,e)}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){yield V(this.delay),Ie[this.dbname]={}}))}}const be="NestDBStore";var Te;!function(e){e[e.UNINITIALIZED=0]="UNINITIALIZED",e[e.OPENING=1]="OPENING",e[e.OPEN=2]="OPEN",e[e.CLOSED=3]="CLOSED"}(Te||(Te={}));var Ce;exports.NestDBState=void 0,(Ce=exports.NestDBState||(exports.NestDBState={})).INIT="INIT",Ce.OPENING="OPENING",Ce.OPENED="OPENED",Ce.CLOSED="CLOSED";exports.AutoResendManager=class{constructor(e,{localCacheEnabled:t,dispatcher:i,sdkState:r,logger:n}){this._iid=e,b[e]=this,this._localCacheEnabled=t,this._isProcessingAutoResend=!1,this._autoResendQueue=[],this._dispatcher=i,this._logger=n,this._sdkState=r,this._localCacheEnabled&&i.on((e=>{if(e instanceof s.ConnectionStateChangeCommand)switch(e.stateType){case s.ConnectionStateType.CONNECTED:this._isProcessingAutoResend||this.processAutoResendRegisteredPendingMessages().then((()=>this._processNextAutoResend()));break;case s.ConnectionStateType.INTERNAL_DISCONNECTED:case s.ConnectionStateType.EXTERNAL_DISCONNECTED:this._isProcessingAutoResend=!1}}))}static of(e){return b[e]}processNonAutoResendRegisteredPendingMessages(){return s.__awaiter(this,void 0,void 0,(function*(){const e=yield this._fetchAllCachedPendingMessages();for(const t of e)0===t.errorCode&&(this._logger.debug("cached pending message is not auto-resend registered. changing its sending status to failed: ",t.reqId),t.sendingStatus=s.SendingStatus.FAILED,t.errorCode=s.SendbirdErrorCode.ACK_TIMEOUT,this._dispatcher.dispatch(new s.MessageUpdateEventCommand({messages:[t],source:s.MessageEventSource.LOCAL_MESSAGE_FAILED})))}))}processAutoResendRegisteredPendingMessages(){return s.__awaiter(this,void 0,void 0,(function*(){const e=yield this._fetchAllCachedPendingMessages();for(const t of e)if(t.errorCode&&s.isAutoResendableError(t.errorCode)){const e=(new Date).getTime(),i=t.createdAt+2592e5;e<=i?this._autoResendQueue.map((e=>e.reqId)).indexOf(t.reqId)<0&&this._autoResendQueue.push(t):(this._logger.debug("auto-resend registered pending messaged expired. expiration date: ",new Date(i).toLocaleString()),t.sendingStatus=s.SendingStatus.FAILED,this._dispatcher.dispatch(new s.MessageUpdateEventCommand({messages:[t],source:s.MessageEventSource.LOCAL_MESSAGE_FAILED})))}}))}completeCurrentAndProcessNextAutoResend(e){if(this._localCacheEnabled&&(e.sendingStatus===s.SendingStatus.SUCCEEDED||e.sendingStatus===s.SendingStatus.FAILED&&!s.isAutoResendableError(e.errorCode))){const t=this.indexOf(e);t>=0&&this._autoResendQueue.splice(t,1),0===t&&this._processNextAutoResend()}}_fetchAllCachedPendingMessages(){return s.__awaiter(this,void 0,void 0,(function*(){const e=N.of(this._iid);return e?yield e.fetch({sendingStatus:s.SendingStatus.PENDING,backward:!0}):[]}))}indexOf(e){return this._autoResendQueue.length>0?this._autoResendQueue.map((e=>e.reqId)).indexOf(e.reqId):-1}_isNotInQueue(e){return-1===this._autoResendQueue.map((e=>e.reqId)).indexOf(e.reqId)}_processNextAutoResend(){return s.__awaiter(this,void 0,void 0,(function*(){if(this._localCacheEnabled&&"foreground"===this._sdkState.appState)try{if(this._autoResendQueue.length>0){this._isProcessingAutoResend||(this._logger.debug("auto-resend queue started."),this._isProcessingAutoResend=!0);const e=this._autoResendQueue[0];this._dispatcher.dispatch(new p({message:e})),this._logger.debug("processing auto-resend for message request id: ",e.reqId)}else this._logger.debug("auto-resend queue finished."),this._isProcessingAutoResend=!1}catch(e){this._logger.warn("process auto-resend error: ",e),this._isProcessingAutoResend=!1}}))}},exports.AutoResendRequestCommand=p,exports.BaseStore=Ne,exports.DatabaseOpenCommand=O,exports.GroupChannelRemoveEventCommand=S,exports.GroupChannelUpdateEventCommand=w,exports.IndexedDbStore=class extends Ne{constructor(e={}){var t;super(Object.assign(Object.assign({},e),{itemSizeLimit:null!==(t=e.itemSizeLimit)&&void 0!==t?t:104857600})),this._storeName=be,this._state=Te.UNINITIALIZED,this._openJobQueue=[],this._window="undefined"!=typeof window?window:void 0,this._indexedDb=this._window?this._window.indexedDB||this._window.mozIndexedDB||this._window.webkitIndexedDB||this._window.msIndexedDB:void 0}get state(){return this._state}_openDatabase(e){return new Promise(((t,i)=>{if(this._indexedDb){this._state=Te.OPENING;const s=this._indexedDb.open(e);s.addEventListener("upgradeneeded",(e=>{e.target.result.createObjectStore(be,{keyPath:"key"})})),s.addEventListener("success",(i=>{this._state=Te.OPEN,this._database=i.target.result,this._openJobQueue.forEach((e=>e())),this._openJobQueue=[],this._database.onclose=()=>{this._database=void 0,this._state=Te.OPENING,setTimeout((()=>{this._openDatabase(e)}),5)},t(this._database)})),s.addEventListener("error",(e=>{this._state=Te.UNINITIALIZED,i(e.target.error)}))}else i(P.storeNotAvailable)}))}_getObjectStore(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this._database)return this._database.transaction(this._storeName,e).objectStore(this._storeName);switch(this._state){case Te.UNINITIALIZED:case Te.OPEN:throw P.storeNotInitialized;case Te.OPENING:case Te.CLOSED:return new Promise((t=>{this._openJobQueue.push((()=>t(this._getObjectStore(e))))}));default:return yield this._getObjectStore(e)}}))}_getAllRawKeys(){return s.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getObjectStore("readonly");return yield new Promise(((t,i)=>{const s=e.getAllKeys();s.addEventListener("success",(e=>{t(e.target.result)})),s.addEventListener("error",(e=>i(e.target.error)))}))}))}_getRaw(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readonly");return yield new Promise(((i,s)=>{const r=t.get(e);r.addEventListener("success",(e=>{var t;i(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.result)})),r.addEventListener("error",(e=>s(e.target.error)))}))}))}_setRaw(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readwrite");yield Promise.all(e.map((e=>new Promise(((i,s)=>{const r=t.put(e);r.addEventListener("success",(e=>{i(e.target.result)})),r.addEventListener("error",(()=>{s("Failed to write.")}))})))))}))}_removeRaw(e){return s.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readwrite");yield Promise.all(e.map((e=>new Promise(((i,s)=>{const r=t.delete(e);r.addEventListener("success",(()=>i(e))),r.addEventListener("error",(e=>s(e.target.error)))})))))}))}_triggerDatabaseClose(){this._database&&this._database.onclose&&this._database.onclose(new Event("dummy"))}checkAvailability(){return s.__awaiter(this,void 0,void 0,(function*(){const e="undefined"!=typeof window?window:null;if(!((null==e?void 0:e.indexedDB)||(null==e?void 0:e.mozIndexedDB)||(null==e?void 0:e.webkitIndexedDB)||(null==e?void 0:e.msIndexedDB)))throw P.storeNotAvailable;if(this._indexedDb=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB,!this._window||!l())throw P.storeNotAvailable;if(l()&&navigator.userAgent&&navigator.userAgent.includes("Edge/")){if(!this._window.indexedDB&&(e.PointerEvent||e.MSPointerEvent))throw P.storeNotAvailableInPrivateBrowsing}else yield new Promise(((e,t)=>{if(this._indexedDb)try{const i=this._indexedDb.open("_testMozilla");i.onerror=()=>t(P.storeNotAvailableInPrivateBrowsing),i.onsuccess=()=>e()}catch(e){t(P.storeNotAvailableInPrivateBrowsing)}else t(P.storeNotAvailable)}))}))}init(e){return s.__awaiter(this,void 0,void 0,(function*(){this.dbname=e,yield this.checkAvailability(),yield this._openDatabase(e),yield this._resetIfEncryptionChanged()}))}clear(){return s.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getObjectStore("readwrite");return yield new Promise(((t,i)=>{const s=e.clear();s.addEventListener("success",(()=>t())),s.addEventListener("error",(e=>i(e.target.error)))}))}))}},exports.MemoryStore=pe,exports.MessageCache=I,exports.MessageFilter=a,exports.NESTDB_UNSENT_MESSAGE_COLLECTION_KEY="reqId",exports.NESTDB_UNSENT_MESSAGE_COLLECTION_NAME=g,exports.NestDB=class{constructor({name:e,version:t,store:i,config:s}){this.name=e,this._version=t,this._state=exports.NestDBState.INIT,this._config=s||new R({dbname:e}),this._store=i,this._event={success:K,error:K,storeReplaced:K,upgrade:z},this._collections=new Map,this._globalMutex=new E(`${this.name}.lock`),this._config.disableLogger&&ge.off(),new oe({dbname:e,limit:this._config.cacheLimit})}get version(){return this._version}get state(){return this._state}get store(){return this._store}estimateUsage(){return s.__awaiter(this,void 0,void 0,(function*(){return yield(e=this._store,s.__awaiter(void 0,void 0,void 0,(function*(){return yield e.usage()})));var e}))}commitSchema(e){return s.__awaiter(this,void 0,void 0,(function*(){if(this._state!==exports.NestDBState.OPENING)throw P.databaseSchemaNotOnUpgrade;yield Promise.all(e.map((e=>s.__awaiter(this,void 0,void 0,(function*(){const{collectionName:t,keyName:i,index:s=[]}=e;this._collections.has(t)||this._collections.set(t,new Ee({dbname:this.name,collectionName:t,keyName:i,indexes:s,store:this._store}));const r=this._collections.get(t);r&&(yield r.init())})))))}))}open(){var e;return s.__awaiter(this,void 0,void 0,(function*(){if(yield this._globalMutex.lock(),this._state!==exports.NestDBState.OPENED){this._state=exports.NestDBState.OPENING;try{yield this._store.init(this.name);const i=(t=this.name,`${Q(t)}.metadata`),r={version:0,collectionNames:[]},n=null!==(e=yield this._store.get(i))&&void 0!==e?e:r;return new Promise(((e,t)=>{const r=e=>{n.version<this._version?this._event.upgrade(n.version,(t=>s.__awaiter(this,void 0,void 0,(function*(){if(t)e({continued:!1,err:t});else{n.version++,n.collectionNames=Array.from(this._collections.keys());try{yield this._store.set({key:i,value:n}),e({continued:!0})}catch(t){e({continued:!1,err:t})}}})))):e({continued:!1})},a=i=>{const{continued:o=!1,err:d=null}=i;if(o)setTimeout((()=>r(a)),10);else if(d)ge.error(d.message),this._globalMutex.unlock(),this._event.error(d),t(d);else{const i=[];n.collectionNames.forEach((e=>{const t=this._collections.get(e);t&&t.state===D.READY||i.push((()=>s.__awaiter(this,void 0,void 0,(function*(){const t=yield Ee.metadataOf(this.name,e,this._store);if(t){const i=new Ee({dbname:this.name,collectionName:e,keyName:t.keyName,indexes:t.indexes,store:this._store});this._collections.set(e,i),yield i.init()}})))())})),Promise.all(i).then((()=>{this._state=exports.NestDBState.OPENED,this._globalMutex.unlock(),this._event.success(),e()})).catch((e=>{ge.error(e.message),this._globalMutex.unlock(),this._event.error(e),t(e)}))}};r(a)}))}catch(e){switch(e.code){case M.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING:ge.warning("Access to the local storage is not allowed. Switched to MemoryStore automatically."),this._store=new pe({}),this._globalMutex.unlock(),this._event.error(e),this._event.storeReplaced(this._store),yield this.open();break;case M.STORE_NOT_AVAILABLE:ge.warning("IndexedDB is not available in this environment. Switched to MemoryStore automatically. Consider using other store to save data persistently (e.g. AsyncStorage)."),this._store=new pe({}),this._globalMutex.unlock(),this._event.error(e),this._event.storeReplaced(this._store),yield this.open();break;default:throw ge.error(e.message),this._globalMutex.unlock(),this._event.error(e),e}}}var t}))}close(){this._collections.forEach((e=>e.close())),this._state=exports.NestDBState.CLOSED}clear(){return s.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(Array.from(this._collections.values()).map((e=>e.clear())))}))}reset(){return s.__awaiter(this,void 0,void 0,(function*(){this.close();const e=oe.get(this.name);e&&e.clearByCondition((e=>e.key.startsWith(Q(this.name)))),yield this._store.clear()}))}on(e,t){this._event[e]=t}off(e){if("function"==typeof this._event[e])if("upgrade"===e)this._event[e]=z;else this._event[e]=K}collection(e){const t=this._collections.get(e);if(t)return t;throw P.collectionNotReady}},exports.NestDBError=P,exports.ReduceDBSizeEventCommand=L,exports.ScheduledFileMessageCreateParamsDefault=f,exports.ScheduledUserMessageCreateParamsDefault=m,exports.UnsentMessageCache=N,exports.UserEvent=A,exports.UserEventCommand=k,exports.getGroupChannelIndexBy=e=>{switch(e){case exports.GroupChannelListOrder.LATEST_LAST_MESSAGE:return["-lastMessageUpdatedAt","-createdAt","syncIndex"];case exports.GroupChannelListOrder.CHRONOLOGICAL:return["-createdAt","syncIndex"];case exports.GroupChannelListOrder.CHANNEL_NAME_ALPHABETICAL:return["name"];default:return["-lastMessageUpdatedAt","-createdAt","syncIndex"]}},exports.getMessageIndexBy=d,exports.shouldGiveEvent=e=>e.startsWith("EVENT_")||e===exports.GroupChannelEventSource.SYNC_CHANNEL_CHANGELOGS||e===exports.GroupChannelEventSource.REFRESH_CHANNEL,exports.validateScheduledFileMessageCreateParams=e=>r.validateBaseMessageCreateParams(e)&&s.isTypeOf("number",e.scheduledAt)&&(s.isFile(e.file)||s.isTypeOf("string",e.fileUrl))&&s.isTypeOf("string",e.fileName,!0)&&s.isTypeOf("string",e.mimeType,!0)&&s.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||e.thumbnailSizes.every((e=>s.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))),exports.validateScheduledUserMessageCreateParams=e=>r.validateUserMessageCreateParams(e)&&s.isTypeOf("number",e.scheduledAt,!0);
