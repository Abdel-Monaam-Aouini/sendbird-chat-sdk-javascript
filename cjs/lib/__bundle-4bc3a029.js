"use strict";var e,t=require("./__bundle-c176c59f.js");class s extends t.APIRequestCommand{constructor(e){if(super(),this.method=t.APIRequestMethod.POST,this.path=`${t.API_PATH_UPLOAD}`,this.params=t.deundefined({file:e.file,channel_url:e.channelUrl}),e.thumbnailSizes)for(let t=0;t<e.thumbnailSizes.length;t++){const{maxWidth:s,maxHeight:i}=e.thumbnailSizes[t];this.params[`thumbnail${t+1}`]=`${s},${i}`}this.requestId=e.requestId}}class i extends t.APIResponseCommand{constructor(e,t){var s,i,n;super(e,t),this.url=t.url,this.fileSize=null!==(s=t.file_size)&&void 0!==s?s:0,this.thumbnailSizes=null!==(i=t.thumbnails)&&void 0!==i?i:[],this.requireAuth=null!==(n=t.require_auth)&&void 0!==n&&n}}class n extends t.InstancedObject{constructor(e,s){var i,n,a;super(e),this.replyCount=0,this.lastRepliedAt=0,this.updatedAt=0,this.replyCount=null!==(i=s.reply_count)&&void 0!==i?i:0,this.mostRepliedUsers=s.most_replies&&t.isArrayOf("object",s.most_replies)?s.most_replies.map((e=>new t.User(this._iid,e))):[],this.lastRepliedAt=null!==(n=s.last_replied_at)&&void 0!==n?n:0,this.updatedAt=null!==(a=s.updated_at)&&void 0!==a?a:0}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{reply_count:e.replyCount,most_replies:Array.isArray(e.mostRepliedUsers)?e.mostRepliedUsers.map((e=>t.User.payloadify(e))):[],last_replied_at:e.lastRepliedAt,updated_at:e.updatedAt})))}}exports.ReactionEventOperation=void 0,(e=exports.ReactionEventOperation||(exports.ReactionEventOperation={})).ADD="add",e.DELETE="delete";class a{constructor(e){var s;const i=e.key,n=null!==(s=[...e.user_ids])&&void 0!==s?s:[],a=e.updated_at;t.isTypeOf("string",i)&&i&&t.isArrayOf("string",n)&&n.length>0&&t.isTypeOf("number",a)&&(this.key=i,this.userIds=n,this.updatedAt=a);const r={};for(const e of this.userIds)r[e]=this.updatedAt;this._version=r}get isEmpty(){return 0===this.userIds.length}static payloadify(e){return t.deundefined(t.undefineNullProps({key:e.key,user_ids:e.userIds,updated_at:e.updatedAt}))}applyEvent(e){if(e.key===this.key&&this.updatedAt<=e.updatedAt){if(!this._version[e.userId]||this._version[e.userId]<=e.updatedAt){const t=this.userIds.indexOf(e.userId);switch(e.operation){case exports.ReactionEventOperation.ADD:t<0&&this.userIds.push(e.userId);break;case exports.ReactionEventOperation.DELETE:t>=0&&this.userIds.splice(t,1)}this._version[e.userId]=e.updatedAt}this.updatedAt=Math.max(this.updatedAt,e.updatedAt)}}}class r{constructor(e){this.key=e.key,this.value=t.isArrayOf("string",e.value)?[...e.value]:[]}static payloadify(e){var s;return t.deundefined(t.undefineNullProps({key:e.key,value:null!==(s=e.value)&&void 0!==s?s:[]}))}}class o{constructor(e){this.secureUrl=null,this.type=null,this.width=0,this.height=0,this.alt=null,this.url=e.url,e.secure_url&&(this.secureUrl=e.secure_url),e.type&&(this.type=e.type),e.width&&(this.width=e.width),e.height&&(this.height=e.height),e.alt&&(this.alt=e.alt)}static payloadify(e){var s,i;return t.deundefined(t.undefineNullProps({url:e.url,secure_url:e.secureUrl,type:e.type,width:null!==(s=e.width)&&void 0!==s?s:0,height:null!==(i=e.height)&&void 0!==i?i:0,alt:e.alt}))}}class l{constructor(e){this.title=null,this.url=null,this.description=null,this.defaultImage=null,e["og:title"]&&(this.title=e["og:title"]),e["og:url"]&&(this.url=e["og:url"]),e["og:description"]&&(this.description=e["og:description"]),e["og:image"]&&(this.defaultImage=new o(e["og:image"]))}static payloadify(e){return t.deundefined(t.undefineNullProps({"og:title":e.title,"og:url":e.url,"og:description":e.description,"og:image":e.defaultImage?o.payloadify(e.defaultImage):null}))}}class d{constructor(e){var t,s;this.volume=0,this.name=null!==(t=e.name)&&void 0!==t?t:"default",this.volume=null!==(s=e.volume)&&void 0!==s?s:1}serialize(){return{name:this.name,volume:this.volume}}static payloadify(e){return t.deundefined(t.undefineNullProps({name:e.name,volume:e.volume}))}}class u extends t.User{constructor(e,s){var i;super(e,s),this.isBlockedByMe=!1,this.role=t.isEnumOf(t.Role,s.role)?s.role:t.Role.NONE,this.isBlockedByMe=null!==(i=s.is_blocked_by_me)&&void 0!==i&&i}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{role:e.role,is_blocked_by_me:e.isBlockedByMe})))}}var c,h;exports.ScheduledStatus=void 0,(c=exports.ScheduledStatus||(exports.ScheduledStatus={})).PENDING="pending",c.SENT="sent",c.FAILED="failed",c.CANCELED="canceled",exports.InternalScheduledStatus=void 0,(h=exports.InternalScheduledStatus||(exports.InternalScheduledStatus={})).PENDING="pending",h.IN_QUEUE="in_queue",h.SENT="sent",h.FAILED="failed",h.CANCELED="canceled",h.REMOVED="removed";const _=e=>{switch(e){case t.MessageType.BASE:return"";case t.MessageType.USER:return"MESG";case t.MessageType.FILE:return"FILE";case t.MessageType.ADMIN:return"ADMM"}};class p extends t.InstancedObject{constructor(e,s){var i,o,u,c,h,_,p,m,y,g,f,v,I,E,T,b;super(e),this.channelType=t.ChannelType.BASE,this.parentMessage=null,this.silent=!1,this.isOperatorMessage=!1,this.messageType=t.MessageType.BASE,this.mentionType=null,this.threadInfo=null,this.reactions=[],this.metaArrays=[],this.appleCriticalAlertOptions=null,this.createdAt=0,this.updatedAt=0,this.scheduledInfo=null,this.extendedMessage={},this._isContinuousMessages=!1,this._scheduledStatus=null,this.messageId=null!==(o=null!==(i=s.msg_id)&&void 0!==i?i:s.message_id)&&void 0!==o?o:0,this.channelUrl=s.channel_url,this.channelType=t.isEnumOf(t.ChannelType,s.channel_type)?s.channel_type:t.ChannelType.GROUP,s.channel&&(s.channel.channel_url&&(this.channelUrl=s.channel.channel_url),s.channel.channel_type&&(this.channelType=s.channel.channel_type)),this.parentMessageId=null!==(u="string"==typeof s.parent_message_id?parseInt(s.parent_message_id):s.parent_message_id)&&void 0!==u?u:0,this.data=null!==(c=s.data)&&void 0!==c?c:"",this.customType=null!==(h=s.custom_type)&&void 0!==h?h:"",this.mentionType=t.isEnumOf(t.MentionType,s.mention_type)?s.mention_type:null,this.mentionedUsers=s.mentioned_users?s.mentioned_users.map((e=>new t.User(this._iid,e))):null,this.mentionedUserIds=null!==(_=s.mentioned_user_ids)&&void 0!==_?_:null,this.mentionedUsers&&!this.mentionedUserIds&&(this.mentionedUserIds=this.mentionedUsers.map((e=>e.userId))),this.mentionedMessageTemplate=null!==(p=s.mentioned_message_template)&&void 0!==p?p:"",this.threadInfo=s.thread_info?new n(this._iid,s.thread_info):null,this.reactions=s.reactions?s.reactions.map((e=>new a(e))):[];const O=null!==(m=s.metaarray)&&void 0!==m?m:{},N=null!==(y=s.metaarray_key_order)&&void 0!==y?y:Object.keys(O).sort(((e,t)=>e.localeCompare(t)));this.metaArrays=[];for(let e=0;e<N.length;e++){const t=N[e];this.metaArrays.push(new r({key:t,value:O[t]||[]}))}s.sorted_metaarray&&(this.metaArrays=s.sorted_metaarray.map((e=>new r(e)))),this.ogMetaData=s.og_tag?new l(s.og_tag):null,this.silent=null!==(g=s.silent)&&void 0!==g&&g,this.isOperatorMessage=null!==(f=s.is_op_msg)&&void 0!==f&&f,this.appleCriticalAlertOptions=s.apple_critical_alert_options?new d(s.apple_critical_alert_options):null,this.createdAt=null!==(I=null!==(v=s.created_at)&&void 0!==v?v:s.ts)&&void 0!==I?I:0,this.updatedAt=null!==(E=s.updated_at)&&void 0!==E?E:0,"number"==typeof s.scheduled_message_id&&"number"==typeof s.scheduled_at&&s.scheduled_status&&(this.scheduledInfo={scheduledMessageId:s.scheduled_message_id,scheduledAt:s.scheduled_at},this._scheduledStatus=s.scheduled_status),this.extendedMessage=null!==(T=s.extended_message)&&void 0!==T?T:{},this._isContinuousMessages=null!==(b=s.is_continuous_messages)&&void 0!==b&&b}static payloadify(e){var s,i,o,u;return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{channel_url:e.channelUrl,channel_type:e.channelType,message_id:e.messageId,type:_(e.messageType),parent_message_id:e.parentMessageId,data:e.data,custom_type:e.customType,mention_type:e.mentionType,mentioned_user_ids:e.mentionedUserIds,mentioned_users:null===(s=e.mentionedUsers)||void 0===s?void 0:s.map((e=>t.User.payloadify(e))),mentioned_message_template:e.mentionedMessageTemplate,thread_info:e.threadInfo?n.payloadify(e.threadInfo):null,reactions:e.reactions.map((e=>a.payloadify(e))),sorted_metaarray:null===(i=e.metaArrays)||void 0===i?void 0:i.map((e=>r.payloadify(e))),og_tag:e.ogMetaData?l.payloadify(e.ogMetaData):null,silent:e.silent,is_op_msg:e.isOperatorMessage,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,created_at:e.createdAt,updated_at:e.updatedAt,scheduled_message_id:null===(o=e.scheduledInfo)||void 0===o?void 0:o.scheduledMessageId,scheduled_at:null===(u=e.scheduledInfo)||void 0===u?void 0:u.scheduledAt,scheduled_status:e._scheduledStatus,extended_message:e.extendedMessage})))}static _getParentMessageInfoPayload(e){return t.deundefined(t.undefineNullProps({type:_(e.messageType),ts:e.createdAt,user:e.sender?u.payloadify(e.sender):null,message:e.message,file:{url:e.plainUrl,name:e.name,type:e.type,require_auth:e.requireAuth}}))}isIdentical(e){return this.messageId===e.messageId}isEqual(e){return t.deepEqual(this,e)}isUserMessage(){return this.messageType===t.MessageType.USER}isFileMessage(){return this.messageType===t.MessageType.FILE&&!Object.prototype.hasOwnProperty.call(this,"fileInfoList")}isMultipleFilesMessage(){return this.messageType===t.MessageType.FILE&&Object.prototype.hasOwnProperty.call(this,"fileInfoList")}isAdminMessage(){return this.messageType===t.MessageType.ADMIN}serialize(){return t.serialize(this)}getMetaArraysByKeys(e){return this.metaArrays.filter((t=>e.includes(t.key)))}applyThreadInfoUpdateEvent(e){return this.messageId===e.targetMessageId&&(this.threadInfo=e.threadInfo),!1}applyReactionEvent(e){if(this.messageId===e.messageId){let t=!1;for(let s=0;s<this.reactions.length;s++)if(this.reactions[s].key===e.key){this.reactions[s].applyEvent(e),this.reactions[s].isEmpty&&this.reactions.splice(s,1),t=!0;break}t||"add"!==e.operation||this.reactions.push(new a(a.payloadify({key:e.key,userIds:[e.userId],updatedAt:e.updatedAt})))}}applyParentMessage(e){if(!this.parentMessage)return this.parentMessage=e,!0;if(this.parentMessageId===e.messageId){const t=this.parentMessage.updatedAt;if(e.updatedAt>=t)return this.parentMessage=e,!0}return!1}}class m extends p{constructor(e,s){var i,n,a,r;if(super(e,s),this.reqId="",this.replyToChannel=!1,this.errorCode=0,this.sender=s.user?new u(this._iid,s.user):s.sender_id,this.reqId=null!==(n=null!==(i=s.req_id)&&void 0!==i?i:s.request_id)&&void 0!==n?n:"",this.replyToChannel=null!==(a=s.is_reply_to_channel)&&void 0!==a&&a,s.request_state&&t.isEnumOf(t.SendingStatus,s.request_state)&&(this.sendingStatus=s.request_state),!this.sendingStatus)if(this.messageId>0)this.sendingStatus=t.SendingStatus.SUCCEEDED;else if(this.scheduledInfo)switch(s.scheduled_status&&(this._scheduledStatus=s.scheduled_status),s.scheduled_status){case exports.InternalScheduledStatus.SENT:case exports.InternalScheduledStatus.IN_QUEUE:this.sendingStatus=t.SendingStatus.SUCCEEDED;break;case exports.InternalScheduledStatus.PENDING:this.sendingStatus=t.SendingStatus.SCHEDULED;break;case exports.InternalScheduledStatus.FAILED:case exports.InternalScheduledStatus.REMOVED:this.sendingStatus=t.SendingStatus.FAILED;break;case exports.InternalScheduledStatus.CANCELED:this.sendingStatus=t.SendingStatus.CANCELED}else this.sendingStatus=t.SendingStatus.PENDING;this.errorCode=null!==(r=s.error_code)&&void 0!==r?r:0}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{user:u.payloadify(e.sender),req_id:e.reqId,is_reply_to_channel:e.replyToChannel,request_state:e.sendingStatus,error_code:e.errorCode})))}get isResendable(){return this.sendingStatus===t.SendingStatus.FAILED&&t.isResendableError(this.errorCode)}isIdentical(e){return this.messageId>0&&e.messageId>0?this.messageId===e.messageId:this.reqId===e.reqId}}class y{constructor(e){var t,s;this.width=0,this.height=0,this.realWidth=0,this.realHeight=0,this.url=e.url,this.width=e.width,this.height=e.height,this.realWidth=null!==(t=e.real_width)&&void 0!==t?t:e.width,this.realHeight=null!==(s=e.real_height)&&void 0!==s?s:e.height}static payloadify(e){return t.deundefined(t.undefineNullProps({url:"",width:e.maxWidth,height:e.maxHeight,real_width:0,real_height:0}))}get plainUrl(){return this.url.split("?auth=")[0]}}const g={prevResultSize:0,nextResultSize:0,isInclusive:!1,reverse:!1,messageTypeFilter:t.MessageTypeFilter.ALL,customTypesFilter:void 0,senderUserIdsFilter:void 0,includeReactions:!1,includeMetaArray:!1,includeParentMessageInfo:!1},f=e=>t.isTypeOf("number",e.prevResultSize)&&t.isTypeOf("number",e.nextResultSize)&&t.isTypeOf("boolean",e.isInclusive)&&t.isTypeOf("boolean",e.reverse)&&t.isTypeOf("string",e.messageTypeFilter)&&t.isEnumOf(t.MessageTypeFilter,e.messageTypeFilter)&&t.isArrayOf("string",e.customTypesFilter,!0)&&t.isArrayOf("string",e.senderUserIdsFilter,!0)&&t.isTypeOf("boolean",e.includeMetaArray)&&t.isTypeOf("boolean",e.includeReactions)&&t.isTypeOf("boolean",e.includeParentMessageInfo);class v extends p{constructor(e,s){var i,n,a,r;if(super(e,s),this.translations={},this.message=null!==(i=s.message)&&void 0!==i?i:"",this.messageType=t.MessageType.ADMIN,this.translations=null!==(n=s.translations)&&void 0!==n?n:{},s.parent_message_info){const i=s.parent_message_info;this.parentMessage=O(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(a=i.file)||void 0===a?void 0:a.url,require_auth:null===(r=i.file)||void 0===r?void 0:r.require_auth}))))}}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{message:e.message,translations:e.translations,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},g),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&f(i)).throw(t.SendbirdError.invalidParameters);const n=bt.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}}class I{constructor(e){var s,i;this.detail={},this.type=null!==(s=e.type)&&void 0!==s?s:"",this.vendor=null!==(i=e.vendor)&&void 0!==i?i:"",e.detail&&t.isTypeOf("object",e.detail)&&!Array.isArray(e.detail)&&(this.detail=e.detail)}static payloadify(e){return t.deundefined(t.undefineNullProps({type:e.type,vendor:e.vendor,detail:e.detail}))}}class E extends m{constructor(e,s){var i,n,a,r,o;if(super(e,s),this.message="",this.messageParams=null,this.translations={},this.translationTargetLanguages=[],this.messageSurvivalSeconds=-1,this.plugins=[],this._poll=null,this.message=s.message,this.messageType=t.MessageType.USER,this.translations=null!==(i=s.translations)&&void 0!==i?i:{},this.translationTargetLanguages=null!==(n=s.target_langs)&&void 0!==n?n:[],0===Object.keys(this.translations).length&&this.translationTargetLanguages.length>0)for(const e of this.translationTargetLanguages)this.translations[e]="";if(this.messageSurvivalSeconds=null!==(a=s.message_survival_seconds)&&void 0!==a?a:-1,this.plugins=s.plugins?s.plugins.map((e=>new I(e))):[],this._poll=s.poll?new t.Poll(this._iid,s.poll):null,s.parent_message_info){const i=s.parent_message_info;this.parentMessage=O(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{created_at:i.ts,message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(r=i.file)||void 0===r?void 0:r.url,require_auth:null===(o=i.file)||void 0===o?void 0:o.require_auth}))))}}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{message:e.message,translations:e.translations,message_survival_seconds:e.messageSurvivalSeconds,plugins:e.plugins.map((e=>I.payloadify(e))),poll:e._poll?t.Poll.payloadify(e._poll):null,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},g),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&f(i)).throw(t.SendbirdError.invalidParameters);const n=bt.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}applyPoll(e){return!(this._poll&&this._poll.id===e.id&&this._poll.updatedAt>e.updatedAt)&&(this._poll=e,!0)}get poll(){return this._poll}}class T extends t.InstancedObject{constructor(e,s){var i,n,a,r,o;super(e),this.plainUrl="",this.fileName=null,this.mimeType=null,this.fileSize=0,this.thumbnails=[],this._requireAuth=!1,this.plainUrl=null!==(i=s.url)&&void 0!==i?i:"",this.fileName=null!==(n=s.file_name)&&void 0!==n?n:null,this.mimeType=null!==(a=s.file_type)&&void 0!==a?a:null,this.fileSize=null!==(r=s.file_size)&&void 0!==r?r:0,this._requireAuth=null!==(o=s.require_auth)&&void 0!==o&&o;const{sessionManager:l}=t.Vault.of(this._iid);this.thumbnails=s.thumbnails?s.thumbnails.map((e=>new y(Object.assign(Object.assign({},e),{url:`${e.url.split("?auth=")[0]}${this._requireAuth?`?auth=${l.ekey}`:""}`})))):[]}static payloadify(e){var s;return t.deundefined(t.undefineNullProps({url:e.plainUrl,file_name:e.fileName,file_type:e.mimeType,file_size:e.fileSize,thumbnails:null===(s=e.thumbnails)||void 0===s?void 0:s.map((e=>({url:e.url,width:e.width,height:e.height,real_width:e.realWidth,real_height:e.realHeight}))),require_auth:e._requireAuth}))}get url(){const{sessionManager:e}=t.Vault.of(this._iid);return this._requireAuth?`${this.plainUrl}?auth=${e.ekey}`:this.plainUrl}}class b extends m{constructor(e,s){var i,n,a,r,o;if(super(e,s),this.messageParams=null,this.fileInfoList=[],this.messageSurvivalSeconds=-1,this.messageType=t.MessageType.FILE,this.fileInfoList=null!==(n=null===(i=s.files)||void 0===i?void 0:i.map((t=>new T(e,t))))&&void 0!==n?n:[],this.messageSurvivalSeconds=null!==(a=s.message_survival_seconds)&&void 0!==a?a:-1,s.parent_message_info){const i=s.parent_message_info;this.parentMessage=O(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{created_at:i.ts,message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(r=i.file)||void 0===r?void 0:r.url,require_auth:null===(o=i.file)||void 0===o?void 0:o.require_auth}))))}}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},g),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&f(i)).throw(t.SendbirdError.invalidParameters);const n=bt.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}static payloadify(e){return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{files:e.fileInfoList&&e.fileInfoList&&Array.isArray(e.fileInfoList)?e.fileInfoList.map((e=>T.payloadify(e))):null,message_survival_seconds:e.messageSurvivalSeconds,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}static _isMultipleFilesMessagePayload(e){const t=e.files;return Array.isArray(t)&&t.length>=2}static _isMultipleFilesMessageSerializedData(e){const t=e.fileInfoList;return Array.isArray(t)}}const O=(e,s)=>{switch(s.type){case"MESG":return new E(e,s);case"FILE":return b._isMultipleFilesMessagePayload(s)?new b(e,s):new N(e,s);case"ADMM":case"BRDM":return new v(e,s)}throw t.SendbirdError.unknown};class N extends m{constructor(e,s){var i,n,a,r,o,l,d,u,c,h,_,p,m,g;super(e,s),this.messageParams=null,this.plainUrl="",this.requireAuth=!1,this.thumbnails=[],this.messageSurvivalSeconds=-1,this.messageType=t.MessageType.FILE;const f=s.file;this.plainUrl=(null!==(n=null!==(i=null==f?void 0:f.url)&&void 0!==i?i:s.url)&&void 0!==n?n:"").split("?auth=")[0],this.name=null!==(r=null!==(a=null==f?void 0:f.name)&&void 0!==a?a:s.name)&&void 0!==r?r:"File",this.size=null!==(l=null!==(o=null==f?void 0:f.size)&&void 0!==o?o:s.size)&&void 0!==l?l:0,this.data=null!==(u=null!==(d=null==f?void 0:f.data)&&void 0!==d?d:s.custom)&&void 0!==u?u:"",this.type=f?null!==(c=f.type)&&void 0!==c?c:"":null!==(h=s.type)&&void 0!==h?h:"";const{sessionManager:v}=t.Vault.of(this._iid);if(this.requireAuth=null!==(_=s.require_auth)&&void 0!==_&&_,this.thumbnails=s.thumbnails?s.thumbnails.map((e=>new y(Object.assign(Object.assign({},e),{url:`${e.url.split("?auth=")[0]}${this.requireAuth?`?auth=${v.ekey}`:""}`})))):[],this.messageSurvivalSeconds=null!==(p=s.message_survival_seconds)&&void 0!==p?p:-1,s.parent_message_info){const i=s.parent_message_info;this.parentMessage=O(e,t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},i),{created_at:i.ts,message_id:this.parentMessageId,channel_url:this.channelUrl,channel_type:this.channelType,file:i.file,url:null===(m=i.file)||void 0===m?void 0:m.url,require_auth:null===(g=i.file)||void 0===g?void 0:g.require_auth}))))}}static payloadify(e){var s;return t.deundefined(t.undefineNullProps(Object.assign(Object.assign({},super.payloadify(e)),{url:e.plainUrl,require_auth:e.requireAuth,file:{name:e.name,size:e.size,type:e.type,data:e.data},thumbnails:null===(s=e.thumbnails)||void 0===s?void 0:s.map((e=>({url:e.url,width:e.width,height:e.height,real_width:e.realWidth,real_height:e.realHeight}))),message_survival_seconds:e.messageSurvivalSeconds,parent_message_info:e.parentMessage?super._getParentMessageInfoPayload(e.parentMessage):null})))}get url(){const{sessionManager:e}=t.Vault.of(this._iid);return this.requireAuth?`${this.plainUrl}?auth=${e.ekey}`:this.plainUrl}getThreadedMessagesByTimestamp(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},g),s);t.unless(this.messageId>0&&t.isTypeOf("number",e)&&f(i)).throw(t.SendbirdError.invalidParameters);const n=bt.of(this._iid);return yield n.getThreadedMessagesByTimestamp(this,e,i)}))}}class S extends t.WebSocketRequestCommand{constructor(e){var s,i,n;let a=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?a=e.mentionedUserIds:e.mentionedUsers&&(a=e.mentionedUsers.map((e=>e.userId)))),super({code:"FILE",ackRequired:!0,payload:t.deundefined(t.undefineNullProps({channel_url:e.channelUrl,files:e.files?C(e.files):null,url:e.url,name:null!==(s=e.fileName)&&void 0!==s?s:"",type:null!==(i=e.mimeType)&&void 0!==i?i:"",size:null!==(n=e.fileSize)&&void 0!==n?n:0,custom:e.data,custom_type:e.customType,thumbnails:e.thumbnailSizes,require_auth:e.requireAuth,metaarray:e.metaArrays,mention_type:e.mentionType,mentioned_user_ids:a,push_option:e.pushNotificationDeliveryOption&&e.pushNotificationDeliveryOption!==t.PushNotificationDeliveryOption.DEFAULT?e.pushNotificationDeliveryOption:void 0,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,silent:e.silent,reply_to_channel:e.isReplyToChannel,parent_message_id:e.parentMessageId?e.parentMessageId:null,req_id:e.reqId,pin_message:e.isPinnedMessage}))})}}class M extends t.APIRequestCommand{constructor(e){var s,i;super();let n=[];e.mentionType===t.MentionType.USERS&&(e.mentionedUserIds?n=e.mentionedUserIds:e.mentionedUsers&&(n=e.mentionedUsers.map((e=>e.userId)))),this.method=t.APIRequestMethod.POST,this.path=`${t.getChannelApiPathByType(e.channelType)}/${encodeURIComponent(e.channelUrl)}/messages`,this.params=t.deundefined(t.undefineNullProps({message_type:t.MessageType.FILE,user_id:e.userId,files:e.files?C(e.files):null,url:e.fileUrl,mention_type:e.mentionType,mentioned_user_ids:n,file_name:e.fileName,file_size:e.fileSize,file_type:e.mimeType,data:e.data,custom_type:e.customType,thumbnails:null===(s=e.thumbnailSizes)||void 0===s?void 0:s.map((e=>y.payloadify(e))),require_auth:e.requireAuth,sorted_metaarray:null===(i=e.metaArrays)||void 0===i?void 0:i.map((e=>r.payloadify(e))),push_option:e.pushNotificationDeliveryOption,parent_message_id:e.parentMessageId?e.parentMessageId:null,apple_critical_alert_options:e.appleCriticalAlertOptions?d.payloadify(e.appleCriticalAlertOptions):null,reply_to_channel:e.isReplyToChannel,req_id:e.reqId,pin_message:e.isPinnedMessage}))}}class w extends t.WebSocketEventCommand{constructor(e,s,i){var n,a,r,o;super(e,"FILE",i),this.message=i.files&&i.files.length>=2?new b(e,i):new N(e,i);const{sdkState:l}=t.Vault.of(e);this.isMentioned=t.checkIfMentioned(this.message.mentionType,null!==(r=null!==(n=this.message.mentionedUserIds)&&void 0!==n?n:null===(a=this.message.mentionedUsers)||void 0===a?void 0:a.map((e=>e.userId)))&&void 0!==r?r:[],l.userId),this.forceUpdateLastMessage=null!==(o=i.force_update_last_message)&&void 0!==o&&o}}class A extends t.APIResponseCommand{constructor(e,s){var i,n,a,r;super(e,s),this.message=s.files&&s.files.length>=2?new b(e,s):new N(e,s);const{sdkState:o}=t.Vault.of(e);this.isMentioned=t.checkIfMentioned(this.message.mentionType,null!==(a=null!==(i=this.message.mentionedUserIds)&&void 0!==i?i:null===(n=this.message.mentionedUsers)||void 0===n?void 0:n.map((e=>e.userId)))&&void 0!==a?a:[],o.userId),this.forceUpdateLastMessage=null!==(r=s.force_update_last_message)&&void 0!==r&&r}}function C(e){return e.map((e=>{var s,i;return t.deundefined(t.undefineNullProps({url:e.fileUrl,file_name:e.fileName,file_type:e.mimeType,file_size:e.fileSize,thumbnails:null===(s=e.thumbnailSizes)||void 0===s?void 0:s.map((e=>y.payloadify(e))),require_auth:null===(i=e._uploadedMetaData)||void 0===i?void 0:i.requireAuth}))}))}var x;!function(e){e[e.PENDING=0]="PENDING",e[e.UPLOADING=1]="UPLOADING",e[e.UPLOADED=2]="UPLOADED",e[e.SENDING=3]="SENDING",e[e.FAILED=4]="FAILED"}(x||(x={}));class R{constructor(e,{sdkState:s,dispatcher:i,requestQueue:n,onlineDetector:a,cacheContext:r}){this._queueMap=new Map,this._iid=e,this._sdkState=s,this._requestQueue=n,this._cacheContext=r,this._dispatcher=i,this._dispatcher.on((e=>{e instanceof t.ConnectionStateChangeCommand&&(this._connectionState=e.stateType)})),this._onlineDetector=a}get _shouldSendThroughWebSocket(){return this._connectionState===t.ConnectionStateType.CONNECTED||this._connectionState===t.ConnectionStateType.CONNECTING||this._connectionState===t.ConnectionStateType.RECONNECTING}_sendFileMessage(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=this._createSendFileMessageRequestParams(e,s);if(this._shouldSendThroughWebSocket){const e=new S(t),s=yield this._requestQueue.send(e),{message:i}=s.as(w);return i}{const e=new M(Object.assign(Object.assign({},t),{userId:this._sdkState.userId})),s=yield this._requestQueue.send(e),{message:i}=s.as(A);return i}}))}_createSendFileMessageRequestParams(e,t){const s=Object.assign(Object.assign({},t.params),{channelUrl:e.url,channelType:e.channelType,reqId:t.requestId,url:""});if(t.multipleFileUploadInfo){const e=t.params;s.files=e.fileInfoList}else{const e=t.params;s.url=e.fileUrl,s.requireAuth=e.requireAuth}return s}_resolveMessageQueue(e){var s;return t.__awaiter(this,void 0,void 0,(function*(){const i=this._queueMap.get(e.url);if(i)if(i.isResolving)i.isResolveRequestPending=!0;else{i.isResolving=!0;const n=[];let a=!0;for(const r of i.messageQueue)switch(r.state){case x.PENDING:case x.UPLOADING:a=!1,n.push(r);break;case x.UPLOADED:if(a)try{r.state=x.SENDING;const s=yield this._sendFileMessage(e,r);r.deferred.resolve(s),yield t.sleep(100)}catch(e){r.deferred.reject(e)}else n.push(r);break;case x.FAILED:{const e=null!==(s=r.error)&&void 0!==s?s:t.SendbirdError.unknown;r.deferred.reject(e.code===t.SendbirdErrorCode.REQUEST_CANCELED?t.SendbirdError.fileUploadCanceled:e);break}}const r=i.isResolveRequestPending;i.messageQueue=n,i.isResolving=!1,i.isResolveRequestPending=!1,r&&(yield this._resolveMessageQueue(e))}}))}_uploadNextPendingItem(e){var s;return t.__awaiter(this,void 0,void 0,(function*(){const i=this._queueMap.get(e.url);if(i){const n=i.messageQueue.find((e=>e.state===x.PENDING));if(n){if(n.multipleFileUploadInfo){const{uploadIndex:a,uploadCount:r,requestHandler:o}=n.multipleFileUploadInfo,l=n.params.fileInfoList[a];t.isFile(l.file)&&!(null===(s=l._uploadedMetaData)||void 0===s?void 0:s.isUploaded)?yield this._tryUploadNextItemAndUpdateItemState(e,i,n):n.state=a<r-1?x.PENDING:x.UPLOADED;const d=a;null==o||o._triggerOnFileUploaded(n.requestId,d,l,n.error),n.multipleFileUploadInfo.uploadIndex++}else{const s=n.params;t.isFile(s.file)?yield this._tryUploadNextItemAndUpdateItemState(e,i,n):(s.thumbnailSizes=[],n.state=x.UPLOADED)}this._uploadNextPendingItem(e),yield this._resolveMessageQueue(e)}}}))}_tryUploadNextItemAndUpdateItemState(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){const n=yield this._onlineDetector.isOnline(),{sessionManager:a}=t.Vault.of(this._iid);if(!a.currentUser||!n)return i.error=t.SendbirdError.connectionRequired,void(i.state=x.FAILED);if(s.uploadQueue.length<6){i.state=x.UPLOADING,s.uploadQueue.push(i);try{if(i.multipleFileUploadInfo){const{uploadIndex:t,uploadCount:s}=i.multipleFileUploadInfo,n=i.params;yield this._uploadNextFileForMultipleFilesItemAndUpdateParams(e,i,n),i.state=t<s-1?x.PENDING:x.UPLOADED}else{const t=i.params;yield this._uploadNextFileForSingleFileItemAndUpdateParams(e,i,t),i.state=x.UPLOADED}}catch(e){i.error=e.code===t.SendbirdErrorCode.REQUEST_FAILED?new t.SendbirdError({code:t.SendbirdErrorCode.NETWORK_ERROR,message:"Failed to upload a file."}):e,i.state=x.FAILED}this._dequeueUploadItem(s,i)}}))}_dequeueUploadItem(e,t){const s=e.uploadQueue.findIndex((e=>e.requestId===t.requestId));s>=0&&e.uploadQueue.splice(s,1)}_uploadNextFileForSingleFileItemAndUpdateParams(e,n,a){var r,o,l;return t.__awaiter(this,void 0,void 0,(function*(){const t=new s({file:a.file,channelUrl:e.url,thumbnailSizes:a.thumbnailSizes,requestId:n.requestId}),d=yield this._requestQueue.send(t),{url:u,fileSize:c=a.fileSize,thumbnailSizes:h=a.thumbnailSizes,requireAuth:_=!1}=d.as(i);a.fileName=null!==(r=a.fileName)&&void 0!==r?r:a.file.name,a.mimeType=null!==(o=a.mimeType)&&void 0!==o?o:a.file.type,a.fileSize=null!==(l=a.fileSize)&&void 0!==l?l:a.file.size,a.fileUrl=u,a.fileSize=c,a.thumbnailSizes=h,a.requireAuth=_}))}_uploadNextFileForMultipleFilesItemAndUpdateParams(e,n,a){var r,o,l;return t.__awaiter(this,void 0,void 0,(function*(){const{uploadIndex:t}=n.multipleFileUploadInfo,d=a.fileInfoList[t],u=new s({file:d.file,channelUrl:e.url,thumbnailSizes:d.thumbnailSizes,requestId:n.requestId}),c=yield this._requestQueue.send(u),{url:h,fileSize:_=d.fileSize,thumbnailSizes:p=d.thumbnailSizes,requireAuth:m=!1}=c.as(i);d.fileName=null!==(r=d.fileName)&&void 0!==r?r:d.file.name,d.mimeType=null!==(o=d.mimeType)&&void 0!==o?o:d.file.type,d.fileSize=null!==(l=d.fileSize)&&void 0!==l?l:d.file.size,d.file=void 0,d.fileUrl=h,d.fileSize=_,d.thumbnailSizes=p,d._uploadedMetaData=Object.assign(Object.assign({},d._uploadedMetaData),{requireAuth:m,isUploaded:!0})}))}request(e,s,i,n){return t.__awaiter(this,void 0,void 0,(function*(){if(!this._queueMap.has(e.url)){const t={messageQueue:[],uploadQueue:[],isResolving:!1,isResolveRequestPending:!1};this._queueMap.set(e.url,t)}const a=this._queueMap.get(e.url),r=new t.Deferred,o={requestId:s,params:i,state:x.PENDING,deferred:r};if(function(e){return"fileInfoList"in e}(i)){const e={uploadIndex:0,uploadCount:i.fileInfoList.length,requestHandler:n};o.multipleFileUploadInfo=e}return a.messageQueue.push(o),this._uploadNextPendingItem(e),r.promise}))}cancel(e,s){const i=this._queueMap.get(e.url);if(i){const n=s?[i.messageQueue.find((e=>e.requestId===s))]:[...i.messageQueue];for(const s of n)if(s)switch(s.state){case x.PENDING:s.state=x.FAILED,s.error=t.SendbirdError.requestCanceled,this._resolveMessageQueue(e);break;case x.UPLOADING:this._requestQueue.cancel(s.requestId)}}}}const L={prevResultSize:0,nextResultSize:0,isInclusive:!1,reverse:!1,messageTypeFilter:t.MessageTypeFilter.ALL,customTypesFilter:void 0,senderUserIdsFilter:void 0,replyType:t.ReplyType.NONE,includeReactions:!1,includeMetaArray:!1,includeParentMessageInfo:!1,includeThreadInfo:!1,showSubchannelMessagesOnly:!1},k={replyType:t.ReplyType.NONE,includeReactions:!1,includeThreadInfo:!1,includeMetaArray:!1,includeParentMessageInfo:!1};class P extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,messageId:i,includeMetaArray:n,includeReactions:a,includeThreadInfo:r,includeParentMessageInfo:o}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/${encodeURIComponent(i)}`,this.params={is_sdk:!0,with_sorted_meta_array:n,include_reactions:a,include_thread_info:r,include_parent_message_info:o,include_poll_details:!0}}}class D extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=t?O(e,Object.assign({},t)):null}}class U extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,timestamp:i,token:n,prevResultSize:a,nextResultSize:r,isInclusive:o,reverse:l,messageTypeFilter:d,customTypesFilter:u,senderUserIdsFilter:c,replyType:h,includeMetaArray:_,includeReactions:p,parentMessageId:m,includeThreadInfo:y,includeParentMessageInfo:g,showSubchannelMessagesOnly:f,checkingContinuousMessages:v}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages`,this.params=t.deundefined(t.undefineNullProps({is_sdk:!0,prev_limit:a,next_limit:r,include:o,reverse:l,message_ts:i,message_id:n,message_type:null!=d?d:null,custom_types:u,sender_ids:c,include_reply_type:h,with_sorted_meta_array:_,include_reactions:p,parent_message_id:m,include_thread_info:y,include_parent_message_info:g,show_subchannel_message_only:f,include_poll_details:!0,checking_continuous_messages:v}))}}class F extends t.APIResponseCommand{constructor(e,t){super(e,t),this.messages=t.messages.map((t=>O(e,t)))}}class q extends t.APIRequestCommand{constructor({channelType:e,channelUrl:s,timestamp:i,token:n,replyType:a,includeMetaArray:r,includeReactions:o,includeThreadInfo:l,includeParentMessageInfo:d}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.getChannelApiPathByType(e)}/${encodeURIComponent(s)}/messages/changelogs`,this.params={change_ts:i,token:n,with_sorted_meta_array:r,include_reactions:o,include_thread_info:l,include_reply_type:a,include_parent_message_info:d,include_poll_details:!0}}}class B extends t.APIResponseCommand{constructor(e,t){super(e,t),this.updatedMessages=t.updated.map((t=>O(e,t))),this.deletedMessagesInfo=t.deleted.map((e=>({messageId:e.message_id,deletedAt:e.deleted_at}))),this.hasMore=t.has_more,this.nextToken=t.next}}class z extends t.APIRequestCommand{constructor({channelUrl:e,scheduledMessageId:s}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(e)}/scheduled_messages/${encodeURIComponent(s)}`,this.params={}}}class j extends t.APIResponseCommand{constructor(e,t){super(e,t),this.message=t?O(e,Object.assign({},t)):null}}var K;exports.RestrictionType=void 0,(K=exports.RestrictionType||(exports.RestrictionType={})).MUTED="muted",K.BANNED="banned";class G{constructor(){this._onPending=t.noop,this._onFailed=t.noop,this._onSucceeded=t.noop}_trigger(e){switch(null==e?void 0:e.sendingStatus){case t.SendingStatus.PENDING:0===e.errorCode&&this._onPending(e);break;case t.SendingStatus.SCHEDULED:case t.SendingStatus.SUCCEEDED:this._onSucceeded(e)}}_triggerFailed(e,s){switch(null==s?void 0:s.sendingStatus){case t.SendingStatus.FAILED:case t.SendingStatus.CANCELED:this._onFailed(e,s.scheduledInfo?null:s)}}onPending(e){return this._onPending=e,this}onFailed(e){return this._onFailed=e,this}onSucceeded(e){return this._onSucceeded=e,this}}const V={data:void 0,customType:void 0,mentionType:t.MentionType.USERS,mentionedUserIds:void 0,mentionedUsers:void 0,mentionedMessageTemplate:void 0,metaArrays:void 0,parentMessageId:void 0,isReplyToChannel:!1,pushNotificationDeliveryOption:void 0,appleCriticalAlertOptions:void 0,isPinnedMessage:!1},H=e=>t.isTypeOf("string",e.data,!0)&&t.isTypeOf("string",e.customType,!0)&&t.isEnumOf(t.MentionType,e.mentionType)&&t.isArrayOf("string",e.mentionedUserIds,!0)&&t.isArrayOf(t.User,e.mentionedUsers,!0)&&t.isTypeOf("string",e.mentionedMessageTemplate,!0)&&t.isArrayOf(r,e.metaArrays,!0)&&t.isTypeOf("number",e.parentMessageId,!0)&&t.isTypeOf("boolean",e.isReplyToChannel)&&t.isEnumOf(t.PushNotificationDeliveryOption,e.pushNotificationDeliveryOption,!0)&&t.isTypeOf(d,e.appleCriticalAlertOptions,!0)&&t.isTypeOf("boolean",e.isPinnedMessage,!0),$=e=>({isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,pollId:e.pollId}),Q=Object.assign(Object.assign({},V),{message:"",translationTargetLanguages:void 0,pollId:void 0}),W=e=>H(e)&&t.isTypeOf("string",e.message)&&t.isArrayOf("string",e.translationTargetLanguages,!0)&&t.isTypeOf("number",e.pollId,!0);var Y;!function(e){e.FILE="file",e.BLOB="blob",e.BLOB_LIKE_OBJECT="blobLikeObject",e.URL="url"}(Y||(Y={}));const J=e=>"undefined"!=typeof window&&"Blob"in window&&"undefined"!=typeof Blob&&e instanceof Blob,X=e=>e===Y.BLOB||e===Y.FILE,Z=e=>({file:e.file,fileKey:e.fileKey,fileType:e.fileType,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption}),ee=Object.assign(Object.assign({},V),{file:void 0,fileKey:void 0,fileUrl:void 0,fileName:void 0,fileType:void 0,fileSize:void 0,mimeType:void 0,thumbnailSizes:void 0,requireAuth:!1}),te={data:void 0,customType:void 0,mentionType:t.MentionType.USERS,mentionedUserIds:void 0,mentionedUsers:void 0,mentionedMessageTemplate:void 0,metaArrays:void 0,pushNotificationDeliveryOption:void 0,appleCriticalAlertOptions:void 0},se=e=>t.isTypeOf("string",e.data,!0)&&t.isTypeOf("string",e.customType,!0)&&t.isEnumOf(t.MentionType,e.mentionType)&&t.isArrayOf("string",e.mentionedUserIds,!0)&&t.isArrayOf(t.User,e.mentionedUsers,!0)&&t.isTypeOf("string",e.mentionedMessageTemplate,!0)&&t.isArrayOf(r,e.metaArrays,!0)&&t.isEnumOf(t.PushNotificationDeliveryOption,e.pushNotificationDeliveryOption,!0)&&t.isTypeOf(d,e.appleCriticalAlertOptions,!0),ie=Object.assign(Object.assign({},te),{message:void 0,translationTargetLanguages:void 0,pollId:void 0}),ne=Object.assign({},te);class ae extends t.ChannelDataListQuery{constructor(e,s,i,n){var a,r,o,l,d,u,c,h,_,p;super(e,s,i,n),this.reverse=!1,this.messageTypeFilter=t.MessageTypeFilter.ALL,this.customTypesFilter=null,this.senderUserIdsFilter=null,this.replyType=t.ReplyType.NONE,this.includeMetaArray=!1,this.includeReactions=!1,this.includeParentMessageInfo=!1,this.includeThreadInfo=!1,this.showSubchannelMessagesOnly=!1,this._edge=Number.MAX_SAFE_INTEGER,this.reverse=null!==(a=n.reverse)&&void 0!==a&&a,this.messageTypeFilter=null!==(r=n.messageTypeFilter)&&void 0!==r?r:t.MessageTypeFilter.ALL,this.customTypesFilter=null!==(o=n.customTypesFilter)&&void 0!==o?o:null,this.senderUserIdsFilter=null!==(l=n.senderUserIdsFilter)&&void 0!==l?l:null,this.replyType=null!==(d=n.replyType)&&void 0!==d?d:t.ReplyType.NONE,this.includeMetaArray=null!==(u=n.includeMetaArray)&&void 0!==u&&u,this.includeReactions=null!==(c=n.includeReactions)&&void 0!==c&&c,this.includeParentMessageInfo=null!==(h=n.includeParentMessageInfo)&&void 0!==h&&h,this.includeThreadInfo=null!==(_=n.includeThreadInfo)&&void 0!==_&&_,this.showSubchannelMessagesOnly=null!==(p=n.showSubchannelMessagesOnly)&&void 0!==p&&p}_validate(){return super._validate()&&t.isTypeOf("boolean",this.reverse)&&t.isEnumOf(t.MessageTypeFilter,this.messageTypeFilter)&&t.isEnumOf(t.ReplyType,this.replyType)&&t.isArrayOf("string",this.customTypesFilter,!0)&&t.isArrayOf("string",this.senderUserIdsFilter,!0)&&t.isTypeOf("boolean",this.includeMetaArray)&&t.isTypeOf("boolean",this.includeReactions)&&t.isTypeOf("boolean",this.includeParentMessageInfo)&&t.isTypeOf("boolean",this.includeThreadInfo)&&t.isTypeOf("boolean",this.showSubchannelMessagesOnly)}load(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const e=bt.of(this._iid),s=yield e.getMessagesByTimestamp(this.channelUrl,this.channelType,this._edge,t.undefineNullProps({prevResultSize:this.limit,nextResultSize:0,isInclusive:!1,reverse:this.reverse,messageTypeFilter:this.messageTypeFilter,customTypesFilter:this.customTypesFilter,replyType:this.replyType,senderUserIdsFilter:this.senderUserIdsFilter,includeReactions:this.includeReactions,includeMetaArray:this.includeMetaArray,includeParentMessageInfo:this.includeParentMessageInfo,includeThreadInfo:this.includeThreadInfo,showSubchannelMessagesOnly:this.showSubchannelMessagesOnly}));return this._edge=Math.min(Number.MAX_SAFE_INTEGER,...s.map((e=>e.createdAt))),this._hasNext=s.length>=this.limit,this._isLoading=!1,s}return[]}throw t.SendbirdError.invalidParameters}))}}var re;exports.ReportCategory=void 0,(re=exports.ReportCategory||(exports.ReportCategory={})).SPAM="spam",re.HARASSING="harassing",re.SUSPICIOUS="suspicious",re.INAPPROPRIATE="inappropriate";const oe="Message",le=Object.assign(Object.assign({},V),{fileInfoList:[]}),de=e=>(t.isFile(e.file)||t.isTypeOf("string",e.fileUrl))&&t.isTypeOf("string",e.fileName,!0)&&t.isTypeOf("string",e.mimeType,!0)&&t.isTypeOf("number",e.fileSize,!0)&&(void 0===e.thumbnailSizes||Array.isArray(e.thumbnailSizes)&&e.thumbnailSizes.every((e=>e.maxWidth>0&&e.maxHeight>0)));const ue={};class ce{constructor({dbname:e,itemSizeLimit:t=1048576,cacheLimit:s=256,blockHashBase:i=2,blockHashMultiplier:n=10,blockHashConstant:a=11,transactionApplyDelay:r=200,disableLogger:o=!1}){return ue[e]||(this.itemSizeLimit=t,this.cacheLimit=s,this.blockHashBase=i,this.blockHashMultiplier=n,this.blockHashConstant=a,this.transactionApplyDelay=r,this.disableLogger=o,ue[e]=this),ue[e]}static get(e){return ue[e]}}var he,_e;!function(e){e[e.UNKNOWN_ERROR=6e7]="UNKNOWN_ERROR",e[e.STORE_NOT_DEFINED=61001e3]="STORE_NOT_DEFINED",e[e.STORE_NOT_AVAILABLE=61001001]="STORE_NOT_AVAILABLE",e[e.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING=61001002]="STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING",e[e.STORE_IS_FULL=61001003]="STORE_IS_FULL",e[e.STORE_NOT_INITIALIZED=61001004]="STORE_NOT_INITIALIZED",e[e.STORE_INVALID_KEY_TYPE=61002e3]="STORE_INVALID_KEY_TYPE",e[e.STORE_BROKEN_INTEGRITY=61002001]="STORE_BROKEN_INTEGRITY",e[e.STORE_BROKEN_BLOB=61002002]="STORE_BROKEN_BLOB",e[e.STORE_ENCRYPTION_INVALID=61002003]="STORE_ENCRYPTION_INVALID",e[e.STORE_ITEM_SIZE_LIMIT_EXCEEDED=61017e3]="STORE_ITEM_SIZE_LIMIT_EXCEEDED",e[e.STORE_READ_FAILED=61017001]="STORE_READ_FAILED",e[e.STORE_WRITE_FAILED=61017002]="STORE_WRITE_FAILED",e[e.DATABASE_SCHEMA_NOT_ON_UPGRADE=62002e3]="DATABASE_SCHEMA_NOT_ON_UPGRADE",e[e.COLLECTION_NOT_READY=63001e3]="COLLECTION_NOT_READY",e[e.COLLECTION_KEY_NOT_MATCH=63002e3]="COLLECTION_KEY_NOT_MATCH",e[e.COLLECTION_QUERY_NOT_VALID=63002001]="COLLECTION_QUERY_NOT_VALID",e[e.COLLECTION_KEY_NOT_FOUND=63004e3]="COLLECTION_KEY_NOT_FOUND",e[e.COLLECTION_KEY_NOT_GIVEN=63004001]="COLLECTION_KEY_NOT_GIVEN",e[e.COLLECTION_INSERT_DUPLICATE=63009e3]="COLLECTION_INSERT_DUPLICATE",e[e.COLLECTION_WRITE_FAILED=63017e3]="COLLECTION_WRITE_FAILED",e[e.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED=63017001]="COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED",e[e.INDEX_TABLE_IS_REQUIRED=65001e3]="INDEX_TABLE_IS_REQUIRED",e[e.INDEX_TYPE_NOT_MATCH=65002e3]="INDEX_TYPE_NOT_MATCH",e[e.COMPARE_TYPE_NOT_MATCH=69002001]="COMPARE_TYPE_NOT_MATCH",e[e.CIRCULAR_REFERENCE_FOUND=69002002]="CIRCULAR_REFERENCE_FOUND"}(he||(he={}));class pe extends Error{constructor({code:e=he.UNKNOWN_ERROR,message:t="Unknown error occurred."}){super(t),this.code=e,Object.setPrototypeOf(this,pe.prototype)}static get storeNotDefined(){return new pe({code:he.STORE_NOT_DEFINED,message:"Store is not defined. Specify the store on NestDB()"})}static get storeNotAvailable(){return new pe({code:he.STORE_NOT_AVAILABLE,message:"Store is not available. Check your environment settings."})}static get storeNotAvailableInPrivateBrowsing(){return new pe({code:he.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING,message:"Store is not available because it is in private browsing."})}static get storeIsFull(){return new pe({code:he.STORE_IS_FULL,message:"Store is full."})}static get storeNotInitialized(){return new pe({code:he.STORE_NOT_INITIALIZED,message:"Store is not initialized."})}static get storeKeyTypeIsInvalid(){return new pe({code:he.STORE_INVALID_KEY_TYPE,message:"Store key should be string type."})}static get storeBrokenIntegrity(){return new pe({code:he.STORE_BROKEN_INTEGRITY,message:"Data should be in a store but it does not. Integrity is broken."})}static get storeBrokenBlob(){return new pe({code:he.STORE_BROKEN_BLOB,message:"Data should be in a store but it does not. Blob data is broken."})}static get storeEncryptionInvalid(){return new pe({code:he.STORE_ENCRYPTION_INVALID,message:"Encryption algorithm has changed. All the store should reset."})}static get storeItemSizeExceeded(){return new pe({code:he.STORE_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that the store allows."})}static get storeReadFailed(){return new pe({code:he.STORE_READ_FAILED,message:"Failed to read from store."})}static get storeWriteFailed(){return new pe({code:he.STORE_WRITE_FAILED,message:"Failed to write to store."})}static get databaseSchemaNotOnUpgrade(){return new pe({code:he.DATABASE_SCHEMA_NOT_ON_UPGRADE,message:"Committing schema is not allowed when upgrade is not running."})}static get collectionNotReady(){return new pe({code:he.COLLECTION_NOT_READY,message:"Collection is not ready due to an error during initialization."})}static get collectionKeyNotMatch(){return new pe({code:he.COLLECTION_KEY_NOT_MATCH,message:"keyName of collection could not change."})}static get collectionQueryNotValid(){return new pe({code:he.COLLECTION_QUERY_NOT_VALID,message:"Query parameter is not a valid format."})}static get collectionInsertDuplicate(){return new pe({code:he.COLLECTION_INSERT_DUPLICATE,message:"The key already exists."})}static get collectionKeyNotFound(){return new pe({code:he.COLLECTION_KEY_NOT_FOUND,message:"The key is not found."})}static get collectionKeyNotGiven(){return new pe({code:he.COLLECTION_KEY_NOT_GIVEN,message:"The item should contain [keyName] property."})}static get collectionWriteFailed(){return new pe({code:he.COLLECTION_WRITE_FAILED,message:"Failed to write an item."})}static get collectionItemSizeExceeded(){return new pe({code:he.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that a collection allows."})}static get indexTableIsRequired(){return new pe({code:he.INDEX_TABLE_IS_REQUIRED,message:"Index table is required."})}static get indexTypesNotMatch(){return new pe({code:he.INDEX_TYPE_NOT_MATCH,message:"Indexed column should have primitive type."})}static get compareTypesNotMatch(){return new pe({code:he.COMPARE_TYPE_NOT_MATCH,message:"Values to compare have different types."})}static get circularReferenceFound(){return new pe({code:he.CIRCULAR_REFERENCE_FOUND,message:"Cannot handle circular referenced object."})}}!function(e){e.INIT="init",e.READY="ready",e.CLOSED="closed"}(_e||(_e={}));const me=(e,t=new WeakMap)=>{if("object"==typeof e&&null!==e){if(t.has(e))throw pe.circularReferenceFound;{let s;if(t.set(e,!0),Array.isArray(e))s=e.map((e=>me(e,t)));else if(e instanceof RegExp)s=e;else if(e instanceof Date)s=e;else{s={};for(const i in e)s[i]=me(e[i],t)}return t.delete(e),s}}return e},ye=(e,t)=>{if(null==t)return 1;if(null==e)return-1;if(typeof e!=typeof t)throw pe.compareTypesNotMatch;let s=0;switch(typeof e){case"boolean":case"number":s=e-t;break;case"string":s=e.localeCompare(t)}return s},ge=(e,t)=>{let s=0;for(let t=0;t<e.length;t++)s=e.charCodeAt(t)+(s<<6)+(s<<16)-s;return(s>>>0)%t},fe=e=>new Promise((t=>{setTimeout((()=>t()),e)})),ve=(e,t)=>{if(!t)return!1;if("function"!=typeof e){for(const s in e)if(["/and","&&"].includes(s)){if(e[s].some((e=>!ve(e,t))))return!1}else if(["/or","||"].includes(s)){if(e[s].every((e=>!ve(e,t))))return!1}else if("/where"===s){if(!(0,e[s])(t))return!1}else{const i=s;if("object"==typeof e[i]){const s=e[i];for(const e in s)switch(e){case"/eq":case"=":if(t[i]!==s[e])return!1;break;case"/neq":case"!=":if(t[i]===s[e])return!1;break;case"/gt":case">":{const n=t[i],a=s[e];if(!(ye(n,a)>0))return!1;break}case"/gte":case">=":{const n=t[i],a=s[e];if(!(ye(n,a)>=0))return!1;break}case"/lt":case"<":{const n=t[i],a=s[e];if(!(ye(n,a)<0))return!1;break}case"/lte":case"<=":{const n=t[i],a=s[e];if(!(ye(n,a)<=0))return!1;break}case"/in":{const n=t[i];if(!s[e].includes(n))return!1;break}case"/nin":{const n=t[i];if(s[e].includes(n))return!1;break}case"/contain":{const n=t[i],a=s[e];if(!n.includes(a))return!1;break}case"/regex":{const n=t[i];if(!s[e].test(n))return!1;break}case"/where":{const n=t[i];if(!(0,s[e])(n))return!1;break}}}else if("function"==typeof e[i]){if(!e[i](t[i]))return!1}else if(e[i]!==t[i])return!1}return!0}return e(t)},Ie=()=>{},Ee=()=>Promise.resolve(),Te=e=>e,be=(e,t)=>{t()};var Oe;!function(e){e[e.FORWARD=0]="FORWARD",e[e.BACKWARD=1]="BACKWARD"}(Oe||(Oe={}));class Ne{constructor({initialPrevValue:e=null,initialNextValue:t=null,iterator:s,map:i=Te,backward:n=Ee,forward:a=Ee,complete:r=Ie}){this._prevValue=e,this._nextValue=t,this._error=null,this._map=i,this._backward=n,this._forward=a,this._iterator=s,this._complete=r}get prevValue(){return this._map(this._prevValue)}get nextValue(){return this._map(this._nextValue)}get error(){return this._error}get hasPrevious(){return!!this._prevValue}get hasNext(){return!!this._nextValue}prev(){return t.__awaiter(this,void 0,void 0,(function*(){if(this.hasPrevious){try{const e=this._prevValue;this._prevValue=(yield this._backward())||null,this._nextValue=e}catch(e){this._error=e}return yield this._iterator(this)}this._complete()}))}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this.hasNext){try{const e=this._nextValue;this._nextValue=(yield this._forward())||null,this._prevValue=e}catch(e){this._error=e}return yield this._iterator(this)}this._complete()}))}stop(){this._prevValue=null,this._nextValue=null,this._complete()}}class Se{constructor({condition:e={},backward:t=!1,blockManager:s,indexer:i}){this.condition=e,this.backward=t,this._blockManager=s,this._indexer=i}findOptimizedStartPosition(){const e=["=","/eq",">",">=","/gt","/gte"],t=["=","/eq","<","<=","/lt","/lte"];if(this.backward){let s=this._indexer.origin.length-1;if("function"!=typeof this.condition)for(const i in this._indexer.fields){let n=this._indexer.fields[i],a=1;if("-"===n[0]&&(n=n.slice(1),a=-1),this.condition[n])if("object"==typeof this.condition[n]){const r=a>0?t:e;for(const e in this.condition[n])if(r.includes(e))for(let t=s;t>=0;t--)if(a*ye(this._indexer.origin[t].columnValues[i],this.condition[n][e])<=0){s=t;break}}else for(let e=s;e>=0;e--)if(a*ye(this._indexer.origin[e].columnValues[i],this.condition[n])<=0){s=e;break}}return Math.min(s+1,this._indexer.origin.length-1)}{let s=0;if("function"!=typeof this.condition)for(let i=0;i<this._indexer.fields.length;i++){let n=this._indexer.fields[i],a=1;if("-"===n[0]&&(n=n.slice(1),a=-1),this.condition[n])if("object"==typeof this.condition[n])Object.keys(this.condition[n]).forEach((r=>{if((a>0?e:t).includes(r))for(let e=s;e<this._indexer.origin.length;e++)if(a*ye(this._indexer.origin[e].columnValues[i],this.condition[n][r])>=0){s=e;break}}));else for(let e=s;e<this._indexer.origin.length;e++)if(a*ye(this._indexer.origin[e].columnValues[i],this.condition[n])>=0){s=e;break}}return Math.max(s-1,0)}}each(e){return t.__awaiter(this,void 0,void 0,(function*(){let s=this.findOptimizedStartPosition(),i=0;this.backward&&this._indexer.origin[s]&&(i=this._indexer.origin[s].keys.length-1);const n=()=>{if(this._indexer.origin[s]){if(!this._indexer.origin[s].keys[++i]){if(!this._indexer.origin[++s])return!1;i=0}return!0}return!1},a=()=>{if(this._indexer.origin[s]){if(!this._indexer.origin[s].keys[--i]){if(!this._indexer.origin[--s])return!1;i=this._indexer.origin[s].keys.length-1}return!0}return!1};let r=null;if(this._indexer.origin[s]){const e=this.backward?a:n;do{const e=yield this._blockManager.getFromBlock(this._indexer.origin[s].keys[i]);if(e&&ve(this.condition,e)){r=e;break}}while(e())}return yield new Promise((o=>{const l=new Ne({initialNextValue:me(r),iterator:e,forward:()=>t.__awaiter(this,void 0,void 0,(function*(){const e=this.backward?a:n;for(;e();){const e=yield this._blockManager.getFromBlock(this._indexer.origin[s].keys[i]);if(e&&ve(this.condition,e))return me(e)}return null})),backward:()=>t.__awaiter(this,void 0,void 0,(function*(){const e=this.backward?n:a;for(;e();){const e=yield this._blockManager.getFromBlock(this._indexer.origin[s].keys[i]);if(e&&ve(this.condition,e))return me(e)}return null})),complete:o});e(l)}))}))}}class Me{constructor({condition:e={},backward:t=!1,mutex:s,blockManager:i,indexer:n}){this._mutex=s,this._iterator=new Se({condition:e,backward:t,blockManager:i,indexer:n})}fetch(e={}){return t.__awaiter(this,void 0,void 0,(function*(){let s=Math.max(e.offset||0,0);const i="number"==typeof e.limit?e.limit:Number.MAX_SAFE_INTEGER;if(0===i)return[];if(i<0)throw pe.collectionQueryNotValid;try{const e=[];return yield this._mutex.lock(),yield this._iterator.each((n=>t.__awaiter(this,void 0,void 0,(function*(){n.error?n.stop():n.hasNext?0===s?(e.push(n.nextValue),0<i&&i<=e.length?n.stop():n.next()):(s--,n.next()):n.stop()})))),this._mutex.unlock(),e}catch(e){throw this._mutex.unlock(),e}}))}count(){return t.__awaiter(this,void 0,void 0,(function*(){try{let e=0;return yield this._mutex.lock(),yield this._iterator.each((s=>t.__awaiter(this,void 0,void 0,(function*(){s.error?s.stop():s.hasNext?(e++,s.next()):s.stop()})))),this._mutex.unlock(),e}catch(e){throw this._mutex.unlock(),e}}))}}const we=e=>`nest@${e}`,Ae=(e,t)=>`${we(e)}/${t}`,Ce=(e,t)=>`${Ae(e,t)}.metadata`,xe=(e,t)=>`${Ae(e,t)}/block.`,Re=(e,t)=>`${Ae(e,t)}/blob.`;class Le{constructor({dbname:e,collectionName:t,store:s}){this.dbname=e,this.collectionName=t,this.store=s}get(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this.store.get(e);if(t){const{data:e,type:s}=t;if("undefined"!=typeof fetch){const t=yield fetch(e);return yield t.blob()}{const t=512,i=[],n=atob(e.split(",")[1]);for(let e=0;e<n.length;e+=t){const s=n.slice(e,e+t),a=new Array(s.length);for(let e=0;e<s.length;e++)a[e]=s.charCodeAt(e);i.push(new Uint8Array(a))}return new Blob(i,{type:s})}}return null}))}save(e,s=`${Date.now()}`){return t.__awaiter(this,void 0,void 0,(function*(){const{blobId:t,data:i,type:n}=yield new Promise((t=>{const i=((e,t,s,i=0)=>`${Re(e,t)}${s}.${i}`)(this.dbname,this.collectionName,s),n=new FileReader;n.onload=()=>{t({blobId:i,data:n.result,type:e.type})},n.readAsDataURL(e)}));return yield this.store.set({key:t,value:{data:i,type:n}}),t}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){yield this.store.remove(e)}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){const e=Re(this.dbname,this.collectionName),s=yield this.store.getAllKeys();yield Promise.all(s.filter((t=>t.startsWith(e))).map((e=>t.__awaiter(this,void 0,void 0,(function*(){return yield this.store.remove(e)})))))}))}}var ke,Pe,De;!function(e){e[e.COMMIT=0]="COMMIT",e[e.WRITE=1]="WRITE",e[e.ERROR=2]="ERROR"}(ke||(ke={})),function(e){e.PENDING="pending",e.PERSISTENT="persistent",e.VOLATILE="volatile"}(Pe||(Pe={})),function(e){e[e.NO_CACHE=0]="NO_CACHE",e[e.DEFAULT=1]="DEFAULT",e[e.PERSISTENT=2]="PERSISTENT"}(De||(De={}));const Ue=[Pe.PENDING,Pe.VOLATILE],Fe={};class qe{constructor({dbname:e,limit:t=256}){return Fe[e]||(this.dbname=e,this._items=[],this._limit=t,Fe[e]=this),Fe[e]}static get(e){return Fe[e]}get items(){return this._items}find(e,s,i=De.DEFAULT){return t.__awaiter(this,void 0,void 0,(function*(){let t=this.get(s);if(t)i===De.PERSISTENT&&(t.state=Pe.PERSISTENT);else{const n=yield e.get(s);n&&(t={key:s,value:n,state:i===De.PERSISTENT?Pe.PERSISTENT:Pe.VOLATILE},this.put(t))}return t}))}get(e,t=De.DEFAULT){const s=this._items.map((e=>e.key)).indexOf(e);if(s>-1){const e=this._items[s];return t===De.PERSISTENT&&(e.state=Pe.PERSISTENT),t!==De.NO_CACHE&&this.put(e),e}return null}put(e){if(this._limit>0){const t=this._items.map((e=>e.key)).indexOf(e.key);if(t>-1)Ue.includes(this._items[t].state)&&Ue.includes(e.state)?(this._items.splice(t,1),this._items.push(e)):(this._items[t].state=e.state,this._items[t].value=e.value);else{this._items.push(e);const t=this._items.filter((e=>e.state===Pe.VOLATILE));let s=t.length-this._limit;if(s>0){const e=[];for(const t of this._items)t.state===Pe.VOLATILE&&s>0?s--:e.push(t);this._items=e}}}}remove(e){const t=this._items.map((e=>e.key)).indexOf(e);t>-1&&this._items.splice(t,1)}clearByCondition(e){this._items=this._items.filter((t=>!e(t)))}clear(e=!1){this._items=e?[]:this._items.filter((e=>e.state!==Pe.VOLATILE))}}class Be{constructor({dbname:e,collectionName:t,store:s}){this._requests=[],this._onCommit=new Map,this._onWrite=new Map,this._onError=new Map,this.dbname=e,this.collectionName=t,this.metadataKey=((e,t)=>`${Ae(e,t)}/trans.metadata`)(e,t),this.recordsetKey=((e,t)=>`${Ae(e,t)}/trans.recordset`)(e,t),this._store=s}get generation(){return this._metadata?this._metadata.generation:0}get requestCount(){return this._requests.length}_getReducedRecordset(e=[]){return t.__awaiter(this,void 0,void 0,(function*(){const t=(yield this._store.get(this.recordsetKey))||[];return t.push(...e),this._reduceRecordSet(t)}))}_reduceRecordSet(e){const t=[],s={};for(let i=e.length-1;i>=0;i--){const n=e[i],a=[];for(let e=n.requests.length-1;e>=0;e--){const t=n.requests[e],i=t.data;s[i.key]||(a.unshift(t),s[i.key]=!0)}a.length>0&&(n.requests=a,t.unshift(n))}return t}_applyRecord(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=qe.get(this.dbname),{generation:i,requests:n}=s;let a=null;try{const e=yield this._store.setMany(n.map((e=>Object.assign(Object.assign({},e.data),{generation:i}))));for(let s=0;s<n.length;s++)if(e[s]instanceof Error){a||(a=e[s]);const{data:i}=n[s];t.put(Object.assign(Object.assign({},i),{state:Pe.PERSISTENT}))}}catch(e){a=e}if(a)this._onError.forEach((e=>{a&&e(a)}));else{const t=e.filter((e=>e.generation!==i));yield this._store.set({key:this.recordsetKey,value:t}),this._onWrite.forEach((e=>{e(n.map((e=>e.data)))}))}}))}init(){return t.__awaiter(this,void 0,void 0,(function*(){this._metadata=(yield this._store.get(this.metadataKey))||{generation:1};const e=yield this._getReducedRecordset();for(const t of e)yield this._applyRecord(e,t)}))}on(e,t,s){switch(e){case ke.COMMIT:this._onCommit.set(t,s);break;case ke.WRITE:this._onWrite.set(t,s);break;case ke.ERROR:this._onError.set(t,s)}}requestWrite(e,t){this._requests.push({data:e,options:t});qe.get(this.dbname).put(Object.assign({state:Pe.PENDING},e))}requestMultipleWrite(e,t){const s=qe.get(this.dbname);for(const i of e)this._requests.push({data:i,options:t}),s.put(Object.assign({state:Pe.PENDING},i))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){qe.get(this.dbname).clearByCondition((e=>e.state===Pe.PENDING)),this._requests=[]}))}commit(){return t.__awaiter(this,void 0,void 0,(function*(){const e=this._requests;if(e.length>0){const t=[],s={};for(let i=e.length-1;i>=0;i--){const n=e[i],a=n.data;s[a.key]||(s[a.key]=!0,t.unshift(n))}const i={generation:this.generation,requests:t},n=yield this._getReducedRecordset([i]);yield this._store.set({key:this.recordsetKey,value:n}),this._metadata.generation++,yield this._store.set({key:this.metadataKey,value:this._metadata});const a=qe.get(this.dbname);for(let e=0;e<t.length;e++){const{data:s,options:i}=t[e];a.put(Object.assign(Object.assign({},s),{state:i&&i.persistent?Pe.PERSISTENT:Pe.VOLATILE}))}this._requests=[],this._onCommit.forEach((t=>{t(e.map((e=>e.data)))}));const r=ce.get(this.dbname);setTimeout((()=>{try{this._applyRecord(n,i)}catch(e){this._onError.forEach((t=>t(e)))}}),r.transactionApplyDelay)}}))}}class ze{constructor({blockId:e,keyName:t,items:s=[],limit:i}){this.blockId=e,this.keyName=t,this.limit=i,this._items=[...s]}static createFromCacheItem(e){return e?new ze(e.value):null}get isEmpty(){return 0===this._items.length}get items(){return this._items}serialize(){return{blockId:this.blockId,keyName:this.keyName,limit:this.limit,items:this._items}}getItemByKey(e){const t=this._items.find((t=>{const s=t[this.keyName];return e===s}));return null!=t?t:null}has(e){return this._items.map((e=>e[this.keyName])).includes(e)}add(e){const t=this._items.map((e=>e[this.keyName])).indexOf(e[this.keyName]);return t<0?this._items.length<this.limit&&(this._items.push(e),!0):(this._items[t]=e,!0)}remove(e){for(const t in this._items)if(this._items[t][this.keyName]===e)return this._items.splice(parseInt(t),1),!0;return!1}clear(){this._items=[]}}class je{constructor({dbname:e,collectionName:t,metadata:s,hashFunction:i=ge,transaction:n,store:a}){this.dbname=e,this.collectionName=t,this.hashFunction=i,this.metadata=s,this._transaction=n,this._store=a}get keyName(){return this.metadata.keyName}createBlockId(e,t=this.metadata.blockLevel){return s=this.dbname,i=this.collectionName,n=t,a=`${((e,t,s)=>{const i=s.base*Math.pow(s.multiplier,t)+s.constant;return(s.hashFunction||ge)(e,i)})(e,t,{hashFunction:this.hashFunction,base:this.metadata.blockHashBase,multiplier:this.metadata.blockHashMultiplier,constant:this.metadata.blockHashConstant})}`,`${xe(s,i)}${n}.${a}`;var s,i,n,a}_findBlock(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=qe.get(this.dbname);for(let s=this.metadata.blockLevel;s>0;s--){const i=this.createBlockId(e,s),n=yield t.find(this._store,i);if(n){const t=ze.createFromCacheItem(n);if(null==t?void 0:t.getItemByKey(e))return t}}return null}))}getFromBlock(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return t?t.getItemByKey(e):null}))}putToBlock(e,s){return t.__awaiter(this,void 0,void 0,(function*(){const t=ce.get(this.dbname),i=this.createBlockId(e),n=Math.floor(this._store.itemSizeLimit/t.itemSizeLimit),a=qe.get(this.dbname),r=yield a.find(this._store,i),o=r?ze.createFromCacheItem(r):new ze({blockId:i,keyName:this.keyName,items:[],limit:n});return!!(null==o?void 0:o.add(s))&&(this._transaction.requestWrite({key:o.blockId,value:o.serialize()}),!0)}))}removeFromBlock(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return!(!t||!t.remove(e))&&(this._transaction.requestWrite({key:t.blockId,value:t.serialize()}),!0)}))}clearAllBlocks(){return t.__awaiter(this,void 0,void 0,(function*(){const e=xe(this.dbname,this.collectionName),t=(yield this._store.getAllKeys()).filter((t=>t.startsWith(e)));yield this._store.removeMany(t),yield this._transaction.clear();qe.get(this.dbname).clearByCondition((t=>t.key.startsWith(e)))}))}}const Ke=e=>{const t=typeof e;return null===e||"undefined"===t||"boolean"===t||"number"===t||"string"===t},Ge={};class Ve{constructor({dbname:e,collectionName:t,keyName:s,fields:i,transaction:n,store:a}){this._origin=[],this._table=[];const r=((e,t,s)=>`${Ae(e,t)}/index.${s}`)(e,t,i.join(">"));return Ge[r]||(this.dbname=e,this.collectionName=t,this.keyName=s,this.fields=i,this.indexerKey=r,this._transaction=n,this._store=a,this._transaction.on(ke.COMMIT,this.indexerKey,(()=>this.commit())),this._transaction.on(ke.ERROR,this.indexerKey,(()=>this.abort()))),Ge[r]}static createKey(e){return e.join(">")}static parseKey(e){return e.split(">")}static clearIndexerMap(){for(const e in Ge)delete Ge[e]}_addItem(e){const t=e[this.keyName],s=this.getColumnValues(e),[i,n]=this.indexOf(s);return n?!this._table[i].keys.includes(t)&&(this._table[i].keys.push(t),!0):(this._table.splice(i,0,{columnValues:s,keys:[t]}),!0)}_removeItem(e){const t=e[this.keyName],s=this.getColumnValues(e),[i,n]=this.indexOf(s);if(n){const e=this._table[i].keys.indexOf(t);if(e>-1)return this._table[i].keys.splice(e,1),0===this._table[i].keys.length&&this._table.splice(i,1),!0}return!1}get origin(){return this._origin}get table(){return this._table}getColumnValues(e){const t=[];for(let s of this.fields){if("-"===s[0]&&(s=s.slice(1)),!Ke(e[s]))throw pe.indexTypesNotMatch;t.push(e[s])}return t}diff(e,t){for(const s in this.fields){const i="-"===this.fields[s][0]?-1:1,n=ye(e[s],t[s]);if(0!==n)return i*n}return 0}indexOf(e){if(this._table.length>0){let t=0,s=this._table.length-1;for(;t<=s;){const i=Math.floor((t+s)/2),n=this.diff(e,this._table[i].columnValues);if(n>0)t=i+1;else{if(!(n<0))return[i,!0];s=i-1}}return[t,!1]}return[0,!1]}ensure(){return t.__awaiter(this,void 0,void 0,(function*(){const e=qe.get(this.dbname),t=yield e.find(this._store,this.indexerKey,De.PERSISTENT);if(t)this._origin=t.value,this._table=me(this._origin);else{const t=xe(this.dbname,this.collectionName),s=yield this._store.getAllKeys();for(const i of s)if(i.startsWith(t)){const t=yield e.find(this._store,i,De.NO_CACHE),s=ze.createFromCacheItem(t);if(s)for(const e of s.items)this._addItem(e)}this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}Ge[this.indexerKey]=this}))}drop(){return t.__awaiter(this,void 0,void 0,(function*(){qe.get(this.dbname).remove(this.indexerKey),yield this._store.remove(this.indexerKey),delete Ge[this.indexerKey]}))}addItem(e){return t.__awaiter(this,void 0,void 0,(function*(){this._addItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}removeItem(e){return t.__awaiter(this,void 0,void 0,(function*(){this._removeItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this._table=[],this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}commit(){this._origin=this._table,this._table=me(this._origin)}abort(){this._table=me(this._origin)}}const He=()=>"undefined"!=typeof document&&"undefined"!=typeof navigator&&"ReactNative"!==navigator.product,$e=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?s:3&s|8).toString(16)}))};var Qe,We;!function(e){e[e.PROCESSING=0]="PROCESSING",e[e.DONE=1]="DONE"}(Qe||(Qe={})),function(e){e.NEWNODE="newnode",e.REMOVENODE="removenode",e.CLAIM_HOST="claimhost",e.SYNC_HOST="synchost",e.REQUEST_LOCK="requestlock",e.ACQUIRE_LOCK="acquirelock",e.RELEASE_LOCK="releaselock"}(We||(We={}));const Ye={};class Je{constructor(e,t={}){return this._state=Qe.PROCESSING,this._queue=[],this._activationQueue=[],Ye[e]&&!t.forceCreate||(this.nodeId=$e(),this.key=e,He()&&(t.startAsInvisible?this.registerNode():"visible"===document.visibilityState?this.claimHost():this.registerNode(),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.claimHost()})),window.addEventListener("message",(e=>{const t=e.data,{nodeId:s,requestId:i,key:n,op:a,data:r}=t;if(s!==this.nodeId&&n===this.key)switch(a){case We.NEWNODE:this._sendSync();break;case We.CLAIM_HOST:this._sendSync(),this._hostId=s;break;case We.SYNC_HOST:if(!this.isInSync){this._activationTimeout&&clearTimeout(this._activationTimeout);const{currentItemRequestId:e,queue:t}=r;for(const e of t){this._queue.findIndex((t=>t.requestId===e.requestId))<0&&this._requestLock({nodeId:e.nodeId,requestId:e.requestId,key:this.key,op:We.REQUEST_LOCK,ts:e.ts})}this._currentItem=this._queue.find((t=>t.requestId===e)),this._completeSync()}break;case We.REMOVENODE:this._queue=this._queue.filter((e=>e.nodeId!==t.nodeId)),this._currentItem&&this._currentItem.nodeId===t.nodeId&&(this._currentItem=void 0,this._acquire(this._queue[0]));break;case We.REQUEST_LOCK:this._requestLock(t);break;case We.ACQUIRE_LOCK:{const e=this._queue.find((e=>e.requestId===i));this._acquire(e);break}case We.RELEASE_LOCK:this._release(i)}})),window.addEventListener("beforeunload",(()=>{this._send(We.REMOVENODE)}))),Ye[e]=this),Ye[e]}get locked(){return!!this._currentItem}get isHost(){return this._hostId===this.nodeId}get isInSync(){return this._state==Qe.DONE}_send(e,t={}){var s;const i={nodeId:this.nodeId,requestId:null!==(s=null==t?void 0:t.requestId)&&void 0!==s?s:$e(),key:this.key,op:e,data:t.data,ts:Date.now()};return He()&&window.postMessage(i,"*"),i}_acquire(e){e?(this._currentItem=e,this._currentItem.onAcquired&&this._currentItem.onAcquired(e.requestId)):this._currentItem=void 0}_release(e){if(this._currentItem&&this._currentItem.requestId===e){const t=this._currentItem;this._currentItem=void 0,t.nodeId===this.nodeId&&this._send(We.RELEASE_LOCK,{requestId:t.requestId});const s=this._queue.findIndex((t=>t.requestId===e));s>-1&&this._queue.splice(s,1),t.onReleased&&t.onReleased(e)}}_requestLock(e){return new Promise((t=>{const s={nodeId:e.nodeId,requestId:e.requestId,ts:e.ts,onAcquired:e=>{this.isHost&&this._send(We.ACQUIRE_LOCK,{requestId:e}),t()},onReleased:()=>{this._acquire(this._queue[0])}};let i=!1;for(const e in this._queue)if(this._queue[e].ts>s.ts){this._queue.splice(parseInt(e),0,s),i=!0;break}i||this._queue.push(s),this._currentItem||this._acquire(this._queue[0])}))}_sendSync(){var e;this.isHost&&this._send(We.SYNC_HOST,{data:{currentItemRequestId:null===(e=this._currentItem)||void 0===e?void 0:e.requestId,queue:this._queue.map((e=>({nodeId:e.nodeId,requestId:e.requestId,ts:e.ts})))}})}_waitUntilSyncCompleted(){return t.__awaiter(this,void 0,void 0,(function*(){if(this.isHost&&!this.isInSync)return new Promise((e=>{this._activationQueue.push(e)}))}))}_waitSync(){this.isInSync||(this._activationTimeout=setTimeout((()=>{this._completeSync()}),8))}_completeSync(){this.isInSync||(this._state=Qe.DONE,this._activationQueue.forEach((e=>e())),this._activationQueue=[])}registerNode(){this._send(We.NEWNODE),this._waitSync()}claimHost(){this._hostId=this.nodeId,this._send(We.CLAIM_HOST),this._waitSync()}lock(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._waitUntilSyncCompleted();const e=this._send(We.REQUEST_LOCK);yield this._requestLock(e)}))}unlock(){var e;(null===(e=this._currentItem)||void 0===e?void 0:e.requestId)&&this._release(this._currentItem.requestId)}}class Xe{constructor({dbname:e,collectionName:t,keyName:s,keyHash:i,indexes:n,store:a}){this._state=_e.INIT,this._indexers=[],this.dbname=e,this.name=t,this.keyName=s,this.indexes=[[s],...n.filter((e=>Ve.createKey(e)!==this.keyName))],this._keyHash=i,this._store=a,this._mutex=new Je(((e,t)=>`${Ae(e,t)}.lock`)(e,t)),this._blobContainer=new Le({dbname:e,collectionName:t,store:a}),this._transaction=new Be({dbname:e,collectionName:t,store:a})}static metadataOf(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){const t=Ce(e,s);return yield i.get(t)}))}get state(){return this._state}get isReady(){return this._state===_e.READY}init(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._mutex.lock();try{const e=ce.get(this.dbname),t=yield Xe.metadataOf(this.dbname,this.name,this._store);this._metadata=t||{keyName:this.keyName,blockLevel:1,blockHashBase:e.blockHashBase,blockHashMultiplier:e.blockHashMultiplier,blockHashConstant:e.blockHashConstant,indexes:this.indexes},yield this._transaction.init(),this._blockManager=new je({dbname:this.dbname,collectionName:this.name,hashFunction:this._keyHash,metadata:this._metadata,transaction:this._transaction,store:this._store});const s=[...this.indexes],i=[],n=s.map((e=>Ve.createKey(e))),a=t?t.indexes.map((e=>Ve.createKey(e))):[];for(const e of a)n.includes(e)||i.push(Ve.parseKey(e));const r=[];if(r.push(...s.map((e=>{const t=new Ve({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:e,transaction:this._transaction,store:this._store});return this._indexers.push(t),t.ensure()}))),r.push(...i.map((e=>new Ve({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:e,transaction:this._transaction,store:this._store}).drop()))),yield Promise.all(r),yield this._transaction.commit(),n.sort().join(",")!==a.sort().join(",")){const e=Ce(this.dbname,this.name);this._metadata.indexes=s,yield this._store.set({key:e,value:this._metadata})}this._state=_e.READY,this._mutex.unlock()}catch(e){throw this._mutex.unlock(),e}}))}close(){this._state=_e.CLOSED}_hasPropertyOfKeyName(e){const t=e[this.keyName];return"string"==typeof t&&!!t}_getIndexerBy(e=null){e||(e=[this.keyName]);const t=Ve.createKey(e);for(const e of this._indexers)if(t===Ve.createKey(e.fields))return e;throw pe.indexTableIsRequired}_upgradeBlockLevel(){return t.__awaiter(this,void 0,void 0,(function*(){const e=Ce(this.dbname,this.name);this._metadata.blockLevel++,yield this._store.set({key:e,value:this._metadata})}))}_requestInsert(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName];if(yield this._blockManager.getFromBlock(t))throw pe.collectionInsertDuplicate;(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}))}_requestUpsert(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName],s=yield this._blockManager.getFromBlock(t);if(s){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(s),t.getColumnValues(e))&&(yield t.removeItem(s),yield t.addItem(e))}else{(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}}))}_requestUpdate(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e[this.keyName],s=yield this._blockManager.getFromBlock(t);if(s){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(s),t.getColumnValues(e))&&(yield t.removeItem(s),yield t.addItem(e))}}))}_requestRemove(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._blockManager.getFromBlock(e);if(t){yield this._blockManager.removeFromBlock(e);for(const e of this._indexers)yield e.removeItem(t)}}))}_requestClear(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._blockManager.clearAllBlocks();for(const e of this._indexers)yield e.clear()}))}getByKey(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{const t=yield this._blockManager.getFromBlock(e);return this._mutex.unlock(),me(t)}catch(e){throw this._mutex.unlock(),e}}))}query(e={}){if(this.isReady)return new Me({condition:e.where,mutex:this._mutex,blockManager:this._blockManager,indexer:this._getIndexerBy(e.index),backward:!!e.backward});throw pe.collectionNotReady}insertOne(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw pe.collectionKeyNotGiven;return yield this._requestInsert(me(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}insertMany(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{if(e.some((e=>!this._hasPropertyOfKeyName(e))))throw pe.collectionKeyNotGiven;for(const t of e)yield this._requestInsert(me(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}upsertOne(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw pe.collectionKeyNotGiven;return yield this._requestUpsert(me(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}upsertMany(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{if(e.some((e=>!this._hasPropertyOfKeyName(e))))throw pe.collectionKeyNotGiven;for(const t of e)yield this._requestUpsert(me(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}update(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw pe.collectionKeyNotGiven;return yield this._requestUpdate(me(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}updateIf(e,s){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw this._transaction.clear(),pe.collectionNotReady;yield this._mutex.lock();try{const{where:i={},index:n=null,backward:a=!1}=e,r=[],o=new Se({condition:i,blockManager:this._blockManager,backward:a,indexer:this._getIndexerBy(n)});yield o.each((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e.error)throw e.stop(),e.error;if(e.hasNext){const t=e.nextValue;if(ve(i,t)&&s.set){if("function"!=typeof s.set)for(const e in s.set)t[e]=s.set[e];else s.set(t);r.push(t)}e.next()}else e.stop()}))));for(const e of r)yield this._requestUpdate(me(e));return yield this._transaction.commit(),this._mutex.unlock(),r}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{yield this._requestRemove(e),yield this._transaction.commit(),this._mutex.unlock()}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}removeIf(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw this._transaction.clear(),pe.collectionNotReady;yield this._mutex.lock();try{const{where:s={},index:i=null,backward:n=!1}=e,a=[],r=new Se({condition:s,blockManager:this._blockManager,backward:n,indexer:this._getIndexerBy(i)});yield r.each((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e.error)throw e.stop(),e.error;if(e.hasNext){const t=e.nextValue;if(ve(s,t)){const e=t[this.keyName];a.push(e)}e.next()}else e.stop()}))));for(const e of a)yield this._requestRemove(e);return yield this._transaction.commit(),this._mutex.unlock(),a}catch(e){throw this._mutex.unlock(),e}}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.isReady)throw pe.collectionNotReady;yield this._mutex.lock();try{yield this._requestClear(),yield this._transaction.commit(),this._mutex.unlock()}catch(e){throw yield this._transaction.clear(),this._mutex.unlock(),e}}))}getBlob(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield this._blobContainer.get(e)}))}saveBlob(e,s){return t.__awaiter(this,void 0,void 0,(function*(){return yield this._blobContainer.save(e,s)}))}removeBlob(e){return t.__awaiter(this,void 0,void 0,(function*(){yield this._blobContainer.remove(e)}))}removeAllBlobs(){return t.__awaiter(this,void 0,void 0,(function*(){yield this._blobContainer.clear()}))}}const Ze="[NESTDB]";let et=!0;class tt{static off(){et=!1}static log(...e){et&&console.log(`${Ze}[LOG]`,...e)}static warning(...e){et&&console.warn(`${Ze}[WARNING]`,...e)}static error(...e){et&&console.error(`${Ze}[ERROR]`,...e)}}const st=[{},{a:700400,n:"error"}];class it{constructor(e){var s,i,n;this.encryption=null!==(s=e.encryption)&&void 0!==s?s:t.DEFAULT_ENCRYPTION,this.itemSizeLimit=null!==(i=e.itemSizeLimit)&&void 0!==i?i:4194304,this.metadataBuffer=null!==(n=e.metadataBuffer)&&void 0!==n?n:256}get _encryptionCheckKey(){return`${this.dbname}.encrypt`}get _reservedKeys(){return[this._encryptionCheckKey]}_getRawKey(e,t=""){return`${e}${t}`}_generateShardPostfixArray(e=1){return[...Array(e).keys()]}_shardify(e){const{key:t,value:s}=e,i=JSON.stringify(this.encryption.encrypt(s)),n=Math.ceil(i.length/this.adjustedItemSizeLimit);return this._generateShardPostfixArray(n).map((e=>{const s={key:this._getRawKey(t,`.${e}`),data:i.substring(e*this.adjustedItemSizeLimit,(e+1)*this.adjustedItemSizeLimit)};return 0===e&&(s.metadata={shards:n}),s}))}_resetIfEncryptionChanged(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield this.get(this._encryptionCheckKey),t={encrypted:st.map((e=>{var t;return null===(t=this.encryption)||void 0===t?void 0:t.encrypt(e)}))};if(e&&e.encrypted&&Array.isArray(e.encrypted))for(const s in e.encrypted){if(JSON.stringify(e.encrypted[s])!==JSON.stringify(t.encrypted[s])){tt.warning("Encryption algorithm has changed. Stored data would be cleared."),yield this.clear();break}}yield this.set({key:this._encryptionCheckKey,value:t})}))}get adjustedItemSizeLimit(){return Math.max(this.itemSizeLimit-this.metadataBuffer,4)}usage(){return t.__awaiter(this,void 0,void 0,(function*(){let e=0;const t=yield this._getAllRawKeys();for(const s of t){const t=yield this._getRaw(s);t&&(e+=JSON.stringify(t).length)}return e}))}getAllKeys(){return t.__awaiter(this,void 0,void 0,(function*(){return(yield this._getAllRawKeys()).filter((e=>e.endsWith(".0"))).map((e=>e.replace(/\.0$/,""))).filter((e=>!this._reservedKeys.includes(e)))}))}get(e){return t.__awaiter(this,void 0,void 0,(function*(){const s=this._getRawKey(e,".0"),i=yield this._getRaw(s);if(i)try{const{data:s,metadata:n}=i,a=(null==n?void 0:n.shards)&&n.shards>1?yield Promise.all(this._generateShardPostfixArray(null==n?void 0:n.shards).map((i=>t.__awaiter(this,void 0,void 0,(function*(){if(i>0){const t=this._getRawKey(e,`.${i}`),s=yield this._getRaw(t);if(!s)throw pe.storeBrokenIntegrity;return s.data}return s}))))):[s];return this.encryption.decrypt(JSON.parse(a.join("")))}catch(e){return null}return null}))}set(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=this._shardify(e);return yield this._setRaw(t),Object.assign({},e.value)}))}setMany(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield this._setRaw([].concat(...e.map((e=>this._shardify(e))))),e.map((e=>e.value))}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=this._getRawKey(e,".0"),s=yield this._getRaw(t);if(s){const{metadata:t}=s;return yield this._removeRaw(this._generateShardPostfixArray(null==t?void 0:t.shards).map((t=>this._getRawKey(e,`.${t}`)))),!0}return!1}))}removeMany(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=[];for(const s of e){const e=this._getRawKey(s,".0"),i=yield this._getRaw(e);if(i){const{metadata:e}=i;t.push(...this._generateShardPostfixArray(null==e?void 0:e.shards).map((e=>this._getRawKey(s,`.${e}`))))}}return t.length>0&&(yield this._removeRaw(t)),e}))}}const nt=1,at={};class rt extends it{constructor(e={}){var t;super(Object.assign(Object.assign({},e),{itemSizeLimit:null!==(t=e.itemSizeLimit)&&void 0!==t?t:4194304}));const{delay:s=nt}=e;this.delay=s,this.observer={}}get rawData(){return at[this.dbname]}set rawData(e){at[this.dbname]=e}_getAllRawKeys(){return t.__awaiter(this,void 0,void 0,(function*(){if(at[this.dbname])return Object.keys(at[this.dbname]);throw pe.storeNotAvailable}))}_getRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){if(at[this.dbname])return yield fe(this.delay),at[this.dbname][e]?Object.assign({key:e},at[this.dbname][e]):null;throw pe.storeNotAvailable}))}_setRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!at[this.dbname])throw pe.storeNotAvailable;yield fe(this.delay);for(const t of e){const{key:e,data:s,metadata:i}=t;at[this.dbname][e]=Object.freeze({data:s,metadata:i})}}))}_removeRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!at[this.dbname])throw pe.storeNotAvailable;yield fe(this.delay);for(const t of e)at[this.dbname][t]&&delete at[this.dbname][t]}))}observe(e,t,s){this.observer[e]||(this.observer[e]={}),t.forEach((t=>this.observer[e][t]=s))}checkAvailability(){return t.__awaiter(this,void 0,void 0,(function*(){}))}init(e){return t.__awaiter(this,void 0,void 0,(function*(){this.dbname=e,at[this.dbname]||(at[this.dbname]={}),yield this._resetIfEncryptionChanged()}))}set(e){const s=Object.create(null,{set:{get:()=>super.set}});return t.__awaiter(this,void 0,void 0,(function*(){const t=this.observer[e.key];if(t&&"function"==typeof t.set){const e=t.set();if(e)throw e}return s.set.call(this,e)}))}setMany(e){const s=Object.create(null,{setMany:{get:()=>super.setMany}});return t.__awaiter(this,void 0,void 0,(function*(){for(const t of e){const e=this.observer[t.key];if(e&&"function"==typeof e.set){const t=e.set();if(t)throw t}}return s.setMany.call(this,e)}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){yield fe(this.delay),at[this.dbname]={}}))}}const ot="NestDBStore";var lt;!function(e){e[e.UNINITIALIZED=0]="UNINITIALIZED",e[e.OPENING=1]="OPENING",e[e.OPEN=2]="OPEN",e[e.CLOSED=3]="CLOSED"}(lt||(lt={}));var dt,ut;exports.NestDBState=void 0,(dt=exports.NestDBState||(exports.NestDBState={})).INIT="INIT",dt.OPENING="OPENING",dt.OPENED="OPENED",dt.CLOSED="CLOSED";class ct{constructor(){this.messageTypeFilter=t.MessageTypeFilter.ALL,this.customTypesFilter=null,this.senderUserIdsFilter=null,this.replyType=t.ReplyType.NONE}clone(){const e=new ct,t=JSON.parse(JSON.stringify(this));return Object.keys(t).forEach((s=>{e[s]=t[s]})),e}match(e){switch(this.messageTypeFilter){case t.MessageTypeFilter.USER:if(e.messageType!==t.MessageType.USER)return!1;break;case t.MessageTypeFilter.FILE:if(e.messageType!==t.MessageType.FILE)return!1;break;case t.MessageTypeFilter.ADMIN:if(e.messageType!==t.MessageType.ADMIN)return!1}if(this.customTypesFilter&&this.customTypesFilter.length>0&&!this.customTypesFilter.includes(e.customType))return!1;if(this.senderUserIdsFilter&&this.senderUserIdsFilter.length>0){if(!(e instanceof m))return!1;if(!this.senderUserIdsFilter.includes(e.sender.userId))return!1}switch(this.replyType){case t.ReplyType.NONE:if(e.parentMessageId>0)return!1;break;case t.ReplyType.ONLY_REPLY_TO_CHANNEL:if(e instanceof m&&e.parentMessageId>0&&!e.replyToChannel)return!1}return!0}}exports.MessageListOrder=void 0,(ut=exports.MessageListOrder||(exports.MessageListOrder={})).CHANNEL_LATEST="channel_latest",ut.NEWEST_CHILD_MESSAGE="newest_child_message";const ht=e=>{switch(e){case exports.MessageListOrder.CHANNEL_LATEST:return["channelUrl","-createdAt","-messageId"];case exports.MessageListOrder.NEWEST_CHILD_MESSAGE:return["channelUrl","-parentMessageId","-createdAt","-messageId"]}},_t=Object.assign(Object.assign({},Q),{scheduledAt:void 0}),pt=Object.assign(Object.assign({},V),{scheduledAt:0,file:void 0,fileUrl:void 0,fileName:void 0,mimeType:void 0,fileSize:void 0,thumbnailSizes:void 0,requireAuth:!1}),mt="UnsentMessage",yt={};class gt extends t.InstancedObject{get _cacheContext(){return t.Vault.of(this._iid).cacheContext}constructor(e){super(e),this._mutex=new Je("unsendmessagecache.lock"),yt[e]=this}static of(e,t=!1){return yt[e]&&!t||(yt[e]=new gt(e)),yt[e]}get collection(){const{nestdb:e}=this._cacheContext,s=null==e?void 0:e.collection(mt);if(!s)throw t.SendbirdError.databaseError;return s}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){if(e.messageId>0)throw t.SendbirdError.invalidParameters;const s=Object.assign({},e.serialize());var i;return e instanceof E?(e.messageParams&&(s.messageParams=$(e.messageParams)),e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams&&(s.scheduledInfo.scheduledMessageParams=(i=e.scheduledInfo.scheduledMessageParams,Object.assign(Object.assign({},$(i)),{scheduledAt:i.scheduledAt})))):e instanceof N?(e.messageParams&&(s.messageParams=Z(e.messageParams)),e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams&&(s.scheduledInfo.scheduledMessageParams=(e=>Object.assign(Object.assign({},Z(e)),{scheduledAt:e.scheduledAt}))(e.scheduledInfo.scheduledMessageParams))):e instanceof b&&e.messageParams&&(s.messageParams=(e=>t.deundefined({fileInfoList:e.fileInfoList,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption}))(e.messageParams)),s}_deserialize(e){e=Object.assign(Object.assign({},e),{messageId:parseInt(e.messageId)});return bt.of(this._iid).buildMessageFromSerializedData(e)}_deserializeWithMessageCreateParams(e){var s,i,n;return t.__awaiter(this,void 0,void 0,(function*(){const a=bt.of(this._iid),r=this._deserialize(e);if(e.messageParams)if(r instanceof E){const t=e.messageParams;r.messageParams=a.buildUserMessageCreateParamsFromSerializedData(t,r)}else if(r instanceof N){const t=e.messageParams;t.fileKey&&"string"==typeof t.fileKey&&X(null!==(s=t.fileType)&&void 0!==s?s:"")&&(t.file=null!==(i=yield this.collection.getBlob(t.fileKey))&&void 0!==i?i:void 0),r.messageParams=a.buildFileMessageCreateParamsFromSerializedData(t,r)}else if(r instanceof b){const s=e.messageParams;s&&s.fileInfoList&&(r.messageParams=a.buildMultipleFilesMessageCreateParamsFromSerializedData(s,r),yield Promise.all(r.messageParams.fileInfoList.map((e=>t.__awaiter(this,void 0,void 0,(function*(){var t,s,i,n;"string"==typeof(null===(t=e._uploadedMetaData)||void 0===t?void 0:t.fileKey)&&X(null!==(i=null===(s=e._uploadedMetaData)||void 0===s?void 0:s.fileType)&&void 0!==i?i:"")&&(e.file=null!==(n=yield this.collection.getBlob(e._uploadedMetaData.fileKey))&&void 0!==n?n:void 0)}))))))}if(r.scheduledInfo&&e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams)if(r instanceof E){const t=e.scheduledInfo.scheduledMessageParams;r.scheduledInfo.scheduledMessageParams=a.buildScheduledUserMessageCreateParamsFromSerializedData(t,r)}else if(r instanceof N){const t=e.scheduledInfo.scheduledMessageParams;t.fileKey&&"string"==typeof t.fileKey&&"string"==typeof t.fileType&&X(t.fileType)&&(t.file=null!==(n=yield this.collection.getBlob(t.fileKey))&&void 0!==n?n:void 0),r.scheduledInfo.scheduledMessageParams=a.buildScheduledFileMessageCreateParamsFromSerializedData(t,r)}return r}))}_getFileInfoBlobKey(e,t){return`${e}.${t}`}get(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(`${e}`);if(t)return this._deserializeWithMessageCreateParams(t)}}))}fetch({channelUrl:e,filter:s=new ct,order:i=exports.MessageListOrder.CHANNEL_LATEST,sendingStatus:n,backward:a=!1,parentMessageId:r}){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const o=ht(i),l={"/where":e=>!!(i!==exports.MessageListOrder.NEWEST_CHILD_MESSAGE||r&&0!==e.parentMessageId&&e.parentMessageId===r)&&s.match(this._deserialize(e))};e&&(l.channelUrl=e),n&&(l.sendingStatus=n);const d={where:l,index:o,backward:a},u=yield this.collection.query(d),c=yield u.fetch({});return Promise.all(c.map((e=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._deserializeWithMessageCreateParams(e)})))))}return[]}))}getAllChildMessages(e,s=new ct){return t.__awaiter(this,void 0,void 0,(function*(){return yield this.fetch({filter:s,order:exports.MessageListOrder.NEWEST_CHILD_MESSAGE,channelUrl:e.channelUrl,backward:!1,parentMessageId:e.messageId})}))}upsert(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){(e instanceof N||e instanceof b)&&(yield this._mutex.lock(),yield this.saveBlob(e),yield this._mutex.unlock());const t=this._serialize(e);yield this.collection.upsertOne(t)}))))))}))}upsertChildMessages(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){let t=[];e.threadInfo&&e.threadInfo.replyCount>0&&(t=yield this.getAllChildMessages(e)),t.length>0&&(t.forEach((t=>t.applyParentMessage(e))),yield this.upsert(t))}))))))}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(t)}))}removeMessagesOfChannel(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e}}))}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}saveBlob(e){return t.__awaiter(this,void 0,void 0,(function*(){if(e instanceof N){if(e.messageParams){const t=e.messageParams;if(t.file&&J(t.file)){const s=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=s,t.fileType=Y.BLOB}}if(e.scheduledInfo&&e.scheduledInfo.scheduledMessageParams){const t=e.scheduledInfo.scheduledMessageParams;if(t.file&&J(t.file)){const s=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=s,t.fileType=Y.BLOB}}}else if(e instanceof b){const s=e.messageParams;s&&s.fileInfoList&&Array.isArray(s.fileInfoList)&&(yield Promise.all(s.fileInfoList.map(((s,i)=>t.__awaiter(this,void 0,void 0,(function*(){if(s.file&&J(s.file)){const t=yield this.collection.saveBlob(s.file,this._getFileInfoBlobKey(e.reqId,i));s._uploadedMetaData||(s._uploadedMetaData={}),s._uploadedMetaData.fileKey=t,s._uploadedMetaData.fileType=Y.BLOB}}))))))}}))}}const ft={};class vt extends t.InstancedObject{get _sdkState(){return t.Vault.of(this._iid).sdkState}get _cacheContext(){return t.Vault.of(this._iid).cacheContext}get _unsentMessageCache(){return gt.of(this._iid)}constructor(e){super(e),ft[e]=this}static of(e,t=!1){return ft[e]&&!t||(ft[e]=new vt(e)),ft[e]}get collection(){const{nestdb:e}=this._cacheContext;return t.unless(!!e).throw(t.SendbirdError.databaseError),e.collection(oe)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e){return Object.assign(Object.assign({},e.serialize()),{messageId:`${e.messageId}`})}_deserialize(e){e=Object.assign(Object.assign({},e),{messageId:parseInt(e.messageId)});return bt.of(this._iid).buildMessageFromSerializedData(e)}get(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=yield this.collection.getByKey(`${e}`);if(t)return this._deserialize(t)}}))}fetch({channelUrl:e,token:s,limit:i=100,filter:n=new ct,order:a=exports.MessageListOrder.CHANNEL_LATEST,backward:r=!1,parentMessageId:o,isPollOnly:l=!1,exactMatch:d=!1,inclusive:u=!0}){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const c=ht(a),h={where:{channelUrl:e,"/where":e=>{if(s)switch(a){case exports.MessageListOrder.CHANNEL_LATEST:if(d&&e.createdAt!==s)return!1;if(r){if(u&&e.createdAt<s||!u&&e.createdAt<=s)return!1}else if(u&&e.createdAt>s||!u&&e.createdAt>=s)return!1;break;case exports.MessageListOrder.NEWEST_CHILD_MESSAGE:if(!o||0===e.parentMessageId||e.parentMessageId!==o)return!1}return!(l&&!e._poll)&&n.match(this._deserialize(e))}},index:c,backward:r},_=yield this.collection.query(h),p=yield _.fetch({limit:null!=i?i:void 0});return Promise.all(p.map((e=>t.__awaiter(this,void 0,void 0,(function*(){return this._deserialize(e)})))))}return[]}))}getAllChildMessages(e,s=new ct){return t.__awaiter(this,void 0,void 0,(function*(){return yield this.fetch({channelUrl:e.channelUrl,token:Date.now(),limit:null,backward:!1,filter:s,order:exports.MessageListOrder.NEWEST_CHILD_MESSAGE,parentMessageId:e.messageId})}))}upsert(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.saveBlobs(e);const t=e.map((e=>this._serialize(e)));yield this.collection.upsertMany(t),yield this.upsertChildMessages(e),yield this._unsentMessageCache.upsertChildMessages(e)}}))}upsertChildMessages(e){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){var t;let s=[];(null===(t=e.threadInfo)||void 0===t?void 0:t.replyCount)&&e.threadInfo.replyCount>0&&(s=yield this.getAllChildMessages(e)),s.length>0&&(s.forEach((t=>t.applyParentMessage(e))),yield this.upsert(s))}))))))}))}remove(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled)for(const t of e)yield this.collection.remove(`${t}`)}))}removeMessagesOfChannel(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){yield this.collection.removeIf({where:{channelUrl:e},index:ht(exports.MessageListOrder.CHANNEL_LATEST)});const{preference:t}=this._cacheContext;yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),yield t.remove(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`)}}))}removeUnderOffset(e,s){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.removeIf({where:{channelUrl:e,createdAt:{"<":s}},index:ht(exports.MessageListOrder.CHANNEL_LATEST)}))}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){this.localCacheEnabled&&(yield this.collection.clear())}))}countBetween(e,s,i){return t.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const t=ht(exports.MessageListOrder.CHANNEL_LATEST),n=this.collection.query({where:{channelUrl:e,"/where":e=>{const t=this._deserialize(e);return i.includes(t.createdAt)&&s.match(t)}},index:t});return yield n.count()}return 0}))}saveBlobs(e){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e instanceof N&&e.messageParams){const t=e.messageParams;if(t.file&&J(t.file)){const s=yield this.collection.saveBlob(t.file,e.reqId);t.fileKey=s}}})))))}))}_getGroupChannelPreferenceSize(e){return t.__awaiter(this,void 0,void 0,(function*(){let t=0;const{preference:s}=this._cacheContext,i=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync`),n=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/sync.meta`),a=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs`),r=yield s.get(`sendbird:${this._sdkState.userId}@groupchannel/${e}/message/changelogs.meta`);return i&&(t+=JSON.stringify(i).length),n&&(t+=JSON.stringify(n).length),a&&(t+=JSON.stringify(a).length),r&&(t+=JSON.stringify(r).length),t}))}}const It={};class Et extends t.InstancedObject{get _cacheContext(){return t.Vault.of(this._iid).cacheContext}get _dispatcher(){return t.Vault.of(this._iid).dispatcher}get _messageCache(){return vt.of(this._iid)}get _unsentMessageCache(){return gt.of(this._iid)}constructor(e){super(e),this._observers=new Map,this._dispatcherContext=this._dispatcher.on((e=>t.__awaiter(this,void 0,void 0,(function*(){if(e instanceof t.MessageUpdateEventCommand){const{messages:s,source:i,isWebSocketEventComing:n}=e,a=s.filter((e=>e.messageId>0)),r=s.filter((e=>0===e.messageId));a.length>0&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._messageCache.upsert(a),yield this._unsentMessageCache.remove(a.map((e=>e instanceof m?e.reqId:null)).filter((e=>null!==e)))})))),n||this._broadcastUpdateEvent(a,i)),r.length>0&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._unsentMessageCache.upsert(r)})))),n||this._broadcastUpdateEvent(r,i))}else if(e instanceof t.MessageRemoveEventCommand){const{messageIds:s,source:i,isWebSocketEventComing:n}=e;yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._messageCache.remove(s)})))),n||this._broadcastRemoveEvent(s,i)}else if(e instanceof t.UnsentMessageRemoveEventCommand){const{reqId:s,source:i}=e;yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){yield this._unsentMessageCache.remove([s])})))),this._broadcastRemoveUnsentEvent(s,i)}else if(e instanceof t.PollChangeLogEventCommand){const{polls:s,source:i}=e;if(this._cacheContext.localCacheEnabled){const e=s.map((e=>e.messageId)),i=(yield Promise.all(e.map((e=>this._messageCache.get(e))))).filter((e=>e));i.length>0&&s.forEach((e=>{const t=i.find((t=>t.messageId===e.messageId));t&&t.applyPoll(e)})),yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.upsert(i)}))))}this._broadcastPollChangeLogEvent(s,i)}else if(e instanceof t.PollUpdateInternalEventCommand){const{event:s,source:i}=e,n=yield this._messageCache.get(s.messageId);n&&n.isUserMessage()&&n.poll&&n.poll.applyPollUpdateEvent(s)&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.upsert([n])}))))),this._broadcastPollUpdateEvent(s,i)}else if(e instanceof t.PollVoteInternalEventCommand){const{event:s,source:i}=e,n=yield this._messageCache.get(s.messageId);n&&n.isUserMessage()&&n.poll&&n.poll.applyPollVoteEvent(s)&&(yield t.runOrNothing((()=>t.__awaiter(this,void 0,void 0,(function*(){return yield this._messageCache.upsert([n])}))))),this._broadcastPollVoteEvent(s,i)}}))))}static of(e,t=!1){var s;return It[e]&&!t||(It[e]&&(null===(s=It[e]._dispatcherContext)||void 0===s||s.close()),It[e]=new Et(e)),It[e]}_broadcastUpdateEvent(e,t){for(const s of this._observers.values())s.onUpdate&&s.onUpdate(e,t)}_broadcastPollChangeLogEvent(e,t){for(const s of this._observers.values())s.onPollChangeLogUpdate&&s.onPollChangeLogUpdate(e,t)}_broadcastPollUpdateEvent(e,t){for(const s of this._observers.values())s.onPollUpdate&&s.onPollUpdate(e,t)}_broadcastPollVoteEvent(e,t){for(const s of this._observers.values())s.onPollVote&&s.onPollVote(e,t)}_broadcastRemoveEvent(e,t){for(const s of this._observers.values())s.onRemove&&s.onRemove(e,t)}_broadcastRemoveUnsentEvent(e,t){for(const s of this._observers.values())s.onRemoveUnsent&&s.onRemoveUnsent(e,t)}subscribe(e,t){this._observers.set(e,t)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}const Tt={};class bt{constructor(e,{sdkState:t,dispatcher:s,requestQueue:i,onlineDetector:n,cacheContext:a}){this._iid=e,this._sdkState=t,this._requestQueue=i,this._dispatcher=s,this._cacheContext=a,vt.of(e),gt.of(e),Et.of(e),this.fileMessageQueue=new R(e,{sdkState:t,dispatcher:s,requestQueue:i,onlineDetector:n,cacheContext:a}),Tt[e]=this}static of(e){return Tt[e]}buildMessageFromSerializedData(e){const s=t.deserialize(e);switch(s.messageType){case t.MessageType.USER:return new E(this._iid,E.payloadify(s));case t.MessageType.FILE:return b._isMultipleFilesMessageSerializedData(s)?new b(this._iid,b.payloadify(s)):new N(this._iid,N.payloadify(s));case t.MessageType.ADMIN:return new v(this._iid,v.payloadify(s))}throw t.SendbirdError.invalidParameters}buildUserMessageCreateParamsFromSerializedData(e,s){return t.deundefined(t.undefineNullProps({data:s.data,customType:s.customType,mentionType:s.mentionType,mentionedUserIds:s.mentionedUserIds,mentionedUsers:s.mentionedUsers,mentionedMessageTemplate:s.mentionedMessageTemplate,metaArrays:s.metaArrays,parentMessageId:s.parentMessageId,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,appleCriticalAlertOptions:s.appleCriticalAlertOptions,reqId:s.reqId,message:s.message,translationTargetLanguages:Object.keys(s.translations),pollId:e.pollId}))}buildFileMessageCreateParamsFromSerializedData(e,s){var i;return t.deundefined(t.undefineNullProps({data:s.data,customType:s.customType,mentionType:s.mentionType,mentionedUserIds:s.mentionedUserIds,mentionedUsers:s.mentionedUsers,mentionedMessageTemplate:s.mentionedMessageTemplate,metaArrays:s.metaArrays,parentMessageId:s.parentMessageId,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,appleCriticalAlertOptions:s.appleCriticalAlertOptions,reqId:s.reqId,file:e.file,fileKey:e.fileKey,fileUrl:s.plainUrl,fileName:s.name,fileSize:s.size,mimeType:s.type,thumbnailSizes:null===(i=s.thumbnails)||void 0===i?void 0:i.map((e=>({maxWidth:e.width,maxHeight:e.height}))),fileType:e.fileType,requireAuth:s.requireAuth}))}buildMultipleFilesMessageCreateParamsFromSerializedData(e,s){return t.deundefined({data:s.data,customType:s.customType,mentionType:s.mentionType,mentionedUserIds:s.mentionedUserIds,mentionedUsers:s.mentionedUsers,mentionedMessageTemplate:s.mentionedMessageTemplate,metaArrays:s.metaArrays,parentMessageId:s.parentMessageId,isReplyToChannel:e.isReplyToChannel,pushNotificationDeliveryOption:e.pushNotificationDeliveryOption,appleCriticalAlertOptions:s.appleCriticalAlertOptions,reqId:s.reqId,fileInfoList:e.fileInfoList})}buildScheduledUserMessageCreateParamsFromSerializedData(e,t){return Object.assign(Object.assign({},this.buildUserMessageCreateParamsFromSerializedData(e,t)),{scheduledAt:e.scheduledAt})}buildScheduledFileMessageCreateParamsFromSerializedData(e,t){return Object.assign(Object.assign({},this.buildFileMessageCreateParamsFromSerializedData(e,t)),{scheduledAt:e.scheduledAt})}buildSenderFromSerializedData(e){const s=t.deserialize(e);return new u(this._iid,u.payloadify(s))}getMessage(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=new P(e),s=yield this._requestQueue.send(t),{message:i}=s.as(D);return i}))}getScheduledMessage(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=new z(e),s=yield this._requestQueue.send(t),{message:i}=s.as(j);return i}))}getMessagesByMessageId(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE){return t.__awaiter(this,void 0,void 0,(function*(){const r=new U(Object.assign(Object.assign({channelType:s,channelUrl:e,token:String(i)},L),n)),o=yield this._requestQueue.send(r),{messages:l}=o.as(F);return this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:a})),l}))}getMessagesByTimestamp(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE){return t.__awaiter(this,void 0,void 0,(function*(){const r=new U(Object.assign(Object.assign({channelType:s,channelUrl:e,timestamp:i},L),n)),o=yield this._requestQueue.send(r),{messages:l}=o.as(F);return this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:a})),l}))}_getMessagesByTimestampForCollection(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE,r){return t.__awaiter(this,void 0,void 0,(function*(){const o=new U(Object.assign(Object.assign(Object.assign({channelType:s,channelUrl:e,timestamp:i},L),n),{checkingContinuousMessages:r})),l=yield this._requestQueue.send(o),d=l.payload,{messages:u}=l.as(F);return this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:u,source:a})),{messages:u,isContinuousMessages:d}}))}getThreadedMessagesByTimestamp(e,s,i,n=t.CollectionEventSource.REQUEST_THREADED_MESSAGE){return t.__awaiter(this,void 0,void 0,(function*(){const a=new U(Object.assign(Object.assign(Object.assign({channelUrl:e.channelUrl,channelType:e.channelType,timestamp:s},g),i),{replyType:t.ReplyType.ALL,parentMessageId:e.messageId,includeThreadInfo:!0})),r=yield this._requestQueue.send(a),{messages:o}=r.as(F),l=o.slice(1);return l.forEach((t=>{t.parentMessage=e})),this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:n})),{parentMessage:o[0],threadedMessages:l}}))}getMessageChangelogs(e,s,i,n,a=t.CollectionEventSource.REQUEST_MESSAGE_CHANGELOGS){return t.__awaiter(this,void 0,void 0,(function*(){const r=new q(t.deundefined(t.undefineNullProps(Object.assign(Object.assign({channelType:s,channelUrl:e,timestamp:"number"==typeof i?i:null,token:"string"==typeof i?i:null},k),n)))),o=yield this._requestQueue.send(r),{updatedMessages:l,deletedMessagesInfo:d,hasMore:u,nextToken:c}=o.as(B),h=d.map((e=>e.messageId));return l.length>0&&this._dispatcher.dispatch(new t.MessageUpdateEventCommand({messages:l,source:a})),h.length>0&&this._dispatcher.dispatch(new t.MessageRemoveEventCommand({messageIds:h,source:a})),{updatedMessages:l,deletedMessageIds:h,hasMore:u,token:c}}))}}class Ot extends t.InstancedObject{constructor(e,s){super(e),this.targetMessageId=0;const i=s.thread_info,a=s.parent_message_id,r=s.channel_url,o=s.channel_type;i&&t.isTypeOf("object",i)&&t.isTypeOf("number",a)&&t.isTypeOf("string",r)&&t.isTypeOf("string",o)&&(this.threadInfo=new n(e,i),this.targetMessageId=a,this.channelUrl=r,this.channelType=o)}}const Nt={channelUrl:"",channelType:t.ChannelType.BASE,messageId:0,includeReactions:!1,includeMetaArray:!1,includeParentMessageInfo:!1,includeThreadInfo:!1};class St extends t.APIRequestCommand{constructor({channelCustomType:e,keyword:s,limit:i,reverse:n,exactMatch:a,channelUrl:r,order:o,messageTimestampFrom:l,messageTimestampTo:d,advancedQuery:u,targetFields:c,nextToken:h}){super(),this.method=t.APIRequestMethod.GET,this.path=`${t.API_PATH_SEARCH}/messages`,this.params={custom_type:e,query:s,limit:i,reverse:n,exact_match:a,channel_url:r,message_ts_from:l,message_ts_to:d,sort_field:o,advanced_query:u,target_fields:c,after:h}}}class Mt extends t.APIResponseCommand{constructor(e,t){super(e,t),this.messages=t.results.map((t=>O(e,t))),this.hasNext=t.has_next,this.nextToken=t.end_cursor,this.totalCount=t.total_count}}var wt;exports.MessageSearchOrder=void 0,(wt=exports.MessageSearchOrder||(exports.MessageSearchOrder={})).SCORE="score",wt.TIMESTAMP="ts";class At extends t.BaseListQuery{constructor(e,t){var s,i,n,a,r,o,l,d,u;super(e,t),this.keyword="",this.reverse=!1,this.exactMatch=!1,this.channelUrl="",this.channelCustomType="",this.messageTimestampFrom=null,this.messageTimestampTo=null,this.order=exports.MessageSearchOrder.SCORE,this.advancedQuery=!1,this.targetFields=null,this._nextToken="",this.totalCount=-1,this.keyword=t.keyword,this.reverse=null!==(s=t.reverse)&&void 0!==s&&s,this.exactMatch=null!==(i=t.exactMatch)&&void 0!==i&&i,this.channelUrl=null!==(n=t.channelUrl)&&void 0!==n?n:"",this.channelCustomType=null!==(a=t.channelCustomType)&&void 0!==a?a:"",this.messageTimestampFrom=null!==(r=t.messageTimestampFrom)&&void 0!==r?r:null,this.messageTimestampTo=null!==(o=t.messageTimestampTo)&&void 0!==o?o:null,this.order=null!==(l=t.order)&&void 0!==l?l:exports.MessageSearchOrder.SCORE,this.advancedQuery=null!==(d=t.advancedQuery)&&void 0!==d&&d,this.targetFields=null!==(u=t.targetFields)&&void 0!==u?u:null}_validate(){return super._validate()&&t.isTypeOf("string",this.keyword)&&this.keyword.length>0&&t.isTypeOf("boolean",this.reverse)&&t.isTypeOf("boolean",this.exactMatch)&&t.isTypeOf("string",this.channelUrl)&&t.isTypeOf("string",this.channelCustomType)&&(t.isTypeOf("number",this.messageTimestampFrom)||null===this.messageTimestampFrom)&&(t.isTypeOf("number",this.messageTimestampTo)||null===this.messageTimestampTo)&&t.isEnumOf(exports.MessageSearchOrder,this.order)&&t.isTypeOf("boolean",this.advancedQuery)&&t.isArrayOf("string",this.targetFields,!0)}next(){return t.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw t.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const{requestQueue:e}=t.Vault.of(this._iid),s=new St(t.undefineNullProps(Object.assign(Object.assign({},this),{nextToken:this._nextToken?this._nextToken:null}))),i=yield e.send(s),{messages:n,hasNext:a,nextToken:r,totalCount:o}=i.as(Mt);return this._nextToken=r,this._hasNext=a,this._isLoading=!1,this.totalCount=o,n}return[]}throw t.SendbirdError.invalidParameters}))}}exports.AdminMessage=v,exports.AppleCriticalAlertOptions=d,exports.BaseMessage=p,exports.BaseMessageUpdateParamsDefault=te,exports.BaseStore=it,exports.DEFAULT_FEED_LIMIT=100,exports.DEFAULT_GROUPCHANNEL_LIMIT=100,exports.DEFAULT_MESSAGE_LIMIT=100,exports.DEFAULT_POLLS_LIMIT=10,exports.DEFAULT_POLL_VOTER_LIST_LIMIT=20,exports.FileMessage=N,exports.FileMessageCreateParamsDefault=ee,exports.FileMessageEventCommand=w,exports.FileMessageUpdateParamsDefault=ne,exports.IndexedDbStore=class extends it{constructor(e={}){var t;super(Object.assign(Object.assign({},e),{itemSizeLimit:null!==(t=e.itemSizeLimit)&&void 0!==t?t:104857600})),this._storeName=ot,this._state=lt.UNINITIALIZED,this._openJobQueue=[],this._window="undefined"!=typeof window?window:void 0,this._indexedDb=this._window?this._window.indexedDB||this._window.mozIndexedDB||this._window.webkitIndexedDB||this._window.msIndexedDB:void 0}get state(){return this._state}_openDatabase(e){return new Promise(((t,s)=>{if(this._indexedDb){this._state=lt.OPENING;const i=this._indexedDb.open(e);i.addEventListener("upgradeneeded",(e=>{e.target.result.createObjectStore(ot,{keyPath:"key"})})),i.addEventListener("success",(s=>{this._state=lt.OPEN,this._database=s.target.result,this._openJobQueue.forEach((e=>e())),this._openJobQueue=[],this._database.onclose=()=>{this._database=void 0,this._state=lt.OPENING,setTimeout((()=>{this._openDatabase(e)}),5)},t(this._database)})),i.addEventListener("error",(e=>{this._state=lt.UNINITIALIZED,s(e.target.error)}))}else s(pe.storeNotAvailable)}))}_getObjectStore(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this._database)return this._database.transaction(this._storeName,e).objectStore(this._storeName);switch(this._state){case lt.UNINITIALIZED:case lt.OPEN:throw pe.storeNotInitialized;case lt.OPENING:case lt.CLOSED:return new Promise((t=>{this._openJobQueue.push((()=>t(this._getObjectStore(e))))}));default:return yield this._getObjectStore(e)}}))}_getAllRawKeys(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getObjectStore("readonly");return yield new Promise(((t,s)=>{const i=e.getAllKeys();i.addEventListener("success",(e=>{t(e.target.result)})),i.addEventListener("error",(e=>s(e.target.error)))}))}))}_getRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readonly");return yield new Promise(((s,i)=>{const n=t.get(e);n.addEventListener("success",(e=>{var t;s(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.result)})),n.addEventListener("error",(e=>i(e.target.error)))}))}))}_setRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readwrite");yield Promise.all(e.map((e=>new Promise(((s,i)=>{const n=t.put(e);n.addEventListener("success",(e=>{s(e.target.result)})),n.addEventListener("error",(()=>{i("Failed to write.")}))})))))}))}_removeRaw(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this._getObjectStore("readwrite");yield Promise.all(e.map((e=>new Promise(((s,i)=>{const n=t.delete(e);n.addEventListener("success",(()=>s(e))),n.addEventListener("error",(e=>i(e.target.error)))})))))}))}_triggerDatabaseClose(){this._database&&this._database.onclose&&this._database.onclose(new Event("dummy"))}checkAvailability(){return t.__awaiter(this,void 0,void 0,(function*(){const e="undefined"!=typeof window?window:null;if(!((null==e?void 0:e.indexedDB)||(null==e?void 0:e.mozIndexedDB)||(null==e?void 0:e.webkitIndexedDB)||(null==e?void 0:e.msIndexedDB)))throw pe.storeNotAvailable;if(this._indexedDb=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB,!this._window||!He())throw pe.storeNotAvailable;if(He()&&navigator.userAgent&&navigator.userAgent.includes("Edge/")){if(!this._window.indexedDB&&(e.PointerEvent||e.MSPointerEvent))throw pe.storeNotAvailableInPrivateBrowsing}else yield new Promise(((e,t)=>{if(this._indexedDb)try{const s=this._indexedDb.open("_testMozilla");s.onerror=()=>t(pe.storeNotAvailableInPrivateBrowsing),s.onsuccess=()=>e()}catch(e){t(pe.storeNotAvailableInPrivateBrowsing)}else t(pe.storeNotAvailable)}))}))}init(e){return t.__awaiter(this,void 0,void 0,(function*(){this.dbname=e,yield this.checkAvailability(),yield this._openDatabase(e),yield this._resetIfEncryptionChanged()}))}clear(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield this._getObjectStore("readwrite");return yield new Promise(((t,s)=>{const i=e.clear();i.addEventListener("success",(()=>t())),i.addEventListener("error",(e=>s(e.target.error)))}))}))}},exports.MemoryStore=rt,exports.MessageBroadcast=Et,exports.MessageCache=vt,exports.MessageChangeLogsParamsDefault=k,exports.MessageFilter=ct,exports.MessageListParamsDefault=L,exports.MessageManager=bt,exports.MessageMetaArray=r,exports.MessageRequestHandler=G,exports.MessageRetrievalParamsDefault=Nt,exports.MessageSearchQuery=At,exports.MultipleFilesMessage=b,exports.MultipleFilesMessageCreateParamsDefault=le,exports.MultipleFilesMessageRequestHandler=class extends G{constructor(){super(...arguments),this._onFileUploaded=t.noop}_triggerOnFileUploaded(e,t,s,i){this._onFileUploaded(e,t,s,i)}onFileUploaded(e){return this._onFileUploaded=e,this}onPending(e){return super.onPending(e),this}onFailed(e){return super.onFailed(e),this}onSucceeded(e){return super.onSucceeded(e),this}},exports.NESTDB_FEEDCHANNEL_COLLECTION_KEY="url",exports.NESTDB_FEEDCHANNEL_COLLECTION_NAME="FeedChannel",exports.NESTDB_GROUPCHANNEL_COLLECTION_KEY="url",exports.NESTDB_GROUPCHANNEL_COLLECTION_NAME="GroupChannel",exports.NESTDB_MESSAGE_COLLECTION_KEY="messageId",exports.NESTDB_MESSAGE_COLLECTION_NAME=oe,exports.NESTDB_POLL_COLLECTION_KEY="pollId",exports.NESTDB_POLL_COLLECTION_NAME="Poll",exports.NESTDB_UNSENT_MESSAGE_COLLECTION_KEY="reqId",exports.NESTDB_UNSENT_MESSAGE_COLLECTION_NAME=mt,exports.NestDB=class{constructor({name:e,version:t,store:s,config:i}){this.name=e,this._version=t,this._state=exports.NestDBState.INIT,this._config=i||new ce({dbname:e}),this._store=s,this._event={success:Ie,error:Ie,storeReplaced:Ie,upgrade:be},this._collections=new Map,this._globalMutex=new Je(`${this.name}.lock`),this._config.disableLogger&&tt.off(),new qe({dbname:e,limit:this._config.cacheLimit})}get version(){return this._version}get state(){return this._state}get store(){return this._store}estimateUsage(){return t.__awaiter(this,void 0,void 0,(function*(){return yield(e=this._store,t.__awaiter(void 0,void 0,void 0,(function*(){return yield e.usage()})));var e}))}commitSchema(e){return t.__awaiter(this,void 0,void 0,(function*(){if(this._state!==exports.NestDBState.OPENING)throw pe.databaseSchemaNotOnUpgrade;yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){const{collectionName:t,keyName:s,index:i=[]}=e;this._collections.has(t)||this._collections.set(t,new Xe({dbname:this.name,collectionName:t,keyName:s,indexes:i,store:this._store}));const n=this._collections.get(t);n&&(yield n.init())})))))}))}open(){var e;return t.__awaiter(this,void 0,void 0,(function*(){if(yield this._globalMutex.lock(),this._state!==exports.NestDBState.OPENED){this._state=exports.NestDBState.OPENING;try{yield this._store.init(this.name);const i=(s=this.name,`${we(s)}.metadata`),n={version:0,collectionNames:[]},a=null!==(e=yield this._store.get(i))&&void 0!==e?e:n;return new Promise(((e,s)=>{const n=e=>{a.version<this._version?this._event.upgrade(a.version,(s=>t.__awaiter(this,void 0,void 0,(function*(){if(s)e({continued:!1,err:s});else{a.version++,a.collectionNames=Array.from(this._collections.keys());try{yield this._store.set({key:i,value:a}),e({continued:!0})}catch(t){e({continued:!1,err:t})}}})))):e({continued:!1})},r=i=>{const{continued:o=!1,err:l=null}=i;if(o)setTimeout((()=>n(r)),10);else if(l)tt.error(l.message),this._globalMutex.unlock(),this._event.error(l),s(l);else{const i=[];a.collectionNames.forEach((e=>{const s=this._collections.get(e);s&&s.state===_e.READY||i.push((()=>t.__awaiter(this,void 0,void 0,(function*(){const t=yield Xe.metadataOf(this.name,e,this._store);if(t){const s=new Xe({dbname:this.name,collectionName:e,keyName:t.keyName,indexes:t.indexes,store:this._store});this._collections.set(e,s),yield s.init()}})))())})),Promise.all(i).then((()=>{this._state=exports.NestDBState.OPENED,this._globalMutex.unlock(),this._event.success(),e()})).catch((e=>{tt.error(e.message),this._globalMutex.unlock(),this._event.error(e),s(e)}))}};n(r)}))}catch(e){switch(e.code){case he.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING:tt.warning("Access to the local storage is not allowed. Switched to MemoryStore automatically."),this._store=new rt({}),this._globalMutex.unlock(),this._event.error(e),this._event.storeReplaced(this._store),yield this.open();break;case he.STORE_NOT_AVAILABLE:tt.warning("IndexedDB is not available in this environment. Switched to MemoryStore automatically. Consider using other store to save data persistently (e.g. AsyncStorage)."),this._store=new rt({}),this._globalMutex.unlock(),this._event.error(e),this._event.storeReplaced(this._store),yield this.open();break;default:throw tt.error(e.message),this._globalMutex.unlock(),this._event.error(e),e}}}var s}))}close(){this._collections.forEach((e=>e.close())),this._state=exports.NestDBState.CLOSED}clear(){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(Array.from(this._collections.values()).map((e=>e.clear())))}))}reset(){return t.__awaiter(this,void 0,void 0,(function*(){this.close();const e=qe.get(this.name);e&&e.clearByCondition((e=>e.key.startsWith(we(this.name)))),yield this._store.clear()}))}on(e,t){this._event[e]=t}off(e){if("function"==typeof this._event[e])if("upgrade"===e)this._event[e]=be;else this._event[e]=Ie}collection(e){const t=this._collections.get(e);if(t)return t;throw pe.collectionNotReady}},exports.NestDBError=pe,exports.OGImage=o,exports.OGMetaData=l,exports.Plugin=I,exports.PreviousMessageListQuery=ae,exports.Reaction=a,exports.ReactionEvent=class{constructor(e){this.messageId=0,this.operation=null,this.updatedAt=0;const s=t.isTypeOf("string",e.msg_id)?parseInt(e.msg_id):e.msg_id,i=e.user_id,n=e.operation?e.operation.toLowerCase():null,a=e.reaction,r=e.updated_at;s&&t.isTypeOf("string",i)&&t.isTypeOf("string",n)&&t.isEnumOf(exports.ReactionEventOperation,n)&&t.isTypeOf("string",a)&&a&&t.isTypeOf("number",r)&&(this.messageId=s,this.userId=i,this.key=a,this.operation=n,this.updatedAt=r)}},exports.RestrictionInfo=class{constructor(e){var s,i,n,a;this.restrictionType=null,t.isEnumOf(exports.RestrictionType,e.restriction_type)&&(this.restrictionType=e.restriction_type),this.description=null!==(s=e.description)&&void 0!==s?s:null,this.endAt=null!==(n=null!==(i=e.end_at)&&void 0!==i?i:e.muted_end_at)&&void 0!==n?n:-1,this.remainingDuration=null!==(a=e.remaining_duration)&&void 0!==a?a:-1}static payloadify(e){return t.deundefined(t.undefineNullProps({restriction_type:e.restrictionType,description:e.description,end_at:e.endAt,remaining_duration:e.remainingDuration}))}},exports.ScheduledFileMessageCreateParamsDefault=pt,exports.ScheduledUserMessageCreateParamsDefault=_t,exports.SendableMessage=m,exports.Sender=u,exports.ThreadInfo=n,exports.ThreadInfoUpdateEvent=Ot,exports.Thumbnail=y,exports.UnsentMessageCache=gt,exports.UploadFileRequestCommand=s,exports.UploadFileResponseCommand=i,exports.UploadedFileInfo=T,exports.UserMessage=E,exports.UserMessageCreateParamsDefault=Q,exports.UserMessageUpdateParamsDefault=ie,exports.createFileMessageCreateParamsFromFailedFileMessage=(e,s)=>{var i;return e.messageParams?(!e.url&&t.isFile(s)&&(e.messageParams.file=s),e.messageParams):t.deundefined(t.undefineNullProps({data:e.data,customType:e.customType,mentionType:e.mentionType,mentionedUsers:e.mentionedUsers,mentionedUserIds:e.mentionedUserIds,metaArrays:e.metaArrays,parentMessageId:e.parentMessageId,appleCriticalAlertOptions:e.appleCriticalAlertOptions,file:s,fileUrl:e.url,fileName:e.name,fileSize:e.size,mimeType:e.type,thumbnailSizes:null===(i=e.thumbnails)||void 0===i?void 0:i.map((e=>({maxWidth:e.width,maxHeight:e.height})))}))},exports.createUserMessageCreateParamsFromFailedUserMessage=e=>{var s;return t.deundefined(t.undefineNullProps({data:e.data,customType:e.customType,mentionType:e.mentionType,mentionedUsers:e.mentionedUsers,mentionedUserIds:e.mentionedUserIds,mentionedMessageTemplate:e.mentionedMessageTemplate,metaArrays:e.metaArrays,pollId:null===(s=e.poll)||void 0===s?void 0:s.id,parentMessageId:e.parentMessageId,appleCriticalAlertOptions:e.appleCriticalAlertOptions,message:e.message,translationTargetLanguages:Object.keys(e.translations)}))},exports.getMessageIndexBy=ht,exports.parseMessagePayload=O,exports.payloadifyMessage=e=>{switch(e.messageType){case t.MessageType.USER:return E.payloadify(e);case t.MessageType.FILE:return e.fileInfoList?b.payloadify(e):N.payloadify(e);case t.MessageType.ADMIN:return v.payloadify(e);default:throw t.SendbirdError.unknown}},exports.validateBaseMessageUpdateParams=se,exports.validateFileMessageCreateParams=e=>H(e)&&(t.isFile(e.file)||t.isTypeOf("string",e.fileUrl))&&t.isTypeOf("string",e.fileName,!0)&&t.isTypeOf("string",e.mimeType,!0)&&t.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||Array.isArray(e.thumbnailSizes)&&e.thumbnailSizes.every((e=>t.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))),exports.validateFileMessageUpdateParams=e=>se(e),exports.validateMessageChangeLogsParams=e=>t.isEnumOf(t.ReplyType,e.replyType)&&t.isTypeOf("boolean",e.includeReactions)&&t.isTypeOf("boolean",e.includeMetaArray)&&t.isTypeOf("boolean",e.includeParentMessageInfo)&&t.isTypeOf("boolean",e.includeThreadInfo),exports.validateMessageListParams=e=>t.isTypeOf("number",e.prevResultSize)&&t.isTypeOf("number",e.nextResultSize)&&t.isTypeOf("boolean",e.isInclusive)&&t.isTypeOf("boolean",e.reverse)&&t.isTypeOf("string",e.messageTypeFilter)&&t.isEnumOf(t.MessageTypeFilter,e.messageTypeFilter)&&t.isArrayOf("string",e.customTypesFilter,!0)&&t.isArrayOf("string",e.senderUserIdsFilter,!0)&&t.isEnumOf(t.ReplyType,e.replyType)&&t.isTypeOf("boolean",e.includeMetaArray)&&t.isTypeOf("boolean",e.includeReactions)&&t.isTypeOf("boolean",e.includeParentMessageInfo)&&t.isTypeOf("boolean",e.includeThreadInfo)&&t.isTypeOf("boolean",e.showSubchannelMessagesOnly),exports.validateMessageRetrievalParams=e=>t.isTypeOf("string",e.channelUrl)&&t.isEnumOf(t.ChannelType,e.channelType)&&t.isTypeOf("number",e.messageId)&&t.isTypeOf("boolean",e.includeReactions,!0)&&t.isTypeOf("boolean",e.includeMetaArray,!0)&&t.isTypeOf("boolean",e.includeParentMessageInfo,!0)&&t.isTypeOf("boolean",e.includeThreadInfo,!0),exports.validateMultipleFilesMessageCreateParams=(e,s=t.DEFAULT_MULTIPLE_FILES_MESSAGE_FILE_COUNT_LIMIT)=>H(e)&&Array.isArray(e.fileInfoList)&&e.fileInfoList.length>=2&&e.fileInfoList.length<=s&&e.fileInfoList.every((e=>de(e))),exports.validateScheduledFileMessageCreateParams=e=>H(e)&&t.isTypeOf("number",e.scheduledAt)&&(t.isFile(e.file)||t.isTypeOf("string",e.fileUrl))&&t.isTypeOf("string",e.fileName,!0)&&t.isTypeOf("string",e.mimeType,!0)&&t.isTypeOf("number",e.fileSize,!0)&&(null===e.thumbnailSizes||void 0===e.thumbnailSizes||e.thumbnailSizes.every((e=>t.isTypeOf("object",e)&&e.maxWidth>0&&e.maxHeight>0))),exports.validateScheduledUserMessageCreateParams=e=>W(e)&&t.isTypeOf("number",e.scheduledAt,!0),exports.validateUserMessageCreateParams=W,exports.validateUserMessageUpdateParams=e=>se(e)&&t.isTypeOf("string",e.message,!0)&&t.isArrayOf("string",e.translationTargetLanguages,!0)&&t.isTypeOf("number",e.pollId,!0);
