"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./lib/__bundle-c176c59f.js"),n=require("./lib/__bundle-a4005096.js"),t=require("./lib/__bundle-218bea1d.js"),s=require("./lib/__bundle-4bc3a029.js"),a=require("./lib/__bundle-86b43237.js"),i=require("./lib/__bundle-617167af.js"),r=require("./lib/__bundle-7ee4a5eb.js");require("./lib/__bundle-f5cc59df.js");class o extends e.InstancedObject{constructor(e,{sdkState:n,cacheContext:t,channelManager:s}){super(e),this._channels=new Map,this._sdkState=n,this._cacheContext=t,this._channelManager=s}get collection(){const{nestdb:n}=this._cacheContext;return e.unless(!!n).throw(e.SendbirdError.databaseError),n.collection(s.NESTDB_FEEDCHANNEL_COLLECTION_NAME)}get localCacheEnabled(){const{localCacheEnabled:e}=this._cacheContext;return e&&!!this.collection}_serialize(e,n=0){return Object.assign(Object.assign({},e.serialize()),{lastMessageUpdatedAt:e.lastMessage?e.lastMessage.createdAt:0,syncIndex:n})}_deserialize(e){return this._channelManager.buildFeedChannelFromSerializedData(e)}get channels(){return[...this._channels.values()]}isCachedInMemory(e){return this._channels.has(e)}get(n){return e.__awaiter(this,void 0,void 0,(function*(){if(this._channels.has(n))return this._channels.get(n);if(this.localCacheEnabled){const e=yield this.collection.getByKey(n);if(e)return this._channels.set(n,this._deserialize(e)),this._channels.get(n)}}))}fetch({token:n,limit:t=s.DEFAULT_FEED_LIMIT,backward:i=!1,order:r="latest_last_message",borderlineChannelUrl:o}){return e.__awaiter(this,void 0,void 0,(function*(){if(this.localCacheEnabled){const e={where:e=>{if(n&&"latest_last_message"===r){if(!i&&e.lastMessageUpdatedAt>n||i&&e.lastMessageUpdatedAt<n)return!1;if(o&&o===e.url)return!1}return!0},index:a.getFeedChannelIndexBy(r),backward:i},s=yield this.collection.query(e),d=(yield s.fetch({limit:t})).map((e=>this._deserialize(e)));return d.forEach((e=>{this._channels.has(e.url)||this._channels.set(e.url,e)})),d}return[]}))}upsert(n){return e.__awaiter(this,void 0,void 0,(function*(){const t=[];if(n.forEach((n=>{if(this._channels.has(n.url)){const s=this._channels.get(n.url),a=e.deundefined(n);Object.assign(s,a,{_iid:this._iid}),t.push(s)}else this._channels.set(n.url,n),t.push(n)})),this.localCacheEnabled){const e=[];for(const n in t)e.push(this._serialize(t[n],parseInt(n)));yield this.collection.upsertMany(e)}return t}))}remove(n){return e.__awaiter(this,void 0,void 0,(function*(){for(const e of n)this._channels.delete(e),this.localCacheEnabled&&(yield this.collection.remove(e))}))}clear(){return e.__awaiter(this,void 0,void 0,(function*(){this.clearMemoryCache(),this.localCacheEnabled&&(yield this.collection.clear())}))}clearMemoryCache(){this._channels.clear()}}const d=!1;class l extends e.APIRequestCommand{constructor(n){super();const{userId:t,token:s,limit:a,includeEmpty:i}=n;this.method=e.APIRequestMethod.GET,this.path=`${e.API_PATH_USERS}/${encodeURIComponent(t)}/my_group_channels`,this.params=e.deundefined({token:s,limit:a,show_empty:null!=i?i:d,show_read_receipt:!0,show_delivery_receipt:!0,show_member:!0,is_feed_channel:!0,order:"latest_last_message"})}}class h extends e.APIResponseCommand{constructor(e,n){super(e,n),this.channels=[];const{next:t,channels:s,ts:a}=n;this.token=t,this.ts=null!=a?a:0,this.channels=(null!=s?s:[]).map((n=>(n.ts=a,new T(e,n))))}}class c{constructor({feedChannelCache:n,messageCache:s,unsentMessageCache:a,dispatcher:r}){this._observers=new Map,r.on((r=>e.__awaiter(this,void 0,void 0,(function*(){if(r instanceof t.FeedChannelUpdateEventCommand){const{channels:e,source:t,isWebSocketEventComing:s,data:a}=r,i=e.filter((e=>e instanceof T)),o=yield n.upsert(i);s||this._broadcastUpdateEvent(o,t,a)}else if(r instanceof t.FeedChannelRemoveEventCommand){const{channelUrls:t,source:i,isWebSocketEventComing:o}=r;yield n.remove(t),yield e.runOrNothing((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of t)yield s.removeMessagesOfChannel(e),yield a.removeMessagesOfChannel(e)})))),o||this._broadcastRemoveEvent(t,i)}else r instanceof i.DatabaseOpenCommand&&(yield n.fetch({token:Number.MAX_SAFE_INTEGER,limit:Number.MAX_SAFE_INTEGER}))}))))}_broadcastUpdateEvent(e,n,t){for(const s of this._observers.values())s.onUpdate&&s.onUpdate(e,n,t)}_broadcastRemoveEvent(e,n){for(const t of this._observers.values())t.onRemove&&t.onRemove(e,n)}subscribe(e,n){this._observers.set(e,n)}unsubscribe(e){this._observers.delete(e)}unsubscribeAll(){this._observers.clear()}}class u extends e.APIRequestCommand{constructor({channelUrl:n,isInternalCall:t}){super(),this.method=e.APIRequestMethod.GET,this.path=`${t?e.API_PATH_GROUP_CHANNELS_INTERNAL:e.API_PATH_GROUP_CHANNELS}/${encodeURIComponent(n)}`,this.params={show_member:!0,show_read_receipt:!0,show_delivery_receipt:!0,is_feed_channel:!0}}}class C extends e.APIResponseCommand{constructor(e,n){super(e,n),this.channel=new T(e,n)}}const _={includeEmpty:!0},m=n=>e.isTypeOf("boolean",n.includeEmpty);class p extends e.APIRequestCommand{constructor({userId:n,ts:t,token:s,params:a}){super();const{includeEmpty:i}=Object.assign(Object.assign({},_),a);this.method=e.APIRequestMethod.GET,this.path=`${e.API_PATH_USERS}/${encodeURIComponent(n)}/my_group_channels/changelogs`,this.params=e.deundefined(e.undefineNullProps({show_delivery_receipt:!0,show_member:!0,show_read_receipt:!0,is_feed_channel:!0,show_empty:i,change_ts:t||null,token:s}))}}class E extends e.APIResponseCommand{constructor(e,n){super(e,n),this.updatedChannels=n.updated.map((n=>new T(e,n))),this.deletedChannelUrls=n.deleted,this.hasMore=n.has_more,this.token=n.next}}class g extends e.APIRequestCommand{constructor(){super(),this.method=e.APIRequestMethod.GET,this.path=`${e.API_PATH_NOTIFICATIONS}/settings`}}class v extends e.APIResponseCommand{constructor(e,n){super(e,n),this.jsonString=JSON.stringify(n)}}const f=20;class b extends e.APIRequestCommand{constructor(n){const{reverse:t=!1,keys:s,limit:a=f,token:i}=n;super(),this.method=e.APIRequestMethod.GET,this.path=`${e.API_PATH_NOTIFICATIONS}/templates`,this.params=e.deundefined({token:i,keys:s,limit:a,reverse:t,order:"updated_at",show_ui_template:!0,show_color_variables:!0})}}class M extends e.APIResponseCommand{constructor(n,t){super(n,t);const{next:s,has_more:a=!1}=t,i=e.__rest(t,["next","has_more"]);this.nextToken=s,this.hasMore=a,this.notificationTemplateList={jsonString:JSON.stringify(i)}}}const y={reverse:!1,keys:void 0,limit:20};class I extends e.APIRequestCommand{constructor(n){const{key:t}=n;super(),this.method=e.APIRequestMethod.GET,this.path=`${e.API_PATH_NOTIFICATIONS}/templates/${t}`,this.params=e.deundefined({key:t})}}class U extends e.APIResponseCommand{constructor(e,n){super(e,n),this.jsonString=JSON.stringify(n)}}const S={};class A extends r.BaseChannelManager{constructor(n,t){var a;super(n,Object.assign(Object.assign({},t),{channelType:e.ChannelType.FEED})),this._disableMack=!1,this._disableMack=null!==(a=t.disableMack)&&void 0!==a&&a,this._feedChannelHandlers=new Map,this._feedChannelCache=new o(this._iid,{sdkState:this._sdkState,cacheContext:this._cacheContext,channelManager:this}),this._feedChannelBroadcast=new c({feedChannelCache:this._feedChannelCache,dispatcher:this._dispatcher,messageCache:s.MessageCache.of(n),unsentMessageCache:s.UnsentMessageCache.of(n)}),this._dispatcher.on((n=>{n instanceof e.WebSocketEventCommand&&this._handleEvent(n)})),S[n]||(S[n]=this)}static of(n){return S[n]||(S[n]=new A(n,e.Vault.of(n))),S[n]}static clear(e){S[e]&&delete S[e]}get handlers(){return[...this._feedChannelHandlers.values()]}buildFeedChannelFromSerializedData(n){const t=e.deserialize(n);return new T(this._iid,T.payloadify(t))}addHandler(e,n){this._feedChannelHandlers.set(e,n)}removeHandler(e){this._feedChannelHandlers.delete(e)}clearHandler(){this._feedChannelHandlers.clear()}getMyFeedChannels(n,t,s){return e.__awaiter(this,void 0,void 0,(function*(){const e=new l(Object.assign(Object.assign({},t),{userId:this._sdkState.userId,token:n,limit:s})),a=yield this._requestQueue.send(e),{channels:i,token:r}=a.as(h);return{channels:i,token:r}}))}getChannel(n,t=!1){return e.__awaiter(this,void 0,void 0,(function*(){e.unless(e.isTypeOf("string",n)).throw(e.SendbirdError.invalidParameters);try{const e=yield this.getChannelFromCache(n);if(e)return e}catch(e){}return yield this.getChannelWithoutCache(n,t)}))}getChannelFromCache(n){var t;return e.__awaiter(this,void 0,void 0,(function*(){return e.unless(e.isTypeOf("string",n)).throw(e.SendbirdError.invalidParameters),null!==(t=yield this._feedChannelCache.get(n))&&void 0!==t?t:null}))}getChannelWithoutCache(n,t=!1){return e.__awaiter(this,void 0,void 0,(function*(){e.unless(e.isTypeOf("string",n)).throw(e.SendbirdError.invalidParameters);const s=new u({channelUrl:n,isInternalCall:t}),a=yield this._requestQueue.send(s),{channel:i}=a.as(C),[r]=yield this.upsertChannelsToCache([i]);return r}))}getMyFeedChannelChangeLogs(n,s,a=e.CollectionEventSource.REQUEST_CHANNEL_CHANGELOGS){return e.__awaiter(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},_),s);e.unless((e.isTypeOf("string",n)||e.isTypeOf("number",n))&&m(i)).throw(e.SendbirdError.invalidParameters);const r=new p(e.undefineNullProps({userId:this._sdkState.userId,ts:"number"==typeof n?n:null,token:"string"==typeof n?n:null,params:i})),o=yield this._requestQueue.send(r),{updatedChannels:d,deletedChannelUrls:l,hasMore:h,token:c}=o.as(E);return d.length>0&&this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:d,source:a})),l.length>0&&this._dispatcher.dispatch(new t.FeedChannelRemoveEventCommand({channelUrls:l,source:a})),{updatedChannels:d,deletedChannelUrls:l,hasMore:h,token:c}}))}getTotalUnreadMessageCount(n){return e.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},t.TotalUnreadMessageCountParamsDefault),n);e.unless(t.validateTotalUnreadMessageCountParams(s)).throw(e.SendbirdError.invalidParameters);const{sdkState:a,requestQueue:i}=e.Vault.of(this._iid),r=new t.GetTotalUnreadMessageCountRequestCommand({userId:a.userId,filter:s,includeFeedChannel:!0}),o=yield i.send(r),{unreadFeedCount:d=0}=o.as(t.GetTotalUnreadMessageCountResponseCommand);return d}))}getGlobalNotificationChannelSetting(){return e.__awaiter(this,void 0,void 0,(function*(){const e=new g,n=yield this._requestQueue.send(e),{jsonString:t}=n.as(v);return{jsonString:t}}))}getNotificationTemplateListByToken(n,t={}){return e.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},y),t);e.unless(e.isTypeOf("string",n)&&(n=>e.isTypeOf("boolean",n.reverse,!0)&&e.isArrayOf("string",n.keys,!0)&&e.isTypeOf("number",n.limit,!0))(s)).throw(e.SendbirdError.invalidParameters);const a=new b({token:n,keys:s.keys,reverse:s.reverse,limit:s.limit}),i=yield this._requestQueue.send(a),{hasMore:r,nextToken:o,notificationTemplateList:d}=i.as(M);return{hasMore:r,token:o,notificationTemplateList:d}}))}getNotificationTemplate(n){return e.__awaiter(this,void 0,void 0,(function*(){e.unless(e.isTypeOf("string",n)).throw(e.SendbirdError.invalidParameters);const t=new I({key:n}),s=yield this._requestQueue.send(t),{jsonString:a}=s.as(U);return{jsonString:a}}))}upsertChannelsToCache(n){return e.__awaiter(this,void 0,void 0,(function*(){return yield this._feedChannelCache.upsert(n)}))}removeChannelsFromCache(n){return e.__awaiter(this,void 0,void 0,(function*(){yield this._feedChannelCache.remove(n)}))}refreshChannel(n,s=!0,a=e.CollectionEventSource.REFRESH_CHANNEL){return e.__awaiter(this,void 0,void 0,(function*(){try{const e=new u({channelUrl:n,isInternalCall:s}),i=yield this._requestQueue.send(e),{channel:r}=i.as(C);if(r.myMemberState===t.MemberState.NONE)this._dispatcher.dispatch(new t.FeedChannelRemoveEventCommand({channelUrls:[r.url],source:a}));else{const e=yield this.upsertChannelsToCache([r]);this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:e,source:a}))}}catch(s){s.code!==e.SendbirdErrorCode.NON_AUTHORIZED&&s.code!==e.SendbirdErrorCode.NOT_FOUND_IN_DATABASE||this._dispatcher.dispatch(new t.FeedChannelRemoveEventCommand({channelUrls:[n],source:a}))}}))}subscribeChannelEvent(e,n){this._feedChannelBroadcast.subscribe(e,n)}unsubscribeChannelEvent(e){this._feedChannelBroadcast.unsubscribe(e)}_handleEvent(a){return e.__awaiter(this,void 0,void 0,(function*(){switch(a.code){case"MESG":case"FILE":case"ADMM":case"BRDM":{const i="MESG"===a.code?a.as(n.UserMessageEventCommand):"FILE"===a.code?a.as(s.FileMessageEventCommand):"ADMM"===a.code||"BRDM"===a.code?a.as(r.AdminMessageEventCommand):null;if(i&&i.message.channelType===this._channelType){const{message:n,isMentioned:a,forceUpdateLastMessage:r}=i;this._disableMack||e.runOrNothing((()=>e.__awaiter(this,void 0,void 0,(function*(){const e=new t.MessageAckCommand(n);this._requestQueue.send(e)}))));const o=yield this.getChannel(n.channelUrl,!0);o._runIfHandleableWithGroupChannel((i=>{var d;const l=this._feedChannelCache.isCachedInMemory(n.channelUrl),h=n instanceof s.SendableMessage&&n.sender.userId===this._sdkState.userId;if(i.hiddenState===t.HiddenState.HIDDEN_ALLOW_AUTO_UNHIDE&&(i.hiddenState=t.HiddenState.UNHIDDEN),n instanceof s.SendableMessage){const{useMemberInfoInMessage:t}=e.Vault.of(this._iid);for(const e of i.members)if(e.userId===n.sender.userId){t||(n.sender.nickname=e.nickname,n.sender.plainProfileUrl=e.plainProfileUrl,n.sender.metaData=e.metaData,n.sender.isBlockedByMe=e.isBlockedByMe);break}if(!t&&a&&(null===(d=n.mentionedUsers)||void 0===d||d.forEach((e=>{for(const n of i.members)if(e.userId===n.userId){e.nickname=n.nickname,e.plainProfileUrl=n.plainProfileUrl,e.metaData=n.metaData;break}}))),h){const{currentUser:e}=this._sessionManager;e&&(e.nickname=n.sender.nickname,e.plainProfileUrl=n.sender.plainProfileUrl,e.metaData=n.sender.metaData)}}n.silent&&!h||(i.isEphemeral||l)&&((!i.lastMessage||i.lastMessage.createdAt<n.createdAt)&&(i.lastMessage=n),h||i._updateUnreadCount(i.unreadMessageCount+1,i.unreadMentionCount+(a?1:0))),r&&(!i.lastMessage||i.lastMessage.createdAt<n.createdAt)&&(i.lastMessage=n),this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[o],source:e.CollectionEventSource.EVENT_MESSAGE_RECEIVED})),n.silent&&!h||e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(o)})))),this._dispatcher.dispatch(new e.MessageUpdateEventCommand({messages:[n],source:e.CollectionEventSource.EVENT_MESSAGE_RECEIVED})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onMessageReceived&&e.onMessageReceived(o,n),a&&e.onMentionReceived&&e.onMentionReceived(o,n)}))))}))}break}case"MEDI":case"FEDI":case"AEDI":{const i="MEDI"===a.code?a.as(n.UpdateUserMessageEventCommand):"FEDI"===a.code?a.as(n.UpdateFileMessageEventCommand):"AEDI"===a.code?a.as(r.UpdateAdminMessageEventCommand):null;if(i&&i.message.channelType===this._channelType){const{message:n,mentionCountChange:a}=i,r=this._feedChannelCache.isCachedInMemory(n.channelUrl),o=yield this.getChannel(n.channelUrl,!0);o._runIfHandleableWithGroupChannel((i=>{const d=n instanceof s.SendableMessage&&n.sender.userId===this._sdkState.userId;let l=!1;if(d){const e=n.sender,{currentUser:t}=this._sessionManager;t&&(t.nickname=e.nickname,t.plainProfileUrl=e.plainProfileUrl,t.metaData=e.metaData)}else i.isReadMessage(n)||0!==a&&!n.silent&&r&&(i._updateUnreadCount(i.unreadMessageCount,i.unreadMentionCount+a),l=!0);!i.lastMessage||i.lastMessage.createdAt<n.createdAt?(i.lastMessage=n,l=!0):i.lastMessage.isIdentical(n)&&(r?i.lastMessage.updatedAt<n.updatedAt&&(i.lastMessage=n,l=!0):l=!0);let h=!1;i.lastPinnedMessage&&i.lastPinnedMessage.messageId===n.messageId&&(i.lastPinnedMessage=n,l=!0,h=!0),l&&(this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[o],source:h?e.CollectionEventSource.EVENT_PINNED_MESSAGE_UPDATED:e.CollectionEventSource.EVENT_MESSAGE_UPDATED})),n.silent&&!d||e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(o)}))))),this._dispatcher.dispatch(new e.MessageUpdateEventCommand({messages:[n],source:e.CollectionEventSource.EVENT_MESSAGE_UPDATED})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onMessageUpdated&&e.onMessageUpdated(o,n),0!==a&&e.onMentionReceived&&e.onMentionReceived(o,n)}))))}))}break}case"DELM":{const t="DELM"===a.code?a.as(n.DeleteMessageEventCommand):null;if(t&&t.channelType===this._channelType){const{channelUrl:n,messageId:s}=t,a=yield this.getChannel(n,!0);this._dispatcher.dispatch(new e.MessageRemoveEventCommand({messageIds:[s],source:e.CollectionEventSource.EVENT_MESSAGE_DELETED})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onMessageDeleted&&e.onMessageDeleted(a,s)}))))}break}case"READ":{const n="READ"===a.code?a.as(t.ReadEventCommand):null;if(n){const{readStatus:s}=n,a=this._feedChannelCache.isCachedInMemory(s.channelUrl),i=yield this.getChannel(s.channelUrl,!0);i._runIfHandleableWithGroupChannel((n=>{a&&n._updateUnreadMemberState(s.reader.userId,s.readAt),s.reader.userId===this._sdkState.userId?a?(n.unreadMessageCount>0||n.unreadMentionCount>0)&&(n._updateUnreadCount(0,0),this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[i],source:e.CollectionEventSource.EVENT_CHANNEL_READ})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(i)}))))):0!==n.unreadMessageCount&&0!==n.unreadMentionCount||(this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[i],source:e.CollectionEventSource.EVENT_CHANNEL_READ})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onChannelChanged&&e.onChannelChanged(i)}))))):(this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[i],source:e.CollectionEventSource.EVENT_CHANNEL_READ})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){for(const e of this._feedChannelHandlers.values())e.onUnreadMemberStatusUpdated&&e.onUnreadMemberStatusUpdated(i)})))))}))}break}case"SYEV":{const n="SYEV"===a.code?a.as(r.ChannelEventCommand):null;if(n&&n.event.channelType===this._channelType){const{event:s}=n;switch(s.category){case r.ChannelEventCategory.CHANNEL_INVITE:{const n=yield this.getChannel(s.channelUrl,!0);n._runIfHandleableWithGroupChannel((i=>{const{memberCount:r,joinedMemberCount:o,invitees:d}=a.as(t.InviteToGroupChannelEventCommand);d.forEach((e=>e.state=t.MemberState.INVITED));for(const e of d)i.isExclusive||i.isSuper||i.isBroadcast?i._setLatestMemberCount(r,o,s.ts):i.addMember(e,s.ts),this._sdkState.userId===e.userId&&(i.hiddenState=t.HiddenState.UNHIDDEN,i.myMemberState!==t.MemberState.JOINED&&(i.myMemberState=t.MemberState.INVITED),i.invitedAt=s.ts);this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[n],source:e.CollectionEventSource.EVENT_CHANNEL_INVITED}))}));break}case r.ChannelEventCategory.CHANNEL_DECLINE_INVITE:{const n=yield this.getChannel(s.channelUrl,!0);n._runIfHandleableWithGroupChannel((i=>{const{memberCount:r,joinedMemberCount:o,invitee:d}=a.as(t.DeclineInvitationEventCommand);i.isExclusive||i.isSuper||i.isBroadcast?i._setLatestMemberCount(r,o,s.ts):i.removeMember(d),this._sdkState.userId===d.userId?(i.invitedAt=0,i.myMemberState=t.MemberState.NONE,i.isPublic?this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[n],source:e.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE})):this._dispatcher.dispatch(new t.FeedChannelRemoveEventCommand({channelUrls:[n.url],source:e.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE}))):this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[n],source:e.CollectionEventSource.EVENT_CHANNEL_DECLINED_INVITE}))}));break}case r.ChannelEventCategory.CHANNEL_DELETED:{const n=yield this.getChannel(s.channelUrl,!0);this._dispatcher.dispatch(new t.FeedChannelRemoveEventCommand({channelUrls:[s.channelUrl],source:e.CollectionEventSource.EVENT_CHANNEL_DELETED})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){this._feedChannelHandlers.forEach((e=>{e.onChannelDeleted&&e.onChannelDeleted(n.url,n.channelType)}))}))));break}case r.ChannelEventCategory.CHANNEL_PROP_CHANGED:{const n=yield this.getChannelWithoutCache(s.channelUrl,!0);this._dispatcher.dispatch(new t.FeedChannelUpdateEventCommand({channels:[n],source:e.CollectionEventSource.EVENT_CHANNEL_UPDATED})),e.runAsCallback((()=>e.__awaiter(this,void 0,void 0,(function*(){this._feedChannelHandlers.forEach((e=>{e.onChannelChanged&&e.onChannelChanged(n)}))}))));break}}}break}}}))}}class N extends t.BaseMessageCollection{constructor(e,n){super(e,Object.assign(Object.assign({},n),{channelManager:A.of(e)}))}setMessageCollectionHandler(e){this._setBaseMessageCollectionHandler(e)}}class T extends n.BaseChannel{static payloadify(e){var n;return Object.assign({},t.GroupChannel.payloadify(null!==(n=e._groupChannel)&&void 0!==n?n:e))}constructor(n,s){super(n,s),this.channelType=e.ChannelType.FEED,this._groupChannel=new t.GroupChannel(n,s)}get groupChannel(){return this._groupChannel}get url(){return this._groupChannel.url}get name(){return this._groupChannel.name}set name(e){this._groupChannel.name=e}get createdAt(){return this._groupChannel.createdAt}get members(){return this._groupChannel.members}get memberCount(){return this._groupChannel.memberCount}get myMemberState(){return this._groupChannel.myMemberState}get myLastRead(){return this._groupChannel.myLastRead}get lastMessage(){return this._groupChannel.lastMessage}get unreadMessageCount(){return this._groupChannel.unreadMessageCount}serialize(){return Object.assign({},this._groupChannel.serialize())}refresh(){return e.__awaiter(this,void 0,void 0,(function*(){return yield this._groupChannel._refresh(!0),this}))}markAsRead(){return e.__awaiter(this,void 0,void 0,(function*(){const{sdkState:n,dispatcher:s,requestQueue:a}=e.Vault.of(this._iid),i=new t.ReadRequestCommand({channelUrl:this.url}),r=yield a.send(i),{readStatus:o}=r.as(t.ReadEventCommand);if(this._groupChannel._updateUnreadMemberState(n.userId,o.readAt),this._groupChannel.unreadMessageCount>0||this._groupChannel.unreadMentionCount>0){this._groupChannel._updateUnreadCount(0,0);A.of(this._iid).handlers.map((e=>{e.onChannelChanged&&e.onChannelChanged(this)}))}s.dispatch(new t.FeedChannelUpdateEventCommand({channels:[this],source:e.CollectionEventSource.EVENT_CHANNEL_READ}))}))}createNotificationCollection(e={}){return new N(this._iid,Object.assign({channel:this},e))}}const w=["onUserMuted","onUserUnmuted","onUserBanned","onUserUnbanned","onChannelFrozen","onChannelUnfrozen","onOperatorUpdated","onMetaDataCreated","onMetaDataUpdated","onMetaDataDeleted","onMetaCounterCreated","onMetaCounterUpdated","onMetaCounterDeleted","onReactionUpdated","onThreadInfoUpdated"];class k extends r.BaseChannelHandlerParams{constructor(){super(...arguments),this.onUnreadMemberStatusUpdated=e.noop,this.onUserMuted=e.noop,this.onUserUnmuted=e.noop,this.onUserBanned=e.noop,this.onUserUnbanned=e.noop,this.onChannelFrozen=e.noop,this.onChannelUnfrozen=e.noop,this.onOperatorUpdated=e.noop,this.onMetaDataCreated=e.noop,this.onMetaDataUpdated=e.noop,this.onMetaDataDeleted=e.noop,this.onMetaCounterCreated=e.noop,this.onMetaCounterUpdated=e.noop,this.onMetaCounterDeleted=e.noop,this.onReactionUpdated=e.noop,this.onThreadInfoUpdated=e.noop}}class D extends k{constructor(e={}){super(),Object.keys(e).forEach((n=>{Object.prototype.hasOwnProperty.call(this,n)&&-1===w.indexOf(n)&&(this[n]=e[n])}))}}class O extends e.BaseListQuery{constructor(e,n){var t;super(e,n),this.includeEmpty=d,this.includeEmpty=null!==(t=n.includeEmpty)&&void 0!==t?t:d}_validate(){return super._validate()&&e.isTypeOf("boolean",this.includeEmpty)}next(){return e.__awaiter(this,void 0,void 0,(function*(){if(this._validate()){if(this._isLoading)throw e.SendbirdError.queryInProgress;if(this._hasNext){this._isLoading=!0;const n=A.of(this._iid),t=e.undefineNullProps(Object.assign({},this)),{channels:s,token:a}=yield n.getMyFeedChannels(this._token,t,this.limit);return this._token=a,this._hasNext=!!a,this._isLoading=!1,s}return[]}throw e.SendbirdError.invalidParameters}))}}class P extends e.Module{constructor(){super(...arguments),this.name="feedChannel"}init(e,n){super.init(e,n),this._manager=new A(e,n)}createMyFeedChannelListQuery(e={}){return new O(this._iid,e)}addFeedChannelHandler(n,t){e.unless(e.isTypeOf("string",n)&&t instanceof D).throw(e.SendbirdError.invalidParameters),this._manager.addHandler(n,t)}removeFeedChannelHandler(n){e.unless(e.isTypeOf("string",n)).throw(e.SendbirdError.invalidParameters),this._manager.removeHandler(n)}removeAllFeedChannelHandlers(){this._manager.clearHandler()}getChannel(n){return e.__awaiter(this,void 0,void 0,(function*(){return e.unless(e.isTypeOf("string",n)).throw(e.SendbirdError.invalidParameters),this._manager.getChannel(n)}))}getMyFeedChannelChangeLogsByTimestamp(n,t={}){return e.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},_),t);return e.unless(e.isTypeOf("number",n)&&m(s)).throw(e.SendbirdError.invalidParameters),yield this._manager.getMyFeedChannelChangeLogs(n,s)}))}getMyFeedChannelChangeLogsByToken(n,t={}){return e.__awaiter(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},_),t);return e.unless(e.isTypeOf("string",n)&&m(s)).throw(e.SendbirdError.invalidParameters),yield this._manager.getMyFeedChannelChangeLogs(n,s)}))}getTotalUnreadMessageCount(n={}){return e.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getTotalUnreadMessageCount(n)}))}getGlobalNotificationChannelSetting(){return e.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getGlobalNotificationChannelSetting()}))}getNotificationTemplateListByToken(n,t={}){return e.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getNotificationTemplateListByToken(n,t)}))}getNotificationTemplate(n){return e.__awaiter(this,void 0,void 0,(function*(){return yield this._manager.getNotificationTemplate(n)}))}}exports.FeedChannelEventContext=t.FeedChannelEventContext,exports.NotificationEventContext=t.NotificationEventContext,exports.FeedChannel=T,exports.FeedChannelHandler=D,exports.FeedChannelListQuery=O,exports.FeedChannelModule=P,exports.NotificationCollection=N;
